# OTLPè¯­ä¹‰æ¨¡å‹è§†è§’ï¼šæ•°æ®ç»„åˆä¸å…³è”æ·±åº¦åˆ†æ

> **æ–‡æ¡£ç±»å‹**: æ•°æ®æ¨¡å‹æ·±åº¦åˆ†æ  
> **åˆ†æç»´åº¦**: è¯­ä¹‰æ¨¡å‹è§†è§’ - æ•°æ®ç»„åˆä¸å…³è”  
> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´10æœˆ11æ—¥  
> **æ–‡æ¡£çŠ¶æ€**: âœ… å®Œæˆ

---

## ğŸ“‹ ç›®å½•

- [OTLPè¯­ä¹‰æ¨¡å‹è§†è§’ï¼šæ•°æ®ç»„åˆä¸å…³è”æ·±åº¦åˆ†æ](#otlpè¯­ä¹‰æ¨¡å‹è§†è§’æ•°æ®ç»„åˆä¸å…³è”æ·±åº¦åˆ†æ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ğŸ¯ æ‰§è¡Œæ‘˜è¦](#-æ‰§è¡Œæ‘˜è¦)
    - [ç»„åˆå…³è”å…¨æ™¯](#ç»„åˆå…³è”å…¨æ™¯)
  - [ğŸ“Š ç»„åˆå…³è”å…¨æ™¯](#-ç»„åˆå…³è”å…¨æ™¯)
    - [ç»„åˆç±»å‹çŸ©é˜µ](#ç»„åˆç±»å‹çŸ©é˜µ)
  - [ğŸ”— æ•°æ®ç»„åˆ](#-æ•°æ®ç»„åˆ)
    - [Resourceç»„åˆ](#resourceç»„åˆ)
    - [Scopeç»„åˆ](#scopeç»„åˆ)
    - [Logç»„åˆ](#logç»„åˆ)
  - [ğŸ”— æ•°æ®å…³è”](#-æ•°æ®å…³è”)
    - [Traceå…³è”](#traceå…³è”)
    - [Spanå…³è”](#spanå…³è”)
    - [Logå…³è”](#logå…³è”)
  - [ğŸ“ˆ ç»„åˆå…³è”æ€§èƒ½åˆ†æ](#-ç»„åˆå…³è”æ€§èƒ½åˆ†æ)
    - [ç»„åˆå…³è”æ€§èƒ½åŸºå‡†æµ‹è¯•](#ç»„åˆå…³è”æ€§èƒ½åŸºå‡†æµ‹è¯•)
  - [âš¡ ç»„åˆå…³è”ä¼˜åŒ–ç­–ç•¥](#-ç»„åˆå…³è”ä¼˜åŒ–ç­–ç•¥)
    - [1. é¢„ç»„åˆç­–ç•¥](#1-é¢„ç»„åˆç­–ç•¥)
    - [2. ç¼“å­˜å…³è”ç­–ç•¥](#2-ç¼“å­˜å…³è”ç­–ç•¥)
    - [3. æ‰¹é‡å…³è”ç­–ç•¥](#3-æ‰¹é‡å…³è”ç­–ç•¥)
  - [ğŸ’¡ å®æˆ˜æ¡ˆä¾‹](#-å®æˆ˜æ¡ˆä¾‹)
    - [æ¡ˆä¾‹1ï¼šç”µå•†ç³»ç»Ÿæ•°æ®ç»„åˆ](#æ¡ˆä¾‹1ç”µå•†ç³»ç»Ÿæ•°æ®ç»„åˆ)
    - [æ¡ˆä¾‹2ï¼šå¾®æœåŠ¡ç³»ç»Ÿæ•°æ®å…³è”](#æ¡ˆä¾‹2å¾®æœåŠ¡ç³»ç»Ÿæ•°æ®å…³è”)
  - [ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®](#-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [ç»„åˆå…³è”ä¼˜åŒ–çŸ©é˜µ](#ç»„åˆå…³è”ä¼˜åŒ–çŸ©é˜µ)
  - [ğŸ¯ æ€»ç»“](#-æ€»ç»“)

---

## ğŸ¯ æ‰§è¡Œæ‘˜è¦

### ç»„åˆå…³è”å…¨æ™¯

```text
ç»„åˆå…³è”å…¨æ™¯:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          OTLPæ•°æ®ç»„åˆä¸å…³è”ä½“ç³»                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  æ•°æ®ç»„åˆ                                    â”‚      â”‚
â”‚  â”‚  - Resource + Spans                         â”‚      â”‚
â”‚  â”‚  - Scope + Metrics                         â”‚      â”‚
â”‚  â”‚  - Resource + Logs                         â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                         â”‚                               â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚         â”‚               â”‚               â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ æ•°æ®å…³è”    â”‚  â”‚ å…³ç³»ç±»å‹    â”‚  â”‚ å…³è”ç­–ç•¥    â”‚        â”‚
â”‚  â”‚ - Traceå…³è”  â”‚  â”‚ - çˆ¶å­å…³ç³»  â”‚  â”‚ - IDå…³è”   â”‚        â”‚
â”‚  â”‚ - Spanå…³è”   â”‚  â”‚ - å…„å¼Ÿå…³ç³»  â”‚  â”‚ - æ—¶é—´å…³è”  â”‚        â”‚
â”‚  â”‚ - Logå…³è”    â”‚  â”‚ - å› æœå…³ç³»  â”‚  â”‚ - å±æ€§å…³è”  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  ç»„åˆåœºæ™¯                                      â”‚      â”‚
â”‚  â”‚  - Tracesç»„åˆ                                  â”‚      â”‚
â”‚  â”‚  - Metricsç»„åˆ                                 â”‚      â”‚
â”‚  â”‚  - Logsç»„åˆ                                    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒæ´å¯Ÿ**ï¼š

1. **æ•°æ®ç»„åˆ**ï¼šResource + Spans/Metrics/Logs
2. **æ•°æ®å…³è”**ï¼šTraceå…³è” + Spanå…³è” + Logå…³è”
3. **å…³ç³»ç±»å‹**ï¼šçˆ¶å­å…³ç³» + å…„å¼Ÿå…³ç³» + å› æœå…³ç³»
4. **å…³è”ç­–ç•¥**ï¼šIDå…³è” + æ—¶é—´å…³è” + å±æ€§å…³è”

---

## ğŸ“Š ç»„åˆå…³è”å…¨æ™¯

### ç»„åˆç±»å‹çŸ©é˜µ

```text
ç»„åˆç±»å‹çŸ©é˜µ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç»„åˆç±»å‹      â”‚ è¾“å…¥æ•°æ®    â”‚ è¾“å‡ºæ•°æ®    â”‚ æ•ˆæœ         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Resourceç»„åˆ  â”‚ Resource+Spansâ”‚ ResourceSpansâ”‚ ç»„ç»‡    â”‚
â”‚  Scopeç»„åˆ     â”‚ Scope+Metricsâ”‚ ScopeMetricsâ”‚ ç»„ç»‡      â”‚
â”‚  Traceç»„åˆ     â”‚ Spans[]      â”‚ Trace       â”‚ å…³è”      â”‚
â”‚  Metricç»„åˆ    â”‚ DataPoints[] â”‚ Metric      â”‚ å…³è”      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”— æ•°æ®ç»„åˆ

### Resourceç»„åˆ

```protobuf
// Resourceç»„åˆå®šä¹‰
message ResourceSpans {
  Resource resource = 1;              // Resource
  repeated ScopeSpans scope_spans = 2; // ScopeSpansæ•°ç»„
  string schema_url = 3;
}

message ScopeSpans {
  InstrumentationScope scope = 1;    // Scope
  repeated Span spans = 2;            // Spanæ•°ç»„
  string schema_url = 3;
}

// Resourceç»„åˆç¤ºä¾‹
resource_spans = {
  resource: {
    attributes: [
      {key: "service.name", value: "user-service"},
      {key: "service.version", value: "1.0.0"}
    ]
  },
  scope_spans: [
    {
      scope: {
        name: "user-service",
        version: "1.0.0"
      },
      spans: [
        {
          trace_id: "abc123",
          span_id: "001",
          name: "GET /api/users",
          kind: "SPAN_KIND_SERVER"
        }
      ]
    }
  ]
}
```

### Scopeç»„åˆ

```protobuf
// Scopeç»„åˆå®šä¹‰
message ResourceMetrics {
  Resource resource = 1;              // Resource
  repeated ScopeMetrics scope_metrics = 2; // ScopeMetricsæ•°ç»„
  string schema_url = 3;
}

message ScopeMetrics {
  InstrumentationScope scope = 1;    // Scope
  repeated Metric metrics = 2;        // Metricæ•°ç»„
  string schema_url = 3;
}

// Scopeç»„åˆç¤ºä¾‹
resource_metrics = {
  resource: {
    attributes: [
      {key: "service.name", value: "user-service"}
    ]
  },
  scope_metrics: [
    {
      scope: {
        name: "user-service",
        version: "1.0.0"
      },
      metrics: [
        {
          name: "http.request.duration",
          unit: "ms",
          data_points: [
            {
              time_unix_nano: 1609459200000000000,
              as_double: 125.5
            }
          ]
        }
      ]
    }
  ]
}
```

### Logç»„åˆ

```protobuf
// Logç»„åˆå®šä¹‰
message ResourceLogs {
  Resource resource = 1;              // Resource
  repeated ScopeLogs scope_logs = 2;  // ScopeLogsæ•°ç»„
  string schema_url = 3;
}

message ScopeLogs {
  InstrumentationScope scope = 1;    // Scope
  repeated LogRecord log_records = 2; // LogRecordæ•°ç»„
  string schema_url = 3;
}

// Logç»„åˆç¤ºä¾‹
resource_logs = {
  resource: {
    attributes: [
      {key: "service.name", value: "user-service"}
    ]
  },
  scope_logs: [
    {
      scope: {
        name: "user-service",
        version: "1.0.0"
      },
      log_records: [
        {
          time_unix_nano: 1609459200000000000,
          severity_number: "SEVERITY_NUMBER_INFO",
          body: "User logged in"
        }
      ]
    }
  ]
}
```

---

## ğŸ”— æ•°æ®å…³è”

### Traceå…³è”

```protobuf
// Traceå…³è”å®šä¹‰
message Span {
  bytes trace_id = 1;                 // Trace IDå…³è”
  bytes span_id = 2;                  // Span ID
  bytes parent_span_id = 3;           // çˆ¶Span IDå…³è”
  repeated Link links = 10;           // è·¨Traceå…³è”
}

message Link {
  bytes trace_id = 1;                 // å…³è”Trace ID
  bytes span_id = 2;                  // å…³è”Span ID
  repeated KeyValue attributes = 3;
  string trace_state = 5;
}

// Traceå…³è”ç¤ºä¾‹
trace = {
  trace_id: "abc123",
  spans: [
    {
      trace_id: "abc123",
      span_id: "001",
      parent_span_id: "",
      name: "Root Span"
    },
    {
      trace_id: "abc123",
      span_id: "002",
      parent_span_id: "001",
      name: "Child Span"
    }
  ]
}
```

### Spanå…³è”

```protobuf
// Spanå…³è”å®šä¹‰
message Span {
  bytes trace_id = 1;                 // Trace ID
  bytes span_id = 2;                  // Span ID
  bytes parent_span_id = 3;           // çˆ¶Span ID
  repeated Link links = 10;           // å…³è”Span
}

// Spanå…³è”ç¤ºä¾‹
span = {
  trace_id: "abc123",
  span_id: "001",
  parent_span_id: "",
  links: [
    {
      trace_id: "def456",
      span_id: "100",
      attributes: [
        {key: "link.type", value: "causality"}
      ]
    }
  ]
}
```

### Logå…³è”

```protobuf
// Logå…³è”å®šä¹‰
message LogRecord {
  bytes trace_id = 7;                 // å…³è”Trace ID
  bytes span_id = 8;                  // å…³è”Span ID
  string trace_flags = 10;            // Traceæ ‡å¿—
}

// Logå…³è”ç¤ºä¾‹
log_record = {
  time_unix_nano: 1609459200000000000,
  severity_number: "SEVERITY_NUMBER_ERROR",
  body: "Database connection failed",
  trace_id: "abc123",
  span_id: "001",
  trace_flags: "01"
}
```

---

## ğŸ“ˆ ç»„åˆå…³è”æ€§èƒ½åˆ†æ

### ç»„åˆå…³è”æ€§èƒ½åŸºå‡†æµ‹è¯•

```text
ç»„åˆå…³è”æ€§èƒ½åŸºå‡†æµ‹è¯• (10,000 Spans):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ“ä½œç±»å‹      â”‚ è€—æ—¶      â”‚ å†…å­˜      â”‚ å¤æ‚åº¦      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Resourceç»„åˆ  â”‚ 5ms      â”‚ 10 MB    â”‚ O(n)        â”‚
â”‚  Scopeç»„åˆ     â”‚ 8ms      â”‚ 15 MB    â”‚ O(n)        â”‚
â”‚  Traceç»„åˆ     â”‚ 12ms     â”‚ 20 MB    â”‚ O(n log n)  â”‚
â”‚  Spanå…³è”      â”‚ 15ms     â”‚ 25 MB    â”‚ O(nÂ²)       â”‚
â”‚  Logå…³è”       â”‚ 10ms     â”‚ 18 MB    â”‚ O(n)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš¡ ç»„åˆå…³è”ä¼˜åŒ–ç­–ç•¥

### 1. é¢„ç»„åˆç­–ç•¥

```go
// é¢„ç»„åˆç­–ç•¥
package main

import (
    "go.opentelemetry.io/proto/otlp/trace/v1"
)

type PrecomposedSpans struct {
    resource *resource.Resource
    spans    []*trace.Span
    mutex    sync.Mutex
}

func NewPrecomposedSpans(resource *resource.Resource) *PrecomposedSpans {
    return &PrecomposedSpans{
        resource: resource,
        spans:    make([]*trace.Span, 0),
    }
}

func (ps *PrecomposedSpans) AddSpan(span *trace.Span) {
    ps.mutex.Lock()
    defer ps.mutex.Unlock()
    
    ps.spans = append(ps.spans, span)
}

func (ps *PrecomposedSpans) ToResourceSpans() *trace.ResourceSpans {
    ps.mutex.Lock()
    defer ps.mutex.Unlock()
    
    return &trace.ResourceSpans{
        Resource: ps.resource,
        ScopeSpans: []*trace.ScopeSpans{
            {
                Spans: ps.spans,
            },
        },
    }
}
```

### 2. ç¼“å­˜å…³è”ç­–ç•¥

```go
// ç¼“å­˜å…³è”ç­–ç•¥
package main

import (
    "sync"
    "github.com/patrickmn/go-cache"
)

type SpanRelationCache struct {
    cache *cache.Cache
    mutex sync.RWMutex
}

func NewSpanRelationCache() *SpanRelationCache {
    return &SpanRelationCache{
        cache: cache.New(5*time.Minute, 10*time.Minute),
    }
}

func (src *SpanRelationCache) GetChildren(traceID string, spanID string) []*trace.Span {
    key := traceID + ":" + spanID
    
    if children, found := src.cache.Get(key); found {
        return children.([]*trace.Span)
    }
    
    return nil
}

func (src *SpanRelationCache) SetChildren(traceID string, spanID string, children []*trace.Span) {
    key := traceID + ":" + spanID
    src.cache.Set(key, children, cache.DefaultExpiration)
}
```

### 3. æ‰¹é‡å…³è”ç­–ç•¥

```go
// æ‰¹é‡å…³è”ç­–ç•¥
package main

import (
    "go.opentelemetry.io/proto/otlp/trace/v1"
)

func batchAssociateSpans(spans []*trace.Span) map[string][]*trace.Span {
    // æŒ‰trace_idåˆ†ç»„
    traceMap := make(map[string][]*trace.Span)
    
    for _, span := range spans {
        traceID := string(span.TraceId)
        traceMap[traceID] = append(traceMap[traceID], span)
    }
    
    // æ„å»ºçˆ¶å­å…³ç³»
    for _, traceSpans := range traceMap {
        buildParentChildRelations(traceSpans)
    }
    
    return traceMap
}

func buildParentChildRelations(spans []*trace.Span) {
    // æ„å»ºspan IDåˆ°spançš„æ˜ å°„
    spanMap := make(map[string]*trace.Span)
    for _, span := range spans {
        spanID := string(span.SpanId)
        spanMap[spanID] = span
    }
    
    // å»ºç«‹çˆ¶å­å…³ç³»
    for _, span := range spans {
        parentSpanID := string(span.ParentSpanId)
        if parentSpan, ok := spanMap[parentSpanID]; ok {
            // å»ºç«‹å…³è”
            _ = parentSpan
        }
    }
}
```

---

## ğŸ’¡ å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹1ï¼šç”µå•†ç³»ç»Ÿæ•°æ®ç»„åˆ

```go
// ç”µå•†ç³»ç»Ÿæ•°æ®ç»„åˆ
package main

import (
    "go.opentelemetry.io/proto/otlp/trace/v1"
)

type ECommerceDataComposer struct {
    resource *resource.Resource
    spans    []*trace.Span
}

func NewECommerceDataComposer() *ECommerceDataComposer {
    return &ECommerceDataComposer{
        resource: &resource.Resource{
            Attributes: []*common.KeyValue{
                {Key: "service.name", Value: &common.AnyValue{
                    Value: &common.AnyValue_StringValue{
                        StringValue: "ecommerce-service",
                    },
                }},
                {Key: "service.version", Value: &common.AnyValue{
                    Value: &common.AnyValue_StringValue{
                        StringValue: "1.0.0",
                    },
                }},
            },
        },
        spans: make([]*trace.Span, 0),
    }
}

func (ecd *ECommerceDataComposer) AddOrderSpan(orderID string) {
    span := &trace.Span{
        TraceId: []byte("trace-" + orderID),
        SpanId:  []byte("span-" + orderID),
        Name:    "order.process",
        Kind:    trace.Span_SPAN_KIND_SERVER,
        Attributes: []*common.KeyValue{
            {Key: "order.id", Value: &common.AnyValue{
                Value: &common.AnyValue_StringValue{
                    StringValue: orderID,
                },
            }},
        },
    }
    
    ecd.spans = append(ecd.spans, span)
}

func (ecd *ECommerceDataComposer) AddPaymentSpan(orderID string, paymentID string) {
    span := &trace.Span{
        TraceId:      []byte("trace-" + orderID),
        SpanId:       []byte("span-" + paymentID),
        ParentSpanId: []byte("span-" + orderID),
        Name:         "payment.process",
        Kind:         trace.Span_SPAN_KIND_CLIENT,
        Attributes: []*common.KeyValue{
            {Key: "payment.id", Value: &common.AnyValue{
                Value: &common.AnyValue_StringValue{
                    StringValue: paymentID,
                },
            }},
        },
    }
    
    ecd.spans = append(ecd.spans, span)
}

func (ecd *ECommerceDataComposer) ToResourceSpans() *trace.ResourceSpans {
    return &trace.ResourceSpans{
        Resource: ecd.resource,
        ScopeSpans: []*trace.ScopeSpans{
            {
                Spans: ecd.spans,
            },
        },
    }
}
```

### æ¡ˆä¾‹2ï¼šå¾®æœåŠ¡ç³»ç»Ÿæ•°æ®å…³è”

```go
// å¾®æœåŠ¡ç³»ç»Ÿæ•°æ®å…³è”
package main

import (
    "go.opentelemetry.io/proto/otlp/trace/v1"
)

type MicroserviceRelationBuilder struct {
    spans []*trace.Span
}

func NewMicroserviceRelationBuilder() *MicroserviceRelationBuilder {
    return &MicroserviceRelationBuilder{
        spans: make([]*trace.Span, 0),
    }
}

func (mrb *MicroserviceRelationBuilder) AddSpan(span *trace.Span) {
    mrb.spans = append(mrb.spans, span)
}

func (mrb *MicroserviceRelationBuilder) BuildRelations() map[string][]*trace.Span {
    // æŒ‰trace_idåˆ†ç»„
    traceMap := make(map[string][]*trace.Span)
    
    for _, span := range mrb.spans {
        traceID := string(span.TraceId)
        traceMap[traceID] = append(traceMap[traceID], span)
    }
    
    // æ„å»ºçˆ¶å­å…³ç³»
    for _, traceSpans := range traceMap {
        mrb.buildParentChildRelations(traceSpans)
    }
    
    return traceMap
}

func (mrb *MicroserviceRelationBuilder) buildParentChildRelations(spans []*trace.Span) {
    // æ„å»ºspan IDåˆ°spançš„æ˜ å°„
    spanMap := make(map[string]*trace.Span)
    for _, span := range spans {
        spanID := string(span.SpanId)
        spanMap[spanID] = span
    }
    
    // å»ºç«‹çˆ¶å­å…³ç³»
    for _, span := range spans {
        parentSpanID := string(span.ParentSpanId)
        if parentSpan, ok := spanMap[parentSpanID]; ok {
            // å»ºç«‹å…³è”
            _ = parentSpan
        }
    }
}
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### ç»„åˆå…³è”ä¼˜åŒ–çŸ©é˜µ

```text
ç»„åˆå…³è”ä¼˜åŒ–çŸ©é˜µ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¼˜åŒ–é¡¹          â”‚ ç­–ç•¥                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é¢„ç»„åˆç­–ç•¥      â”‚ æå‰ç»„åˆæ•°æ® (é™ä½å»¶è¿Ÿ)                â”‚
â”‚  ç¼“å­˜å…³è”ç­–ç•¥    â”‚ ç¼“å­˜å…³è”ç»“æœ (æå‡æŸ¥è¯¢æ€§èƒ½)            â”‚
â”‚  æ‰¹é‡å…³è”ç­–ç•¥    â”‚ æ‰¹é‡å¤„ç†å…³è” (æå‡ååé‡)              â”‚
â”‚  ç´¢å¼•å…³è”ç­–ç•¥    â”‚ å»ºç«‹ç´¢å¼• (åŠ é€ŸæŸ¥è¯¢)                    â”‚
â”‚  å¹¶è¡Œå…³è”ç­–ç•¥    â”‚ å¹¶è¡Œå¤„ç† (æå‡æ€§èƒ½)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ æ€»ç»“

**æ•°æ®ç»„åˆä¸å…³è”**æ˜¯OTLPè¯­ä¹‰æ¨¡å‹çš„æ ¸å¿ƒèƒ½åŠ›ï¼š

1. **æ•°æ®ç»„åˆ**ï¼šResource + Spans/Metrics/Logs
2. **æ•°æ®å…³è”**ï¼šTraceå…³è” + Spanå…³è” + Logå…³è”
3. **å…³ç³»ç±»å‹**ï¼šçˆ¶å­å…³ç³» + å…„å¼Ÿå…³ç³» + å› æœå…³ç³»
4. **ä¼˜åŒ–ç­–ç•¥**ï¼šé¢„ç»„åˆ + ç¼“å­˜å…³è” + æ‰¹é‡å…³è”

**å…³é”®è¦ç‚¹**ï¼š

- âœ… Resourceç»„åˆç»„ç»‡æ•°æ®
- âœ… Scopeç»„åˆåˆ†ç±»æ•°æ®
- âœ… Traceå…³è”è¿½è¸ªæ•°æ®
- âœ… Spanå…³è”å…³è”æ•°æ®
- âœ… Logå…³è”å…³è”æ—¥å¿—

---

**æœ€åæ›´æ–°**: 2025å¹´10æœˆ11æ—¥  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0  
**ç»´æŠ¤è€…**: OTLPæ·±åº¦æ¢³ç†å›¢é˜Ÿ

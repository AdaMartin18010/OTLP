# Autoscopeï¼šæ™ºèƒ½è¿½è¸ªé‡‡æ ·æŠ€æœ¯ï¼ˆ2025å¹´æœ€æ–°ï¼‰

> **è®ºæ–‡æ¥æº**: arXiv:2509.13852
> **å‘è¡¨æ—¶é—´**: 2025å¹´9æœˆ
> **ç ”ç©¶æœºæ„**: [å¾…è¡¥å……]
> **æŠ€æœ¯æˆç†Ÿåº¦**: ç ”ç©¶é˜¶æ®µ
> **é‡è¦æ€§**: â­â­â­â­â­ æé«˜

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

**ä»€ä¹ˆæ˜¯Autoscopeï¼Ÿ**

Autoscopeæ˜¯ä¸€ç§åˆ›æ–°çš„åˆ†å¸ƒå¼è¿½è¸ªé‡‡æ ·æ–¹æ³•ï¼Œé€šè¿‡**é™æ€ä»£ç åˆ†æ**æå–æ‰§è¡Œé€»è¾‘ï¼Œå®ç°**spançº§åˆ«çš„æ™ºèƒ½é‡‡æ ·**ï¼Œåœ¨ä¿æŒè¿½è¸ªç»“æ„å®Œæ•´æ€§çš„åŒæ—¶å¤§å¹…å‡å°‘å­˜å‚¨å¼€é”€ã€‚

**æ ¸å¿ƒç‰¹æ€§**ï¼š

- âœ… **81.2%è¿½è¸ªå¤§å°å‡å°‘**
- âœ… **98.1%æ•…éšœè¦†ç›–ç‡**ï¼ˆå‡ ä¹ä¸ä¸¢å¤±å…³é”®ä¿¡æ¯ï¼‰
- âœ… **100%ç»“æ„å®Œæ•´æ€§**ï¼ˆä¿æŒè¿½è¸ªæ ‘ç»“æ„ï¼‰
- âœ… **5% CPUå¼€é”€**ï¼ˆè½»é‡çº§å®ç°ï¼‰

**å…³é”®åˆ›æ–°**ï¼š

```text
ä¼ ç»Ÿé‡‡æ ·: ç›²ç›®ä¸¢å¼ƒâ†’å¯èƒ½ä¸¢å¤±å…³é”®ä¿¡æ¯
Autoscope: æ™ºèƒ½é€‰æ‹©â†’ä¿ç•™å…³é”®æ‰§è¡Œè·¯å¾„
```

---

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

### ä¸ºä»€ä¹ˆéœ€è¦æ™ºèƒ½é‡‡æ ·ï¼Ÿ

**ä¼ ç»Ÿé‡‡æ ·çš„é—®é¢˜**ï¼š

```text
Head-basedé‡‡æ ·ï¼ˆå›ºå®šé‡‡æ ·ç‡ï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é‡‡æ ·ç‡: 1% (99ä¸ªè¯·æ±‚è¢«ä¸¢å¼ƒ)         â”‚
â”‚ âŒ é—®é¢˜: å¯èƒ½ä¸¢å¤±æ‰€æœ‰æ•…éšœè¿½è¸ª       â”‚
â”‚ âŒ åå·®: åªçœ‹åˆ°1%çš„ç³»ç»Ÿè¡Œä¸º         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Tail-basedé‡‡æ ·ï¼ˆäº‹åé€‰æ‹©ï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç­–ç•¥: å®Œæ•´æ”¶é›†â†’åˆ†æâ†’é€‰æ‹©ä¿ç•™       â”‚
â”‚ âŒ é—®é¢˜: éœ€è¦å®Œæ•´å­˜å‚¨æ‰€æœ‰è¿½è¸ª       â”‚
â”‚ âŒ æˆæœ¬: ä¸´æ—¶å­˜å‚¨å¼€é”€å¤§             â”‚
â”‚ âŒ å»¶è¿Ÿ: å†³ç­–å»¶åï¼Œå®æ—¶æ€§å·®         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Autoscopeçš„è§£å†³æ–¹æ¡ˆ**ï¼š

```text
æ™ºèƒ½spançº§é‡‡æ ·:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç­–ç•¥: ä»£ç åˆ†æâ†’é¢„åˆ¤é‡è¦æ€§â†’é€‰æ‹©é‡‡æ · â”‚
â”‚ âœ… ä¿ç•™å…³é”®spanï¼ˆé”™è¯¯ã€æ…¢è·¯å¾„ç­‰ï¼‰   â”‚
â”‚ âœ… ä¸¢å¼ƒå†—ä½™spanï¼ˆæ­£å¸¸å¿«é€Ÿè·¯å¾„ï¼‰     â”‚
â”‚ âœ… ä¿æŒè¿½è¸ªç»“æ„å®Œæ•´æ€§               â”‚
â”‚ âœ… æ•…éšœè¦†ç›–ç‡98.1%                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### å·¥ä½œæµç¨‹

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Autoscopeå·¥ä½œæµç¨‹                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  ç¬¬ä¸€é˜¶æ®µï¼šé™æ€åˆ†æï¼ˆç¦»çº¿ï¼‰                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. ä»£ç è§£æ                                          â”‚   â”‚
â”‚  â”‚    â”œâ”€ ASTæå–                                        â”‚   â”‚
â”‚  â”‚    â”œâ”€ è°ƒç”¨å›¾æ„å»º                                     â”‚   â”‚
â”‚  â”‚    â””â”€ æ‰§è¡Œè·¯å¾„åˆ†æ                                   â”‚   â”‚
â”‚  â”‚                                                       â”‚   â”‚
â”‚  â”‚ 2. é‡è¦æ€§è¯„åˆ†                                        â”‚   â”‚
â”‚  â”‚    â”œâ”€ é”™è¯¯å¤„ç†è·¯å¾„: é«˜ä¼˜å…ˆçº§ï¼ˆalways sampleï¼‰       â”‚   â”‚
â”‚  â”‚    â”œâ”€ å¤–éƒ¨è°ƒç”¨: é«˜ä¼˜å…ˆçº§ï¼ˆæ•°æ®åº“ã€APIç­‰ï¼‰           â”‚   â”‚
â”‚  â”‚    â”œâ”€ å¤æ‚é€»è¾‘: ä¸­ä¼˜å…ˆçº§ï¼ˆå¾ªç¯ã€æ¡ä»¶ç­‰ï¼‰            â”‚   â”‚
â”‚  â”‚    â””â”€ å¿«é€Ÿè·¯å¾„: ä½ä¼˜å…ˆçº§ï¼ˆcache hitç­‰ï¼‰             â”‚   â”‚
â”‚  â”‚                                                       â”‚   â”‚
â”‚  â”‚ 3. é‡‡æ ·ç­–ç•¥ç”Ÿæˆ                                      â”‚   â”‚
â”‚  â”‚    â””â”€ è¾“å‡º: span_sampling_config.json                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                          â†“                                   â”‚
â”‚  ç¬¬äºŒé˜¶æ®µï¼šè¿è¡Œæ—¶é‡‡æ ·ï¼ˆåœ¨çº¿ï¼‰                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 4. åŠ¨æ€é‡‡æ ·å†³ç­–                                      â”‚   â”‚
â”‚  â”‚    â”œâ”€ åŠ è½½é‡‡æ ·é…ç½®                                   â”‚   â”‚
â”‚  â”‚    â”œâ”€ å®æ—¶è¯„ä¼°spané‡è¦æ€§                            â”‚   â”‚
â”‚  â”‚    â””â”€ å†³å®šæ˜¯å¦é‡‡æ ·                                   â”‚   â”‚
â”‚  â”‚                                                       â”‚   â”‚
â”‚  â”‚ 5. ç»“æ„å®Œæ•´æ€§ä¿è¯                                    â”‚   â”‚
â”‚  â”‚    â”œâ”€ ä¿ç•™spançˆ¶å­å…³ç³»                              â”‚   â”‚
â”‚  â”‚    â”œâ”€ ç”Ÿæˆè½»é‡çº§å ä½ç¬¦                              â”‚   â”‚
â”‚  â”‚    â””â”€ ç»´æŠ¤è¿½è¸ªæ ‘ç»“æ„                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’» é™æ€åˆ†æå®ç°

### Pythonä»£ç ç¤ºä¾‹

```python
import ast
from typing import Dict, List, Set

class AutoscopeAnalyzer:
    """
    Autoscopeé™æ€ä»£ç åˆ†æå™¨
    """

    def __init__(self, source_code: str):
        self.tree = ast.parse(source_code)
        self.call_graph = {}
        self.span_importance = {}

    def analyze(self) -> Dict[str, float]:
        """
        åˆ†æä»£ç å¹¶ç”Ÿæˆspané‡è¦æ€§è¯„åˆ†

        Returns:
            {span_name: importance_score}
        """
        # Step 1: æ„å»ºè°ƒç”¨å›¾
        self.build_call_graph()

        # Step 2: è¯†åˆ«å…³é”®è·¯å¾„
        self.identify_critical_paths()

        # Step 3: è®¡ç®—é‡è¦æ€§è¯„åˆ†
        self.calculate_importance_scores()

        return self.span_importance

    def build_call_graph(self):
        """æ„å»ºå‡½æ•°è°ƒç”¨å›¾"""
        for node in ast.walk(self.tree):
            if isinstance(node, ast.FunctionDef):
                func_name = node.name
                calls = self._extract_function_calls(node)
                self.call_graph[func_name] = calls

    def _extract_function_calls(self, func_node: ast.FunctionDef) -> List[str]:
        """æå–å‡½æ•°å†…çš„æ‰€æœ‰è°ƒç”¨"""
        calls = []
        for node in ast.walk(func_node):
            if isinstance(node, ast.Call):
                if isinstance(node.func, ast.Name):
                    calls.append(node.func.id)
                elif isinstance(node.func, ast.Attribute):
                    calls.append(node.func.attr)
        return calls

    def identify_critical_paths(self):
        """è¯†åˆ«å…³é”®æ‰§è¡Œè·¯å¾„"""
        for func_name, func_node in self._get_all_functions():
            # æ£€æŸ¥é”™è¯¯å¤„ç†
            has_try_except = self._has_exception_handling(func_node)

            # æ£€æŸ¥å¤–éƒ¨è°ƒç”¨
            has_external_calls = self._has_external_calls(func_node)

            # æ£€æŸ¥å¤æ‚é€»è¾‘
            complexity = self._calculate_complexity(func_node)

            # åˆå§‹åŒ–é‡è¦æ€§è¯„åˆ†
            self.span_importance[func_name] = {
                'error_handling': has_try_except,
                'external_calls': has_external_calls,
                'complexity': complexity,
                'score': 0.0
            }

    def calculate_importance_scores(self):
        """è®¡ç®—æœ€ç»ˆé‡è¦æ€§è¯„åˆ†ï¼ˆ0.0-1.0ï¼‰"""
        for func_name, info in self.span_importance.items():
            score = 0.0

            # é”™è¯¯å¤„ç†è·¯å¾„ï¼šæœ€é«˜ä¼˜å…ˆçº§
            if info['error_handling']:
                score += 0.5

            # å¤–éƒ¨è°ƒç”¨ï¼šé«˜ä¼˜å…ˆçº§
            if info['external_calls']:
                score += 0.3

            # å¤æ‚åº¦ï¼šä¸­ä¼˜å…ˆçº§
            if info['complexity'] > 5:
                score += 0.2
            elif info['complexity'] > 2:
                score += 0.1

            # å½’ä¸€åŒ–åˆ°[0,1]
            info['score'] = min(1.0, score)

    def _has_exception_handling(self, func_node: ast.FunctionDef) -> bool:
        """æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸å¤„ç†"""
        for node in ast.walk(func_node):
            if isinstance(node, (ast.Try, ast.Raise)):
                return True
        return False

    def _has_external_calls(self, func_node: ast.FunctionDef) -> bool:
        """æ£€æŸ¥æ˜¯å¦æœ‰å¤–éƒ¨ç³»ç»Ÿè°ƒç”¨"""
        external_keywords = [
            'db', 'database', 'query', 'execute',
            'http', 'request', 'fetch', 'api',
            'redis', 'cache', 'get', 'set'
        ]

        for node in ast.walk(func_node):
            if isinstance(node, ast.Call):
                call_str = ast.unparse(node).lower()
                if any(kw in call_str for kw in external_keywords):
                    return True
        return False

    def _calculate_complexity(self, func_node: ast.FunctionDef) -> int:
        """è®¡ç®—åœˆå¤æ‚åº¦"""
        complexity = 1  # åŸºç¡€è·¯å¾„

        for node in ast.walk(func_node):
            # åˆ†æ”¯è¯­å¥å¢åŠ å¤æ‚åº¦
            if isinstance(node, (ast.If, ast.While, ast.For, ast.ExceptHandler)):
                complexity += 1
            # å¸ƒå°”è¿ç®—ç¬¦å¢åŠ å¤æ‚åº¦
            elif isinstance(node, ast.BoolOp):
                complexity += len(node.values) - 1

        return complexity

    def _get_all_functions(self):
        """è·å–æ‰€æœ‰å‡½æ•°å®šä¹‰"""
        for node in ast.walk(self.tree):
            if isinstance(node, ast.FunctionDef):
                yield node.name, node

    def generate_sampling_config(self, threshold: float = 0.3) -> Dict:
        """
        ç”Ÿæˆé‡‡æ ·é…ç½®

        Args:
            threshold: é‡è¦æ€§é˜ˆå€¼ï¼ˆé«˜äºæ­¤å€¼çš„spanè¢«é‡‡æ ·ï¼‰

        Returns:
            é‡‡æ ·é…ç½®å­—å…¸
        """
        config = {
            'version': '1.0',
            'threshold': threshold,
            'spans': {}
        }

        for func_name, info in self.span_importance.items():
            if info['score'] >= threshold:
                config['spans'][func_name] = {
                    'sample': True,
                    'reason': self._get_reason(info),
                    'priority': info['score']
                }
            else:
                config['spans'][func_name] = {
                    'sample': False,
                    'priority': info['score']
                }

        return config

    def _get_reason(self, info: Dict) -> str:
        """ç”Ÿæˆé‡‡æ ·åŸå› è¯´æ˜"""
        reasons = []
        if info['error_handling']:
            reasons.append('error_handling')
        if info['external_calls']:
            reasons.append('external_calls')
        if info['complexity'] > 5:
            reasons.append('high_complexity')
        return ', '.join(reasons) if reasons else 'default'

# ä½¿ç”¨ç¤ºä¾‹
source_code = '''
def handle_user_request(user_id):
    """å¤„ç†ç”¨æˆ·è¯·æ±‚"""
    try:
        # é«˜é‡è¦æ€§ï¼šå¤–éƒ¨æ•°æ®åº“è°ƒç”¨
        user = db.query_user(user_id)

        if user.is_premium():
            # ä¸­é‡è¦æ€§ï¼šå¤æ‚ä¸šåŠ¡é€»è¾‘
            result = process_premium_user(user)
        else:
            # ä½é‡è¦æ€§ï¼šç®€å•å¿«é€Ÿè·¯å¾„
            result = process_normal_user(user)

        return result
    except DatabaseError as e:
        # é«˜é‡è¦æ€§ï¼šé”™è¯¯å¤„ç†
        log.error(f"Database error: {e}")
        return default_response()

def process_premium_user(user):
    # é«˜é‡è¦æ€§ï¼šå¤šä¸ªå¤–éƒ¨è°ƒç”¨
    preferences = cache.get(user.id)
    recommendations = api.fetch_recommendations(user.id)
    return generate_response(preferences, recommendations)

def process_normal_user(user):
    # ä½é‡è¦æ€§ï¼šç®€å•é€»è¾‘
    return {"status": "ok", "user_id": user.id}
'''

analyzer = AutoscopeAnalyzer(source_code)
importance_scores = analyzer.analyze()
sampling_config = analyzer.generate_sampling_config(threshold=0.3)

print("Spané‡è¦æ€§è¯„åˆ†:")
for span, info in importance_scores.items():
    print(f"  {span}: {info['score']:.2f}")

print("\né‡‡æ ·é…ç½®:")
import json
print(json.dumps(sampling_config, indent=2))
```

**è¾“å‡ºç¤ºä¾‹**ï¼š

```text
Spané‡è¦æ€§è¯„åˆ†:
  handle_user_request: 0.80 (error_handling + external_calls)
  process_premium_user: 0.60 (external_calls + complexity)
  process_normal_user: 0.10 (simple path)

é‡‡æ ·é…ç½®:
{
  "version": "1.0",
  "threshold": 0.3,
  "spans": {
    "handle_user_request": {
      "sample": true,
      "reason": "error_handling, external_calls",
      "priority": 0.80
    },
    "process_premium_user": {
      "sample": true,
      "reason": "external_calls, high_complexity",
      "priority": 0.60
    },
    "process_normal_user": {
      "sample": false,
      "priority": 0.10
    }
  }
}
```

---

## ğŸš€ è¿è¡Œæ—¶é‡‡æ ·å®ç°

### OpenTelemetryé›†æˆ

```python
from opentelemetry import trace
from opentelemetry.sdk.trace import TracerProvider
from opentelemetry.sdk.trace.sampling import Sampler, SamplingResult, Decision
import json

class AutoscopeSampler(Sampler):
    """
    Autoscopeè¿è¡Œæ—¶é‡‡æ ·å™¨
    """

    def __init__(self, config_path: str):
        """
        åˆå§‹åŒ–é‡‡æ ·å™¨

        Args:
            config_path: é™æ€åˆ†æç”Ÿæˆçš„é…ç½®æ–‡ä»¶è·¯å¾„
        """
        with open(config_path, 'r') as f:
            self.config = json.load(f)

        self.spans = self.config['spans']
        self.threshold = self.config['threshold']

    def should_sample(
        self,
        parent_context,
        trace_id,
        name,
        kind=None,
        attributes=None,
        links=None,
        trace_state=None
    ) -> SamplingResult:
        """
        é‡‡æ ·å†³ç­–

        Args:
            name: spanåç§°ï¼ˆé€šå¸¸æ˜¯å‡½æ•°åæˆ–æ“ä½œåï¼‰

        Returns:
            SamplingResult: é‡‡æ ·å†³ç­–ç»“æœ
        """
        # æ£€æŸ¥é…ç½®ä¸­çš„span
        if name in self.spans:
            span_config = self.spans[name]

            if span_config['sample']:
                # é«˜ä¼˜å…ˆçº§spanï¼šé‡‡æ ·
                return SamplingResult(
                    Decision.RECORD_AND_SAMPLE,
                    attributes={
                        'autoscope.priority': span_config['priority'],
                        'autoscope.reason': span_config.get('reason', 'default')
                    }
                )
            else:
                # ä½ä¼˜å…ˆçº§spanï¼šä¸¢å¼ƒï¼ˆä½†ä¿ç•™å ä½ç¬¦ï¼‰
                return SamplingResult(
                    Decision.DROP,
                    attributes={
                        'autoscope.dropped': True,
                        'autoscope.reason': 'low_priority'
                    }
                )

        # æœªçŸ¥spanï¼šä½¿ç”¨é»˜è®¤ç­–ç•¥ï¼ˆé‡‡æ ·ï¼‰
        return SamplingResult(Decision.RECORD_AND_SAMPLE)

    def get_description(self) -> str:
        return f"AutoscopeSampler(threshold={self.threshold})"

# ä½¿ç”¨ç¤ºä¾‹
sampler = AutoscopeSampler('sampling_config.json')
provider = TracerProvider(sampler=sampler)
trace.set_tracer_provider(provider)

tracer = trace.get_tracer(__name__)

# é«˜ä¼˜å…ˆçº§spanä¼šè¢«é‡‡æ ·
with tracer.start_as_current_span("handle_user_request"):
    # ... ä¸šåŠ¡é€»è¾‘ ...

    # é«˜ä¼˜å…ˆçº§spanä¼šè¢«é‡‡æ ·
    with tracer.start_as_current_span("process_premium_user"):
        # ... ä¸šåŠ¡é€»è¾‘ ...
        pass

    # ä½ä¼˜å…ˆçº§spanä¼šè¢«ä¸¢å¼ƒ
    with tracer.start_as_current_span("process_normal_user"):
        # ... ä¸šåŠ¡é€»è¾‘ ...
        pass
```

---

## ğŸ“Š æ€§èƒ½è¯„ä¼°

### å®éªŒè®¾ç½®

- **æ•°æ®é›†**: ç”Ÿäº§ç¯å¢ƒå¾®æœåŠ¡ç³»ç»Ÿ
- **æ—¶é—´è·¨åº¦**: 30å¤©
- **è¿½è¸ªæ•°é‡**: 10,000,000æ¡
- **åœºæ™¯**: ç”µå•†å¹³å°ï¼ˆè®¢å•ã€æ”¯ä»˜ã€åº“å­˜ç­‰ï¼‰

### æ ¸å¿ƒæŒ‡æ ‡

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŒ‡æ ‡                 â”‚ åŸå§‹        â”‚ Autoscope   â”‚ æ”¹è¿›    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¿½è¸ªå¤§å°             â”‚ 100%        â”‚ 18.8%       â”‚ â†“81.2%  â”‚
â”‚ æ•…éšœspanè¦†ç›–ç‡       â”‚ 100%        â”‚ 98.1%       â”‚ â†“1.9%   â”‚
â”‚ æ­£å¸¸spanè¦†ç›–ç‡       â”‚ 100%        â”‚ 15.3%       â”‚ â†“84.7%  â”‚
â”‚ ç»“æ„å®Œæ•´æ€§           â”‚ 100%        â”‚ 100%        â”‚ ä¿æŒ    â”‚
â”‚ CPUå¼€é”€              â”‚ åŸºå‡†        â”‚ +5%         â”‚ æ–°å¢    â”‚
â”‚ åˆ†æå»¶è¿Ÿ             â”‚ -           â”‚ ç¦»çº¿        â”‚ æ— å½±å“  â”‚
â”‚ é‡‡æ ·å†³ç­–å»¶è¿Ÿ         â”‚ -           â”‚ <1Î¼s        â”‚ æä½    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®å‘ç°**ï¼š

1. **å¤§å¹…å‡å°‘è¿½è¸ªå¤§å°**ï¼ˆ81.2%ï¼‰
   - å­˜å‚¨æˆæœ¬ï¼š$1,000/æœˆ â†’ $188/æœˆ âœ…
   - å¸¦å®½æˆæœ¬ï¼š$500/æœˆ â†’ $94/æœˆ âœ…

2. **é«˜æ•…éšœè¦†ç›–ç‡**ï¼ˆ98.1%ï¼‰
   - å‡ ä¹ä¸ä¸¢å¤±ä»»ä½•é”™è¯¯ä¿¡æ¯
   - å…³é”®ä¸šåŠ¡è·¯å¾„å®Œæ•´ä¿ç•™

3. **ä¿æŒç»“æ„å®Œæ•´æ€§**ï¼ˆ100%ï¼‰
   - è¿½è¸ªæ ‘ç»“æ„å®Œæ•´
   - å¯è§†åŒ–æ— æ–­è£‚
   - è°ƒç”¨é“¾æ¸…æ™°

4. **æä½è¿è¡Œå¼€é”€**ï¼ˆ5% CPUï¼‰
   - é™æ€åˆ†æç¦»çº¿å®Œæˆ
   - è¿è¡Œæ—¶ä»…æŸ¥è¯¢é…ç½®
   - å†³ç­–é€Ÿåº¦<1Î¼s

---

## ğŸ¯ åº”ç”¨åœºæ™¯

### åœºæ™¯1: å¤§è§„æ¨¡ç”µå•†å¹³å°

**é—®é¢˜**: æ¯æ—¥100äº¿spansï¼Œå­˜å‚¨æˆæœ¬é«˜æ˜‚

**ä¼ ç»Ÿæ–¹æ¡ˆ**:

```text
æ•°æ®é‡: 100B spans Ã— 2KB = 200TB/å¤©
Headé‡‡æ ·ç‡: 1%
ä¿ç•™æ•°æ®: 2TB/å¤©
æˆæœ¬: $46,000/æœˆï¼ˆå­˜å‚¨ï¼‰
é—®é¢˜: âŒ ä¸¢å¤±99%çš„é”™è¯¯ä¿¡æ¯
```

**Autoscopeæ–¹æ¡ˆ**:

```text
æ™ºèƒ½é‡‡æ ·: 81.2%å‡å°‘
ä¿ç•™æ•°æ®: 37.6TB/å¤©ï¼ˆä½†ä¿ç•™98.1%é”™è¯¯ï¼‰
æˆæœ¬: $8,648/æœˆ
èŠ‚çœ: $37,352/æœˆï¼ˆ81.2%ï¼‰
ä¼˜åŠ¿: âœ… ä¿ç•™98.1%é”™è¯¯ä¿¡æ¯
```

---

### åœºæ™¯2: é‡‘èæ”¯ä»˜ç³»ç»Ÿ

**éœ€æ±‚**:

- é«˜æ•…éšœè¦†ç›–ç‡ï¼ˆç›‘ç®¡è¦æ±‚ï¼‰
- ä½å­˜å‚¨æˆæœ¬
- å®Œæ•´è¿½è¸ªé“¾è·¯

**Autoscopeé…ç½®**:

```python
config = {
    'critical_paths': [
        'payment_processing',      # ä¼˜å…ˆçº§: 1.0
        'fraud_detection',         # ä¼˜å…ˆçº§: 1.0
        'transaction_validation',  # ä¼˜å…ˆçº§: 0.9
        'risk_assessment'          # ä¼˜å…ˆçº§: 0.8
    ],
    'normal_paths': [
        'cache_lookup',            # ä¼˜å…ˆçº§: 0.1
        'static_content',          # ä¼˜å…ˆçº§: 0.05
    ],
    'threshold': 0.5
}
```

**æ•ˆæœ**:

- âœ… 100%è¦†ç›–æ‰€æœ‰æ”¯ä»˜ç›¸å…³span
- âœ… 100%è¦†ç›–æ‰€æœ‰æ¬ºè¯ˆæ£€æµ‹span
- âœ… å‡å°‘75%ç¼“å­˜å’Œé™æ€å†…å®¹span
- âœ… æ€»ä½“å‡å°‘60%å­˜å‚¨

---

### åœºæ™¯3: IoTè¾¹ç¼˜è®¾å¤‡

**æŒ‘æˆ˜**:

- å¸¦å®½å—é™ï¼ˆ4G/5Gï¼‰
- å­˜å‚¨å—é™ï¼ˆè¾¹ç¼˜è®¾å¤‡ï¼‰
- ç”µæ± ç»­èˆªå…³é”®

**Autoscopeä¼˜åŠ¿**:

```text
ä¼ ç»Ÿæ–¹æ¡ˆ:
â”œâ”€ ä¸Šä¼ : 100MB/å¤©ï¼ˆå®Œæ•´è¿½è¸ªï¼‰
â”œâ”€ å¸¦å®½æˆæœ¬: $10/GB = $1,000/æœˆ
â””â”€ ç”µæ± å½±å“: é«˜

Autoscope:
â”œâ”€ ä¸Šä¼ : 19MB/å¤©ï¼ˆæ™ºèƒ½é‡‡æ ·ï¼‰
â”œâ”€ å¸¦å®½æˆæœ¬: $190/æœˆ
â”œâ”€ èŠ‚çœ: 81%
â””â”€ ç”µæ± ç»­èˆª: å»¶é•¿3-5å€
```

---

## ğŸ”„ ä¸å…¶ä»–æŠ€æœ¯å¯¹æ¯”

### vs. Head-basedé‡‡æ ·

| ç»´åº¦ | Headé‡‡æ · | Autoscope | ä¼˜åŠ¿ |
|------|---------|-----------|------|
| æ•…éšœè¦†ç›– | 1% | 98.1% | **+97.1%** |
| è¿½è¸ªå¤§å°å‡å°‘ | 99% | 81.2% | Headæ›´æ¿€è¿› |
| ç»“æ„å®Œæ•´æ€§ | ç ´å | ä¿æŒ | **Autoscope** |
| å®æ—¶æ€§ | å®æ—¶ | å®æ—¶ | ç›¸åŒ |
| å®æ–½å¤æ‚åº¦ | ä½ | ä¸­ | Headæ›´ç®€å• |

---

### vs. Tail-basedé‡‡æ ·

| ç»´åº¦ | Tailé‡‡æ · | Autoscope | ä¼˜åŠ¿ |
|------|----------|-----------|------|
| æ•…éšœè¦†ç›– | 100% | 98.1% | Tailç•¥é«˜ |
| ä¸´æ—¶å­˜å‚¨ | éœ€è¦100% | ä¸éœ€è¦ | **Autoscope** |
| å†³ç­–å»¶è¿Ÿ | ç§’çº§ | å®æ—¶ | **Autoscope** |
| è¿è¡Œå¼€é”€ | é«˜ | 5% | **Autoscope** |
| å®æ–½å¤æ‚åº¦ | é«˜ | ä¸­ | **Autoscope** |

---

### vs. Tracezipå‹ç¼©

| ç»´åº¦ | Tracezip | Autoscope | ä¼˜åŠ¿ |
|------|----------|-----------|------|
| å‹ç¼©æ–¹å¼ | æ•°æ®å‹ç¼© | æ™ºèƒ½é‡‡æ · | ä¸åŒè·¯å¾„ |
| å‹ç¼©ç‡ | 65% | 81.2% | **Autoscope** |
| æ•…éšœè¦†ç›– | 100% | 98.1% | Tracezip |
| CPUå¼€é”€ | 23% | 5% | **Autoscope** |
| æŸ¥è¯¢å»¶è¿Ÿ | +17% | æ— å½±å“ | **Autoscope** |

**æœ€ä½³ç»„åˆ**ï¼šAutoscope + Tracezip

```text
ç¬¬ä¸€æ­¥: Autoscopeé‡‡æ ·ï¼ˆ-81.2%ï¼‰
ç¬¬äºŒæ­¥: Tracezipå‹ç¼©ï¼ˆ-65%ï¼‰
æ€»æ•ˆæœ: åŸå§‹æ•°æ®çš„ 18.8% Ã— 35% = 6.58%
å‹ç¼©ç‡: 93.42%
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. é€‰æ‹©åˆé€‚çš„é˜ˆå€¼

```python
# ä¿å®ˆç­–ç•¥ï¼ˆé«˜æ•…éšœè¦†ç›–ç‡ï¼‰
threshold = 0.2  # ä¿ç•™æ›´å¤šspan

# å¹³è¡¡ç­–ç•¥ï¼ˆæ¨èï¼‰
threshold = 0.3  # å¹³è¡¡è¦†ç›–ç‡å’Œæˆæœ¬

# æ¿€è¿›ç­–ç•¥ï¼ˆä½æˆæœ¬ï¼‰
threshold = 0.5  # åªä¿ç•™æœ€å…³é”®span
```

### 2. å®šæœŸæ›´æ–°åˆ†æ

```bash
# æ¯å‘¨é‡æ–°åˆ†æä»£ç 
cron: 0 2 * * 0 /scripts/analyze_and_deploy.sh

# è„šæœ¬å†…å®¹
#!/bin/bash
# 1. æå–æœ€æ–°ä»£ç 
# 2. è¿è¡ŒAutoscopeåˆ†æ
# 3. ç”Ÿæˆæ–°é…ç½®
# 4. æ»šåŠ¨éƒ¨ç½²
```

### 3. ç›‘æ§é‡‡æ ·è´¨é‡

```python
from prometheus_client import Counter, Histogram

sampled_spans = Counter('autoscope_sampled_spans_total',
                       'Total sampled spans')
dropped_spans = Counter('autoscope_dropped_spans_total',
                       'Total dropped spans')
sampling_decision_time = Histogram('autoscope_decision_seconds',
                                  'Sampling decision time')
```

### 4. é”™è¯¯spanå¼ºåˆ¶é‡‡æ ·

```python
class AutoscopeSamplerWithErrorOverride(AutoscopeSampler):
    def should_sample(self, parent_context, trace_id, name,
                     kind=None, attributes=None, **kwargs):
        # å¼ºåˆ¶é‡‡æ ·é”™è¯¯span
        if attributes and attributes.get('error', False):
            return SamplingResult(Decision.RECORD_AND_SAMPLE,
                                attributes={'autoscope.reason': 'error'})

        # å¦åˆ™ä½¿ç”¨é»˜è®¤é€»è¾‘
        return super().should_sample(parent_context, trace_id, name,
                                    kind, attributes, **kwargs)
```

---

## ğŸ”® æœªæ¥å±•æœ›

### å³å°†åˆ°æ¥çš„ç‰¹æ€§ï¼ˆ2025-2026ï¼‰

1. **æœºå™¨å­¦ä¹ å¢å¼º**
   - å½“å‰ï¼šåŸºäºé™æ€è§„åˆ™
   - æœªæ¥ï¼šMLæ¨¡å‹é¢„æµ‹spané‡è¦æ€§

2. **åŠ¨æ€è‡ªé€‚åº”**
   - å½“å‰ï¼šç¦»çº¿é…ç½®
   - æœªæ¥ï¼šæ ¹æ®ç³»ç»Ÿè´Ÿè½½å®æ—¶è°ƒæ•´

3. **è·¨è¯­è¨€æ”¯æŒ**
   - å½“å‰ï¼šPython/JavaåŸå‹
   - æœªæ¥ï¼šGo/Rust/Node.jså…¨è¦†ç›–

4. **OpenTelemetryé›†æˆ**
   - å½“å‰ï¼šå®éªŒæ€§å®ç°
   - æœªæ¥ï¼šå®˜æ–¹æ”¯æŒï¼ˆé¢„è®¡2026 Q2ï¼‰

---

## ğŸ“š å‚è€ƒèµ„æº

### å­¦æœ¯è®ºæ–‡

- **AutoscopeåŸè®ºæ–‡**: [arXiv:2509.13852](https://arxiv.org/abs/2509.13852)
- **ç›¸å…³ç ”ç©¶**:
  - Distributed Tracing Sampling Strategies
  - Static Analysis for Dynamic Optimization

### ä»£ç å®ç°

- **å‚è€ƒå®ç°**: [GitHubé“¾æ¥å¾…è¡¥å……]
- **OpenTelemetry PR**: [å¾…è¡¥å……]

### è¿›ä¸€æ­¥é˜…è¯»

- OpenTelemetry Sampling Specification
- Distributed Tracing Best Practices
- Static Program Analysis Techniques

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-10-18
**çŠ¶æ€**: ç ”ç©¶é˜¶æ®µï¼Œç”Ÿäº§ä½¿ç”¨éœ€ç­‰å¾…æˆç†Ÿå®ç°
**åé¦ˆ**: [GitHub Issueså¾…æ·»åŠ ]

---

## ğŸ“ å˜æ›´æ—¥å¿—

- **2025-10-18**: åˆå§‹ç‰ˆæœ¬
  - å®Œæ•´çš„Autoscopeæ¦‚å¿µä»‹ç»
  - Pythonå®ç°ç¤ºä¾‹ï¼ˆé™æ€åˆ†æ+è¿è¡Œæ—¶é‡‡æ ·ï¼‰
  - æ€§èƒ½è¯„ä¼°å’Œåº”ç”¨åœºæ™¯
  - ä¸å…¶ä»–æŠ€æœ¯å¯¹æ¯”åˆ†æ
  - æœ€ä½³å®è·µæŒ‡å—

**ğŸ¯ Autoscopeï¼šæ™ºèƒ½é‡‡æ ·ï¼Œä¿ç•™å…³é”®ï¼Œå‡å°‘81.2%ï¼** ğŸš€

# OpenTelemetry CI/CD é›†æˆå®è·µ

> **æœ€åæ›´æ–°**: 2025å¹´10æœˆ8æ—¥
> **ç›®æ ‡è¯»è€…**: DevOpså·¥ç¨‹å¸ˆã€CI/CDå·¥ç¨‹å¸ˆ

---

## ğŸ“‹ ç›®å½•

- [OpenTelemetry CI/CD é›†æˆå®è·µ](#opentelemetry-cicd-é›†æˆå®è·µ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. CI/CDå¯è§‚æµ‹æ€§æ¦‚è¿°](#1-cicdå¯è§‚æµ‹æ€§æ¦‚è¿°)
    - [1.1 ä¸ºä»€ä¹ˆéœ€è¦CI/CDå¯è§‚æµ‹æ€§](#11-ä¸ºä»€ä¹ˆéœ€è¦cicdå¯è§‚æµ‹æ€§)
    - [1.2 å…³é”®æŒ‡æ ‡](#12-å…³é”®æŒ‡æ ‡)
  - [2. GitHub Actionsé›†æˆ](#2-github-actionsé›†æˆ)
    - [2.1 åŸºç¡€é›†æˆ](#21-åŸºç¡€é›†æˆ)
    - [2.2 å®Œæ•´å·¥ä½œæµ](#22-å®Œæ•´å·¥ä½œæµ)
  - [3. GitLab CIé›†æˆ](#3-gitlab-cié›†æˆ)
  - [4. Jenkinsé›†æˆ](#4-jenkinsé›†æˆ)
  - [5. å®¹å™¨æ„å»ºè¿½è¸ª](#5-å®¹å™¨æ„å»ºè¿½è¸ª)
  - [6. éƒ¨ç½²è¿½è¸ª](#6-éƒ¨ç½²è¿½è¸ª)
    - [6.1 Kuberneteséƒ¨ç½²](#61-kuberneteséƒ¨ç½²)
    - [6.2 éƒ¨ç½²éªŒè¯](#62-éƒ¨ç½²éªŒè¯)
  - [7. æµ‹è¯•è¿½è¸ª](#7-æµ‹è¯•è¿½è¸ª)
  - [8. æ€§èƒ½åŸºå‡†æµ‹è¯•](#8-æ€§èƒ½åŸºå‡†æµ‹è¯•)
  - [9. å‘Šè­¦ä¸é€šçŸ¥](#9-å‘Šè­¦ä¸é€šçŸ¥)
  - [10. æœ€ä½³å®è·µ](#10-æœ€ä½³å®è·µ)
  - [11. CI/CDè¯­ä¹‰çº¦å®šè¯¦è§£ (2025æœ€æ–°)](#11-cicdè¯­ä¹‰çº¦å®šè¯¦è§£-2025æœ€æ–°)
    - [11.1 è¯­ä¹‰çº¦å®šæ¦‚è¿°](#111-è¯­ä¹‰çº¦å®šæ¦‚è¿°)
      - [æ ¸å¿ƒä»·å€¼](#æ ¸å¿ƒä»·å€¼)
    - [11.2 æ ¸å¿ƒå±æ€§å®šä¹‰](#112-æ ¸å¿ƒå±æ€§å®šä¹‰)
      - [Pipelineå±æ€§](#pipelineå±æ€§)
      - [Jobå±æ€§](#jobå±æ€§)
      - [æµ‹è¯•å±æ€§](#æµ‹è¯•å±æ€§)
      - [éƒ¨ç½²å±æ€§](#éƒ¨ç½²å±æ€§)
    - [11.3 å®Œæ•´ç¤ºä¾‹](#113-å®Œæ•´ç¤ºä¾‹)
      - [GitHub Actionsç¤ºä¾‹](#github-actionsç¤ºä¾‹)
      - [GitLab CIç¤ºä¾‹](#gitlab-ciç¤ºä¾‹)
      - [Jenkinsç¤ºä¾‹](#jenkinsç¤ºä¾‹)
    - [11.4 æŸ¥è¯¢å’Œåˆ†æ](#114-æŸ¥è¯¢å’Œåˆ†æ)
      - [æŸ¥è¯¢ç¤ºä¾‹](#æŸ¥è¯¢ç¤ºä¾‹)
      - [DORAæŒ‡æ ‡è®¡ç®—](#doraæŒ‡æ ‡è®¡ç®—)
    - [11.5 æœ€ä½³å®è·µ](#115-æœ€ä½³å®è·µ)
    - [11.6 æ•…éšœæ’æŸ¥](#116-æ•…éšœæ’æŸ¥)
      - [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
  - [12. å‚è€ƒèµ„æº](#12-å‚è€ƒèµ„æº)
  - [ç¬¬åäºŒéƒ¨åˆ†: é«˜çº§CI/CDé›†æˆ (2025æœ€æ–°)](#ç¬¬åäºŒéƒ¨åˆ†-é«˜çº§cicdé›†æˆ-2025æœ€æ–°)
    - [12.1 è‡ªåŠ¨åŒ–æµ‹è¯•é›†æˆ](#121-è‡ªåŠ¨åŒ–æµ‹è¯•é›†æˆ)
      - [æµ‹è¯•è¿½è¸ªé›†æˆ](#æµ‹è¯•è¿½è¸ªé›†æˆ)
    - [12.2 è´¨é‡é—¨ç¦é›†æˆ](#122-è´¨é‡é—¨ç¦é›†æˆ)
      - [è´¨é‡é—¨ç¦é…ç½®](#è´¨é‡é—¨ç¦é…ç½®)
      - [é—¨ç¦æ£€æŸ¥è„šæœ¬](#é—¨ç¦æ£€æŸ¥è„šæœ¬)
    - [12.3 è‡ªåŠ¨åŒ–éƒ¨ç½²è¿½è¸ª](#123-è‡ªåŠ¨åŒ–éƒ¨ç½²è¿½è¸ª)
      - [éƒ¨ç½²è¿½è¸ªé›†æˆ](#éƒ¨ç½²è¿½è¸ªé›†æˆ)
    - [12.4 æ€§èƒ½å›å½’æ£€æµ‹](#124-æ€§èƒ½å›å½’æ£€æµ‹)
      - [æ€§èƒ½åŸºå‡†æµ‹è¯•](#æ€§èƒ½åŸºå‡†æµ‹è¯•)
  - [ç¬¬åä¸‰éƒ¨åˆ†: ç›‘æ§ä¸å‘Šè­¦](#ç¬¬åä¸‰éƒ¨åˆ†-ç›‘æ§ä¸å‘Šè­¦)
    - [13.1 CI/CDæŒ‡æ ‡ç›‘æ§](#131-cicdæŒ‡æ ‡ç›‘æ§)
      - [PrometheusæŒ‡æ ‡](#prometheusæŒ‡æ ‡)
      - [Grafanaä»ªè¡¨ç›˜](#grafanaä»ªè¡¨ç›˜)
    - [13.2 å‘Šè­¦è§„åˆ™](#132-å‘Šè­¦è§„åˆ™)
      - [CI/CDå‘Šè­¦](#cicdå‘Šè­¦)

---

## 1. CI/CDå¯è§‚æµ‹æ€§æ¦‚è¿°

### 1.1 ä¸ºä»€ä¹ˆéœ€è¦CI/CDå¯è§‚æµ‹æ€§

**ä»·å€¼**ï¼š

```text
1. æµæ°´çº¿æ€§èƒ½
   - è¯†åˆ«æ…¢æ­¥éª¤
   - ä¼˜åŒ–æ„å»ºæ—¶é—´
   - æé«˜å¼€å‘æ•ˆç‡

2. æ•…éšœå®šä½
   - å¿«é€Ÿå®šä½å¤±è´¥åŸå› 
   - è¿½è¸ªéƒ¨ç½²é—®é¢˜
   - å›æ»šå†³ç­–æ”¯æŒ

3. è´¨é‡ä¿è¯
   - æµ‹è¯•è¦†ç›–ç‡
   - æµ‹è¯•å¤±è´¥è¶‹åŠ¿
   - æ€§èƒ½å›å½’æ£€æµ‹

4. åˆè§„å®¡è®¡
   - éƒ¨ç½²å†å²
   - å˜æ›´è¿½è¸ª
   - å®¡æ‰¹æµç¨‹

5. DevOpsæŒ‡æ ‡
   - éƒ¨ç½²é¢‘ç‡
   - å˜æ›´å‰ç½®æ—¶é—´
   - MTTR
   - å˜æ›´å¤±è´¥ç‡

ç¤ºä¾‹:
éƒ¨ç½²å¤±è´¥ â†’ æŸ¥çœ‹Trace â†’ å‘ç°æ˜¯é•œåƒæ‹‰å–è¶…æ—¶ â†’ ä¼˜åŒ–é•œåƒä»“åº“
```

### 1.2 å…³é”®æŒ‡æ ‡

```text
CI/CDå…³é”®æŒ‡æ ‡:

1. æ„å»ºæŒ‡æ ‡
   - build_duration: æ„å»ºæ—¶é•¿
   - build_success_rate: æˆåŠŸç‡
   - build_queue_time: æ’é˜Ÿæ—¶é—´

2. æµ‹è¯•æŒ‡æ ‡
   - test_duration: æµ‹è¯•æ—¶é•¿
   - test_pass_rate: é€šè¿‡ç‡
   - test_coverage: è¦†ç›–ç‡

3. éƒ¨ç½²æŒ‡æ ‡
   - deployment_duration: éƒ¨ç½²æ—¶é•¿
   - deployment_frequency: éƒ¨ç½²é¢‘ç‡
   - deployment_success_rate: æˆåŠŸç‡

4. DORAæŒ‡æ ‡
   - Deployment Frequency
   - Lead Time for Changes
   - Time to Restore Service
   - Change Failure Rate

5. èµ„æºæŒ‡æ ‡
   - cpu_usage: CPUä½¿ç”¨
   - memory_usage: å†…å­˜ä½¿ç”¨
   - artifact_size: äº§ç‰©å¤§å°
```

---

## 2. GitHub Actionsé›†æˆ

### 2.1 åŸºç¡€é›†æˆ

**è®¾ç½®OpenTelemetry**ï¼š

```yaml
# .github/workflows/ci.yml
name: CI with OpenTelemetry

on: [push, pull_request]

env:
  OTEL_EXPORTER_OTLP_ENDPOINT: ${{ secrets.OTEL_COLLECTOR_ENDPOINT }}
  OTEL_EXPORTER_OTLP_HEADERS: ${{ secrets.OTEL_AUTH_HEADER }}
  OTEL_SERVICE_NAME: my-app-ci
  OTEL_RESOURCE_ATTRIBUTES: service.version=${{ github.sha }},deployment.environment=ci

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup OpenTelemetry
        run: |
          # ä¸‹è½½otel CLI
          curl -L https://github.com/equinix-labs/otel-cli/releases/download/v0.4.0/otel-cli_0.4.0_linux_amd64.tar.gz | tar xz
          sudo mv otel-cli /usr/local/bin/

      - name: Build with tracing
        run: |
          otel-cli exec \
            --name "Build application" \
            --kind internal \
            --service my-app-ci \
            --attrs "build.branch=${{ github.ref }}" \
            --attrs "build.commit=${{ github.sha }}" \
            -- make build

      - name: Run tests with tracing
        run: |
          otel-cli exec \
            --name "Run tests" \
            --kind internal \
            --service my-app-ci \
            -- make test
```

### 2.2 å®Œæ•´å·¥ä½œæµ

**ç”Ÿäº§çº§CIé…ç½®**ï¼š

```yaml
# .github/workflows/full-ci.yml
name: Full CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  OTEL_EXPORTER_OTLP_ENDPOINT: https://otel-collector.example.com:4317
  OTEL_EXPORTER_OTLP_HEADERS: "authorization=Bearer ${{ secrets.OTEL_TOKEN }}"
  OTEL_SERVICE_NAME: my-app-ci
  OTEL_RESOURCE_ATTRIBUTES: >
    service.version=${{ github.sha }},
    deployment.environment=ci,
    vcs.repository.url=${{ github.repositoryUrl }},
    vcs.ref=${{ github.ref }},
    ci.pipeline.name=${{ github.workflow }},
    ci.pipeline.run.id=${{ github.run_id }}

jobs:
  # ========== é˜¶æ®µ1: å‡†å¤‡ ==========
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Start Pipeline Trace
        id: start-trace
        run: |
          # åˆ›å»ºæ ¹Trace
          TRACE_ID=$(openssl rand -hex 16)
          SPAN_ID=$(openssl rand -hex 8)
          echo "TRACE_ID=$TRACE_ID" >> $GITHUB_OUTPUT
          echo "ROOT_SPAN_ID=$SPAN_ID" >> $GITHUB_OUTPUT

          # å‘é€Span
          curl -X POST $OTEL_EXPORTER_OTLP_ENDPOINT/v1/traces \
            -H "Content-Type: application/json" \
            -H "$OTEL_EXPORTER_OTLP_HEADERS" \
            -d '{
              "resourceSpans": [{
                "resource": {
                  "attributes": [
                    {"key": "service.name", "value": {"stringValue": "my-app-ci"}},
                    {"key": "deployment.environment", "value": {"stringValue": "ci"}}
                  ]
                },
                "scopeSpans": [{
                  "spans": [{
                    "traceId": "'$TRACE_ID'",
                    "spanId": "'$SPAN_ID'",
                    "name": "CI Pipeline",
                    "kind": 1,
                    "startTimeUnixNano": '$(date +%s%N)'
                  }]
                }]
              }]
            }'

    outputs:
      trace_id: ${{ steps.start-trace.outputs.TRACE_ID }}
      root_span_id: ${{ steps.start-trace.outputs.ROOT_SPAN_ID }}

  # ========== é˜¶æ®µ2: æ„å»º ==========
  build:
    needs: setup
    runs-on: ubuntu-latest
    env:
      TRACE_PARENT: "00-${{ needs.setup.outputs.trace_id }}-${{ needs.setup.outputs.root_span_id }}-01"

    steps:
      - uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

      - name: Download dependencies
        run: |
          START=$(date +%s%N)
          go mod download
          END=$(date +%s%N)
          DURATION=$((($END - $START) / 1000000))
          echo "::notice::Dependencies downloaded in ${DURATION}ms"

      - name: Build application
        run: |
          otel-cli exec \
            --name "go build" \
            --kind internal \
            --service my-app-ci \
            --tp-carrier "$TRACE_PARENT" \
            --attrs "build.language=go" \
            --attrs "build.version=1.21" \
            -- go build -o app ./cmd/server

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: app-binary
          path: app

  # ========== é˜¶æ®µ3: æµ‹è¯• ==========
  test:
    needs: [setup, build]
    runs-on: ubuntu-latest
    env:
      TRACE_PARENT: "00-${{ needs.setup.outputs.trace_id }}-${{ needs.setup.outputs.root_span_id }}-01"

    steps:
      - uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Run unit tests
        run: |
          otel-cli exec \
            --name "Unit Tests" \
            --kind internal \
            --tp-carrier "$TRACE_PARENT" \
            --attrs "test.type=unit" \
            -- go test -v -cover ./... -coverprofile=coverage.out

      - name: Run integration tests
        run: |
          otel-cli exec \
            --name "Integration Tests" \
            --kind internal \
            --tp-carrier "$TRACE_PARENT" \
            --attrs "test.type=integration" \
            -- go test -v -tags=integration ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.out

  # ========== é˜¶æ®µ4: å®‰å…¨æ‰«æ ==========
  security:
    needs: [setup, build]
    runs-on: ubuntu-latest
    env:
      TRACE_PARENT: "00-${{ needs.setup.outputs.trace_id }}-${{ needs.setup.outputs.root_span_id }}-01"

    steps:
      - uses: actions/checkout@v3

      - name: Run Trivy scan
        run: |
          otel-cli exec \
            --name "Security Scan" \
            --kind internal \
            --tp-carrier "$TRACE_PARENT" \
            --attrs "scan.tool=trivy" \
            -- trivy fs --security-checks vuln,config .

  # ========== é˜¶æ®µ5: Dockeræ„å»º ==========
  docker:
    needs: [setup, build, test, security]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    env:
      TRACE_PARENT: "00-${{ needs.setup.outputs.trace_id }}-${{ needs.setup.outputs.root_span_id }}-01"

    steps:
      - uses: actions/checkout@v3

      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: app-binary

      - name: Build Docker image
        run: |
          otel-cli exec \
            --name "Docker Build" \
            --kind internal \
            --tp-carrier "$TRACE_PARENT" \
            --attrs "docker.image=my-app:${{ github.sha }}" \
            -- docker build -t my-app:${{ github.sha }} .

      - name: Push to registry
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          docker push my-app:${{ github.sha }}

  # ========== é˜¶æ®µ6: éƒ¨ç½² ==========
  deploy:
    needs: [setup, docker]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    env:
      TRACE_PARENT: "00-${{ needs.setup.outputs.trace_id }}-${{ needs.setup.outputs.root_span_id }}-01"

    steps:
      - name: Deploy to Kubernetes
        run: |
          otel-cli exec \
            --name "Deploy to Production" \
            --kind client \
            --tp-carrier "$TRACE_PARENT" \
            --attrs "deployment.target=production" \
            --attrs "deployment.version=${{ github.sha }}" \
            -- kubectl set image deployment/my-app \
                my-app=my-app:${{ github.sha }} \
                -n production

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/my-app -n production --timeout=5m

      - name: Smoke test
        run: |
          otel-cli exec \
            --name "Smoke Test" \
            --kind internal \
            --tp-carrier "$TRACE_PARENT" \
            -- curl -f https://api.example.com/health
```

---

## 3. GitLab CIé›†æˆ

```yaml
# .gitlab-ci.yml
variables:
  OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_COLLECTOR_ENDPOINT}
  OTEL_EXPORTER_OTLP_HEADERS: ${OTEL_AUTH_HEADER}
  OTEL_SERVICE_NAME: my-app-ci
  OTEL_RESOURCE_ATTRIBUTES: >
    service.version=${CI_COMMIT_SHA},
    deployment.environment=ci,
    ci.pipeline.id=${CI_PIPELINE_ID},
    ci.job.name=${CI_JOB_NAME}

stages:
  - build
  - test
  - deploy

before_script:
  - |
    # å®‰è£…otel-cli
    curl -L https://github.com/equinix-labs/otel-cli/releases/download/v0.4.0/otel-cli_0.4.0_linux_amd64.tar.gz | tar xz
    mv otel-cli /usr/local/bin/

build:
  stage: build
  script:
    - |
      otel-cli exec \
        --name "Build ${CI_JOB_NAME}" \
        --kind internal \
        --service my-app-ci \
        --attrs "ci.pipeline.id=${CI_PIPELINE_ID}" \
        --attrs "ci.commit=${CI_COMMIT_SHA}" \
        -- make build
  artifacts:
    paths:
      - build/

test:unit:
  stage: test
  script:
    - |
      otel-cli exec \
        --name "Unit Tests" \
        --kind internal \
        --attrs "test.type=unit" \
        -- make test
  coverage: '/Coverage: \d+\.\d+%/'

deploy:production:
  stage: deploy
  only:
    - main
  script:
    - |
      otel-cli exec \
        --name "Deploy to Production" \
        --kind client \
        --attrs "deployment.target=production" \
        --attrs "deployment.version=${CI_COMMIT_SHA}" \
        -- kubectl set image deployment/my-app my-app=my-app:${CI_COMMIT_SHA}
```

---

## 4. Jenkinsé›†æˆ

```groovy
// Jenkinsfile
pipeline {
    agent any

    environment {
        OTEL_EXPORTER_OTLP_ENDPOINT = credentials('otel-collector-endpoint')
        OTEL_EXPORTER_OTLP_HEADERS = credentials('otel-auth-header')
        OTEL_SERVICE_NAME = 'my-app-ci'
        TRACE_ID = sh(script: 'openssl rand -hex 16', returnStdout: true).trim()
    }

    stages {
        stage('Setup') {
            steps {
                script {
                    // å®‰è£…otel-cli
                    sh '''
                        curl -L https://github.com/equinix-labs/otel-cli/releases/download/v0.4.0/otel-cli_0.4.0_linux_amd64.tar.gz | tar xz
                        chmod +x otel-cli
                    '''
                }
            }
        }

        stage('Build') {
            steps {
                script {
                    sh '''
                        ./otel-cli exec \
                          --name "Build ${JOB_NAME}" \
                          --kind internal \
                          --service my-app-ci \
                          --attrs "build.number=${BUILD_NUMBER}" \
                          --attrs "build.url=${BUILD_URL}" \
                          -- make build
                    '''
                }
            }
        }

        stage('Test') {
            parallel {
                stage('Unit Tests') {
                    steps {
                        sh '''
                            ./otel-cli exec \
                              --name "Unit Tests" \
                              --kind internal \
                              --attrs "test.type=unit" \
                              -- make test:unit
                        '''
                    }
                }

                stage('Integration Tests') {
                    steps {
                        sh '''
                            ./otel-cli exec \
                              --name "Integration Tests" \
                              --kind internal \
                              --attrs "test.type=integration" \
                              -- make test:integration
                        '''
                    }
                }
            }
        }

        stage('Deploy') {
            when {
                branch 'main'
            }
            steps {
                sh '''
                    ./otel-cli exec \
                      --name "Deploy to Production" \
                      --kind client \
                      --attrs "deployment.target=production" \
                      -- kubectl set image deployment/my-app my-app=my-app:${GIT_COMMIT}
                '''
            }
        }
    }

    post {
        always {
            script {
                // å‘é€Pipelineå®Œæˆäº‹ä»¶
                sh '''
                    ./otel-cli span event \
                      --name "Pipeline ${currentBuild.result}" \
                      --attrs "build.result=${currentBuild.result}" \
                      --attrs "build.duration=${currentBuild.duration}"
                '''
            }
        }
    }
}
```

---

## 5. å®¹å™¨æ„å»ºè¿½è¸ª

**Docker Buildè¿½è¸ª**ï¼š

```bash
#!/bin/bash
# build-with-tracing.sh

# å¼€å§‹Build Span
SPAN_START=$(date +%s%N)

# æ„å»ºé•œåƒ
otel-cli exec \
  --name "Docker Build" \
  --kind internal \
  --service docker-build \
  --attrs "docker.image=${IMAGE_NAME}:${VERSION}" \
  --attrs "docker.file=Dockerfile" \
  -- docker build \
    --progress=plain \
    --tag ${IMAGE_NAME}:${VERSION} \
    --build-arg VERSION=${VERSION} \
    .

BUILD_RESULT=$?
SPAN_END=$(date +%s%N)
DURATION=$((($SPAN_END - $SPAN_START) / 1000000))

# è®°å½•æ„å»ºæŒ‡æ ‡
echo "Build duration: ${DURATION}ms"
echo "Build result: $BUILD_RESULT"

# å¦‚æœæ„å»ºæˆåŠŸï¼Œæ¨é€é•œåƒ
if [ $BUILD_RESULT -eq 0 ]; then
    otel-cli exec \
      --name "Docker Push" \
      --kind client \
      --attrs "docker.registry=${REGISTRY}" \
      -- docker push ${IMAGE_NAME}:${VERSION}
fi

exit $BUILD_RESULT
```

**å¤šé˜¶æ®µæ„å»ºè¿½è¸ª**ï¼š

```dockerfile
# Dockerfile with build stages
FROM golang:1.21 AS builder
WORKDIR /app
COPY . .

# è¿™äº›å‘½ä»¤ä¼šè¢«è¿½è¸ª
RUN go mod download
RUN CGO_ENABLED=0 go build -o app ./cmd/server

FROM alpine:latest
COPY --from=builder /app/app /usr/local/bin/app
ENTRYPOINT ["app"]
```

---

## 6. éƒ¨ç½²è¿½è¸ª

### 6.1 Kuberneteséƒ¨ç½²

```bash
#!/bin/bash
# deploy-with-tracing.sh

DEPLOYMENT_NAME="my-app"
NAMESPACE="production"
IMAGE_TAG=$1

# åˆ›å»ºéƒ¨ç½²Span
otel-cli span \
  --name "Deploy ${DEPLOYMENT_NAME}" \
  --kind client \
  --service deployment \
  --attrs "deployment.name=${DEPLOYMENT_NAME}" \
  --attrs "deployment.namespace=${NAMESPACE}" \
  --attrs "deployment.image.tag=${IMAGE_TAG}" \
  --attrs "deployment.strategy=rolling" \
  --start

# æ›´æ–°é•œåƒ
kubectl set image deployment/${DEPLOYMENT_NAME} \
  ${DEPLOYMENT_NAME}=${IMAGE_NAME}:${IMAGE_TAG} \
  -n ${NAMESPACE}

# ç­‰å¾…rolloutå®Œæˆ
kubectl rollout status deployment/${DEPLOYMENT_NAME} \
  -n ${NAMESPACE} \
  --timeout=5m

ROLLOUT_RESULT=$?

# ç»“æŸSpan
otel-cli span \
  --end \
  --attrs "deployment.result=$([[ $ROLLOUT_RESULT -eq 0 ]] && echo success || echo failure)"

# éªŒè¯éƒ¨ç½²
if [ $ROLLOUT_RESULT -eq 0 ]; then
    otel-cli exec \
      --name "Verify Deployment" \
      --kind internal \
      -- curl -f https://api.example.com/health
fi

exit $ROLLOUT_RESULT
```

### 6.2 éƒ¨ç½²éªŒè¯

```bash
# smoke-test.sh
#!/bin/bash

ENDPOINTS=(
    "https://api.example.com/health"
    "https://api.example.com/ready"
    "https://api.example.com/metrics"
)

otel-cli span --name "Smoke Tests" --start

for endpoint in "${ENDPOINTS[@]}"; do
    otel-cli exec \
      --name "Test ${endpoint}" \
      --kind client \
      --attrs "http.url=${endpoint}" \
      -- curl -f -s -o /dev/null -w "%{http_code}" ${endpoint}

    if [ $? -ne 0 ]; then
        echo "âŒ Failed: ${endpoint}"
        otel-cli span event --name "Test failed" --attrs "endpoint=${endpoint}"
        exit 1
    else
        echo "âœ… Passed: ${endpoint}"
    fi
done

otel-cli span --end
echo "âœ… All smoke tests passed"
```

---

## 7. æµ‹è¯•è¿½è¸ª

**Goæµ‹è¯•è¿½è¸ª**ï¼š

```go
// test_helper.go
package main

import (
    "context"
    "testing"
    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/trace"
)

func TestWithTracing(t *testing.T, fn func(ctx context.Context, t *testing.T)) {
    tracer := otel.Tracer("test")
    ctx, span := tracer.Start(context.Background(), t.Name(),
        trace.WithSpanKind(trace.SpanKindInternal),
    )
    defer span.End()

    fn(ctx, t)

    if t.Failed() {
        span.RecordError(errors.New("test failed"))
        span.SetStatus(codes.Error, "Test failed")
    }
}

// ä½¿ç”¨ç¤ºä¾‹
func TestUserService(t *testing.T) {
    TestWithTracing(t, func(ctx context.Context, t *testing.T) {
        // æµ‹è¯•ä»£ç 
        service := NewUserService()
        user, err := service.GetUser(ctx, "user-123")

        if err != nil {
            t.Fatal(err)
        }

        if user.Name == "" {
            t.Error("User name is empty")
        }
    })
}
```

---

## 8. æ€§èƒ½åŸºå‡†æµ‹è¯•

```bash
# benchmark.sh
#!/bin/bash

echo "Running performance benchmarks..."

otel-cli exec \
  --name "Performance Benchmark" \
  --kind internal \
  --service benchmark \
  -- go test -bench=. -benchtime=10s -benchmem ./...

# è§£æç»“æœå¹¶å‘é€ä¸ºMetric
go test -bench=. -benchtime=10s -benchmem ./... | \
  grep -E "^Benchmark" | \
  while read line; do
    NAME=$(echo $line | awk '{print $1}')
    OPS=$(echo $line | awk '{print $3}')
    NS_OP=$(echo $line | awk '{print $5}')

    # å‘é€Metricåˆ°OTLP
    curl -X POST ${OTEL_EXPORTER_OTLP_ENDPOINT}/v1/metrics \
      -H "Content-Type: application/json" \
      -d '{
        "resourceMetrics": [{
          "scopeMetrics": [{
            "metrics": [{
              "name": "benchmark.'${NAME}'",
              "gauge": {
                "dataPoints": [{
                  "asDouble": '${NS_OP}',
                  "timeUnixNano": '$(date +%s%N)'
                }]
              }
            }]
          }]
        }]
      }'
  done
```

---

## 9. å‘Šè­¦ä¸é€šçŸ¥

**Slacké€šçŸ¥**ï¼š

```bash
# notify-slack.sh
#!/bin/bash

PIPELINE_URL="${CI_PIPELINE_URL}"
TRACE_URL="https://jaeger.example.com/trace/${TRACE_ID}"

if [ "$BUILD_STATUS" == "success" ]; then
    COLOR="good"
    EMOJI=":white_check_mark:"
else
    COLOR="danger"
    EMOJI=":x:"
fi

curl -X POST $SLACK_WEBHOOK_URL \
  -H 'Content-Type: application/json' \
  -d '{
    "attachments": [{
      "color": "'${COLOR}'",
      "title": "'${EMOJI}' Pipeline '${BUILD_STATUS}'",
      "fields": [
        {
          "title": "Pipeline",
          "value": "<'${PIPELINE_URL}'|#'${BUILD_NUMBER}'>",
          "short": true
        },
        {
          "title": "Trace",
          "value": "<'${TRACE_URL}'|View Trace>",
          "short": true
        },
        {
          "title": "Commit",
          "value": "'${GIT_COMMIT:0:7}'",
          "short": true
        },
        {
          "title": "Duration",
          "value": "'${BUILD_DURATION}'",
          "short": true
        }
      ]
    }]
  }'
```

---

## 10. æœ€ä½³å®è·µ

```text
âœ… DO (æ¨è)
1. æ¯ä¸ªPipelineåˆ›å»ºä¸€ä¸ªæ ¹Trace
2. æ¯ä¸ªJob/Stageåˆ›å»ºå­Span
3. è®°å½•å…³é”®å±æ€§ (commit, branch, version)
4. è¿½è¸ªæ…¢æ­¥éª¤å¹¶ä¼˜åŒ–
5. å¤±è´¥æ—¶è®°å½•è¯¦ç»†é”™è¯¯
6. è®°å½•éƒ¨ç½²ç‰ˆæœ¬å’Œç¯å¢ƒ
7. å®æ–½smoke tests
8. ç›‘æ§DORAæŒ‡æ ‡

âŒ DON'T (é¿å…)
1. ä¸è¦åœ¨æ—¥å¿—ä¸­è®°å½•æ•æ„Ÿä¿¡æ¯
2. ä¸è¦é˜»å¡Pipeline (å¼‚æ­¥å‘é€)
3. ä¸è¦å¿½ç•¥è¿½è¸ªå¤±è´¥
4. ä¸è¦è¿‡åº¦è¿½è¸ª (< 5% overhead)

æ€§èƒ½ä¼˜åŒ–:
- ä½¿ç”¨ç¼“å­˜åŠ é€Ÿæ„å»º
- å¹¶è¡Œæ‰§è¡Œç‹¬ç«‹ä»»åŠ¡
- ä¼˜åŒ–Dockerå±‚ç¼“å­˜
- ä½¿ç”¨è½»é‡çº§åŸºç¡€é•œåƒ

ç›‘æ§å»ºè®®:
- Pipeline durationè¶‹åŠ¿
- å¤±è´¥ç‡è¶‹åŠ¿
- çƒ­ç‚¹æ­¥éª¤è¯†åˆ«
- éƒ¨ç½²é¢‘ç‡
- å‰ç½®æ—¶é—´
```

---

## 11. CI/CDè¯­ä¹‰çº¦å®šè¯¦è§£ (2025æœ€æ–°)

> **æ›´æ–°æ—¶é—´**: 2025å¹´12æœˆ
> **è§„èŒƒç‰ˆæœ¬**: Semantic Conventions v1.29.0
> **çŠ¶æ€**: ç¨³å®šç‰ˆ

### 11.1 è¯­ä¹‰çº¦å®šæ¦‚è¿°

OpenTelemetryåœ¨2025å¹´æ­£å¼å‘å¸ƒäº†CI/CDè¯­ä¹‰çº¦å®šï¼Œä¸ºCI/CDç³»ç»Ÿæä¾›äº†ç»Ÿä¸€çš„å±æ€§å‘½åè§„èŒƒã€‚

#### æ ¸å¿ƒä»·å€¼

```text
âœ… ç»Ÿä¸€å±æ€§å‘½å: è·¨CI/CDç³»ç»Ÿä¸€è‡´
âœ… è‡ªåŠ¨å…³è”: æ„å»ºã€æµ‹è¯•ã€éƒ¨ç½²è‡ªåŠ¨å…³è”
âœ… æ ‡å‡†åŒ–æŸ¥è¯¢: ç»Ÿä¸€çš„æŸ¥è¯¢å’Œè¿‡æ»¤
âœ… äº’æ“ä½œæ€§: ä¸åŒCI/CDç³»ç»Ÿæ•°æ®äº’é€š
```

### 11.2 æ ¸å¿ƒå±æ€§å®šä¹‰

#### Pipelineå±æ€§

| å±æ€§å | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| `ci.pipeline.id` | string | Pipelineå”¯ä¸€ID | `12345` |
| `ci.pipeline.name` | string | Pipelineåç§° | `main` |
| `ci.pipeline.url` | string | Pipeline URL | `https://gitlab.com/project/-/pipelines/12345` |
| `ci.pipeline.build_number` | string | æ„å»ºç¼–å· | `42` |
| `ci.pipeline.vcs.branch` | string | Gitåˆ†æ”¯ | `main`, `feature/new-api` |
| `ci.pipeline.vcs.tag` | string | Gitæ ‡ç­¾ | `v1.2.3` |
| `ci.pipeline.vcs.commit_sha` | string | æäº¤SHA | `abc123def456` |
| `ci.pipeline.vcs.commit_message` | string | æäº¤æ¶ˆæ¯ | `Fix bug in API` |
| `ci.pipeline.vcs.commit_author.name` | string | æäº¤ä½œè€… | `John Doe` |
| `ci.pipeline.vcs.commit_author.email` | string | ä½œè€…é‚®ç®± | `john@example.com` |
| `ci.pipeline.status` | string | PipelineçŠ¶æ€ | `success`, `failure`, `canceled` |
| `ci.pipeline.stage.name` | string | Stageåç§° | `build`, `test`, `deploy` |

#### Jobå±æ€§

| å±æ€§å | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| `ci.job.id` | string | Jobå”¯ä¸€ID | `job-123` |
| `ci.job.name` | string | Jobåç§° | `build-backend` |
| `ci.job.url` | string | Job URL | `https://gitlab.com/project/-/jobs/123` |
| `ci.job.status` | string | JobçŠ¶æ€ | `success`, `failure`, `running` |
| `ci.job.duration` | int | JobæŒç»­æ—¶é—´(æ¯«ç§’) | `120000` |
| `ci.job.queue_duration` | int | æ’é˜Ÿæ—¶é—´(æ¯«ç§’) | `5000` |

#### æµ‹è¯•å±æ€§

| å±æ€§å | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| `ci.test.name` | string | æµ‹è¯•åç§° | `test_user_creation` |
| `ci.test.suite` | string | æµ‹è¯•å¥—ä»¶ | `unit_tests`, `integration_tests` |
| `ci.test.status` | string | æµ‹è¯•çŠ¶æ€ | `pass`, `fail`, `skip` |
| `ci.test.duration` | int | æµ‹è¯•æŒç»­æ—¶é—´(æ¯«ç§’) | `150` |
| `ci.test.coverage.percentage` | double | ä»£ç è¦†ç›–ç‡ | `85.5` |

#### éƒ¨ç½²å±æ€§

| å±æ€§å | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| `ci.deployment.environment` | string | éƒ¨ç½²ç¯å¢ƒ | `production`, `staging`, `development` |
| `ci.deployment.version` | string | éƒ¨ç½²ç‰ˆæœ¬ | `v1.2.3`, `abc123` |
| `ci.deployment.url` | string | éƒ¨ç½²URL | `https://app.example.com` |
| `ci.deployment.status` | string | éƒ¨ç½²çŠ¶æ€ | `success`, `failure`, `rollback` |

### 11.3 å®Œæ•´ç¤ºä¾‹

#### GitHub Actionsç¤ºä¾‹

```yaml
# .github/workflows/ci-with-semantic-conventions.yml
name: CI with Semantic Conventions

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup OpenTelemetry
        uses: open-telemetry/setup-otel-cli@v1

      - name: Build
        run: |
          otel-cli span \
            --name "Build Application" \
            --attrs "ci.pipeline.id=${{ github.run_id }}" \
            --attrs "ci.pipeline.name=${{ github.workflow }}" \
            --attrs "ci.pipeline.url=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --attrs "ci.pipeline.vcs.branch=${{ github.ref_name }}" \
            --attrs "ci.pipeline.vcs.commit_sha=${{ github.sha }}" \
            --attrs "ci.pipeline.vcs.commit_message=${{ github.event.head_commit.message }}" \
            --attrs "ci.job.name=build" \
            --attrs "ci.job.id=${{ github.job }}" \
            -- \
            npm run build

      - name: Test
        run: |
          otel-cli span \
            --name "Run Tests" \
            --attrs "ci.pipeline.id=${{ github.run_id }}" \
            --attrs "ci.job.name=test" \
            --attrs "ci.test.suite=unit_tests" \
            -- \
            npm test

      - name: Deploy
        if: github.ref == 'refs/heads/main'
        run: |
          otel-cli span \
            --name "Deploy to Production" \
            --attrs "ci.pipeline.id=${{ github.run_id }}" \
            --attrs "ci.deployment.environment=production" \
            --attrs "ci.deployment.version=${{ github.sha }}" \
            --attrs "ci.deployment.url=https://app.example.com" \
            -- \
            ./deploy.sh
```

#### GitLab CIç¤ºä¾‹

```yaml
# .gitlab-ci.yml
stages:
  - build
  - test
  - deploy

variables:
  OTEL_SERVICE_NAME: "gitlab-ci"
  OTEL_EXPORTER_OTLP_ENDPOINT: "http://collector:4317"

build:
  stage: build
  script:
    - |
      otel-cli span \
        --name "Build Application" \
        --attrs "ci.pipeline.id=${CI_PIPELINE_ID}" \
        --attrs "ci.pipeline.name=${CI_PIPELINE_URL}" \
        --attrs "ci.pipeline.vcs.branch=${CI_COMMIT_REF_NAME}" \
        --attrs "ci.pipeline.vcs.commit_sha=${CI_COMMIT_SHA}" \
        --attrs "ci.pipeline.vcs.commit_message=${CI_COMMIT_MESSAGE}" \
        --attrs "ci.job.name=${CI_JOB_NAME}" \
        --attrs "ci.job.id=${CI_JOB_ID}" \
        -- \
        npm run build

test:
  stage: test
  script:
    - |
      otel-cli span \
        --name "Run Tests" \
        --attrs "ci.pipeline.id=${CI_PIPELINE_ID}" \
        --attrs "ci.job.name=${CI_JOB_NAME}" \
        --attrs "ci.test.suite=integration_tests" \
        -- \
        npm test

deploy:
  stage: deploy
  only:
    - main
  script:
    - |
      otel-cli span \
        --name "Deploy to Production" \
        --attrs "ci.pipeline.id=${CI_PIPELINE_ID}" \
        --attrs "ci.deployment.environment=production" \
        --attrs "ci.deployment.version=${CI_COMMIT_SHA}" \
        --attrs "ci.deployment.url=https://app.example.com" \
        -- \
        ./deploy.sh
```

#### Jenkinsç¤ºä¾‹

```groovy
// Jenkinsfile
pipeline {
    agent any

    environment {
        OTEL_SERVICE_NAME = 'jenkins-pipeline'
        OTEL_EXPORTER_OTLP_ENDPOINT = 'http://collector:4317'
    }

    stages {
        stage('Build') {
            steps {
                script {
                    sh '''
                        otel-cli span \
                            --name "Build Application" \
                            --attrs "ci.pipeline.id=${BUILD_NUMBER}" \
                            --attrs "ci.pipeline.name=${JOB_NAME}" \
                            --attrs "ci.pipeline.url=${BUILD_URL}" \
                            --attrs "ci.pipeline.vcs.branch=${GIT_BRANCH}" \
                            --attrs "ci.pipeline.vcs.commit_sha=${GIT_COMMIT}" \
                            --attrs "ci.job.name=build" \
                            -- \
                            npm run build
                    '''
                }
            }
        }

        stage('Test') {
            steps {
                script {
                    sh '''
                        otel-cli span \
                            --name "Run Tests" \
                            --attrs "ci.pipeline.id=${BUILD_NUMBER}" \
                            --attrs "ci.job.name=test" \
                            --attrs "ci.test.suite=unit_tests" \
                            -- \
                            npm test
                    '''
                }
            }
        }

        stage('Deploy') {
            when {
                branch 'main'
            }
            steps {
                script {
                    sh '''
                        otel-cli span \
                            --name "Deploy to Production" \
                            --attrs "ci.pipeline.id=${BUILD_NUMBER}" \
                            --attrs "ci.deployment.environment=production" \
                            --attrs "ci.deployment.version=${GIT_COMMIT}" \
                            --attrs "ci.deployment.url=https://app.example.com" \
                            -- \
                            ./deploy.sh
                    '''
                }
            }
        }
    }
}
```

### 11.4 æŸ¥è¯¢å’Œåˆ†æ

#### æŸ¥è¯¢ç¤ºä¾‹

```text
# æŸ¥è¯¢ç‰¹å®šPipelineçš„æ‰€æœ‰Jobs
ci.pipeline.id = "12345"

# æŸ¥è¯¢å¤±è´¥çš„Pipeline
ci.pipeline.status = "failure"

# æŸ¥è¯¢ç‰¹å®šåˆ†æ”¯çš„Pipeline
ci.pipeline.vcs.branch = "main"

# æŸ¥è¯¢ç‰¹å®šç¯å¢ƒçš„éƒ¨ç½²
ci.deployment.environment = "production"

# æŸ¥è¯¢å¤±è´¥çš„æµ‹è¯•
ci.test.status = "fail"

# æŸ¥è¯¢æ…¢çš„Jobs (è¶…è¿‡5åˆ†é’Ÿ)
ci.job.duration > 300000
```

#### DORAæŒ‡æ ‡è®¡ç®—

```python
# dora_metrics.py - DORAæŒ‡æ ‡è®¡ç®—

from opentelemetry import trace
from opentelemetry.sdk.trace import TracerProvider

tracer = trace.get_tracer(__name__)

def calculate_dora_metrics(traces):
    """è®¡ç®—DORAæŒ‡æ ‡"""

    metrics = {
        'deployment_frequency': 0,  # éƒ¨ç½²é¢‘ç‡
        'lead_time': 0,  # å‰ç½®æ—¶é—´
        'mttr': 0,  # å¹³å‡æ¢å¤æ—¶é—´
        'change_failure_rate': 0  # å˜æ›´å¤±è´¥ç‡
    }

    # 1. éƒ¨ç½²é¢‘ç‡ (æ¯å¤©éƒ¨ç½²æ¬¡æ•°)
    deployments = [t for t in traces if 'ci.deployment.environment' in t.attributes]
    metrics['deployment_frequency'] = len(deployments) / 30  # å‡è®¾30å¤©

    # 2. å‰ç½®æ—¶é—´ (ä»æäº¤åˆ°éƒ¨ç½²çš„æ—¶é—´)
    for trace in traces:
        if 'ci.pipeline.vcs.commit_sha' in trace.attributes:
            commit_time = trace.start_time
            deploy_time = get_deploy_time(trace)
            if deploy_time:
                metrics['lead_time'] += (deploy_time - commit_time).total_seconds()

    # 3. MTTR (å¹³å‡æ¢å¤æ—¶é—´)
    failed_deployments = [d for d in deployments
                          if d.attributes.get('ci.deployment.status') == 'failure']
    if failed_deployments:
        recovery_times = [calculate_recovery_time(d) for d in failed_deployments]
        metrics['mttr'] = sum(recovery_times) / len(recovery_times)

    # 4. å˜æ›´å¤±è´¥ç‡
    total_changes = len(deployments)
    failed_changes = len(failed_deployments)
    metrics['change_failure_rate'] = failed_changes / total_changes if total_changes > 0 else 0

    return metrics
```

### 11.5 æœ€ä½³å®è·µ

```text
âœ… DO (æ¨è)
1. æ¯ä¸ªPipelineåˆ›å»ºæ ¹Span
2. æ¯ä¸ªStage/Jobåˆ›å»ºå­Span
3. ä½¿ç”¨æ ‡å‡†è¯­ä¹‰çº¦å®šå±æ€§
4. è®°å½•å…³é”®VCSä¿¡æ¯ (commit, branch, tag)
5. è®°å½•éƒ¨ç½²ç¯å¢ƒä¿¡æ¯
6. è®°å½•æµ‹è¯•ç»“æœå’Œè¦†ç›–ç‡
7. å…³è”æ„å»ºã€æµ‹è¯•ã€éƒ¨ç½²Span

âŒ DON'T (é¿å…)
1. ä¸è¦ä½¿ç”¨è‡ªå®šä¹‰å±æ€§å (ä½¿ç”¨æ ‡å‡†å±æ€§)
2. ä¸è¦è®°å½•æ•æ„Ÿä¿¡æ¯ (å¯†ç ã€å¯†é’¥)
3. ä¸è¦é˜»å¡Pipeline (å¼‚æ­¥å‘é€)
4. ä¸è¦è¿‡åº¦è¿½è¸ª (ä¿æŒ<5%å¼€é”€)

æ€§èƒ½ä¼˜åŒ–:
- ä½¿ç”¨æ‰¹å¤„ç†å‘é€Span
- é‡‡æ ·éå…³é”®æ­¥éª¤
- å¼‚æ­¥å‘é€åˆ°Collector
- ä½¿ç”¨æœ¬åœ°ç¼“å†²
```

### 11.6 æ•…éšœæ’æŸ¥

#### å¸¸è§é—®é¢˜

**1. å±æ€§æœªæ­£ç¡®è®¾ç½®**

```bash
# æ£€æŸ¥Spanå±æ€§
otel-cli span show --trace-id <trace-id>

# éªŒè¯å±æ€§å
# åº”è¯¥ä½¿ç”¨ ci.pipeline.id è€Œä¸æ˜¯ pipeline_id
```

**2. å…³è”å¤±è´¥**

```text
é—®é¢˜: Pipelineå’ŒDeploymentæ— æ³•å…³è”
è§£å†³: ç¡®ä¿ä½¿ç”¨ç›¸åŒçš„ ci.pipeline.id
```

**3. æ•°æ®ä¸¢å¤±**

```text
é—®é¢˜: éƒ¨åˆ†Spanæœªå‘é€åˆ°Collector
è§£å†³:
  - æ£€æŸ¥ç½‘ç»œè¿æ¥
  - å¢åŠ é‡è¯•æœºåˆ¶
  - ä½¿ç”¨æœ¬åœ°ç¼“å†²
```

---

## 12. å‚è€ƒèµ„æº

- **otel-cli**: <https://github.com/equinix-labs/otel-cli>
- **GitHub Actions**: <https://docs.github.com/actions>
- **GitLab CI**: <https://docs.gitlab.com/ee/ci/>
- **Jenkins**: <https://www.jenkins.io/doc/>
- **CI/CDè¯­ä¹‰çº¦å®š**: <https://github.com/open-telemetry/semantic-conventions/blob/main/docs/cicd/cicd-spans.md>
- **DORA Metrics**: <https://cloud.google.com/blog/products/devops-sre/using-the-four-keys-to-measure-your-devops-performance>

---

---

## ç¬¬åäºŒéƒ¨åˆ†: é«˜çº§CI/CDé›†æˆ (2025æœ€æ–°)

### 12.1 è‡ªåŠ¨åŒ–æµ‹è¯•é›†æˆ

#### æµ‹è¯•è¿½è¸ªé›†æˆ

```yaml
# .github/workflows/test-with-tracing.yml
name: Test with Tracing

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup OpenTelemetry
        uses: open-telemetry/setup-otel-cli@v1

      - name: Run Unit Tests
        run: |
          otel-cli span \
            --name "Unit Tests" \
            --attrs "ci.pipeline.id=${{ github.run_id }}" \
            --attrs "ci.job.name=unit-tests" \
            --attrs "ci.test.suite=unit_tests" \
            -- \
            pytest tests/unit --cov=src

      - name: Run Integration Tests
        run: |
          otel-cli span \
            --name "Integration Tests" \
            --attrs "ci.pipeline.id=${{ github.run_id }}" \
            --attrs "ci.job.name=integration-tests" \
            --attrs "ci.test.suite=integration_tests" \
            -- \
            pytest tests/integration

      - name: Run E2E Tests
        run: |
          otel-cli span \
            --name "E2E Tests" \
            --attrs "ci.pipeline.id=${{ github.run_id }}" \
            --attrs "ci.job.name=e2e-tests" \
            --attrs "ci.test.suite=e2e_tests" \
            -- \
            pytest tests/e2e
```

### 12.2 è´¨é‡é—¨ç¦é›†æˆ

#### è´¨é‡é—¨ç¦é…ç½®

```yaml
# quality-gates.yml
quality_gates:
  unit_tests:
    coverage_threshold: 80
    pass_rate: 100

  integration_tests:
    pass_rate: 95

  e2e_tests:
    pass_rate: 90

  performance:
    p99_latency: 100ms
    throughput: 1000 req/s

  security:
    vulnerabilities: 0
    license_check: pass
```

#### é—¨ç¦æ£€æŸ¥è„šæœ¬

```python
# quality_gate_checker.py
import json
from typing import Dict

class QualityGateChecker:
    """è´¨é‡é—¨ç¦æ£€æŸ¥å™¨"""

    def check(self, test_results: Dict, gates: Dict) -> bool:
        """æ£€æŸ¥è´¨é‡é—¨ç¦"""

        all_passed = True

        # æ£€æŸ¥å•å…ƒæµ‹è¯•
        unit_tests = test_results.get('unit_tests', {})
        if unit_tests.get('coverage', 0) < gates['unit_tests']['coverage_threshold']:
            print(f"âŒ å•å…ƒæµ‹è¯•è¦†ç›–ç‡ä¸è¶³: {unit_tests.get('coverage')}% < {gates['unit_tests']['coverage_threshold']}%")
            all_passed = False

        if unit_tests.get('pass_rate', 0) < gates['unit_tests']['pass_rate']:
            print(f"âŒ å•å…ƒæµ‹è¯•é€šè¿‡ç‡ä¸è¶³: {unit_tests.get('pass_rate')}% < {gates['unit_tests']['pass_rate']}%")
            all_passed = False

        # æ£€æŸ¥é›†æˆæµ‹è¯•
        integration_tests = test_results.get('integration_tests', {})
        if integration_tests.get('pass_rate', 0) < gates['integration_tests']['pass_rate']:
            print(f"âŒ é›†æˆæµ‹è¯•é€šè¿‡ç‡ä¸è¶³: {integration_tests.get('pass_rate')}% < {gates['integration_tests']['pass_rate']}%")
            all_passed = False

        # æ£€æŸ¥æ€§èƒ½
        performance = test_results.get('performance', {})
        if performance.get('p99_latency', 0) > gates['performance']['p99_latency']:
            print(f"âŒ P99å»¶è¿Ÿè¶…æ ‡: {performance.get('p99_latency')} > {gates['performance']['p99_latency']}")
            all_passed = False

        if all_passed:
            print("âœ… æ‰€æœ‰è´¨é‡é—¨ç¦é€šè¿‡")

        return all_passed
```

### 12.3 è‡ªåŠ¨åŒ–éƒ¨ç½²è¿½è¸ª

#### éƒ¨ç½²è¿½è¸ªé›†æˆ

```yaml
# deployment-tracking.yml
name: Deploy with Tracing

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup OpenTelemetry
        uses: open-telemetry/setup-otel-cli@v1

      - name: Deploy to Staging
        run: |
          otel-cli span \
            --name "Deploy to Staging" \
            --attrs "ci.pipeline.id=${{ github.run_id }}" \
            --attrs "ci.deployment.environment=staging" \
            --attrs "ci.deployment.version=${{ github.sha }}" \
            --attrs "ci.deployment.url=https://staging.example.com" \
            -- \
            ./deploy.sh staging

      - name: Run Smoke Tests
        run: |
          otel-cli span \
            --name "Smoke Tests" \
            --attrs "ci.pipeline.id=${{ github.run_id }}" \
            --attrs "ci.test.suite=smoke_tests" \
            -- \
            pytest tests/smoke

      - name: Deploy to Production
        if: success()
        run: |
          otel-cli span \
            --name "Deploy to Production" \
            --attrs "ci.pipeline.id=${{ github.run_id }}" \
            --attrs "ci.deployment.environment=production" \
            --attrs "ci.deployment.version=${{ github.sha }}" \
            --attrs "ci.deployment.url=https://app.example.com" \
            -- \
            ./deploy.sh production
```

### 12.4 æ€§èƒ½å›å½’æ£€æµ‹

#### æ€§èƒ½åŸºå‡†æµ‹è¯•

```yaml
# performance-regression.yml
name: Performance Regression Test

on:
  pull_request:
    branches: [main]

jobs:
  performance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Run Performance Tests
        run: |
          # è¿è¡Œæ€§èƒ½æµ‹è¯•
          k6 run performance-test.js --out json=results.json

      - name: Compare with Baseline
        run: |
          python compare_performance.py \
            --baseline baseline.json \
            --current results.json \
            --threshold 10  # å…è®¸10%æ€§èƒ½ä¸‹é™

      - name: Report Results
        if: always()
        run: |
          otel-cli span \
            --name "Performance Test" \
            --attrs "ci.pipeline.id=${{ github.run_id }}" \
            --attrs "ci.test.suite=performance_tests" \
            --attrs "performance.p99_latency=$(jq -r '.metrics.http_req_duration.values.p99' results.json)" \
            --attrs "performance.throughput=$(jq -r '.metrics.http_reqs.values.rate' results.json)"
```

---

## ç¬¬åä¸‰éƒ¨åˆ†: ç›‘æ§ä¸å‘Šè­¦

### 13.1 CI/CDæŒ‡æ ‡ç›‘æ§

#### PrometheusæŒ‡æ ‡

```yaml
# prometheus-ci-metrics.yml
scrape_configs:
- job_name: 'ci-cd-metrics'
  static_configs:
  - targets: ['ci-server:9090']

  # CI/CDå…³é”®æŒ‡æ ‡
  metrics:
    - ci_pipeline_duration_seconds
    - ci_pipeline_success_rate
    - ci_test_coverage_percentage
    - ci_deployment_frequency
    - ci_lead_time_seconds
```

#### Grafanaä»ªè¡¨ç›˜

```json
{
  "dashboard": {
    "title": "CI/CD Metrics",
    "panels": [
      {
        "title": "Pipeline Success Rate",
        "targets": [
          {
            "expr": "sum(rate(ci_pipeline_total{status=\"success\"}[5m])) / sum(rate(ci_pipeline_total[5m]))"
          }
        ]
      },
      {
        "title": "Average Pipeline Duration",
        "targets": [
          {
            "expr": "avg(ci_pipeline_duration_seconds)"
          }
        ]
      },
      {
        "title": "Deployment Frequency",
        "targets": [
          {
            "expr": "sum(rate(ci_deployment_total[1h]))"
          }
        ]
      }
    ]
  }
}
```

### 13.2 å‘Šè­¦è§„åˆ™

#### CI/CDå‘Šè­¦

```yaml
# ci-cd-alerts.yml
groups:
- name: cicd_alerts
  rules:
  - alert: HighPipelineFailureRate
    expr: |
      sum(rate(ci_pipeline_total{status="failure"}[5m])) /
      sum(rate(ci_pipeline_total[5m])) > 0.1
    for: 5m
    annotations:
      summary: "Pipelineå¤±è´¥ç‡è¿‡é«˜"
      description: "Pipelineå¤±è´¥ç‡è¶…è¿‡10%"

  - alert: SlowPipeline
    expr: |
      avg(ci_pipeline_duration_seconds) > 1800
    for: 10m
    annotations:
      summary: "Pipelineæ‰§è¡Œæ—¶é—´è¿‡é•¿"
      description: "Pipelineå¹³å‡æ‰§è¡Œæ—¶é—´è¶…è¿‡30åˆ†é’Ÿ"

  - alert: LowTestCoverage
    expr: |
      avg(ci_test_coverage_percentage) < 80
    for: 1h
    annotations:
      summary: "æµ‹è¯•è¦†ç›–ç‡ä¸è¶³"
      description: "æµ‹è¯•è¦†ç›–ç‡ä½äº80%"
```

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å®Œæˆ (3,500+ è¡Œ)
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸
**æœ€åæ›´æ–°**: 2025å¹´12æœˆ
**ç›¸å…³æ–‡æ¡£**: [æ•…éšœæ’æŸ¥](../08_æ•…éšœæ’æŸ¥/01_å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ.md), [æ€§èƒ½ä¼˜åŒ–](../05_é‡‡æ ·ä¸æ€§èƒ½/02_æ€§èƒ½ä¼˜åŒ–å®è·µ.md), [è¯­ä¹‰çº¦å®š](../02_Semantic_Conventions/README.md), [è‡ªåŠ¨åŒ–æµ‹è¯•å·¥å…·](../å·¥å…·/è‡ªåŠ¨åŒ–æµ‹è¯•å·¥å…·å®Œæ•´æŒ‡å—.md)

# ğŸ“Š OTLPæ•°æ®æ¨¡å‹ä¸è¯­ä¹‰è½¬æ¢å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´10æœˆ20æ—¥  
> **å¯¹æ ‡æ ‡å‡†**: OTLP v1.3.0 + Semantic Conventions v1.29.0  
> **è¦†ç›–èŒƒå›´**: è¯­ä¹‰æ¨¡å‹ Â· æ•°æ®è½¬æ¢ Â· ç”Ÿå‘½å‘¨æœŸç®¡ç† Â· æˆç†Ÿæ¡ˆä¾‹

---

## ğŸ¯ æ ¸å¿ƒé—®é¢˜åŸŸ

æœ¬æ–‡æ¡£å…¨é¢æ¢³ç†OTLPæ ‡å‡†è§„å®šçš„è¯­ä¹‰æ¨¡å‹ï¼Œä»¥åŠæ•°æ®åœ¨æ•´ä¸ªå¯è§‚æµ‹æ€§ç³»ç»Ÿä¸­çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼š

```text
æ•°æ®ç”Ÿå‘½å‘¨æœŸå®Œæ•´é“¾è·¯:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·åº”ç”¨ â†’ æ•°æ®æ”¶é›† â†’ æ•°æ®è½¬æ¢ â†’ æ•°æ®å­˜å‚¨ â†’ æ•°æ®å¤„ç† â†’ æ•°æ®æŸ¥è¯¢  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“          â†“          â†“          â†“          â†“          â†“
  è‡ªå®šä¹‰    SDKæ ‡å‡†åŒ–   Collector   åç«¯é€‰æ‹©   å®æ—¶/æ‰¹å¤„ç†  åˆ†æå±•ç°
  ä¸šåŠ¡æ¨¡å‹   â†’è¯­ä¹‰çº¦å®š   è½¬æ¢å™¨      å­˜å‚¨å¼•æ“    èšåˆè®¡ç®—    å¯è§†åŒ–
```

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šOTLPæ ‡å‡†è¯­ä¹‰æ¨¡å‹å®Œæ•´æ¢³ç†

### 1.1 è¯­ä¹‰æ¨¡å‹å±‚æ¬¡ç»“æ„

#### 1.1.1 ä¸‰å±‚è¯­ä¹‰æ¨¡å‹

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  OTLPè¯­ä¹‰æ¨¡å‹å®Œæ•´ä½“ç³»                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ğŸ“Š ç¬¬ä¸€å±‚ï¼šèµ„æºæ¨¡å‹ (Resource Model)                       â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚  å®šä¹‰ï¼šæè¿°é¥æµ‹æ•°æ®æ¥æºçš„é™æ€å±æ€§                            â”‚
â”‚  ç”Ÿå‘½å‘¨æœŸï¼šè¿›ç¨‹çº§åˆ«ï¼Œå¯åŠ¨æ—¶ç¡®å®šï¼Œè¿è¡ŒæœŸä¸å˜                    â”‚
â”‚                                                             â”‚
â”‚  Resource = âŸ¨                                               â”‚
â”‚    service.name: string          (å¿…éœ€)                     â”‚
â”‚    service.version: string       (æ¨è)                     â”‚
â”‚    service.namespace: string     (å¯é€‰)                     â”‚
â”‚    service.instance.id: string   (æ¨è)                     â”‚
â”‚    deployment.environment: string (æ¨è)                    â”‚
â”‚    telemetry.sdk.name: string    (å¿…éœ€)                     â”‚
â”‚    telemetry.sdk.version: string (å¿…éœ€)                     â”‚
â”‚    + å¹³å°å±æ€§ (host.*, container.*, k8s.*, cloud.*)         â”‚
â”‚  âŸ©                                                          â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ğŸ“ˆ ç¬¬äºŒå±‚ï¼šä»ªå™¨åŒ–ä½œç”¨åŸŸ (Instrumentation Scope)             â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚  å®šä¹‰ï¼šé¥æµ‹æ•°æ®çš„ç”Ÿäº§è€…æ ‡è¯†                                  â”‚
â”‚  ç”¨é€”ï¼šåŒºåˆ†ä¸åŒåº“ã€æ¡†æ¶ã€è‡ªåŠ¨ä»ªå™¨åŒ–çš„æ•°æ®                      â”‚
â”‚                                                             â”‚
â”‚  InstrumentationScope = âŸ¨                                   â”‚
â”‚    name: string           (å¿…éœ€) å¦‚ "io.opentelemetry.api"  â”‚
â”‚    version: string        (å¯é€‰) å¦‚ "1.30.0"                â”‚
â”‚    schema_url: string     (å¯é€‰) è¯­ä¹‰çº¦å®šç‰ˆæœ¬URL              â”‚
â”‚    attributes: Map[K,V]   (å¯é€‰) ä½œç”¨åŸŸçº§åˆ«å±æ€§               â”‚
â”‚  âŸ©                                                          â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ğŸ“Š ç¬¬ä¸‰å±‚ï¼šé¥æµ‹æ•°æ®æ¨¡å‹ (Telemetry Data Model)              â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚  ä¸‰ç§ä¿¡å·ç±»å‹ï¼Œå„æœ‰ç‹¬ç«‹çš„æ•°æ®æ¨¡å‹                            â”‚
â”‚                                                             â”‚
â”‚  1ï¸âƒ£ Trace Model (é“¾è·¯è¿½è¸ª)                                â”‚
â”‚     Span = âŸ¨trace_id, span_id, parent_span_id, name,       â”‚
â”‚              start_time, end_time, attributes, events,      â”‚
â”‚              links, statusâŸ©                                 â”‚
â”‚                                                             â”‚
â”‚  2ï¸âƒ£ Metric Model (æŒ‡æ ‡æ•°æ®)                               â”‚
â”‚     Metric = âŸ¨name, description, unit, type,               â”‚
â”‚                data_points[]âŸ©                               â”‚
â”‚     ç±»å‹: Sum, Gauge, Histogram, ExponentialHistogram       â”‚
â”‚                                                             â”‚
â”‚  3ï¸âƒ£ Log Model (æ—¥å¿—è®°å½•)                                  â”‚
â”‚     LogRecord = âŸ¨timestamp, observed_timestamp,            â”‚
â”‚                   severity_number, severity_text, body,     â”‚
â”‚                   attributes, trace_id, span_idâŸ©            â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ‡å‡†è§„å®šçš„è¯­ä¹‰çº¦å®šæ¢³ç†

#### 1.2.1 HTTPè¯­ä¹‰çº¦å®š (v1.29.0)

**å®¢æˆ·ç«¯ Span å±æ€§**:

| å±æ€§å | ç±»å‹ | å¿…éœ€æ€§ | ç¤ºä¾‹å€¼ | è¯´æ˜ |
|-------|------|-------|-------|------|
| `http.request.method` | string | Required | "GET" | HTTPæ–¹æ³• |
| `server.address` | string | Required | "api.example.com" | æœåŠ¡å™¨åœ°å€ |
| `server.port` | int | Conditional | 443 | æœåŠ¡å™¨ç«¯å£ |
| `url.full` | string | Required | "<https://api.example.com/v1/users>" | å®Œæ•´URL |
| `url.scheme` | string | Required | "https" | URLåè®® |
| `url.path` | string | Required | "/v1/users" | URLè·¯å¾„ |
| `http.response.status_code` | int | Recommended | 200 | å“åº”çŠ¶æ€ç  |
| `http.request.body.size` | int | Optional | 1024 | è¯·æ±‚ä½“å¤§å° |
| `http.response.body.size` | int | Optional | 2048 | å“åº”ä½“å¤§å° |
| `network.protocol.version` | string | Recommended | "1.1" | HTTPç‰ˆæœ¬ |
| `user_agent.original` | string | Recommended | "Mozilla/5.0..." | User-Agent |

**æœåŠ¡ç«¯ Span å±æ€§**:

| å±æ€§å | ç±»å‹ | å¿…éœ€æ€§ | ç¤ºä¾‹å€¼ | è¯´æ˜ |
|-------|------|-------|-------|------|
| `http.request.method` | string | Required | "POST" | HTTPæ–¹æ³• |
| `http.route` | string | Required | "/api/users/{id}" | è·¯ç”±æ¨¡æ¿ |
| `url.path` | string | Required | "/api/users/123" | å®é™…è·¯å¾„ |
| `url.scheme` | string | Required | "https" | åè®® |
| `server.address` | string | Recommended | "0.0.0.0" | ç›‘å¬åœ°å€ |
| `server.port` | int | Recommended | 8080 | ç›‘å¬ç«¯å£ |
| `client.address` | string | Conditional | "192.168.1.100" | å®¢æˆ·ç«¯IP |
| `http.response.status_code` | int | Recommended | 201 | å“åº”çŠ¶æ€ç  |

#### 1.2.2 æ•°æ®åº“è¯­ä¹‰çº¦å®š (v1.29.0)

**é€šç”¨æ•°æ®åº“å±æ€§**:

| å±æ€§å | ç±»å‹ | å¿…éœ€æ€§ | æšä¸¾å€¼/ç¤ºä¾‹ | è¯´æ˜ |
|-------|------|-------|-----------|------|
| `db.system` | string | Required | "postgresql", "mysql", "mongodb", "redis" | æ•°æ®åº“ç±»å‹ |
| `db.name` | string | Recommended | "mydb" | æ•°æ®åº“å |
| `db.operation` | string | Recommended | "SELECT", "INSERT", "UPDATE", "find" | æ“ä½œç±»å‹ |
| `db.statement` | string | Recommended | "SELECT * FROM users WHERE id = ?" | SQLè¯­å¥(éœ€è„±æ•) |
| `server.address` | string | Conditional | "db.example.com" | æ•°æ®åº“æœåŠ¡å™¨ |
| `server.port` | int | Conditional | 5432 | ç«¯å£ |
| `network.peer.address` | string | Recommended | "10.0.0.5" | å¯¹ç«¯åœ°å€ |

**SQLç‰¹å®šå±æ€§**:

| å±æ€§å | ç±»å‹ | å¿…éœ€æ€§ | ç¤ºä¾‹å€¼ | è¯´æ˜ |
|-------|------|-------|-------|------|
| `db.sql.table` | string | Recommended | "users" | è¡¨å |
| `db.operation.batch` | boolean | Optional | true | æ˜¯å¦æ‰¹é‡æ“ä½œ(v1.29.0æ–°å¢) |

**NoSQLç‰¹å®šå±æ€§ (MongoDB)**:

| å±æ€§å | ç±»å‹ | å¿…éœ€æ€§ | ç¤ºä¾‹å€¼ | è¯´æ˜ |
|-------|------|-------|-------|------|
| `db.mongodb.collection` | string | Required | "users" | é›†åˆå |
| `db.operation` | string | Required | "find", "insert", "update" | æ“ä½œç±»å‹ |

#### 1.2.3 æ¶ˆæ¯é˜Ÿåˆ—è¯­ä¹‰çº¦å®š (v1.29.0)

**Kafkaç‰¹å®šå±æ€§**:

| å±æ€§å | ç±»å‹ | å¿…éœ€æ€§ | ç¤ºä¾‹å€¼ | è¯´æ˜ |
|-------|------|-------|-------|------|
| `messaging.system` | string | Required | "kafka" | æ¶ˆæ¯ç³»ç»Ÿ |
| `messaging.destination.name` | string | Required | "orders" | Topicåç§° |
| `messaging.operation` | string | Required | "publish", "receive", "process" | æ“ä½œç±»å‹ |
| `messaging.message.id` | string | Recommended | "msg-123456" | æ¶ˆæ¯ID |
| `kafka.message.key` | string | Recommended | "order-001" | æ¶ˆæ¯Key |
| `kafka.consumer.group` | string | Conditional | "order-processor" | æ¶ˆè´¹ç»„ |
| `kafka.partition` | int | Recommended | 3 | åˆ†åŒºå· |
| `kafka.offset` | int | Recommended | 12345 | Offset |

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šè‡ªå®šä¹‰æ•°æ®æ¨¡å‹è®¾è®¡

### 2.1 ç”¨æˆ·è‡ªå®šä¹‰å±æ€§çš„è®¾è®¡åŸåˆ™

#### 2.1.1 å‘½åç©ºé—´è§„èŒƒ

**æ ‡å‡†è¦æ±‚**:

```text
è‡ªå®šä¹‰å±æ€§å¿…é¡»ä½¿ç”¨vendorå‰ç¼€ï¼Œé¿å…ä¸æ ‡å‡†å±æ€§å†²çª:

æ ¼å¼: <vendor>.<domain>.<attribute>

âœ… æ­£ç¡®ç¤ºä¾‹:
- mycompany.order.priority: "high"
- acme.payment.method: "credit_card"
- shopify.cart.item_count: 5

âŒ é”™è¯¯ç¤ºä¾‹:
- order.priority  (æ— vendorå‰ç¼€ï¼Œå¯èƒ½å†²çª)
- OrderPriority   (ä¸ç¬¦åˆå‘½åé£æ ¼)
- order-priority  (åº”è¯¥ç”¨ä¸‹åˆ’çº¿)
```

#### 2.1.2 ä¸šåŠ¡é¢†åŸŸæ•°æ®æ¨¡å‹æ¡ˆä¾‹

**æ¡ˆä¾‹1: ç”µå•†è®¢å•è¿½è¸ª**:

```yaml
# è‡ªå®šä¹‰è¯­ä¹‰çº¦å®šå®šä¹‰
namespace: myshop.order

attributes:
  # è®¢å•åŸºæœ¬ä¿¡æ¯
  myshop.order.id:
    type: string
    requirement: required
    description: è®¢å•å”¯ä¸€æ ‡è¯†
    example: "ORDER-2024-001234"
    
  myshop.order.status:
    type: enum
    requirement: required
    values: ["pending", "paid", "shipped", "delivered", "cancelled"]
    description: è®¢å•çŠ¶æ€
    
  myshop.order.total_amount:
    type: double
    requirement: required
    description: è®¢å•æ€»é‡‘é¢(USD)
    example: 99.99
    
  myshop.order.item_count:
    type: int
    requirement: recommended
    description: è®¢å•å•†å“æ•°é‡
    example: 3
    
  # ç”¨æˆ·ä¿¡æ¯
  myshop.user.tier:
    type: enum
    requirement: recommended
    values: ["free", "silver", "gold", "platinum"]
    description: ç”¨æˆ·ç­‰çº§
    
  myshop.user.segment:
    type: string
    requirement: optional
    description: ç”¨æˆ·ç»†åˆ†æ ‡ç­¾
    example: "high_value_customer"
    
  # ä¿ƒé”€ä¿¡æ¯
  myshop.promotion.code:
    type: string
    requirement: optional
    description: ä¿ƒé”€ç 
    example: "SUMMER2024"
    
  myshop.promotion.discount_percent:
    type: double
    requirement: conditional
    description: æŠ˜æ‰£ç™¾åˆ†æ¯”
    example: 20.0
```

**åº”ç”¨åˆ°Span**:

```go
// Go SDK å®ç°
import (
    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/attribute"
)

func ProcessOrder(ctx context.Context, order Order) error {
    tracer := otel.Tracer("myshop.order-service")
    
    ctx, span := tracer.Start(ctx, "process_order",
        trace.WithAttributes(
            // æ ‡å‡†HTTPå±æ€§
            attribute.String("http.request.method", "POST"),
            attribute.String("http.route", "/api/orders"),
            attribute.Int("http.response.status_code", 201),
            
            // è‡ªå®šä¹‰ä¸šåŠ¡å±æ€§
            attribute.String("myshop.order.id", order.ID),
            attribute.String("myshop.order.status", string(order.Status)),
            attribute.Float64("myshop.order.total_amount", order.TotalAmount),
            attribute.Int("myshop.order.item_count", len(order.Items)),
            attribute.String("myshop.user.tier", string(order.User.Tier)),
            
            // æ¡ä»¶å±æ€§
            attribute.String("myshop.promotion.code", 
                order.PromotionCode), // ä»…å½“æœ‰ä¿ƒé”€æ—¶
        ),
    )
    defer span.End()
    
    // ä¸šåŠ¡é€»è¾‘...
    
    return nil
}
```

**æ¡ˆä¾‹2: é‡‘èäº¤æ˜“è¿½è¸ª**:

```yaml
namespace: fintech.transaction

attributes:
  # äº¤æ˜“æ ¸å¿ƒå±æ€§
  fintech.transaction.id:
    type: string
    requirement: required
    description: äº¤æ˜“å”¯ä¸€ID
    example: "TXN-20241020-123456"
    
  fintech.transaction.type:
    type: enum
    requirement: required
    values: ["payment", "refund", "transfer", "withdrawal"]
    description: äº¤æ˜“ç±»å‹
    
  fintech.transaction.amount:
    type: double
    requirement: required
    description: äº¤æ˜“é‡‘é¢
    example: 1500.00
    
  fintech.transaction.currency:
    type: string
    requirement: required
    description: è´§å¸ä»£ç (ISO 4217)
    example: "USD"
    
  # é£æ§å±æ€§
  fintech.risk.score:
    type: double
    requirement: recommended
    description: é£é™©è¯„åˆ†(0-100)
    example: 25.5
    
  fintech.risk.level:
    type: enum
    requirement: recommended
    values: ["low", "medium", "high", "critical"]
    description: é£é™©ç­‰çº§
    
  fintech.fraud.detected:
    type: boolean
    requirement: conditional
    description: æ˜¯å¦æ£€æµ‹åˆ°æ¬ºè¯ˆ
    example: false
    
  # åˆè§„å±æ€§
  fintech.compliance.aml_check:
    type: boolean
    requirement: required
    description: æ˜¯å¦å®Œæˆåæ´—é’±æ£€æŸ¥
    example: true
    
  fintech.compliance.kyc_verified:
    type: boolean
    requirement: required
    description: KYCéªŒè¯çŠ¶æ€
    example: true
```

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ•°æ®ç”Ÿå‘½å‘¨æœŸå®Œæ•´æµç¨‹

### 3.1 æ•°æ®æ”¶é›†é˜¶æ®µ

#### 3.1.1 SDKè‡ªåŠ¨æ”¶é›† vs æ‰‹åŠ¨åŸ‹ç‚¹

**è‡ªåŠ¨æ”¶é›†** (é€šè¿‡Auto-instrumentation):

```python
# Python - è‡ªåŠ¨ä»ªå™¨åŒ–ç¤ºä¾‹
from opentelemetry.instrumentation.flask import FlaskInstrumentor
from opentelemetry.instrumentation.requests import RequestsInstrumentor
from opentelemetry.instrumentation.sqlalchemy import SQLAlchemyInstrumentor

# è‡ªåŠ¨æ”¶é›†HTTPè¯·æ±‚
FlaskInstrumentor().instrument_app(app)

# è‡ªåŠ¨æ”¶é›†å¤–éƒ¨HTTPè°ƒç”¨
RequestsInstrumentor().instrument()

# è‡ªåŠ¨æ”¶é›†æ•°æ®åº“æŸ¥è¯¢
SQLAlchemyInstrumentor().instrument(engine=engine)

# ä»¥ä¸Šä»£ç è‡ªåŠ¨ç”Ÿæˆæ ‡å‡†è¯­ä¹‰çº¦å®šçš„å±æ€§:
# - http.request.method
# - http.response.status_code
# - db.system
# - db.statement
# ç­‰ç­‰...
```

**æ‰‹åŠ¨åŸ‹ç‚¹** (è‡ªå®šä¹‰ä¸šåŠ¡å±æ€§):

```python
from opentelemetry import trace

tracer = trace.get_tracer(__name__)

@app.route('/api/orders', methods=['POST'])
def create_order():
    with tracer.start_as_current_span(
        "create_order",
        attributes={
            # æ ‡å‡†å±æ€§(è‡ªåŠ¨ä»ªå™¨åŒ–å·²æ·»åŠ ):
            # "http.request.method": "POST"
            # "http.route": "/api/orders"
            
            # æ‰‹åŠ¨æ·»åŠ ä¸šåŠ¡å±æ€§:
            "myshop.order.id": order_id,
            "myshop.order.total_amount": total_amount,
            "myshop.user.tier": user_tier,
        }
    ) as span:
        # ä¸šåŠ¡é€»è¾‘
        order = process_order(data)
        
        # åŠ¨æ€æ·»åŠ å±æ€§
        span.set_attribute("myshop.order.status", order.status)
        
        # è®°å½•äº‹ä»¶
        span.add_event(
            "order_created",
            attributes={
                "myshop.order.id": order.id,
                "myshop.order.item_count": len(order.items)
            }
        )
        
        return order
```

### 3.2 æ•°æ®è½¬æ¢é˜¶æ®µ (Collector Pipeline)

#### 3.2.1 Collectorå¤„ç†æµç¨‹

```yaml
# OpenTelemetry Collector é…ç½®
# æ•°æ®è½¬æ¢å’Œä¸°å¯ŒåŒ–

receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317

processors:
  # 1. æ‰¹å¤„ç† - æ€§èƒ½ä¼˜åŒ–
  batch:
    timeout: 1s
    send_batch_size: 512
    
  # 2. èµ„æºæ£€æµ‹ - è‡ªåŠ¨æ·»åŠ äº‘å¹³å°å±æ€§
  resourcedetection:
    detectors: [env, system, docker, ec2, ecs, gcp, azure]
    timeout: 5s
    
  # 3. å±æ€§å¤„ç† - æ•°æ®è½¬æ¢å’Œæ¸…æ´—
  attributes:
    actions:
      # é‡å‘½åå±æ€§
      - key: http.method
        action: update
        from_attribute: http.request.method
        
      # åˆ é™¤æ•æ„Ÿå±æ€§
      - key: http.request.header.authorization
        action: delete
        
      # å“ˆå¸ŒåŒ–PII
      - key: user.email
        action: hash
        
      # æ·»åŠ å›ºå®šå±æ€§
      - key: deployment.environment
        action: insert
        value: "production"
        
  # 4. èµ„æºå¤„ç† - åˆå¹¶èµ„æºå±æ€§
  resource:
    attributes:
      - key: service.namespace
        value: "mycompany"
        action: insert
        
  # 5. æ•°æ®è¿‡æ»¤ - é‡‡æ ·å’Œè¿‡æ»¤
  filter:
    traces:
      span:
        # åªä¿ç•™é”™è¯¯traceå’Œæ…¢trace
        - 'attributes["http.response.status_code"] >= 400'
        - 'duration > 2000000000'  # > 2ç§’
        
  # 6. Span Metrics - ä»Traceç”ŸæˆMetrics
  spanmetrics:
    metrics_exporter: prometheus
    latency_histogram_buckets: [2ms, 4ms, 6ms, 8ms, 10ms, 50ms, 100ms]
    dimensions:
      - name: http.method
      - name: http.status_code
      - name: myshop.user.tier  # è‡ªå®šä¹‰ç»´åº¦
        
  # 7. Tail Sampling - å°¾éƒ¨é‡‡æ ·
  tail_sampling:
    decision_wait: 10s
    policies:
      # æ‰€æœ‰é”™è¯¯trace
      - name: error-policy
        type: status_code
        status_code: {status_codes: [ERROR]}
        
      # æ…¢trace
      - name: slow-trace-policy
        type: latency
        latency: {threshold_ms: 2000}
        
      # æŒ‰ä¸šåŠ¡å±æ€§é‡‡æ ·
      - name: vip-user-policy
        type: attribute
        attribute: {key: myshop.user.tier, values: [platinum, gold]}

exporters:
  # å¯¼å‡ºåˆ°å¤šä¸ªåç«¯
  otlp/jaeger:
    endpoint: jaeger:4317
    
  prometheusremotewrite:
    endpoint: http://prometheus:9090/api/v1/write
    
  elasticsearch:
    endpoints: [http://elasticsearch:9200]
    logs_index: logs-otlp
    
  kafka:
    brokers: [kafka:9092]
    topic: otlp-traces

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [resourcedetection, attributes, resource, 
                   tail_sampling, spanmetrics, batch]
      exporters: [otlp/jaeger, kafka]
      
    metrics:
      receivers: [otlp]
      processors: [resourcedetection, batch]
      exporters: [prometheusremotewrite]
      
    logs:
      receivers: [otlp]
      processors: [resourcedetection, attributes, batch]
      exporters: [elasticsearch]
```

#### 3.2.2 æ•°æ®è½¬æ¢é€»è¾‘ç¤ºä¾‹

**åœºæ™¯: å°†è‡ªå®šä¹‰å±æ€§è½¬æ¢ä¸ºæ ‡å‡†æŒ‡æ ‡**:

```yaml
# Collectoré…ç½® - ä»Traceå±æ€§ç”ŸæˆMetric
processors:
  spanmetrics:
    metrics_exporter: prometheus
    
    # ç”Ÿæˆå»¶è¿Ÿç›´æ–¹å›¾
    latency_histogram_buckets: [10ms, 50ms, 100ms, 500ms, 1s, 5s]
    
    # ç»´åº¦é…ç½®
    dimensions:
      # æ ‡å‡†ç»´åº¦
      - name: http.method
      - name: http.status_code
      - name: service.name
      
      # è‡ªå®šä¹‰ä¸šåŠ¡ç»´åº¦
      - name: myshop.order.status
      - name: myshop.user.tier
      - name: myshop.promotion.code
        
    # ç”Ÿæˆçš„Metricåç§°
    # calls_total{http_method="GET", http_status_code="200", 
    #             myshop_user_tier="gold"} 1234
    # duration_milliseconds_sum{...} 5678.9
    # duration_milliseconds_count{...} 100
```

**ç”Ÿæˆçš„Prometheus Metrics**:

```promql
# æŒ‰ç”¨æˆ·ç­‰çº§ç»Ÿè®¡è®¢å•å¤„ç†å»¶è¿Ÿ
histogram_quantile(0.95, 
  sum(rate(duration_milliseconds_bucket{
    service_name="order-service",
    myshop_user_tier="gold"
  }[5m])) by (le)
)

# æŒ‰ä¿ƒé”€æ´»åŠ¨ç»Ÿè®¡è®¢å•é‡
sum(rate(calls_total{
  myshop_promotion_code!=""
}[5m])) by (myshop_promotion_code)

# VIPç”¨æˆ·é”™è¯¯ç‡
sum(rate(calls_total{
  myshop_user_tier=~"gold|platinum",
  http_status_code=~"5.."
}[5m])) 
/ 
sum(rate(calls_total{
  myshop_user_tier=~"gold|platinum"
}[5m]))
```

---

### 3.3 æ•°æ®å­˜å‚¨é˜¶æ®µ

#### 3.3.1 ä¸åŒåç«¯çš„æ•°æ®æ¨¡å‹æ˜ å°„

**Elasticsearch (æ—¥å¿—å­˜å‚¨)**:

```json
{
  "_index": "traces-2024.10.20",
  "_id": "span-123456",
  "_source": {
    // æ ‡å‡†OTLPå­—æ®µ
    "trace_id": "4bf92f3577b34da6a3ce929d0e0e4736",
    "span_id": "00f067aa0ba902b7",
    "parent_span_id": "00f067aa0ba902b6",
    "name": "POST /api/orders",
    "kind": "SERVER",
    "start_time": "2024-10-20T10:30:00.000Z",
    "end_time": "2024-10-20T10:30:00.250Z",
    "duration_ms": 250,
    "status": {
      "code": "OK"
    },
    
    // Resourceå±æ€§
    "resource": {
      "service.name": "order-service",
      "service.version": "1.2.3",
      "deployment.environment": "production",
      "host.name": "prod-server-01",
      "k8s.pod.name": "order-service-7d4f8b9c-xk2lp"
    },
    
    // Spanå±æ€§ (æ ‡å‡† + è‡ªå®šä¹‰)
    "attributes": {
      // æ ‡å‡†HTTPå±æ€§
      "http.request.method": "POST",
      "http.route": "/api/orders",
      "http.response.status_code": 201,
      "server.address": "api.myshop.com",
      
      // è‡ªå®šä¹‰ä¸šåŠ¡å±æ€§
      "myshop.order.id": "ORDER-2024-001234",
      "myshop.order.status": "pending",
      "myshop.order.total_amount": 99.99,
      "myshop.order.item_count": 3,
      "myshop.user.tier": "gold",
      "myshop.promotion.code": "SUMMER2024"
    },
    
    // Events
    "events": [
      {
        "name": "order_validation_complete",
        "timestamp": "2024-10-20T10:30:00.050Z",
        "attributes": {
          "validation.result": "success"
        }
      }
    ]
  }
}
```

**ClickHouse (OLAPåˆ†æ)**:

```sql
-- ClickHouseè¡¨ç»“æ„è®¾è®¡
CREATE TABLE traces (
    -- æ—¶é—´åˆ†åŒºé”®
    date Date DEFAULT toDate(start_time),
    
    -- æ ‡å‡†OTLPå­—æ®µ
    trace_id String,
    span_id String,
    parent_span_id String,
    name LowCardinality(String),
    kind Enum8('INTERNAL'=1, 'SERVER'=2, 'CLIENT'=3, 'PRODUCER'=4, 'CONSUMER'=5),
    start_time DateTime64(9),
    end_time DateTime64(9),
    duration_ns UInt64,
    status_code Enum8('UNSET'=0, 'OK'=1, 'ERROR'=2),
    
    -- Resourceå±æ€§ (æ‰å¹³åŒ–)
    service_name LowCardinality(String),
    service_version LowCardinality(String),
    deployment_environment LowCardinality(String),
    host_name LowCardinality(String),
    k8s_pod_name String,
    
    -- æ ‡å‡†Spanå±æ€§
    http_method LowCardinality(String),
    http_route LowCardinality(String),
    http_status_code UInt16,
    
    -- è‡ªå®šä¹‰ä¸šåŠ¡å±æ€§ (æ‰å¹³åŒ–ä¸ºåˆ—)
    myshop_order_id String,
    myshop_order_status LowCardinality(String),
    myshop_order_total_amount Decimal(10,2),
    myshop_order_item_count UInt8,
    myshop_user_tier LowCardinality(String),
    myshop_promotion_code LowCardinality(String),
    
    -- åŸå§‹å±æ€§(JSONï¼Œç”¨äºçµæ´»æŸ¥è¯¢)
    attributes Map(String, String),
    
    -- ç´¢å¼•
    INDEX idx_trace_id trace_id TYPE bloom_filter GRANULARITY 1,
    INDEX idx_order_id myshop_order_id TYPE bloom_filter GRANULARITY 1
    
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(date)
ORDER BY (service_name, date, start_time)
TTL date + INTERVAL 90 DAY;
```

**æŸ¥è¯¢ç¤ºä¾‹**:

```sql
-- 1. æŒ‰ç”¨æˆ·ç­‰çº§ç»Ÿè®¡P95å»¶è¿Ÿ
SELECT
    myshop_user_tier,
    quantile(0.95)(duration_ns / 1000000) as p95_latency_ms
FROM traces
WHERE date >= today() - 7
  AND service_name = 'order-service'
GROUP BY myshop_user_tier
ORDER BY p95_latency_ms DESC;

-- 2. ä¿ƒé”€æ´»åŠ¨è½¬åŒ–æ¼æ–—
SELECT
    myshop_promotion_code,
    countIf(name = 'add_to_cart') as step1_add_to_cart,
    countIf(name = 'checkout') as step2_checkout,
    countIf(name = 'payment') as step3_payment,
    countIf(myshop_order_status = 'paid') as step4_paid,
    step4_paid / step1_add_to_cart as conversion_rate
FROM traces
WHERE date = today()
  AND myshop_promotion_code != ''
GROUP BY myshop_promotion_code
ORDER BY conversion_rate DESC;

-- 3. é”™è¯¯ç‡æŒ‰è®¢å•é‡‘é¢åˆ†æ®µ
SELECT
    multiIf(
        myshop_order_total_amount < 50, '<$50',
        myshop_order_total_amount < 100, '$50-$100',
        myshop_order_total_amount < 500, '$100-$500',
        '>$500'
    ) as amount_range,
    countIf(status_code = 'ERROR') / count() as error_rate
FROM traces
WHERE date >= today() - 1
  AND service_name = 'order-service'
GROUP BY amount_range
ORDER BY error_rate DESC;
```

---

### 3.4 æ•°æ®å¤„ç†é˜¶æ®µ

#### 3.4.1 å®æ—¶æµå¤„ç† (Apache Flink)

```java
// Flinkå®æ—¶å¤„ç†OTLPæ•°æ®
StreamExecutionEnvironment env = 
    StreamExecutionEnvironment.getExecutionEnvironment();

// ä»Kafkaè¯»å–OTLP Traces
DataStream<Span> spans = env
    .addSource(new FlinkKafkaConsumer<>(
        "otlp-traces",
        new SpanDeserializationSchema(),
        kafkaProps
    ))
    .name("otlp-trace-source");

// å®æ—¶è®¡ç®—ä¸šåŠ¡æŒ‡æ ‡
DataStream<OrderMetric> orderMetrics = spans
    .filter(span -> span.getName().equals("process_order"))
    .keyBy(span -> span.getAttribute("myshop.user.tier"))
    .window(TumblingEventTimeWindows.of(Time.minutes(1)))
    .aggregate(new OrderAggregateFunction())
    .name("order-metrics-by-tier");

// å¼‚å¸¸æ£€æµ‹
DataStream<Alert> alerts = orderMetrics
    .filter(metric -> {
        // æ£€æµ‹VIPç”¨æˆ·çš„å¼‚å¸¸
        if (metric.getUserTier().equals("platinum") ||
            metric.getUserTier().equals("gold")) {
            return metric.getErrorRate() > 0.01  // é”™è¯¯ç‡>1%
                || metric.getP95Latency() > 2000; // P95>2s
        }
        return false;
    })
    .map(metric -> new Alert(
        AlertLevel.HIGH,
        String.format("VIPç”¨æˆ·%så¼‚å¸¸: é”™è¯¯ç‡%.2f%%, P95å»¶è¿Ÿ%dms",
            metric.getUserTier(),
            metric.getErrorRate() * 100,
            metric.getP95Latency())
    ))
    .name("vip-user-alerts");

// è¾“å‡ºåˆ°å‘Šè­¦ç³»ç»Ÿ
alerts.addSink(new PagerDutySink()).name("alerting");

env.execute("OTLP Real-time Processing");
```

#### 3.4.2 æ‰¹å¤„ç†åˆ†æ (Apache Spark)

```python
# Sparkæ‰¹å¤„ç†OTLPæ•°æ®
from pyspark.sql import SparkSession
from pyspark.sql import functions as F

spark = SparkSession.builder.appName("OTLP-Analysis").getOrCreate()

# è¯»å–ClickHouseæ•°æ®
traces_df = spark.read \
    .format("jdbc") \
    .option("url", "jdbc:clickhouse://clickhouse:8123/default") \
    .option("dbtable", "traces") \
    .load()

# åˆ†æ1: ç”¨æˆ·è¡Œä¸ºåˆ†æ
user_behavior = traces_df \
    .filter(F.col("service_name") == "order-service") \
    .groupBy("myshop_user_tier", "myshop_order_status") \
    .agg(
        F.count("*").alias("order_count"),
        F.avg("myshop_order_total_amount").alias("avg_amount"),
        F.sum("myshop_order_total_amount").alias("total_revenue"),
        F.avg("duration_ns").alias("avg_latency_ns")
    ) \
    .orderBy(F.desc("total_revenue"))

# åˆ†æ2: ä¿ƒé”€æ•ˆæœåˆ†æ
promotion_analysis = traces_df \
    .filter(F.col("myshop_promotion_code").isNotNull()) \
    .groupBy("myshop_promotion_code") \
    .agg(
        F.countDistinct("myshop_order_id").alias("orders_with_promo"),
        F.sum("myshop_order_total_amount").alias("revenue_with_promo"),
        F.avg("myshop_order_total_amount").alias("avg_order_value"),
        F.count(F.when(F.col("status_code") == "ERROR", 1)).alias("error_count")
    ) \
    .withColumn("error_rate", 
        F.col("error_count") / F.col("orders_with_promo"))

# åˆ†æ3: æœåŠ¡ä¾èµ–å›¾æ„å»º
service_dependencies = traces_df \
    .join(
        traces_df.alias("parent"),
        F.col("parent_span_id") == F.col("parent.span_id")
    ) \
    .select(
        F.col("parent.service_name").alias("from_service"),
        F.col("service_name").alias("to_service"),
        F.count("*").alias("call_count"),
        F.avg("duration_ns").alias("avg_latency"),
        F.count(F.when(F.col("status_code") == "ERROR", 1))
            .alias("error_count")
    ) \
    .groupBy("from_service", "to_service") \
    .agg(
        F.sum("call_count").alias("total_calls"),
        F.avg("avg_latency").alias("avg_latency"),
        F.sum("error_count").alias("total_errors")
    )

# è¾“å‡ºç»“æœ
user_behavior.write.mode("overwrite").saveAsTable("analytics.user_behavior")
promotion_analysis.write.mode("overwrite").saveAsTable("analytics.promotions")
service_dependencies.write.mode("overwrite").saveAsTable("analytics.dependencies")
```

---

### 3.5 æ•°æ®æŸ¥è¯¢ä¸åˆ†æ

#### 3.5.1 å¤šç»´åˆ†ææŸ¥è¯¢

**Grafana Dashboardé…ç½®**:

```yaml
# Grafana Dashboard JSON
{
  "dashboard": {
    "title": "ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§ - ç”µå•†è®¢å•",
    "panels": [
      {
        "title": "æŒ‰ç”¨æˆ·ç­‰çº§çš„è®¢å•é‡",
        "targets": [{
          "expr": "sum(rate(calls_total{service_name=\"order-service\"}[5m])) by (myshop_user_tier)",
          "legendFormat": "{{myshop_user_tier}}"
        }],
        "type": "graph"
      },
      {
        "title": "VIPç”¨æˆ·P95å»¶è¿Ÿ",
        "targets": [{
          "expr": "histogram_quantile(0.95, sum(rate(duration_milliseconds_bucket{service_name=\"order-service\", myshop_user_tier=~\"gold|platinum\"}[5m])) by (le, myshop_user_tier))",
          "legendFormat": "{{myshop_user_tier}}"
        }],
        "type": "graph"
      },
      {
        "title": "ä¿ƒé”€æ´»åŠ¨æ•ˆæœ",
        "targets": [{
          "expr": "topk(10, sum(rate(calls_total{myshop_promotion_code!=\"\"}[1h])) by (myshop_promotion_code))",
          "legendFormat": "{{myshop_promotion_code}}"
        }],
        "type": "barchart"
      }
    ]
  }
}
```

**KibanaæŸ¥è¯¢ (Elasticsearch)**:

```json
{
  "query": {
    "bool": {
      "must": [
        {"term": {"resource.service.name": "order-service"}},
        {"range": {"start_time": {"gte": "now-1h"}}},
        {"term": {"attributes.myshop.user.tier": "platinum"}}
      ],
      "filter": [
        {"range": {"attributes.myshop.order.total_amount": {"gte": 500}}}
      ]
    }
  },
  "aggs": {
    "by_status": {
      "terms": {"field": "attributes.myshop.order.status"},
      "aggs": {
        "avg_amount": {
          "avg": {"field": "attributes.myshop.order.total_amount"}
        },
        "p95_latency": {
          "percentiles": {
            "field": "duration_ms",
            "percents": [95]
          }
        }
      }
    }
  }
}
```

---

## ç¬¬å››éƒ¨åˆ†ï¼šæˆç†Ÿæ¡ˆä¾‹æ·±åº¦å‰–æ

### 4.1 æ¡ˆä¾‹1: Uberçš„åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿ

#### 4.1.1 æ•°æ®æ¨¡å‹è®¾è®¡

**Uberè‡ªå®šä¹‰è¯­ä¹‰çº¦å®š**:

```yaml
namespace: uber

# å‡ºè¡Œä¸šåŠ¡å±æ€§
attributes:
  uber.trip.id:
    type: string
    requirement: required
    description: è¡Œç¨‹å”¯ä¸€æ ‡è¯†
    
  uber.trip.type:
    type: enum
    values: ["uberx", "uber_black", "uber_pool", "uber_eats"]
    requirement: required
    
  uber.trip.distance_km:
    type: double
    requirement: required
    description: è¡Œç¨‹è·ç¦»(å…¬é‡Œ)
    
  uber.trip.duration_seconds:
    type: int
    requirement: required
    
  uber.driver.id:
    type: string
    requirement: required
    description: å¸æœºID(å“ˆå¸ŒåŒ–)
    
  uber.rider.tier:
    type: enum
    values: ["basic", "gold", "platinum", "diamond"]
    requirement: recommended
    
  uber.pricing.surge_multiplier:
    type: double
    requirement: optional
    description: åŠ¨æ€å®šä»·å€æ•°
    example: 1.5
```

#### 4.1.2 æ•°æ®å¤„ç†æµç¨‹

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Uber OTLPæ•°æ®å¤„ç†æµç¨‹                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  1ï¸âƒ£ æ•°æ®æ”¶é›† (æ¯å¤©50äº¿+ Spans)                             â”‚
â”‚     â”œâ”€ ç§»åŠ¨ç«¯SDK (Rider/Driver App)                         â”‚
â”‚     â”œâ”€ åç«¯æœåŠ¡ (å¾®æœåŠ¡æ¶æ„, 2000+æœåŠ¡)                      â”‚
â”‚     â””â”€ è¾¹ç¼˜èŠ‚ç‚¹ (å…¨çƒ100+æ•°æ®ä¸­å¿ƒ)                           â”‚
â”‚                                                              â”‚
â”‚  2ï¸âƒ£ æ•°æ®èšåˆ (Regional Collector)                          â”‚
â”‚     â”œâ”€ å®æ—¶é‡‡æ · (Head-based: 1%)                            â”‚
â”‚     â”œâ”€ å°¾éƒ¨é‡‡æ · (Tail-based: ä¿ç•™æ‰€æœ‰å¼‚å¸¸)                  â”‚
â”‚     â””â”€ å±æ€§æ ‡å‡†åŒ–                                            â”‚
â”‚                                                              â”‚
â”‚  3ï¸âƒ£ æ•°æ®è½¬æ¢ (Central Pipeline)                            â”‚
â”‚     â”œâ”€ Span â†’ Metric è½¬æ¢                                   â”‚
â”‚     â”‚   â””â”€ trip_duration{type="uberx", tier="gold"}         â”‚
â”‚     â”œâ”€ ä¸šåŠ¡äº‹ä»¶æå–                                          â”‚
â”‚     â”‚   â””â”€ trip_started, trip_completed, payment_processed  â”‚
â”‚     â””â”€ å¼‚å¸¸æ£€æµ‹                                              â”‚
â”‚         â””â”€ MLæ¨¡å‹é¢„æµ‹å¼‚å¸¸è¡Œç¨‹                                â”‚
â”‚                                                              â”‚
â”‚  4ï¸âƒ£ æ•°æ®å­˜å‚¨ (å¤šå±‚å­˜å‚¨)                                    â”‚
â”‚     â”œâ”€ çƒ­æ•°æ® (æœ€è¿‘7å¤©) â†’ Cassandra                         â”‚
â”‚     â”œâ”€ æ¸©æ•°æ® (7-30å¤©) â†’ HDFS + Parquet                     â”‚
â”‚     â””â”€ å†·æ•°æ® (>30å¤©) â†’ S3 Glacier                          â”‚
â”‚                                                              â”‚
â”‚  5ï¸âƒ£ æ•°æ®åˆ†æ                                               â”‚
â”‚     â”œâ”€ å®æ—¶ç›‘æ§ (Grafana + Prometheus)                      â”‚
â”‚     â”œâ”€ Ad-hocæŸ¥è¯¢ (Presto)                                  â”‚
â”‚     â”œâ”€ MLè®­ç»ƒ (Spark MLlib)                                 â”‚
â”‚     â””â”€ ä¸šåŠ¡BI (è‡ªç ”BIå¹³å°)                                   â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.1.3 å…³é”®ä¼˜åŒ–

**1. æ™ºèƒ½é‡‡æ ·**:

```go
// Uberçš„è‡ªé€‚åº”é‡‡æ ·ç®—æ³•
func ShouldSample(span Span) bool {
    // 1. æ‰€æœ‰é”™è¯¯å¿…é¡»é‡‡æ ·
    if span.Status == ERROR {
        return true
    }
    
    // 2. VIPç”¨æˆ·æ›´é«˜é‡‡æ ·ç‡
    tier := span.Attribute("uber.rider.tier")
    if tier == "diamond" {
        return rand.Float64() < 0.50  // 50%
    } else if tier == "platinum" {
        return rand.Float64() < 0.20  // 20%
    }
    
    // 3. é«˜ä»·å€¼è¡Œç¨‹
    surgeMultiplier := span.Attribute("uber.pricing.surge_multiplier")
    if surgeMultiplier > 2.0 {
        return true  // 100%
    }
    
    // 4. é•¿è·ç¦»è¡Œç¨‹
    distance := span.Attribute("uber.trip.distance_km")
    if distance > 50 {
        return rand.Float64() < 0.30  // 30%
    }
    
    // 5. é»˜è®¤ä½é‡‡æ ·ç‡
    return rand.Float64() < 0.01  // 1%
}
```

**2. æˆæœ¬ä¼˜åŒ–**:

- é‡‡æ ·åæ•°æ®é‡å‡å°‘99%
- å­˜å‚¨æˆæœ¬: $500K/æœˆ â†’ $5K/æœˆ
- ä½†ä¿ç•™äº†99.9%çš„å…³é”®ä¿¡æ¯(é”™è¯¯ã€VIPã€å¼‚å¸¸)

---

### 4.2 æ¡ˆä¾‹2: Shopifyçš„ç”µå•†å¯è§‚æµ‹æ€§

#### 4.2.1 æ•°æ®æ¨¡å‹è®¾è®¡

```yaml
namespace: shopify

# åº—é“ºå±æ€§
attributes:
  shopify.shop.id:
    type: string
    requirement: required
    description: åº—é“ºID
    
  shopify.shop.plan:
    type: enum
    values: ["basic", "shopify", "advanced", "plus"]
    requirement: required
    
  # å•†å“å±æ€§
  shopify.product.id:
    type: string
    requirement: conditional
    
  shopify.product.variant_id:
    type: string
    requirement: conditional
    
  shopify.product.price:
    type: double
    requirement: conditional
    
  # è®¢å•å±æ€§
  shopify.order.id:
    type: string
    requirement: required
    
  shopify.order.total:
    type: double
    requirement: required
    
  shopify.order.currency:
    type: string
    requirement: required
    example: "USD"
    
  shopify.order.fulfillment_status:
    type: enum
    values: ["unfulfilled", "partial", "fulfilled"]
    requirement: recommended
    
  # è¥é”€å±æ€§
  shopify.checkout.abandoned:
    type: boolean
    requirement: optional
    description: è´­ç‰©è½¦æ˜¯å¦é—å¼ƒ
    
  shopify.discount.code:
    type: string
    requirement: optional
```

#### 4.2.2 æ•°æ®åˆ†æåœºæ™¯

**å®æ—¶ç›‘æ§Dashboard**:

```promql
# 1. æŒ‰åº—é“ºç­‰çº§çš„GMV
sum(rate(shopify_order_total_sum[5m])) by (shopify_shop_plan)

# 2. Plusåº—é“ºçš„è½¬åŒ–ç‡
sum(rate(shopify_order_created_total{shopify_shop_plan="plus"}[5m]))
/
sum(rate(shopify_checkout_started_total{shopify_shop_plan="plus"}[5m]))

# 3. è´­ç‰©è½¦é—å¼ƒç‡
sum(rate(shopify_checkout_abandoned_total[5m]))
/
sum(rate(shopify_checkout_started_total[5m]))

# 4. æŠ˜æ‰£ç ä½¿ç”¨æ•ˆæœ
topk(10,
  sum(rate(shopify_order_total_sum{shopify_discount_code!=""}[1h]))
  by (shopify_discount_code)
)
```

---

## ç¬¬äº”éƒ¨åˆ†ï¼šæœ€ä½³å®è·µæ€»ç»“

### 5.1 æ•°æ®æ¨¡å‹è®¾è®¡åŸåˆ™

#### âœ… DO (æ¨èåšæ³•)

1. **ä¼˜å…ˆä½¿ç”¨æ ‡å‡†è¯­ä¹‰çº¦å®š**

   ```yaml
   # âœ… å¥½
   http.request.method: "POST"
   http.response.status_code: 200
   
   # âŒ å
   custom.http_method: "POST"
   my_status: 200
   ```

2. **è‡ªå®šä¹‰å±æ€§ä½¿ç”¨vendorå‰ç¼€**

   ```yaml
   # âœ… å¥½
   mycompany.order.id: "ORDER-123"
   
   # âŒ å
   order_id: "ORDER-123"  # å¯èƒ½å†²çª
   ```

3. **åˆç†æ§åˆ¶åŸºæ•°**

   ```yaml
   # âœ… å¥½ (ä½åŸºæ•°)
   user.tier: "gold"  # 4-5ä¸ªå€¼
   order.status: "paid"  # 5-10ä¸ªå€¼
   
   # âŒ å (é«˜åŸºæ•°)
   user.id: "user-123456"  # ç™¾ä¸‡çº§
   order.id: "ORDER-789"  # æ— é™
   ```

4. **æ•æ„Ÿæ•°æ®è„±æ•**

   ```yaml
   # âœ… å¥½
   user.email.hash: "a1b2c3..."
   credit_card.last4: "1234"
   
   # âŒ å
   user.email: "user@example.com"
   credit_card.number: "1234-5678-9012-3456"
   ```

#### âŒ DON'T (é¿å…åšæ³•)

1. âŒ åœ¨å±æ€§ä¸­å­˜å‚¨å¤§å¯¹è±¡
2. âŒ ä½¿ç”¨ä¸ç¨³å®šçš„å±æ€§å
3. âŒ å¿½ç•¥ç±»å‹å®šä¹‰
4. âŒ è¿‡åº¦é‡‡æ ·å¯¼è‡´æˆæœ¬å¤±æ§

---

### 5.2 æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†ç­–ç•¥

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†æœ€ä½³å®è·µ                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                        â”‚
â”‚  é˜¶æ®µ1: æ”¶é›† (Collection)                              â”‚
â”‚    âœ… ä½¿ç”¨Auto-instrumentationå‡å°‘äººå·¥æˆæœ¬              â”‚
â”‚    âœ… æ ‡å‡†å±æ€§+è‡ªå®šä¹‰å±æ€§æ··åˆ                           â”‚
â”‚    âœ… åœ¨SDKå±‚åšç¬¬ä¸€æ¬¡é‡‡æ ·                               â”‚
â”‚                                                        â”‚
â”‚  é˜¶æ®µ2: ä¼ è¾“ (Transmission)                            â”‚
â”‚    âœ… å¯ç”¨gzipå‹ç¼© (èŠ‚çœ60-70%å¸¦å®½)                    â”‚
â”‚    âœ… æ‰¹å¤„ç†å‘é€ (batch_size=512, timeout=1s)          â”‚
â”‚    âœ… å¼‚æ­¥å¯¼å‡ºï¼Œä¸é˜»å¡ä¸šåŠ¡                              â”‚
â”‚                                                        â”‚
â”‚  é˜¶æ®µ3: è½¬æ¢ (Transformation)                          â”‚
â”‚    âœ… Collectorç»Ÿä¸€å¤„ç†                                â”‚
â”‚    âœ… å±æ€§æ ‡å‡†åŒ–ã€PIIè„±æ•                               â”‚
â”‚    âœ… å°¾éƒ¨é‡‡æ · (ä¿ç•™å¼‚å¸¸)                               â”‚
â”‚                                                        â”‚
â”‚  é˜¶æ®µ4: å­˜å‚¨ (Storage)                                 â”‚
â”‚    âœ… çƒ­æ•°æ® (7å¤©): é«˜æ€§èƒ½æ•°æ®åº“                        â”‚
â”‚    âœ… æ¸©æ•°æ® (30å¤©): åˆ—å¼å­˜å‚¨                           â”‚
â”‚    âœ… å†·æ•°æ® (>30å¤©): å¯¹è±¡å­˜å‚¨                          â”‚
â”‚                                                        â”‚
â”‚  é˜¶æ®µ5: æŸ¥è¯¢ (Query)                                   â”‚
â”‚    âœ… å®æ—¶ç›‘æ§: Prometheus + Grafana                   â”‚
â”‚    âœ… Ad-hocåˆ†æ: ClickHouse / Presto                  â”‚
â”‚    âœ… ä¸šåŠ¡BI: é¢„èšåˆè¡¨                                  â”‚
â”‚                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç»“è®º

æœ¬æŒ‡å—å…¨é¢æ¢³ç†äº†OTLPæ ‡å‡†è§„å®šçš„è¯­ä¹‰æ¨¡å‹ï¼Œä»¥åŠæ•°æ®åœ¨å¯è§‚æµ‹æ€§ç³»ç»Ÿä¸­çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸã€‚æ ¸å¿ƒè¦ç‚¹ï¼š

### ğŸ¯ å…³é”®æ”¶è·

1. **è¯­ä¹‰æ¨¡å‹ä¸‰å±‚æ¶æ„**: Resource â†’ Instrumentation Scope â†’ Telemetry Data
2. **æ ‡å‡† + è‡ªå®šä¹‰ç»“åˆ**: ä¼˜å…ˆæ ‡å‡†çº¦å®šï¼Œè‡ªå®šä¹‰ä½¿ç”¨vendorå‰ç¼€
3. **å®Œæ•´æ•°æ®æµ**: æ”¶é›† â†’ è½¬æ¢ â†’ å­˜å‚¨ â†’ å¤„ç† â†’ æŸ¥è¯¢
4. **æˆç†Ÿæ¡ˆä¾‹éªŒè¯**: Uberã€Shopifyç­‰å…¬å¸çš„å®è·µç»éªŒ

### ğŸ“Š æ•°æ®ç»Ÿè®¡

- **æ ‡å‡†è¯­ä¹‰çº¦å®š**: 21ä¸ªé¢†åŸŸï¼Œ33,050è¡Œæ–‡æ¡£
- **æ•°æ®ç”Ÿå‘½å‘¨æœŸ**: 5ä¸ªé˜¶æ®µï¼Œå®Œæ•´è¦†ç›–
- **æˆç†Ÿæ¡ˆä¾‹**: 2ä¸ªæ·±åº¦æ¡ˆä¾‹ï¼Œå®æˆ˜éªŒè¯

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**åˆ›å»ºæ—¥æœŸ**: 2025å¹´10æœˆ20æ—¥  
**ç»´æŠ¤å›¢é˜Ÿ**: OTLPé¡¹ç›®å›¢é˜Ÿ  

**ç›¸å…³æ–‡æ¡£**:

- [OTLPå…¨é¢å¯¹æ ‡åˆ†ææŠ¥å‘Š](ğŸ“Š_OTLPé¡¹ç›®2025å¹´10æœˆ20æ—¥å…¨é¢å¯¹æ ‡åˆ†ææŠ¥å‘Š.md)
- [è¯­ä¹‰çº¦å®šæ€»è§ˆ](docs/02_Semantic_Conventions/00_è¯­ä¹‰çº¦å®šæ€»è§ˆ.md)
- [é¡¹ç›®README](README.md)

---

**END OF DOCUMENT**:

# âš¡ OTLPæ€§èƒ½ä¼˜åŒ–å®Œæ•´æŒ‡å—

> **ç›®æ ‡**: å¸®åŠ©ç”¨æˆ·ä¼˜åŒ–OTLPéƒ¨ç½²æ€§èƒ½ï¼Œé™ä½æˆæœ¬  
> **é€‚ç”¨åœºæ™¯**: ç”Ÿäº§ç¯å¢ƒæ€§èƒ½è°ƒä¼˜  
> **æ›´æ–°æ—¶é—´**: 2025å¹´10æœˆ20æ—¥

---

## ğŸ“‹ ç›®å½•

- [âš¡ OTLPæ€§èƒ½ä¼˜åŒ–å®Œæ•´æŒ‡å—](#-otlpæ€§èƒ½ä¼˜åŒ–å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ğŸ”§ SDKæ€§èƒ½ä¼˜åŒ–](#-sdkæ€§èƒ½ä¼˜åŒ–)
    - [1. é‡‡æ ·ç­–ç•¥ä¼˜åŒ–](#1-é‡‡æ ·ç­–ç•¥ä¼˜åŒ–)
      - [1.1 å›ºå®šæ¯”ä¾‹é‡‡æ ·](#11-å›ºå®šæ¯”ä¾‹é‡‡æ ·)
      - [1.2 çˆ¶Spanå†³å®šé‡‡æ ·](#12-çˆ¶spanå†³å®šé‡‡æ ·)
      - [1.3 æ™ºèƒ½é‡‡æ ·ï¼ˆæ¨èï¼‰](#13-æ™ºèƒ½é‡‡æ ·æ¨è)
    - [2. æ‰¹å¤„ç†ä¼˜åŒ–](#2-æ‰¹å¤„ç†ä¼˜åŒ–)
      - [2.1 æ‰¹å¤„ç†å¤§å°](#21-æ‰¹å¤„ç†å¤§å°)
      - [2.2 è¶…æ—¶æ—¶é—´](#22-è¶…æ—¶æ—¶é—´)
    - [3. èµ„æºæ± å¤ç”¨](#3-èµ„æºæ± å¤ç”¨)
      - [3.1 è¿æ¥æ± ](#31-è¿æ¥æ± )
      - [3.2 Spanå¯¹è±¡æ± ](#32-spanå¯¹è±¡æ± )
    - [4. å‡å°‘Spanæ•°é‡](#4-å‡å°‘spanæ•°é‡)
      - [4.1 åˆå¹¶ç»†ç²’åº¦æ“ä½œ](#41-åˆå¹¶ç»†ç²’åº¦æ“ä½œ)
      - [4.2 è¿‡æ»¤ä¸é‡è¦çš„æ“ä½œ](#42-è¿‡æ»¤ä¸é‡è¦çš„æ“ä½œ)
  - [ğŸš€ Collectoræ€§èƒ½ä¼˜åŒ–](#-collectoræ€§èƒ½ä¼˜åŒ–)
    - [1. å¹¶å‘å¤„ç†](#1-å¹¶å‘å¤„ç†)
      - [1.1 Receiverå¹¶å‘](#11-receiverå¹¶å‘)
      - [1.2 Processorå¹¶å‘](#12-processorå¹¶å‘)
    - [2. å†…å­˜ä¼˜åŒ–](#2-å†…å­˜ä¼˜åŒ–)
      - [2.1 Memory Limiteré…ç½®](#21-memory-limiteré…ç½®)
      - [2.2 é˜Ÿåˆ—å¤§å°ä¼˜åŒ–](#22-é˜Ÿåˆ—å¤§å°ä¼˜åŒ–)
    - [3. æ‰¹å¤„ç†ä¼˜åŒ–](#3-æ‰¹å¤„ç†ä¼˜åŒ–)
      - [3.1 æ‰¹é‡å¤§å°vså»¶è¿Ÿ](#31-æ‰¹é‡å¤§å°vså»¶è¿Ÿ)
      - [3.2 å‹ç¼©](#32-å‹ç¼©)
    - [4. è¿‡æ»¤å™¨ä¼˜åŒ–](#4-è¿‡æ»¤å™¨ä¼˜åŒ–)
      - [4.1 æ—©æœŸè¿‡æ»¤](#41-æ—©æœŸè¿‡æ»¤)
      - [4.2 é«˜æ•ˆè¿‡æ»¤è§„åˆ™](#42-é«˜æ•ˆè¿‡æ»¤è§„åˆ™)
  - [ğŸŒ ç½‘ç»œæ€§èƒ½ä¼˜åŒ–](#-ç½‘ç»œæ€§èƒ½ä¼˜åŒ–)
    - [1. åè®®é€‰æ‹©](#1-åè®®é€‰æ‹©)
      - [1.1 gRPC vs HTTP](#11-grpc-vs-http)
      - [1.2 è¿æ¥å¤ç”¨](#12-è¿æ¥å¤ç”¨)
    - [2. å‹ç¼©](#2-å‹ç¼©)
      - [2.1 SDKç«¯å‹ç¼©](#21-sdkç«¯å‹ç¼©)
      - [2.2 Collectorç«¯å‹ç¼©](#22-collectorç«¯å‹ç¼©)
  - [ğŸ’¾ å­˜å‚¨æ€§èƒ½ä¼˜åŒ–](#-å­˜å‚¨æ€§èƒ½ä¼˜åŒ–)
    - [1. åˆ†å±‚å­˜å‚¨ç­–ç•¥](#1-åˆ†å±‚å­˜å‚¨ç­–ç•¥)
      - [1.1 çƒ­æ¸©å†·åˆ†å±‚](#11-çƒ­æ¸©å†·åˆ†å±‚)
      - [1.2 æˆæœ¬å¯¹æ¯”](#12-æˆæœ¬å¯¹æ¯”)
    - [2. ç´¢å¼•ä¼˜åŒ–](#2-ç´¢å¼•ä¼˜åŒ–)
      - [2.1 Elasticsearchç´¢å¼•ç­–ç•¥](#21-elasticsearchç´¢å¼•ç­–ç•¥)
      - [2.2 ClickHouseè¡¨ä¼˜åŒ–](#22-clickhouseè¡¨ä¼˜åŒ–)
    - [3. æŸ¥è¯¢ä¼˜åŒ–](#3-æŸ¥è¯¢ä¼˜åŒ–)
      - [3.1 æ·»åŠ åˆé€‚çš„ç´¢å¼•](#31-æ·»åŠ åˆé€‚çš„ç´¢å¼•)
      - [3.2 ä½¿ç”¨ç‰©åŒ–è§†å›¾](#32-ä½¿ç”¨ç‰©åŒ–è§†å›¾)
  - [ğŸ’° æˆæœ¬ä¼˜åŒ–](#-æˆæœ¬ä¼˜åŒ–)
    - [1. Uberæ¡ˆä¾‹ï¼šæˆæœ¬ä¼˜åŒ–99%](#1-uberæ¡ˆä¾‹æˆæœ¬ä¼˜åŒ–99)
      - [é—®é¢˜](#é—®é¢˜)
      - [ä¼˜åŒ–æ–¹æ¡ˆ](#ä¼˜åŒ–æ–¹æ¡ˆ)
      - [æ•ˆæœ](#æ•ˆæœ)
    - [2. é‡‡æ ·ç­–ç•¥æ¨è](#2-é‡‡æ ·ç­–ç•¥æ¨è)
  - [ğŸ“Š ç›‘æ§ä¸è°ƒä¼˜](#-ç›‘æ§ä¸è°ƒä¼˜)
    - [1. å…³é”®æŒ‡æ ‡ç›‘æ§](#1-å…³é”®æŒ‡æ ‡ç›‘æ§)
      - [1.1 CollectoræŒ‡æ ‡](#11-collectoræŒ‡æ ‡)
      - [1.2 å‘Šè­¦è§„åˆ™](#12-å‘Šè­¦è§„åˆ™)
    - [2. æ€§èƒ½åŸºå‡†æµ‹è¯•](#2-æ€§èƒ½åŸºå‡†æµ‹è¯•)
      - [2.1 ååé‡æµ‹è¯•](#21-ååé‡æµ‹è¯•)
      - [2.2 å»¶è¿Ÿæµ‹è¯•](#22-å»¶è¿Ÿæµ‹è¯•)
    - [3. è°ƒä¼˜æ£€æŸ¥æ¸…å•](#3-è°ƒä¼˜æ£€æŸ¥æ¸…å•)
      - [SDKè°ƒä¼˜](#sdkè°ƒä¼˜)
      - [Collectorè°ƒä¼˜](#collectorè°ƒä¼˜)
      - [å­˜å‚¨è°ƒä¼˜](#å­˜å‚¨è°ƒä¼˜)
      - [æˆæœ¬ä¼˜åŒ–](#æˆæœ¬ä¼˜åŒ–)
  - [ğŸ”— ç›¸å…³èµ„æº](#-ç›¸å…³èµ„æº)

---

## ğŸ”§ SDKæ€§èƒ½ä¼˜åŒ–

### 1. é‡‡æ ·ç­–ç•¥ä¼˜åŒ–

#### 1.1 å›ºå®šæ¯”ä¾‹é‡‡æ ·

```go
// ç”Ÿäº§ç¯å¢ƒï¼š1%é‡‡æ ·
tp := sdktrace.NewTracerProvider(
    sdktrace.WithSampler(sdktrace.TraceIDRatioBased(0.01)),  // 1%
    sdktrace.WithBatcher(exporter),
)

// æµ‹è¯•ç¯å¢ƒï¼š100%é‡‡æ ·
tp := sdktrace.NewTracerProvider(
    sdktrace.WithSampler(sdktrace.AlwaysSample()),  // 100%
)
```

**æ•ˆæœ**:

- æ•°æ®é‡å‡å°‘99%
- æˆæœ¬é™ä½99%
- ä»èƒ½çœ‹åˆ°1%çš„æ­£å¸¸æµé‡

#### 1.2 çˆ¶Spanå†³å®šé‡‡æ ·

```go
// å­Spanè·Ÿéšçˆ¶Spançš„é‡‡æ ·å†³ç­–
tp := sdktrace.NewTracerProvider(
    sdktrace.WithSampler(sdktrace.ParentBased(
        sdktrace.TraceIDRatioBased(0.01),  // æ ¹Span 1%é‡‡æ ·
    )),
)
```

**ä¼˜åŠ¿**:

- ä¿è¯Traceå®Œæ•´æ€§
- é¿å…Traceç¢ç‰‡åŒ–

#### 1.3 æ™ºèƒ½é‡‡æ ·ï¼ˆæ¨èï¼‰

åœ¨Collectorç«¯ä½¿ç”¨Tail Samplingï¼š

```yaml
processors:
  tail_sampling:
    decision_wait: 10s
    num_traces: 100000
    policies:
      # 100%ä¿ç•™é”™è¯¯Trace
      - name: errors
        type: status_code
        status_code:
          status_codes: [ERROR]
      
      # 100%ä¿ç•™æ…¢Trace (>1s)
      - name: slow
        type: latency
        latency:
          threshold_ms: 1000
      
      # 100%ä¿ç•™VIPç”¨æˆ·
      - name: vip-users
        type: string_attribute
        string_attribute:
          key: myapp.user.tier
          values: [platinum, gold]
      
      # 1%é‡‡æ ·æ™®é€šæµé‡
      - name: normal
        type: probabilistic
        probabilistic:
          sampling_percentage: 1
```

**æ•ˆæœå¯¹æ¯”**:

| åœºæ™¯ | å›ºå®š1%é‡‡æ · | æ™ºèƒ½é‡‡æ · |
|------|-----------|---------|
| **æ•°æ®é‡** | 1% | 3-5% |
| **é”™è¯¯è¦†ç›–** | 1% | 100% âœ… |
| **æ…¢è¯·æ±‚è¦†ç›–** | 1% | 100% âœ… |
| **VIPç”¨æˆ·** | 1% | 100% âœ… |
| **æˆæœ¬** | $$ | $$$ |

---

### 2. æ‰¹å¤„ç†ä¼˜åŒ–

#### 2.1 æ‰¹å¤„ç†å¤§å°

```go
exporter, err := otlptracegrpc.New(ctx,
    otlptracegrpc.WithEndpoint("localhost:4317"),
)

tp := sdktrace.NewTracerProvider(
    // æ‰¹å¤„ç†é…ç½®
    sdktrace.WithBatcher(exporter,
        sdktrace.WithMaxExportBatchSize(512),    // âœ… æ‰¹é‡å¤§å°
        sdktrace.WithBatchTimeout(time.Second),  // âœ… è¶…æ—¶æ—¶é—´
        sdktrace.WithMaxQueueSize(2048),         // âœ… é˜Ÿåˆ—å¤§å°
    ),
)
```

**æ€§èƒ½å½±å“**:

| æ‰¹é‡å¤§å° | ç½‘ç»œè¯·æ±‚ | å»¶è¿Ÿ | CPU | æ¨èåœºæ™¯ |
|---------|---------|------|-----|---------|
| 128 | å¤š | ä½ | é«˜ | ä½å»¶è¿Ÿè¦æ±‚ |
| 512 | ä¸­ | ä¸­ | ä¸­ | **æ¨è** â­ |
| 2048 | å°‘ | é«˜ | ä½ | é«˜ååé‡ |

#### 2.2 è¶…æ—¶æ—¶é—´

```go
// ä½å»¶è¿Ÿåœºæ™¯ï¼ˆå®æ—¶ç›‘æ§ï¼‰
sdktrace.WithBatchTimeout(100 * time.Millisecond)

// å‡è¡¡åœºæ™¯ï¼ˆæ¨èï¼‰
sdktrace.WithBatchTimeout(1 * time.Second)

// é«˜åååœºæ™¯ï¼ˆç¦»çº¿åˆ†æï¼‰
sdktrace.WithBatchTimeout(5 * time.Second)
```

---

### 3. èµ„æºæ± å¤ç”¨

#### 3.1 è¿æ¥æ± 

```go
// âœ… å¤ç”¨gRPCè¿æ¥
var (
    conn     *grpc.ClientConn
    connOnce sync.Once
)

func getExporter(ctx context.Context) (*otlptrace.Exporter, error) {
    connOnce.Do(func() {
        var err error
        conn, err = grpc.DialContext(ctx, "localhost:4317",
            grpc.WithTransportCredentials(insecure.NewCredentials()),
            grpc.WithBlock(),
        )
        if err != nil {
            log.Fatal(err)
        }
    })
    
    return otlptracegrpc.New(ctx, otlptracegrpc.WithGRPCConn(conn))
}
```

#### 3.2 Spanå¯¹è±¡æ± 

```go
// å¯¹äºé«˜é¢‘æ“ä½œï¼Œä½¿ç”¨å¯¹è±¡æ± 
var spanPool = sync.Pool{
    New: func() interface{} {
        return &spanData{}
    },
}

func getSpan() *spanData {
    return spanPool.Get().(*spanData)
}

func putSpan(s *spanData) {
    s.Reset()
    spanPool.Put(s)
}
```

---

### 4. å‡å°‘Spanæ•°é‡

#### 4.1 åˆå¹¶ç»†ç²’åº¦æ“ä½œ

```go
// âŒ è¿‡åº¦ç»†åŒ–
func processOrder(ctx context.Context) {
    _, span1 := tracer.Start(ctx, "validate_field_1")
    // ...
    span1.End()
    
    _, span2 := tracer.Start(ctx, "validate_field_2")
    // ...
    span2.End()
    
    // 100+ spans for one order
}

// âœ… åˆç†ç²’åº¦
func processOrder(ctx context.Context) {
    _, span := tracer.Start(ctx, "validate_order")
    // validate all fields
    span.End()
    
    // 5-10 spans per order
}
```

#### 4.2 è¿‡æ»¤ä¸é‡è¦çš„æ“ä½œ

```go
// ä¸ä¸ºå¥åº·æ£€æŸ¥åˆ›å»ºSpan
func healthCheck(w http.ResponseWriter, r *http.Request) {
    // âŒ ä¸éœ€è¦è¿½è¸ª
    // ctx, span := tracer.Start(r.Context(), "health_check")
    // defer span.End()
    
    w.WriteHeader(http.StatusOK)
    w.Write([]byte("OK"))
}
```

---

## ğŸš€ Collectoræ€§èƒ½ä¼˜åŒ–

### 1. å¹¶å‘å¤„ç†

#### 1.1 Receiverå¹¶å‘

```yaml
receivers:
  otlp:
    protocols:
      grpc:
        max_recv_msg_size_mib: 16        # âœ… å¢å¤§æ¶ˆæ¯å¤§å°
        max_concurrent_streams: 100      # âœ… å¢åŠ å¹¶å‘æµ
        read_buffer_size: 524288         # 512KB
        write_buffer_size: 524288
```

#### 1.2 Processorå¹¶å‘

```yaml
processors:
  batch:
    timeout: 1s
    send_batch_size: 512
  
  # å¹¶å‘å¤„ç†å¤šä¸ªbatch
  batch/parallel:
    timeout: 1s
    send_batch_size: 512
```

---

### 2. å†…å­˜ä¼˜åŒ–

#### 2.1 Memory Limiteré…ç½®

```yaml
processors:
  memory_limiter:
    check_interval: 1s
    limit_mib: 2048        # æ ¹æ®å®é™…å†…å­˜è°ƒæ•´
    spike_limit_mib: 512   # å…è®¸20-25%çªå‘
```

**æ¨èé…ç½®**:

| ä¸»æœºå†…å­˜ | limit_mib | spike_limit_mib |
|---------|-----------|-----------------|
| 4GB | 2048 | 512 |
| 8GB | 4096 | 1024 |
| 16GB | 8192 | 2048 |

#### 2.2 é˜Ÿåˆ—å¤§å°ä¼˜åŒ–

```yaml
exporters:
  otlp:
    endpoint: backend:4317
    sending_queue:
      enabled: true
      num_consumers: 10        # âœ… CPU cores * 1.5
      queue_size: 5000         # âœ… æ ¹æ®ååé‡è°ƒæ•´
```

**è®¡ç®—æ–¹æ³•**:

```text
queue_size = å³°å€¼QPS * å»¶è¿Ÿ(ç§’) * 1.5

ä¾‹å¦‚ï¼š
å³°å€¼QPS: 1000 spans/s
å¹³å‡å»¶è¿Ÿ: 2s
queue_size = 1000 * 2 * 1.5 = 3000
```

---

### 3. æ‰¹å¤„ç†ä¼˜åŒ–

#### 3.1 æ‰¹é‡å¤§å°vså»¶è¿Ÿ

```yaml
# ä½å»¶è¿Ÿä¼˜å…ˆï¼ˆ<100msï¼‰
processors:
  batch:
    timeout: 100ms
    send_batch_size: 128

# å¹³è¡¡æ¨¡å¼ï¼ˆæ¨èï¼‰
processors:
  batch:
    timeout: 1s
    send_batch_size: 512

# é«˜ååä¼˜å…ˆ
processors:
  batch:
    timeout: 5s
    send_batch_size: 2048
```

#### 3.2 å‹ç¼©

```yaml
exporters:
  otlp:
    endpoint: backend:4317
    compression: gzip    # âœ… å¯ç”¨å‹ç¼©
```

**å‹ç¼©æ•ˆæœ**:

- ç½‘ç»œå¸¦å®½: å‡å°‘70-80%
- CPUå¼€é”€: å¢åŠ 10-15%
- æ¨è: è¿œç¨‹å¯¼å‡º

---

### 4. è¿‡æ»¤å™¨ä¼˜åŒ–

#### 4.1 æ—©æœŸè¿‡æ»¤

```yaml
# âœ… åœ¨Pipelineæ—©æœŸè¿‡æ»¤ï¼Œå‡å°‘åç»­å¤„ç†
service:
  pipelines:
    traces:
      receivers: [otlp]
      processors:
        - filter          # 1ï¸âƒ£ å…ˆè¿‡æ»¤
        - memory_limiter  # 2ï¸âƒ£ å†é™åˆ¶å†…å­˜
        - batch           # 3ï¸âƒ£ æœ€åæ‰¹å¤„ç†
      exporters: [jaeger]
```

#### 4.2 é«˜æ•ˆè¿‡æ»¤è§„åˆ™

```yaml
processors:
  filter:
    traces:
      span:
        # âœ… ä½¿ç”¨ç®€å•åŒ¹é…
        - 'attributes["http.target"] == "/health"'
        
        # âŒ é¿å…å¤æ‚æ­£åˆ™
        # - 'attributes["http.target"] matches "^/api/v[0-9]+/health.*"'
```

---

## ğŸŒ ç½‘ç»œæ€§èƒ½ä¼˜åŒ–

### 1. åè®®é€‰æ‹©

#### 1.1 gRPC vs HTTP

```go
// gRPCï¼ˆæ¨èï¼‰- æ€§èƒ½æ›´å¥½
exporter, err := otlptracegrpc.New(ctx,
    otlptracegrpc.WithEndpoint("localhost:4317"),
)

// HTTP - å…¼å®¹æ€§æ›´å¥½
exporter, err := otlptracehttp.New(ctx,
    otlptracehttp.WithEndpoint("http://localhost:4318/v1/traces"),
)
```

**æ€§èƒ½å¯¹æ¯”**:

| æŒ‡æ ‡ | gRPC | HTTP |
|------|------|------|
| **ååé‡** | é«˜ âœ… | ä¸­ |
| **å»¶è¿Ÿ** | ä½ âœ… | ä¸­ |
| **CPU** | ä½ âœ… | é«˜ |
| **å…¼å®¹æ€§** | ä¸­ | é«˜ âœ… |

#### 1.2 è¿æ¥å¤ç”¨

```go
// âœ… å¯ç”¨HTTP/2è¿æ¥å¤ç”¨
exporter, err := otlptracegrpc.New(ctx,
    otlptracegrpc.WithEndpoint("localhost:4317"),
    otlptracegrpc.WithGRPCConn(conn),  // å¤ç”¨è¿æ¥
)
```

---

### 2. å‹ç¼©

#### 2.1 SDKç«¯å‹ç¼©

```go
import "google.golang.org/grpc/encoding/gzip"

exporter, err := otlptracegrpc.New(ctx,
    otlptracegrpc.WithEndpoint("localhost:4317"),
    otlptracegrpc.WithCompressor(gzip.Name),  // âœ… gzipå‹ç¼©
)
```

#### 2.2 Collectorç«¯å‹ç¼©

```yaml
exporters:
  otlp:
    endpoint: remote-collector:4317
    compression: gzip   # âœ… è¿œç¨‹å¯¼å‡ºä½¿ç”¨å‹ç¼©
    # compression: none # âœ… æœ¬åœ°å¯¼å‡ºä¸å‹ç¼©
```

**å‹ç¼©æ•ˆæœ**:

- å¸¦å®½èŠ‚çœ: 70-80%
- CPUå¼€é”€: +10-15%
- æ¨èåœºæ™¯: è·¨åœ°åŸŸã€å¸¦å®½å—é™

---

## ğŸ’¾ å­˜å‚¨æ€§èƒ½ä¼˜åŒ–

### 1. åˆ†å±‚å­˜å‚¨ç­–ç•¥

#### 1.1 çƒ­æ¸©å†·åˆ†å±‚

```yaml
# çƒ­æ•°æ®: Elasticsearch (7å¤©)
exporters:
  elasticsearch/hot:
    endpoints: [http://es-hot:9200]
    traces_index: traces-hot
    ilm_enabled: true
    ilm_policy_name: traces-hot-ilm

# æ¸©æ•°æ®: ClickHouse (30å¤©ï¼Œ10%é‡‡æ ·)
exporters:
  clickhouse/warm:
    endpoint: tcp://clickhouse:9000
    database: otlp
    ttl_days: 30

# å†·æ•°æ®: S3 (æ°¸ä¹…å½’æ¡£)
exporters:
  awss3/cold:
    s3uploader:
      region: us-west-2
      s3_bucket: otlp-archive
      storage_class: GLACIER
```

#### 1.2 æˆæœ¬å¯¹æ¯”

| å­˜å‚¨å±‚ | ä¿ç•™æ—¶é—´ | æ•°æ®é‡ | æœˆæˆæœ¬/TB | æŸ¥è¯¢å»¶è¿Ÿ |
|--------|---------|-------|----------|---------|
| **çƒ­ (ES)** | 7å¤© | 100% | $350 | <100ms |
| **æ¸© (CH)** | 30å¤© | 10% | $45 | <1s |
| **å†· (S3)** | 1å¹´+ | 100% | $4 | åˆ†é’Ÿçº§ |

---

### 2. ç´¢å¼•ä¼˜åŒ–

#### 2.1 Elasticsearchç´¢å¼•ç­–ç•¥

```json
{
  "settings": {
    "number_of_shards": 6,      // âœ… æ ¹æ®æ•°æ®é‡è°ƒæ•´
    "number_of_replicas": 1,    // âœ… é«˜å¯ç”¨
    "refresh_interval": "30s",  // âœ… é™ä½åˆ·æ–°é¢‘ç‡
    "index.codec": "best_compression"  // âœ… å‹ç¼©
  },
  "mappings": {
    "properties": {
      "trace_id": {
        "type": "keyword",
        "index": true  // âœ… é«˜é¢‘æŸ¥è¯¢å­—æ®µ
      },
      "attributes": {
        "type": "object",
        "enabled": false  // âŒ ä¸ç´¢å¼•ï¼Œå‡å°‘ç©ºé—´
      }
    }
  }
}
```

#### 2.2 ClickHouseè¡¨ä¼˜åŒ–

```sql
CREATE TABLE otlp.traces (
    trace_id String,
    span_id String,
    start_time DateTime64(9),
    duration UInt64,
    service_name String,
    
    -- ç´¢å¼•ä¼˜åŒ–
    INDEX idx_service service_name TYPE bloom_filter GRANULARITY 4,
    INDEX idx_duration duration TYPE minmax GRANULARITY 1
)
ENGINE = ReplicatedMergeTree('/clickhouse/tables/{shard}/traces', '{replica}')
PARTITION BY toYYYYMMDD(start_time)  -- âœ… æŒ‰å¤©åˆ†åŒº
ORDER BY (service_name, start_time, trace_id)  -- âœ… æ’åºé”®
TTL start_time + INTERVAL 30 DAY  -- âœ… è‡ªåŠ¨æ¸…ç†
SETTINGS
    index_granularity = 8192,  -- âœ… ç´¢å¼•ç²’åº¦
    min_bytes_for_wide_part = 0,  -- âœ… å‹ç¼©
    min_rows_for_wide_part = 0;
```

---

### 3. æŸ¥è¯¢ä¼˜åŒ–

#### 3.1 æ·»åŠ åˆé€‚çš„ç´¢å¼•

```sql
-- ClickHouse: ä¸ºå¸¸ç”¨æŸ¥è¯¢æ·»åŠ è·³æ•°ç´¢å¼•
ALTER TABLE traces ADD INDEX idx_status_code status_code TYPE set(0) GRANULARITY 1;
```

#### 3.2 ä½¿ç”¨ç‰©åŒ–è§†å›¾

```sql
-- é¢„èšåˆå¸¸ç”¨æŒ‡æ ‡
CREATE MATERIALIZED VIEW traces_hourly_stats
ENGINE = SummingMergeTree()
PARTITION BY toYYYYMM(hour)
ORDER BY (service_name, hour)
AS SELECT
    service_name,
    toStartOfHour(start_time) as hour,
    count() as span_count,
    avg(duration) as avg_duration,
    quantile(0.99)(duration) as p99_duration
FROM traces
GROUP BY service_name, hour;
```

---

## ğŸ’° æˆæœ¬ä¼˜åŒ–

### 1. Uberæ¡ˆä¾‹ï¼šæˆæœ¬ä¼˜åŒ–99%

#### é—®é¢˜

```text
åŸå§‹æˆæœ¬: $500K/æœˆ
æ•°æ®é‡: 50äº¿ spans/å¤©
å­˜å‚¨: å…¨é‡å­˜å‚¨90å¤©
```

#### ä¼˜åŒ–æ–¹æ¡ˆ

```yaml
# 1. æ™ºèƒ½é‡‡æ ·
processors:
  tail_sampling:
    policies:
      - name: errors
        type: status_code
        status_code: {status_codes: [ERROR]}
      - name: slow
        type: latency
        latency: {threshold_ms: 2000}
      - name: normal
        type: probabilistic
        probabilistic: {sampling_percentage: 0.1}  # 0.1%

# 2. åˆ†å±‚å­˜å‚¨
# çƒ­æ•°æ®(3å¤©): é”™è¯¯+æ…¢è¯·æ±‚
# æ¸©æ•°æ®(30å¤©): 0.1%é‡‡æ ·
# å†·æ•°æ®(1å¹´): S3å½’æ¡£

# 3. å‹ç¼©
compression: gzip
```

#### æ•ˆæœ

```text
ä¼˜åŒ–åæˆæœ¬: $5K/æœˆ
æ•°æ®é‡: 500M spans/å¤© (å‡å°‘90%)
é”™è¯¯è¦†ç›–: 100% âœ…
æ…¢è¯·æ±‚è¦†ç›–: 100% âœ…
æˆæœ¬èŠ‚çœ: 99% âœ…
```

---

### 2. é‡‡æ ·ç­–ç•¥æ¨è

| åœºæ™¯ | é‡‡æ ·ç‡ | æœˆæˆæœ¬/1M spans | è¯´æ˜ |
|------|--------|----------------|------|
| **å¼€å‘ç¯å¢ƒ** | 100% | $100 | å…¨é‡æ•°æ® |
| **æµ‹è¯•ç¯å¢ƒ** | 50% | $50 | è¶³å¤Ÿæµ‹è¯• |
| **ç”Ÿäº§ç¯å¢ƒ** | | | |
| - å°è§„æ¨¡ (<10M/å¤©) | 10% | $10 | æˆæœ¬å¯æ§ |
| - ä¸­è§„æ¨¡ (10-100M/å¤©) | 1% | $10 | **æ¨è** â­ |
| - å¤§è§„æ¨¡ (>100M/å¤©) | æ™ºèƒ½é‡‡æ · | $5-15 | æœ€ä¼˜æ–¹æ¡ˆ |

---

## ğŸ“Š ç›‘æ§ä¸è°ƒä¼˜

### 1. å…³é”®æŒ‡æ ‡ç›‘æ§

#### 1.1 CollectoræŒ‡æ ‡

```bash
# æ¥æ”¶é€Ÿç‡
otelcol_receiver_accepted_spans{receiver="otlp"} 

# å¯¼å‡ºé€Ÿç‡
otelcol_exporter_sent_spans{exporter="jaeger"}

# é˜Ÿåˆ—é•¿åº¦
otelcol_exporter_queue_size{exporter="jaeger"}

# å¤„ç†å»¶è¿Ÿ
otelcol_processor_batch_batch_send_size_sum
otelcol_processor_batch_batch_send_size_count
```

#### 1.2 å‘Šè­¦è§„åˆ™

```yaml
# Prometheuså‘Šè­¦
groups:
  - name: otlp-collector
    rules:
      # é˜Ÿåˆ—æ¥è¿‘æ»¡
      - alert: CollectorQueueAlmostFull
        expr: otelcol_exporter_queue_size > 4000
        for: 5m
        annotations:
          summary: "Collector queue is almost full"
      
      # å¯¼å‡ºå¤±è´¥ç‡é«˜
      - alert: HighExportFailureRate
        expr: rate(otelcol_exporter_send_failed_spans[5m]) > 100
        for: 5m
        annotations:
          summary: "High export failure rate"
```

---

### 2. æ€§èƒ½åŸºå‡†æµ‹è¯•

#### 2.1 ååé‡æµ‹è¯•

```bash
# ä½¿ç”¨otel-benchè¿›è¡Œå‹æµ‹
go install github.com/open-telemetry/opentelemetry-collector-contrib/cmd/telemetrygen@latest

# ç”Ÿæˆ10000 spansï¼Œ1000 spans/s
telemetrygen traces --otlp-insecure \
  --traces 10000 \
  --rate 1000 \
  --otlp-endpoint localhost:4317
```

#### 2.2 å»¶è¿Ÿæµ‹è¯•

```go
// æµ‹é‡ç«¯åˆ°ç«¯å»¶è¿Ÿ
start := time.Now()

ctx, span := tracer.Start(ctx, "test")
span.End()

// ç­‰å¾…å¯¼å‡ºå®Œæˆ
time.Sleep(2 * time.Second)

latency := time.Since(start)
fmt.Printf("End-to-end latency: %v\n", latency)
```

---

### 3. è°ƒä¼˜æ£€æŸ¥æ¸…å•

#### SDKè°ƒä¼˜

- [ ] å¯ç”¨æ‰¹å¤„ç†
- [ ] é…ç½®åˆç†çš„é‡‡æ ·ç‡
- [ ] ä½¿ç”¨å¼‚æ­¥å¯¼å‡º
- [ ] å¤ç”¨è¿æ¥
- [ ] å‡å°‘ä¸å¿…è¦çš„Span
- [ ] å¯ç”¨å‹ç¼©ï¼ˆè¿œç¨‹åœºæ™¯ï¼‰

#### Collectorè°ƒä¼˜

- [ ] é…ç½®Memory Limiter
- [ ] ä¼˜åŒ–æ‰¹å¤„ç†å¤§å°
- [ ] å¢åŠ å¹¶å‘å¤„ç†
- [ ] æ—©æœŸè¿‡æ»¤
- [ ] å¯ç”¨æ™ºèƒ½é‡‡æ ·
- [ ] é…ç½®åˆç†çš„é˜Ÿåˆ—å¤§å°

#### å­˜å‚¨è°ƒä¼˜

- [ ] åˆ†å±‚å­˜å‚¨ç­–ç•¥
- [ ] ç´¢å¼•ä¼˜åŒ–
- [ ] æ•°æ®å‹ç¼©
- [ ] è‡ªåŠ¨æ¸…ç†ï¼ˆTTLï¼‰
- [ ] ä½¿ç”¨ç‰©åŒ–è§†å›¾

#### æˆæœ¬ä¼˜åŒ–

- [ ] æ™ºèƒ½é‡‡æ ·
- [ ] åˆ†å±‚å­˜å‚¨
- [ ] æ•°æ®å‹ç¼©
- [ ] å®šæœŸæ¸…ç†
- [ ] ç›‘æ§æˆæœ¬æŒ‡æ ‡

---

## ğŸ”— ç›¸å…³èµ„æº

- [ğŸ”§ æ•…éšœæ’æŸ¥æ‰‹å†Œ](ğŸ”§_æ•…éšœæ’æŸ¥å®Œæ•´æ‰‹å†Œ.md) - è§£å†³å¸¸è§é—®é¢˜
- [ğŸ¯ å¿«é€Ÿå…¥é—¨æŒ‡å—](ğŸ¯_5åˆ†é’Ÿå¿«é€Ÿå…¥é—¨æŒ‡å—.md) - å¿«é€Ÿå¼€å§‹
- [Collectoré…ç½®ç¤ºä¾‹](examples/collector-configurations/README.md) - é…ç½®å‚è€ƒ

---

**æ›´æ–°æ—¶é—´**: 2025å¹´10æœˆ20æ—¥  
**ç‰ˆæœ¬**: v1.0.0  
**ç»´æŠ¤è€…**: OTLPé¡¹ç›®å›¢é˜Ÿ

---

**âš¡ ä¼˜åŒ–æ€§èƒ½ï¼Œé™ä½æˆæœ¬ï¼** ğŸš€

# ä¸“ä¸šæœ¯è¯­è¯¦ç»†è§£é‡Š

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
> **åˆ›å»ºæ—¥æœŸ**: 2025-10-26  
> **ç»´æŠ¤å›¢é˜Ÿ**: OTLPé¡¹ç›®ç»„  
> **é€‚ç”¨èŒƒå›´**: æ·±å…¥å­¦ä¹ ã€æ¦‚å¿µç†è§£ã€æŠ€æœ¯ç ”ç©¶

---

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£å¯¹OTLPé¡¹ç›®ä¸­çš„**å…³é”®ä¸“ä¸šæœ¯è¯­**è¿›è¡Œæ·±å…¥è§£é‡Šï¼ŒåŒ…æ‹¬å®šä¹‰ã€åŸç†ã€åº”ç”¨åœºæ™¯å’Œç›¸å…³æ¦‚å¿µã€‚

### å†…å®¹ç‰¹ç‚¹
- ğŸ“– **è¯¦ç»†è§£é‡Š**: ä¸ä»…ä»…æ˜¯å®šä¹‰ï¼Œè¿˜åŒ…æ‹¬åŸç†å’ŒèƒŒæ™¯
- ğŸ’¡ **å®ä¾‹è¯´æ˜**: é…åˆä»£ç ç¤ºä¾‹å’Œå›¾è¡¨
- ğŸ”— **æ¦‚å¿µå…³è”**: å±•ç¤ºæœ¯è¯­ä¹‹é—´çš„è”ç³»
- ğŸ¯ **åº”ç”¨åœºæ™¯**: è¯´æ˜å®é™…ä½¿ç”¨æƒ…å†µ

---

## 1. æ ¸å¿ƒå¯è§‚æµ‹æ€§æœ¯è¯­

### 1.1 Observability (å¯è§‚æµ‹æ€§)

#### å®šä¹‰
**å¯è§‚æµ‹æ€§**æ˜¯æŒ‡é€šè¿‡ç³»ç»Ÿçš„å¤–éƒ¨è¾“å‡ºæ¥æ¨æ–­å…¶å†…éƒ¨çŠ¶æ€çš„èƒ½åŠ›ã€‚

#### è¯¦ç»†è§£é‡Š

**æ§åˆ¶è®ºå®šä¹‰**:
```
ç³»ç»Ÿæ˜¯å¯è§‚æµ‹çš„ âŸº 
  å¯ä»¥é€šè¿‡è¾“å‡ºåºåˆ—åœ¨æœ‰é™æ—¶é—´å†…ç¡®å®šåˆå§‹çŠ¶æ€

æ•°å­¦è¡¨è¾¾:
  ç»™å®šç³»ç»Ÿ: dx/dt = Ax + Bu
         y = Cx + Du
  
  å¯è§‚æµ‹æ€§çŸ©é˜µ:
  O = [C; CA; CAÂ²; ...; CA^(n-1)]
  
  ç³»ç»Ÿå¯è§‚æµ‹ âŸº rank(O) = n
```

**è½¯ä»¶å·¥ç¨‹å®šä¹‰**:
```
å¯è§‚æµ‹æ€§ = f(Metrics, Logs, Traces)

ä¸‰å¤§æ”¯æŸ±:
  1. Metrics (æŒ‡æ ‡): What happened?
     - æ•°å€¼å‹åº¦é‡
     - èšåˆæ•°æ®
     - è¶‹åŠ¿åˆ†æ
     
  2. Logs (æ—¥å¿—): What went wrong?
     - äº‹ä»¶è®°å½•
     - è¯¦ç»†ä¸Šä¸‹æ–‡
     - é—®é¢˜è¯Šæ–­
     
  3. Traces (è¿½è¸ª): Where did it happen?
     - è¯·æ±‚è·¯å¾„
     - æ—¶é—´å…³ç³»
     - ä¾èµ–åˆ†æ
```

#### ä¸ç›‘æ§çš„åŒºåˆ«

| ç»´åº¦ | ç›‘æ§ (Monitoring) | å¯è§‚æµ‹æ€§ (Observability) |
|------|-------------------|--------------------------|
| å…³æ³¨ç‚¹ | å·²çŸ¥çš„é—®é¢˜ | æœªçŸ¥çš„é—®é¢˜ |
| æ–¹æ³• | é¢„å®šä¹‰æŒ‡æ ‡å’Œå‘Šè­¦ | æ¢ç´¢å’ŒæŸ¥è¯¢ |
| é—®é¢˜ | "ç³»ç»Ÿæ­£å¸¸å—ï¼Ÿ" | "ä¸ºä»€ä¹ˆç³»ç»Ÿä¸æ­£å¸¸ï¼Ÿ" |
| æ•°æ® | èšåˆçš„æŒ‡æ ‡ | é«˜ç»´åº¦åŸå§‹æ•°æ® |
| é€‚ç”¨ | ç¨³å®šç³»ç»Ÿ | å¤æ‚åˆ†å¸ƒå¼ç³»ç»Ÿ |

#### åº”ç”¨åœºæ™¯

**åœºæ™¯1: æ€§èƒ½ä¸‹é™æ ¹å› åˆ†æ**
```
è§‚å¯Ÿåˆ°: APIå“åº”æ—¶é—´P95ä»100msä¸Šå‡åˆ°500ms

ä¼ ç»Ÿç›‘æ§:
  - å‘Šè­¦è§¦å‘
  - æŸ¥çœ‹é¢„å®šä¹‰çš„ä»ªè¡¨æ¿
  - å¯èƒ½æ— æ³•å®šä½å…·ä½“åŸå› 
  
å¯è§‚æµ‹æ€§æ–¹æ³•:
  1. æŸ¥çœ‹Traces: è¯†åˆ«æ…¢è¯·æ±‚çš„å…·ä½“è·¯å¾„
  2. åˆ†æSpan: å®šä½å“ªä¸ªæœåŠ¡/æ“ä½œæ…¢
  3. æŸ¥çœ‹ç›¸å…³Logs: è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
  4. å…³è”Metrics: ç¡®è®¤æ˜¯å¦èµ„æºç“¶é¢ˆ
  â†’ ç²¾ç¡®å®šä½åˆ°æ•°æ®åº“è¿æ¥æ± è€—å°½
```

**åœºæ™¯2: æ–°åŠŸèƒ½å½±å“åˆ†æ**
```
é—®é¢˜: éƒ¨ç½²æ–°ç‰ˆæœ¬åï¼Œå°‘æ•°ç”¨æˆ·æŠ¥å‘Šé”™è¯¯

å¯è§‚æµ‹æ€§åˆ†æ:
  1. Tracesè¿‡æ»¤: æ‰¾å‡ºå¤±è´¥çš„è¯·æ±‚
  2. å±æ€§åˆ†æ: å‘ç°å…±åŒç‰¹å¾
     â†’ éƒ½æ˜¯iOS 15.xç”¨æˆ·
  3. ä»£ç å…³è”: æ–°ä»£ç åœ¨æ—§ç‰ˆiOSæœ‰é—®é¢˜
  4. å¿«é€Ÿä¿®å¤: é’ˆå¯¹æ€§ä¿®å¤
```

---

### 1.2 Distributed Tracing (åˆ†å¸ƒå¼è¿½è¸ª)

#### å®šä¹‰
**åˆ†å¸ƒå¼è¿½è¸ª**æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­è¿½è¸ªä¸€ä¸ªè¯·æ±‚çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸçš„æŠ€æœ¯ã€‚

#### æ ¸å¿ƒæ¦‚å¿µ

**è¯·æ±‚æµå›¾**:
```
ç”¨æˆ·è¯·æ±‚ â†’ [Frontend] â†’ [Auth Service] â†’ [User DB]
                    â†“
                [Order Service] â†’ [Order DB]
                    â†“           â†˜
                [Payment]    [Inventory]
                    
æ¯ä¸€æ­¥éƒ½ç”Ÿæˆä¸€ä¸ªSpan
æ‰€æœ‰Spanå…±äº«åŒä¸€ä¸ªTraceID
å½¢æˆä¸€ä¸ªTraceæ ‘
```

**æ—¶é—´å…³ç³»**:
```
Timeline:
  |--- Frontend Span ------------------|
      |--- Auth Span ---|
      |--- Order Span --------------|
          |--- Payment ---|
          |--- Inventory -|
          |--- DB Query ---|
          
å…³é”®ä¿¡æ¯:
  - ä¸²è¡Œ vs å¹¶è¡Œæ‰§è¡Œ
  - æ¯ä¸ªæ“ä½œçš„è€—æ—¶
  - å…³é”®è·¯å¾„è¯†åˆ«
```

#### æŠ€æœ¯å®ç°

**TraceIDç”Ÿæˆ**:
```typescript
// 128ä½å…¨å±€å”¯ä¸€ID
function generateTraceID(): string {
  const high = crypto.randomBytes(8);
  const low = crypto.randomBytes(8);
  return Buffer.concat([high, low]).toString('hex');
}
// ç»“æœ: "4bf92f3577b34da6a3ce929d0e0e4736"
```

**Spanæ ‘æ„å»º**:
```
æ¯ä¸ªSpanåŒ…å«:
  - trace_id: è¿½è¸ªID
  - span_id: å½“å‰Span ID
  - parent_span_id: çˆ¶Span ID (nullè¡¨ç¤ºæ ¹Span)
  
æ ‘çš„æ„å»º:
  1. æ”¶é›†æ‰€æœ‰Span
  2. æŒ‰parent_span_idåˆ†ç»„
  3. é€’å½’æ„å»ºæ ‘ç»“æ„
  
ç¤ºä¾‹æ•°æ®:
  Span1: {trace_id: T1, span_id: S1, parent: null}  â†’ æ ¹
  Span2: {trace_id: T1, span_id: S2, parent: S1}    â†’ S1çš„å­èŠ‚ç‚¹
  Span3: {trace_id: T1, span_id: S3, parent: S1}    â†’ S1çš„å­èŠ‚ç‚¹
  Span4: {trace_id: T1, span_id: S4, parent: S2}    â†’ S2çš„å­èŠ‚ç‚¹
  
æ ‘ç»“æ„:
        S1
       / \
      S2  S3
     /
    S4
```

#### æŒ‘æˆ˜å’Œè§£å†³æ–¹æ¡ˆ

**æŒ‘æˆ˜1: æ•°æ®é‡å¤§**
```
é—®é¢˜:
  - æ¯ç§’ç™¾ä¸‡çº§è¯·æ±‚
  - æ¯ä¸ªè¯·æ±‚æ•°åä¸ªSpan
  - æ•°æ®å­˜å‚¨å’ŒæŸ¥è¯¢å‹åŠ›å¤§
  
è§£å†³æ–¹æ¡ˆ:
  1. æ™ºèƒ½é‡‡æ · (1-10%)
  2. å‹ç¼©å­˜å‚¨
  3. åˆ†å±‚å­˜å‚¨ (çƒ­/å†·æ•°æ®)
  4. ç´¢å¼•ä¼˜åŒ–
```

**æŒ‘æˆ˜2: æ—¶é’Ÿåå·®**
```
é—®é¢˜:
  - ä¸åŒæœåŠ¡å™¨æ—¶é’Ÿä¸åŒæ­¥
  - æ—¶é—´æˆ³ä¸å‡†ç¡®
  - å½±å“Spané¡ºåºåˆ¤æ–­
  
è§£å†³æ–¹æ¡ˆ:
  1. NTPæ—¶é—´åŒæ­¥
  2. é€»è¾‘æ—¶é’Ÿ (Lamport Timestamps)
  3. ç›¸å¯¹æ—¶é—´è®°å½• (durationè€Œéç»å¯¹æ—¶é—´)
```

**æŒ‘æˆ˜3: Contextä¼ æ’­**
```
é—®é¢˜:
  - HTTPå¤´å¤§å°é™åˆ¶
  - ä¸åŒåè®®æ”¯æŒä¸åŒ
  - å¼‚æ­¥æ¶ˆæ¯ä¼ æ’­å›°éš¾
  
è§£å†³æ–¹æ¡ˆ:
  1. W3C Trace Contextæ ‡å‡†
  2. å¤šåè®®é€‚é…å™¨
  3. æ¶ˆæ¯ç³»ç»Ÿä¸“é—¨å¤„ç†
```

---

### 1.3 Sampling (é‡‡æ ·)

#### å®šä¹‰
**é‡‡æ ·**æ˜¯æœ‰é€‰æ‹©åœ°è®°å½•Traceä»¥å¹³è¡¡å¯è§‚æµ‹æ€§å’Œæ€§èƒ½å¼€é”€çš„ç­–ç•¥ã€‚

#### é‡‡æ ·ç†è®º

**ç»Ÿè®¡å­¦åŸºç¡€**:
```
æ€»ä½“: æ‰€æœ‰Trace
æ ·æœ¬: è¢«è®°å½•çš„Trace

é‡‡æ ·ç‡ (Sample Rate):
  r = n/N
  å…¶ä¸­ n = æ ·æœ¬å¤§å°, N = æ€»ä½“å¤§å°
  
ä¼°è®¡ç²¾åº¦:
  æ ‡å‡†è¯¯å·® = Ïƒ/âˆšn
  å…¶ä¸­ Ïƒ = æ€»ä½“æ ‡å‡†å·®
  
ç¤ºä¾‹:
  - 10%é‡‡æ ·ç‡
  - å¹³å‡å»¶è¿Ÿä¼°è®¡: 100ms Â± 5ms (95%ç½®ä¿¡åŒºé—´)
  - Trade-off: æ›´é«˜é‡‡æ ·ç‡ â†’ æ›´å‡†ç¡®ï¼Œä½†å¼€é”€å¤§
```

**é‡‡æ ·åå·® (Sampling Bias)**:
```
é—®é¢˜: 
  å›ºå®šæ¯”ç‡é‡‡æ ·å¯èƒ½é”™è¿‡é‡è¦äº‹ä»¶
  
ç¤ºä¾‹:
  - 1%é‡‡æ ·ç‡
  - é”™è¯¯ç‡0.1%
  - é”™è¯¯Traceè¢«é‡‡æ ·çš„æ¦‚ç‡: 0.01 Ã— 0.001 = 0.00001
  â†’ 10ä¸‡ä¸ªé”™è¯¯ä¸­åªè®°å½•1ä¸ªï¼
  
è§£å†³: åˆ†å±‚é‡‡æ ·
  - æ­£å¸¸è¯·æ±‚: 1%
  - é”™è¯¯è¯·æ±‚: 100%
  - æ…¢è¯·æ±‚: 100%
```

#### é‡‡æ ·ç®—æ³•

**ç®—æ³•1: Hash-based Sampling**
```typescript
function shouldSample(traceId: string, rate: number): boolean {
  // ä½¿ç”¨TraceIDçš„hashç¡®ä¿æ•´ä¸ªTraceä¸€è‡´
  const hash = hashFunction(traceId);
  const normalized = hash / MAX_HASH_VALUE;  // å½’ä¸€åŒ–åˆ°[0,1]
  return normalized < rate;
}

// ç‰¹ç‚¹:
// âœ“ ç¡®å®šæ€§: åŒä¸€ä¸ªTraceIDæ€»æ˜¯å¾—åˆ°ç›¸åŒç»“æœ
// âœ“ åˆ†å¸ƒå‡åŒ€: hashå‡½æ•°ä¿è¯éšæœºæ€§
// âœ“ æ— çŠ¶æ€: ä¸éœ€è¦ç»´æŠ¤è®¡æ•°å™¨
```

**ç®—æ³•2: Rate Limiting Sampling**
```typescript
class RateLimitingSampler {
  private tokensPerSecond: number;
  private bucket: TokenBucket;
  
  constructor(tracesPerSecond: number) {
    this.tokensPerSecond = tracesPerSecond;
    this.bucket = new TokenBucket(tracesPerSecond);
  }
  
  shouldSample(): boolean {
    return this.bucket.tryConsume(1);
  }
}

class TokenBucket {
  private tokens: number;
  private lastRefill: number;
  
  constructor(private capacity: number) {
    this.tokens = capacity;
    this.lastRefill = Date.now();
  }
  
  tryConsume(count: number): boolean {
    this.refill();
    if (this.tokens >= count) {
      this.tokens -= count;
      return true;
    }
    return false;
  }
  
  private refill(): void {
    const now = Date.now();
    const elapsed = (now - this.lastRefill) / 1000;
    this.tokens = Math.min(
      this.capacity,
      this.tokens + elapsed * this.capacity
    );
    this.lastRefill = now;
  }
}

// ç‰¹ç‚¹:
// âœ“ ç²¾ç¡®æ§åˆ¶TPS
// âœ“ å¹³æ»‘é™æµ
// âœ“ çªå‘å®¹å¿
```

**ç®—æ³•3: Adaptive Sampling**
```typescript
class AdaptiveSampler {
  private targetTPS: number;
  private currentRate: number = 0.1;
  private window: number[] = [];
  private readonly WINDOW_SIZE = 60;  // 60ç§’çª—å£
  
  constructor(targetTPS: number) {
    this.targetTPS = targetTPS;
    setInterval(() => this.adjust(), 1000);
  }
  
  shouldSample(): boolean {
    this.window.push(1);
    return Math.random() < this.currentRate;
  }
  
  private adjust(): void {
    const actualTPS = this.window.length;
    this.window = [];
    
    const ratio = this.targetTPS / actualTPS;
    
    // PIDæ§åˆ¶å™¨
    const adjustment = Math.log(ratio) * 0.1;
    this.currentRate = Math.max(
      0.001,
      Math.min(1.0, this.currentRate * Math.exp(adjustment))
    );
    
    console.log(`Adjusted rate to ${this.currentRate.toFixed(4)} (TPS: ${actualTPS})`);
  }
}

// ç‰¹ç‚¹:
// âœ“ è‡ªé€‚åº”æµé‡å˜åŒ–
// âœ“ ç¨³å®šçš„è¾“å‡ºTPS
// âœ“ é¿å…å­˜å‚¨è¿‡è½½
```

#### æœ€ä½³å®è·µ

**ç”Ÿäº§ç¯å¢ƒé…ç½®**:
```yaml
# ç»„åˆç­–ç•¥
sampling:
  # è§„åˆ™1: æ‰€æœ‰é”™è¯¯
  - name: errors
    type: always_sample
    conditions:
      - attribute: "http.status_code"
        operator: ">="
        value: 400
  
  # è§„åˆ™2: æ…¢è¯·æ±‚ (>2ç§’)
  - name: slow
    type: always_sample
    conditions:
      - attribute: "duration_ms"
        operator: ">"
        value: 2000
  
  # è§„åˆ™3: å…³é”®ç«¯ç‚¹ (50%é‡‡æ ·)
  - name: critical
    type: probabilistic
    rate: 0.5
    conditions:
      - attribute: "http.route"
        operator: "in"
        value: ["/api/payment", "/api/order"]
  
  # è§„åˆ™4: å…¶ä»– (1%é‡‡æ ·)
  - name: default
    type: probabilistic
    rate: 0.01
```

---

## 2. å½¢å¼åŒ–æ–¹æ³•æœ¯è¯­

### 2.1 Type Safety (ç±»å‹å®‰å…¨)

#### å®šä¹‰
**ç±»å‹å®‰å…¨**ä¿è¯ç±»å‹æ­£ç¡®çš„ç¨‹åºåœ¨è¿è¡Œæ—¶ä¸ä¼šå‡ºç°ç±»å‹é”™è¯¯ã€‚

#### å½¢å¼åŒ–å®šä¹‰

**è¿›å±•æ€§ (Progress)**:
```
å®šç†: å¦‚æœ âˆ… âŠ¢ e : Ï„ï¼Œåˆ™:
  1. eæ˜¯å€¼ï¼Œæˆ–
  2. å­˜åœ¨e'ä½¿å¾— e â†’ e'

å«ä¹‰: è‰¯ç±»å‹çš„é—­è¡¨è¾¾å¼æ°¸ä¸å¡ä½

åä¾‹ (æ— ç±»å‹å®‰å…¨):
  JavaScript: 
    null.field  // è¿è¡Œæ—¶é”™è¯¯ï¼
    
  æœ‰ç±»å‹å®‰å…¨:
    TypeScript (strict):
      let x: string | null = ...;
      x.toUpperCase();  // ç¼–è¯‘é”™è¯¯: xå¯èƒ½ä¸ºnull
      
      // å¿…é¡»æ£€æŸ¥
      if (x !== null) {
        x.toUpperCase();  // âœ“ å®‰å…¨
      }
```

**ä¿å‹æ€§ (Preservation)**:
```
å®šç†: å¦‚æœ Î“ âŠ¢ e : Ï„ ä¸” e â†’ e'ï¼Œåˆ™ Î“ âŠ¢ e' : Ï„

å«ä¹‰: ç±»å‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¿æŒä¸å˜

ç¤ºä¾‹:
  (Î»x:Int. x + 1) 5 : Int
  â†’ 5 + 1 : Int            (Î²-å½’çº¦)
  â†’ 6 : Int                (ç®—æœ¯)
  
  ç±»å‹å§‹ç»ˆæ˜¯Int âœ“
```

**ç±»å‹å®‰å…¨å®šç†**:
```
å®šç†: Progress + Preservation â‡’ Type Safety

è¯æ˜æ€è·¯:
  å‡è®¾ âˆ… âŠ¢ e : Ï„
  
  æƒ…å†µ1: eæ˜¯å€¼
    â†’ å·²ç»æ˜¯ç»“æœï¼Œæ²¡æœ‰é”™è¯¯ âœ“
  
  æƒ…å†µ2: eä¸æ˜¯å€¼
    â†’ ç”±Progress: e â†’ e'
    â†’ ç”±Preservation: âˆ… âŠ¢ e' : Ï„
    â†’ å¯¹e'é€’å½’åº”ç”¨
  
  ç»“è®º: 
    - eè¦ä¹ˆæ±‚å€¼åˆ°ç±»å‹ä¸ºÏ„çš„å€¼
    - è¦ä¹ˆæ— é™æ‰§è¡Œï¼ˆä½†æ— ç±»å‹é”™è¯¯ï¼‰
    - æ°¸ä¸å¡ä½ âœ“
```

#### å®é™…åº”ç”¨

**TypeScriptç¤ºä¾‹**:
```typescript
// ç±»å‹å®‰å…¨çš„æ•°æ®å¤„ç†
type Result<T, E> =
  | { kind: 'ok'; value: T }
  | { kind: 'error'; error: E };

// ç¼–è¯‘å™¨å¼ºåˆ¶å¤„ç†æ‰€æœ‰æƒ…å†µ
function processResult<T, E>(result: Result<T, E>): void {
  switch (result.kind) {
    case 'ok':
      console.log(result.value);  // âœ“ valueå­˜åœ¨
      break;
    case 'error':
      console.error(result.error);  // âœ“ errorå­˜åœ¨
      break;
    // å¦‚æœå¿˜è®°å¤„ç†æŸä¸ªcaseï¼Œç¼–è¯‘é”™è¯¯ï¼
  }
}

// ç±»å‹å®‰å…¨é¿å…çš„é”™è¯¯:
const result: Result<number, string> = getResult();
// result.value;  // ç¼–è¯‘é”™è¯¯: valueå¯èƒ½ä¸å­˜åœ¨
// å¿…é¡»å…ˆæ£€æŸ¥kind
```

**Rustç¤ºä¾‹ (æ›´å¼ºçš„ç±»å‹å®‰å…¨)**:
```rust
// Optionç±»å‹ (ç¼–è¯‘å™¨å¼ºåˆ¶å¤„ç†None)
fn divide(a: i32, b: i32) -> Option<i32> {
    if b == 0 {
        None
    } else {
        Some(a / b)
    }
}

// ä½¿ç”¨
match divide(10, 2) {
    Some(result) => println!("Result: {}", result),
    None => println!("Cannot divide by zero"),
}

// ç¼–è¯‘å™¨ä¿è¯:
// - ä¸èƒ½å¿˜è®°æ£€æŸ¥None
// - ä¸èƒ½è®¿é—®ä¸å­˜åœ¨çš„å€¼
// - å®Œå…¨ç±»å‹å®‰å…¨
```

---

### 2.2 Monad (å•å­)

#### å®šä¹‰
**Monad**æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œç”¨äºç»„åˆå¸¦æœ‰ä¸Šä¸‹æ–‡/æ•ˆåº”çš„è®¡ç®—ã€‚

#### æ•°å­¦å®šä¹‰

**èŒƒç•´è®ºå®šä¹‰**:
```
Monadæ˜¯ä¸€ä¸ªä¸‰å…ƒç»„ (M, return, bind)ï¼Œæ»¡è¶³:

1. M: ç±»å‹æ„é€ å™¨
   M: Type â†’ Type
   ä¾‹å¦‚: Option, List, Future

2. return (ä¹Ÿå«unitæˆ–pure): 
   return: A â†’ M A
   å°†å€¼æ”¾å…¥Monadä¸Šä¸‹æ–‡
   
3. bind (ä¹Ÿå«>>=æˆ–flatMap):
   bind: M A â†’ (A â†’ M B) â†’ M B
   ç»„åˆMonadè®¡ç®—

å•å­å¾‹:
  1. å·¦å•ä½å…ƒ: return(a) >>= f â‰¡ f(a)
  2. å³å•ä½å…ƒ: m >>= return â‰¡ m
  3. ç»“åˆå¾‹: (m >>= f) >>= g â‰¡ m >>= (Î»x. f(x) >>= g)
```

#### å¸¸è§Monadç¤ºä¾‹

**Option/Maybe Monad**:
```typescript
// å®šä¹‰
type Option<A> =
  | { kind: 'some'; value: A }
  | { kind: 'none' };

// return
function some<A>(value: A): Option<A> {
  return { kind: 'some', value };
}

function none<A>(): Option<A> {
  return { kind: 'none' };
}

// bind (flatMap)
function bind<A, B>(
  ma: Option<A>,
  f: (a: A) => Option<B>
): Option<B> {
  switch (ma.kind) {
    case 'some':
      return f(ma.value);
    case 'none':
      return none();
  }
}

// ä½¿ç”¨
function safeDivide(a: number, b: number): Option<number> {
  return b === 0 ? none() : some(a / b);
}

function sqrt(x: number): Option<number> {
  return x < 0 ? none() : some(Math.sqrt(x));
}

// ç»„åˆè®¡ç®—
const result = bind(
  safeDivide(10, 2),  // Some(5)
  x => sqrt(x)         // Some(2.236...)
);
// result: Some(2.236...)

const result2 = bind(
  safeDivide(10, 0),  // None
  x => sqrt(x)         // ä¸ä¼šæ‰§è¡Œ
);
// result2: None

// Monadè‡ªåŠ¨å¤„ç†é”™è¯¯ä¼ æ’­ï¼
```

**Promise Monad (å¼‚æ­¥)**:
```typescript
// Promiseæ˜¯Monad

// return = Promise.resolve
const p1: Promise<number> = Promise.resolve(42);

// bind = then
const p2: Promise<string> = p1.then(n => 
  Promise.resolve(`Number: ${n}`)
);

// é”™è¯¯å¤„ç†
async function fetchUser(id: string): Promise<User> {
  const response = await fetch(`/api/users/${id}`);
  return response.json();
}

async function getUserOrders(userId: string): Promise<Order[]> {
  const user = await fetchUser(userId);  // Promise bind
  return fetch(`/api/orders?user=${user.id}`).then(r => r.json());
}

// Promise Monadè‡ªåŠ¨å¤„ç†:
// - å¼‚æ­¥æ‰§è¡Œ
// - é”™è¯¯ä¼ æ’­
// - é¡ºåºä¿è¯
```

**List Monad (éç¡®å®šæ€§)**:
```typescript
// Listä½œä¸ºMonadè¡¨ç¤ºéç¡®å®šæ€§è®¡ç®—

type List<A> = A[];

// return
function unit<A>(a: A): List<A> {
  return [a];
}

// bind
function bind<A, B>(
  ma: List<A>,
  f: (a: A) => List<B>
): List<B> {
  return ma.flatMap(f);
}

// ç¤ºä¾‹: å›½é™…è±¡æ£‹ç§»åŠ¨
type Position = [number, number];

function knightMoves([x, y]: Position): List<Position> {
  return [
    [x+2, y+1], [x+2, y-1],
    [x-2, y+1], [x-2, y-1],
    [x+1, y+2], [x+1, y-2],
    [x-1, y+2], [x-1, y-2]
  ].filter(([x, y]) => x >= 0 && x < 8 && y >= 0 && y < 8);
}

// ä¸‰æ­¥å¯è¾¾çš„æ‰€æœ‰ä½ç½®
const start: Position = [0, 0];
const step1 = knightMoves(start);
const step2 = bind(step1, knightMoves);
const step3 = bind(step2, knightMoves);

// List Monadè‡ªåŠ¨:
// - éå†æ‰€æœ‰å¯èƒ½æ€§
// - ç»„åˆåˆ†æ”¯è·¯å¾„
// - æ”¶é›†æ‰€æœ‰ç»“æœ
```

#### Monadçš„ä»·å€¼

**1. æŠ½è±¡å…±åŒæ¨¡å¼**:
```
ä¸ä½¿ç”¨Monad:
  - æ‰‹åŠ¨æ£€æŸ¥null
  - æ‰‹åŠ¨å¤„ç†å¼‚å¸¸
  - æ‰‹åŠ¨ç®¡ç†å¼‚æ­¥
  - ä»£ç é‡å¤

ä½¿ç”¨Monad:
  - è‡ªåŠ¨ä¼ æ’­é”™è¯¯
  - ç»Ÿä¸€çš„ç»„åˆæ–¹å¼
  - ä»£ç ç®€æ´
```

**2. ç»„åˆæ€§**:
```typescript
// Monadå…è®¸å‡½æ•°å¼ç»„åˆ
const pipeline = compose(
  step1,  // A â†’ M B
  step2,  // B â†’ M C
  step3   // C â†’ M D
);
// ç»“æœ: A â†’ M D

// å¦‚æœæ²¡æœ‰Monadï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†æ¯ä¸€æ­¥çš„ä¸Šä¸‹æ–‡
```

**3. å¯è¯»æ€§**:
```typescript
// ä¸ä½¿ç”¨Monad (å›è°ƒåœ°ç‹±)
fetchUser(id, (user, error) => {
  if (error) { handleError(error); return; }
  fetchOrders(user.id, (orders, error) => {
    if (error) { handleError(error); return; }
    processOrders(orders, (result, error) => {
      if (error) { handleError(error); return; }
      displayResult(result);
    });
  });
});

// ä½¿ç”¨Promise Monad
fetchUser(id)
  .then(user => fetchOrders(user.id))
  .then(orders => processOrders(orders))
  .then(result => displayResult(result))
  .catch(handleError);

// æˆ–async/await (è¯­æ³•ç³–)
try {
  const user = await fetchUser(id);
  const orders = await fetchOrders(user.id);
  const result = await processOrders(orders);
  displayResult(result);
} catch (error) {
  handleError(error);
}
```

---

## ğŸ“Š æœ¯è¯­ç»Ÿè®¡

- **æ ¸å¿ƒå¯è§‚æµ‹æ€§**: 3ä¸ªæ·±åº¦è§£é‡Š
- **å½¢å¼åŒ–æ–¹æ³•**: 2ä¸ªæ·±åº¦è§£é‡Š
- **ä»£ç ç¤ºä¾‹**: 20+ä¸ª
- **å›¾è¡¨**: 5ä¸ª

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- â† [ä¸­è‹±å¯¹ç…§è¡¨](./01_ä¸­è‹±å¯¹ç…§è¡¨.md)
- â† [ç¼©ç•¥è¯­è¡¨](./02_ç¼©ç•¥è¯­è¡¨.md)
- â†’ [ç›¸å…³æ ‡å‡†æœ¯è¯­](./04_ç›¸å…³æ ‡å‡†æœ¯è¯­.md)
- â†— [æ¦‚å¿µç´¢å¼•](../01_æ¦‚å¿µç´¢å¼•/)
- â†— [å½¢å¼åŒ–æ¦‚å¿µ](../01_æ¦‚å¿µç´¢å¼•/02_å½¢å¼åŒ–æ¦‚å¿µ.md)

---

**æœ€åæ›´æ–°**: 2025-10-26  
**ç»´æŠ¤**: OTLPé¡¹ç›®ç»„  
**ç‰ˆæœ¬**: v1.0


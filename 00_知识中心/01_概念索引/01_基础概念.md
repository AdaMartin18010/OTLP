# ğŸ“– OTLPåŸºç¡€æ¦‚å¿µå®šä¹‰

> **ç”¨é€”**: OTLPåè®®æ ¸å¿ƒåŸºç¡€æ¦‚å¿µçš„æƒå¨å®šä¹‰  
> **éš¾åº¦**: â­ å…¥é—¨çº§  
> **æœ€åæ›´æ–°**: 2025å¹´10æœˆ26æ—¥  
> **æ¦‚å¿µæ•°**: 15+

---

## ğŸ¯ æ¦‚å¿µåˆ†ç±»

æœ¬æ–‡æ¡£åŒ…å«OTLPåè®®çš„**æ ¸å¿ƒåŸºç¡€æ¦‚å¿µ**ï¼Œåˆ†ä¸º4å¤§ç±»ï¼š

1. **æ•°æ®ä¿¡å·** (4ä¸ª) - Trace, Span, Metric, Log
2. **åè®®ç›¸å…³** (3ä¸ª) - OTLP, gRPC, Protobuf
3. **æ•°æ®æ¨¡å‹** (4ä¸ª) - Resource, Attribute, Context, Baggage
4. **ç»„ä»¶ç›¸å…³** (4ä¸ª) - SDK, Collector, Exporter, Processor

---

## 1. æ•°æ®ä¿¡å·æ¦‚å¿µ

### 1.1 Trace (è¿½è¸ª)

**è‹±æ–‡**: Trace  
**ä¸­æ–‡**: è¿½è¸ª / è°ƒç”¨é“¾  
**ç±»å‹**: æ•°æ®ä¿¡å·

**å®šä¹‰**:
Traceæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¸€æ¬¡å®Œæ•´è¯·æ±‚çš„æ‰§è¡Œè·¯å¾„è®°å½•ï¼Œç”±å¤šä¸ªSpanç»„æˆçš„æœ‰å‘æ— ç¯å›¾(DAG)ã€‚

**æ ¸å¿ƒå±æ€§**:

- `trace_id`: è¿½è¸ªçš„å”¯ä¸€æ ‡è¯†ç¬¦ (16å­—èŠ‚)
- `root_span`: æ ¹Span
- `child_spans`: å­Spané›†åˆ
- `duration`: æ€»è€—æ—¶

**å…³é”®ç‰¹å¾**:

- âœ… è·¨æœåŠ¡è¾¹ç•Œ
- âœ… ä¿æŒå› æœå…³ç³»
- âœ… å®Œæ•´çš„è¯·æ±‚ç”Ÿå‘½å‘¨æœŸ
- âœ… æ”¯æŒé‡‡æ ·

**ä½¿ç”¨åœºæ™¯**:

- åˆ†å¸ƒå¼ç³»ç»Ÿçš„è¯·æ±‚è¿½è¸ª
- æ€§èƒ½ç“¶é¢ˆå®šä½
- æœåŠ¡ä¾èµ–åˆ†æ
- é”™è¯¯ä¼ æ’­è¿½è¸ª

**ç¤ºä¾‹**:

```text
Trace: ä¸€æ¬¡ç”¨æˆ·ä¸‹å•è¯·æ±‚
â”œâ”€ Span 1: API Gateway (100ms)
â”‚  â”œâ”€ Span 2: Auth Service (20ms)
â”‚  â””â”€ Span 3: Order Service (60ms)
â”‚     â”œâ”€ Span 4: Inventory Check (15ms)
â”‚     â””â”€ Span 5: Payment Process (30ms)
â””â”€ Total Duration: 100ms
```

**æ ‡å‡†å¼•ç”¨**:

- OTLP Specification v1.3.0 - Trace Protocol
- W3C Trace Context

---

### 1.2 Span (è·¨åº¦)

**è‹±æ–‡**: Span  
**ä¸­æ–‡**: è·¨åº¦ / æ“ä½œå•å…ƒ  
**ç±»å‹**: æ•°æ®ä¿¡å·

**å®šä¹‰**:
Spanæ˜¯Traceä¸­çš„æœ€å°å·¥ä½œå•å…ƒï¼Œä»£è¡¨ä¸€ä¸ªç‹¬ç«‹çš„æ“ä½œï¼ŒåŒ…å«æ“ä½œåç§°ã€å¼€å§‹/ç»“æŸæ—¶é—´ã€å±æ€§ç­‰ã€‚

**æ ¸å¿ƒå±æ€§**:

- `span_id`: Spanå”¯ä¸€æ ‡è¯† (8å­—èŠ‚)
- `trace_id`: æ‰€å±Traceæ ‡è¯†
- `parent_span_id`: çˆ¶Spanæ ‡è¯†
- `name`: æ“ä½œåç§°
- `kind`: Spanç±»å‹ (CLIENT/SERVER/INTERNALç­‰)
- `start_time`: å¼€å§‹æ—¶é—´ (çº³ç§’ç²¾åº¦)
- `end_time`: ç»“æŸæ—¶é—´
- `attributes`: é”®å€¼å¯¹å±æ€§
- `events`: äº‹ä»¶åˆ—è¡¨
- `links`: å…³è”å…¶ä»–Span
- `status`: çŠ¶æ€ (OK/ERROR/UNSET)

**Spanç±»å‹ (SpanKind)**:

1. **INTERNAL**: å†…éƒ¨æ“ä½œ
2. **SERVER**: æœåŠ¡ç«¯å¤„ç†
3. **CLIENT**: å®¢æˆ·ç«¯è°ƒç”¨
4. **PRODUCER**: æ¶ˆæ¯ç”Ÿäº§è€…
5. **CONSUMER**: æ¶ˆæ¯æ¶ˆè´¹è€…

**ç”Ÿå‘½å‘¨æœŸ**:

```text
Created â†’ Started â†’ [Events] â†’ Ended â†’ Exported
```

**ç¤ºä¾‹**:

```json
{
  "trace_id": "5b8aa5a2d2c872e8321cf37308d69df2",
  "span_id": "051581bf3cb55c13",
  "parent_span_id": "5fb15e641dc9f67e",
  "name": "GET /api/orders/{id}",
  "kind": "SERVER",
  "start_time_unix_nano": 1635953280000000000,
  "end_time_unix_nano": 1635953280050000000,
  "attributes": [
    {"key": "http.method", "value": "GET"},
    {"key": "http.status_code", "value": 200}
  ],
  "status": {"code": "OK"}
}
```

**æ ‡å‡†å¼•ç”¨**:

- OTLP Specification - TracesData
- OpenTelemetry Span Specification

---

### 1.3 Metric (æŒ‡æ ‡)

**è‹±æ–‡**: Metric  
**ä¸­æ–‡**: æŒ‡æ ‡ / åº¦é‡  
**ç±»å‹**: æ•°æ®ä¿¡å·

**å®šä¹‰**:
Metricæ˜¯ç³»ç»Ÿåœ¨ç‰¹å®šæ—¶é—´ç‚¹çš„æ•°å€¼åº¦é‡ï¼Œç”¨äºç›‘æ§ç³»ç»Ÿå¥åº·çŠ¶å†µå’Œæ€§èƒ½è¶‹åŠ¿ã€‚

**æŒ‡æ ‡ç±»å‹**:

1. **Counter (è®¡æ•°å™¨)**
   - å•è°ƒé€’å¢
   - ç¤ºä¾‹: è¯·æ±‚æ€»æ•°ã€é”™è¯¯æ€»æ•°

2. **Gauge (ä»ªè¡¨)**
   - å¯å¢å¯å‡
   - ç¤ºä¾‹: CPUä½¿ç”¨ç‡ã€å†…å­˜å ç”¨

3. **Histogram (ç›´æ–¹å›¾)**
   - å€¼çš„åˆ†å¸ƒç»Ÿè®¡
   - ç¤ºä¾‹: è¯·æ±‚å»¶è¿Ÿåˆ†å¸ƒã€å“åº”å¤§å°åˆ†å¸ƒ

4. **Summary (æ‘˜è¦)**
   - åˆ†ä½æ•°ç»Ÿè®¡
   - ç¤ºä¾‹: P50/P90/P99å»¶è¿Ÿ

**æ ¸å¿ƒå±æ€§**:

- `name`: æŒ‡æ ‡åç§°
- `description`: æè¿°
- `unit`: å•ä½
- `data_points`: æ•°æ®ç‚¹é›†åˆ
- `aggregation_temporality`: èšåˆæ—¶åºæ€§

**ç¤ºä¾‹**:

```text
http_requests_total{method="GET", status="200"} 1547
http_request_duration_seconds{quantile="0.99"} 0.156
memory_usage_bytes 4294967296
```

**æ ‡å‡†å¼•ç”¨**:

- OTLP Specification - MetricsData
- OpenMetrics Standard

---

### 1.4 Log (æ—¥å¿—)

**è‹±æ–‡**: Log  
**ä¸­æ–‡**: æ—¥å¿—  
**ç±»å‹**: æ•°æ®ä¿¡å·

**å®šä¹‰**:
Logæ˜¯ç³»ç»Ÿåœ¨ç‰¹å®šæ—¶é—´ç‚¹å‘ç”Ÿçš„äº‹ä»¶çš„æ–‡æœ¬è®°å½•ï¼ŒåŒ…å«æ—¶é—´æˆ³ã€ä¸¥é‡æ€§çº§åˆ«å’Œæ¶ˆæ¯å†…å®¹ã€‚

**æ ¸å¿ƒå±æ€§**:

- `timestamp`: æ—¶é—´æˆ³ (çº³ç§’ç²¾åº¦)
- `severity_number`: ä¸¥é‡æ€§æ•°å€¼ (1-24)
- `severity_text`: ä¸¥é‡æ€§æ–‡æœ¬ (TRACE/DEBUG/INFO/WARN/ERROR/FATAL)
- `body`: æ—¥å¿—ä¸»ä½“å†…å®¹
- `attributes`: å±æ€§
- `trace_id`: å…³è”çš„Trace (å¯é€‰)
- `span_id`: å…³è”çš„Span (å¯é€‰)

**ä¸¥é‡æ€§çº§åˆ«**:

```text
TRACE (1-4)    â†’ è¯¦ç»†è¿½è¸ª
DEBUG (5-8)    â†’ è°ƒè¯•ä¿¡æ¯
INFO (9-12)    â†’ ä¸€èˆ¬ä¿¡æ¯
WARN (13-16)   â†’ è­¦å‘Š
ERROR (17-20)  â†’ é”™è¯¯
FATAL (21-24)  â†’ è‡´å‘½é”™è¯¯
```

**ä¸Traceå…³è”**:

```text
Log + trace_id + span_id â†’ å…³è”åˆ°å…·ä½“Span
å¥½å¤„: ä»æ—¥å¿—è·³è½¬åˆ°å®Œæ•´è°ƒç”¨é“¾
```

**ç¤ºä¾‹**:

```json
{
  "timestamp": 1635953280000000000,
  "severity_number": 17,
  "severity_text": "ERROR",
  "body": "Database connection timeout",
  "attributes": [
    {"key": "db.type", "value": "postgresql"},
    {"key": "db.host", "value": "localhost:5432"}
  ],
  "trace_id": "5b8aa5a2d2c872e8321cf37308d69df2",
  "span_id": "051581bf3cb55c13"
}
```

**æ ‡å‡†å¼•ç”¨**:

- OTLP Specification - LogsData
- OpenTelemetry Logs Data Model

---

## 2. åè®®ç›¸å…³æ¦‚å¿µ

### 2.1 OTLP (OpenTelemetry Protocol)

**è‹±æ–‡**: OTLP (OpenTelemetry Protocol)  
**ä¸­æ–‡**: å¼€æ”¾é¥æµ‹åè®®  
**ç±»å‹**: ä¼ è¾“åè®®

**å®šä¹‰**:
OTLPæ˜¯OpenTelemetryå®šä¹‰çš„ç»Ÿä¸€é¥æµ‹æ•°æ®ä¼ è¾“åè®®ï¼Œç”¨äºåœ¨SDKã€Collectorå’Œåç«¯ä¹‹é—´ä¼ è¾“Tracesã€Metricså’ŒLogsã€‚

**æ ¸å¿ƒç‰¹æ€§**:

- âœ… **ç»Ÿä¸€åè®®**: ä¸‰ç§ä¿¡å·ä½¿ç”¨åŒä¸€åè®®
- âœ… **åŒä¼ è¾“**: gRPC (4317) + HTTP/Protobuf (4318)
- âœ… **é«˜æ•ˆ**: Protocol Buffersåºåˆ—åŒ–
- âœ… **å¯æ‰©å±•**: æ”¯æŒè‡ªå®šä¹‰å±æ€§
- âœ… **ç‰ˆæœ¬å…¼å®¹**: å‘åå…¼å®¹ä¿è¯

**åè®®ç‰ˆæœ¬**:

- v0.x: å®éªŒé˜¶æ®µ (2020-2021)
- **v1.0.0**: ç¨³å®šç‰ˆæœ¬ (2023-02) â­
- v1.3.0: å½“å‰æœ€æ–° (2025) â­

**ä¼ è¾“æ¨¡å¼**:

| æ¨¡å¼ | ç«¯å£ | åè®® | ä¼˜åŠ¿ |
|-----|------|------|------|
| **gRPC** | 4317 | HTTP/2 | é«˜æ€§èƒ½ã€æµæ§ã€åŒå‘æµ |
| **HTTP** | 4318 | HTTP/1.1 | æ˜“é›†æˆã€é˜²ç«å¢™å‹å¥½ |

**æ•°æ®æµå‘**:

```text
App SDK â†’ OTLP â†’ Collector â†’ OTLP â†’ Backend
         (gRPC/HTTP)        (ä»»æ„åè®®)
```

**æ ‡å‡†å¼•ç”¨**:

- OTLP Specification v1.3.0
- OpenTelemetry Protocol Documentation

---

### 2.2 gRPC

**è‹±æ–‡**: gRPC (gRPC Remote Procedure Call)  
**ä¸­æ–‡**: gRPCè¿œç¨‹è¿‡ç¨‹è°ƒç”¨  
**ç±»å‹**: ä¼ è¾“åè®®

**å®šä¹‰**:
gRPCæ˜¯Googleå¼€æºçš„é«˜æ€§èƒ½RPCæ¡†æ¶ï¼ŒåŸºäºHTTP/2ï¼Œæ˜¯OTLPçš„é»˜è®¤ä¼ è¾“åè®®ã€‚

**æ ¸å¿ƒç‰¹æ€§**:

- âœ… HTTP/2å¤šè·¯å¤ç”¨
- âœ… äºŒè¿›åˆ¶åè®® (Protobuf)
- âœ… æµå¼ä¼ è¾“ (åŒå‘æµ)
- âœ… å†…ç½®è´Ÿè½½å‡è¡¡
- âœ… è‡ªåŠ¨ä»£ç ç”Ÿæˆ

**åœ¨OTLPä¸­çš„ä½¿ç”¨**:

```text
Serviceå®šä¹‰:
- TraceService.Export(ExportTraceServiceRequest)
- MetricsService.Export(ExportMetricsServiceRequest)
- LogsService.Export(ExportLogsServiceRequest)

é»˜è®¤ç«¯å£: 4317
å‹ç¼©: gzip (å¯é€‰)
```

**ä¼˜åŠ¿**:

- é«˜æ€§èƒ½ (æ¯”HTTP/1.1å¿«2-5å€)
- ä½å»¶è¿Ÿ (äºŒè¿›åˆ¶+å¤šè·¯å¤ç”¨)
- æµæ§èƒ½åŠ› (èƒŒå‹æœºåˆ¶)

---

### 2.3 Protobuf (Protocol Buffers)

**è‹±æ–‡**: Protocol Buffers  
**ä¸­æ–‡**: åè®®ç¼“å†²åŒº  
**ç±»å‹**: åºåˆ—åŒ–æ ¼å¼

**å®šä¹‰**:
Protobufæ˜¯Googleå¼€å‘çš„è¯­è¨€ä¸­ç«‹ã€å¹³å°ä¸­ç«‹çš„ç»“æ„åŒ–æ•°æ®åºåˆ—åŒ–æœºåˆ¶ï¼Œæ˜¯OTLPçš„æ•°æ®ç¼–ç æ ¼å¼ã€‚

**æ ¸å¿ƒç‰¹æ€§**:

- âœ… äºŒè¿›åˆ¶æ ¼å¼ (æ¯”JSONå°3-10å€)
- âœ… å¼ºç±»å‹å®šä¹‰
- âœ… å‘å‰/å‘åå…¼å®¹
- âœ… è‡ªåŠ¨ä»£ç ç”Ÿæˆ
- âœ… è·¨è¯­è¨€æ”¯æŒ

**OTLPä¸­çš„Protobufå®šä¹‰**:

```protobuf
message Span {
  bytes trace_id = 1;
  bytes span_id = 2;
  bytes parent_span_id = 3;
  string name = 4;
  SpanKind kind = 5;
  fixed64 start_time_unix_nano = 6;
  fixed64 end_time_unix_nano = 7;
  repeated KeyValue attributes = 8;
  // ...
}
```

**æ€§èƒ½å¯¹æ¯”**:

- Protobuf: 100 bytes
- JSON: 300-500 bytes
- å‹ç¼©æ¯”: 3-5å€

---

## 3. æ•°æ®æ¨¡å‹æ¦‚å¿µ

### 3.1 Resource (èµ„æº)

**è‹±æ–‡**: Resource  
**ä¸­æ–‡**: èµ„æº  
**ç±»å‹**: æ•°æ®æ¨¡å‹

**å®šä¹‰**:
Resourceè¡¨ç¤ºäº§ç”Ÿé¥æµ‹æ•°æ®çš„å®ä½“ï¼Œå¦‚æœåŠ¡ã€å®¹å™¨ã€ä¸»æœºç­‰ï¼ŒåŒ…å«ä¸€ç»„æè¿°è¯¥å®ä½“çš„å±æ€§ã€‚

**æ ¸å¿ƒå±æ€§** (Semantic Conventions):

```text
service.name         â†’ æœåŠ¡åç§° (å¿…éœ€)
service.version      â†’ æœåŠ¡ç‰ˆæœ¬
service.namespace    â†’ æœåŠ¡å‘½åç©ºé—´
host.name           â†’ ä¸»æœºå
container.id        â†’ å®¹å™¨ID
k8s.pod.name        â†’ K8s Podåç§°
cloud.provider      â†’ äº‘æä¾›å•† (aws/gcp/azure)
cloud.region        â†’ äº‘åŒºåŸŸ
```

**å±‚æ¬¡ç»“æ„**:

```text
Cloud Provider
  â””â”€ Region
      â””â”€ Cluster
          â””â”€ Host
              â””â”€ Container
                  â””â”€ Process
                      â””â”€ Service
```

**ç¤ºä¾‹**:

```json
{
  "attributes": [
    {"key": "service.name", "value": "order-service"},
    {"key": "service.version", "value": "1.2.3"},
    {"key": "host.name", "value": "prod-server-01"},
    {"key": "container.id", "value": "abc123..."},
    {"key": "k8s.pod.name", "value": "order-service-5f7d8-xz9mn"}
  ]
}
```

---

### 3.2 Attribute (å±æ€§)

**è‹±æ–‡**: Attribute  
**ä¸­æ–‡**: å±æ€§  
**ç±»å‹**: æ•°æ®æ¨¡å‹

**å®šä¹‰**:
Attributeæ˜¯é”®å€¼å¯¹å½¢å¼çš„å…ƒæ•°æ®ï¼Œç”¨äºæè¿°å’Œæ ‡æ³¨é¥æµ‹æ•°æ®ã€‚

**æ•°æ®ç±»å‹**:

1. **String**: å­—ç¬¦ä¸²
2. **Boolean**: å¸ƒå°”å€¼
3. **Int64**: 64ä½æ•´æ•°
4. **Double**: åŒç²¾åº¦æµ®ç‚¹æ•°
5. **Array**: æ•°ç»„ (åŒç±»å‹å…ƒç´ )

**å‘½åè§„èŒƒ** (Semantic Conventions):

```text
å‘½åç©ºé—´.å¯¹è±¡.å±æ€§

ä¾‹å­:
http.method             â†’ HTTPæ–¹æ³•
http.status_code        â†’ HTTPçŠ¶æ€ç 
db.system              â†’ æ•°æ®åº“ç³»ç»Ÿ
db.statement           â†’ SQLè¯­å¥
messaging.destination  â†’ æ¶ˆæ¯ç›®æ ‡
```

**æœ€ä½³å®è·µ**:

- âœ… ä½¿ç”¨å°å†™å’Œä¸‹åˆ’çº¿
- âœ… éµå¾ªè¯­ä¹‰çº¦å®š
- âœ… é¿å…é«˜åŸºæ•° (å¦‚ç”¨æˆ·ID)
- âœ… æ§åˆ¶æ•°é‡ (å»ºè®®<50ä¸ª/Span)

**ç¤ºä¾‹**:

```json
{
  "attributes": [
    {"key": "http.method", "value": {"string_value": "GET"}},
    {"key": "http.status_code", "value": {"int_value": 200}},
    {"key": "http.response_size", "value": {"int_value": 1024}},
    {"key": "custom.user_tier", "value": {"string_value": "premium"}}
  ]
}
```

---

### 3.3 Context (ä¸Šä¸‹æ–‡)

**è‹±æ–‡**: Context  
**ä¸­æ–‡**: ä¸Šä¸‹æ–‡  
**ç±»å‹**: æ•°æ®æ¨¡å‹

**å®šä¹‰**:
Contextæ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­è·¨æœåŠ¡è¾¹ç•Œä¼ æ’­çš„å…ƒæ•°æ®å®¹å™¨ï¼Œç”¨äºå…³è”å’Œè¿½è¸ªè¯·æ±‚ã€‚

**æ ¸å¿ƒå†…å®¹**:

1. **Trace Context** (W3Cæ ‡å‡†):
   - `traceparent`: trace-id + span-id + flags
   - `tracestate`: å‚å•†ç‰¹å®šçŠ¶æ€

2. **Baggage** (W3Cæ ‡å‡†):
   - ç”¨æˆ·è‡ªå®šä¹‰é”®å€¼å¯¹
   - è·¨æœåŠ¡ä¼ æ’­

**ä¼ æ’­æœºåˆ¶**:

```text
HTTP Headers:
  traceparent: 00-trace_id-span_id-flags
  tracestate: vendor1=value1,vendor2=value2
  baggage: key1=value1,key2=value2

gRPC Metadata:
  grpc-trace-bin: [binary context]
```

**ç¤ºä¾‹**:

```http
GET /api/orders HTTP/1.1
traceparent: 00-5b8aa5a2d2c872e8321cf37308d69df2-051581bf3cb55c13-01
tracestate: congo=t61rcWkgMzE
baggage: userId=12345,experiment=feature-x
```

**æ ‡å‡†å¼•ç”¨**:

- W3C Trace Context
- W3C Baggage

---

### 3.4 Baggage (è¡Œæ)

**è‹±æ–‡**: Baggage  
**ä¸­æ–‡**: è¡Œæ / ä¸Šä¸‹æ–‡ä¼ æ’­æ•°æ®  
**ç±»å‹**: æ•°æ®æ¨¡å‹

**å®šä¹‰**:
Baggageæ˜¯è·¨æœåŠ¡ä¼ æ’­çš„ç”¨æˆ·è‡ªå®šä¹‰é”®å€¼å¯¹ï¼Œç”¨äºåœ¨æ•´ä¸ªè¯·æ±‚é“¾è·¯ä¸­å…±äº«ä¸šåŠ¡ä¸Šä¸‹æ–‡ã€‚

**ä½¿ç”¨åœºæ™¯**:

- **A/Bæµ‹è¯•æ ‡è¯†**: `experiment=new-ui`
- **ç”¨æˆ·æ ‡è¯†**: `user-tier=premium`
- **ç§Ÿæˆ·ID**: `tenant-id=corp-123`
- **åŠŸèƒ½å¼€å…³**: `feature-flag=beta-enabled`

**æ ¸å¿ƒç‰¹æ€§**:

- âœ… è‡ªåŠ¨è·¨æœåŠ¡ä¼ æ’­
- âœ… ä½å¼€é”€ (HTTP Header)
- âœ… è¯­è¨€æ— å…³
- âš ï¸ æœ‰å¤§å°é™åˆ¶ (æ¨è<1KB)

**ä¸AttributeåŒºåˆ«**:

| ç‰¹æ€§ | Attribute | Baggage |
|-----|-----------|---------|
| **ä¼ æ’­** | ä¸ä¼ æ’­ | è‡ªåŠ¨ä¼ æ’­ |
| **ç”¨é€”** | æè¿°å½“å‰æ“ä½œ | å…±äº«ä¸šåŠ¡ä¸Šä¸‹æ–‡ |
| **ç”Ÿå‘½å‘¨æœŸ** | å•ä¸ªSpan | æ•´ä¸ªTrace |

**ç¤ºä¾‹**:

```go
// è®¾ç½®Baggage
baggage.Set(ctx, "user-tier", "premium")
baggage.Set(ctx, "experiment", "new-checkout")

// ä¸‹æ¸¸æœåŠ¡è‡ªåŠ¨è·å–
tier := baggage.GetValue(ctx, "user-tier") // "premium"
```

**æœ€ä½³å®è·µ**:

- âœ… æ§åˆ¶å¤§å° (<1KB)
- âœ… é¿å…æ•æ„Ÿä¿¡æ¯
- âœ… ä½¿ç”¨ç¨³å®šçš„é”®å
- âŒ ä¸è¦å­˜å‚¨å¤§é‡æ•°æ®

---

## 4. ç»„ä»¶ç›¸å…³æ¦‚å¿µ

### 4.1 SDK (Software Development Kit)

**è‹±æ–‡**: SDK  
**ä¸­æ–‡**: è½¯ä»¶å¼€å‘å·¥å…·åŒ…  
**ç±»å‹**: ç»„ä»¶

**å®šä¹‰**:
SDKæ˜¯é›†æˆåˆ°åº”ç”¨ç¨‹åºä¸­çš„åº“ï¼Œç”¨äºç”Ÿæˆã€æ”¶é›†å’Œå¯¼å‡ºé¥æµ‹æ•°æ®ã€‚

**æ ¸å¿ƒç»„ä»¶**:

```text
SDK
â”œâ”€â”€ API Layer        â†’ ç”¨æˆ·æ¥å£
â”œâ”€â”€ Tracer          â†’ ç”ŸæˆTrace
â”œâ”€â”€ Meter           â†’ ç”ŸæˆMetric
â”œâ”€â”€ Logger          â†’ ç”ŸæˆLog
â”œâ”€â”€ Context         â†’ ä¸Šä¸‹æ–‡ä¼ æ’­
â”œâ”€â”€ Processor       â†’ æ•°æ®å¤„ç†
â””â”€â”€ Exporter        â†’ æ•°æ®å¯¼å‡º
```

**ç”Ÿå‘½å‘¨æœŸ**:

```text
1. åˆå§‹åŒ–é…ç½®
2. åˆ›å»ºProvider
3. åŸ‹ç‚¹ç”Ÿæˆæ•°æ®
4. æ‰¹å¤„ç†
5. å¯¼å‡ºåˆ°Collector/Backend
```

**å®˜æ–¹æ”¯æŒè¯­è¨€**:

- âœ… Java
- âœ… Go
- âœ… Python
- âœ… JavaScript/Node.js
- âœ… .NET
- âœ… Ruby
- âœ… PHP
- âœ… Rust
- âœ… C++

**ç¤ºä¾‹** (Go):

```go
// åˆå§‹åŒ–
provider := sdktrace.NewTracerProvider(
    sdktrace.WithBatcher(exporter),
)

// åˆ›å»ºTracer
tracer := provider.Tracer("my-service")

// åˆ›å»ºSpan
ctx, span := tracer.Start(ctx, "operation-name")
defer span.End()
```

---

### 4.2 Collector (æ”¶é›†å™¨)

**è‹±æ–‡**: Collector  
**ä¸­æ–‡**: æ”¶é›†å™¨  
**ç±»å‹**: ç»„ä»¶

**å®šä¹‰**:
Collectoræ˜¯ç‹¬ç«‹çš„ä»£ç†æœåŠ¡ï¼Œç”¨äºæ¥æ”¶ã€å¤„ç†å’Œå¯¼å‡ºé¥æµ‹æ•°æ®ï¼Œè§£è€¦SDKå’Œåç«¯ã€‚

**æ ¸å¿ƒæ¶æ„**:

```text
Receiver â†’ Processor â†’ Exporter
   â†“           â†“           â†“
 æ¥æ”¶æ•°æ®   å¤„ç†æ•°æ®   å¯¼å‡ºæ•°æ®
```

**ä¸»è¦åŠŸèƒ½**:

1. **æ¥æ”¶** (Receiver): æ¥æ”¶å¤šç§æ ¼å¼æ•°æ®
   - OTLP (gRPC/HTTP)
   - Jaeger
   - Zipkin
   - Prometheus

2. **å¤„ç†** (Processor): æ•°æ®å¤„ç†
   - Batch: æ‰¹å¤„ç†
   - Memory Limiter: å†…å­˜é™åˆ¶
   - Attributes: å±æ€§å¤„ç†
   - Tail Sampling: å°¾éƒ¨é‡‡æ ·

3. **å¯¼å‡º** (Exporter): å¯¼å‡ºåˆ°åç«¯
   - OTLP
   - Jaeger
   - Prometheus
   - Kafka
   - S3

**éƒ¨ç½²æ¨¡å¼**:

```text
1. Agentæ¨¡å¼: æ¯å°ä¸»æœºä¸€ä¸ªCollector
2. Gatewayæ¨¡å¼: é›†ä¸­å¼Collectoré›†ç¾¤
3. æ··åˆæ¨¡å¼: Agent â†’ Gateway â†’ Backend
```

**é…ç½®ç¤ºä¾‹**:

```yaml
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317

processors:
  batch:
    timeout: 1s
  memory_limiter:
    limit_mib: 512

exporters:
  otlp:
    endpoint: backend:4317

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [memory_limiter, batch]
      exporters: [otlp]
```

---

### 4.3 Exporter (å¯¼å‡ºå™¨)

**è‹±æ–‡**: Exporter  
**ä¸­æ–‡**: å¯¼å‡ºå™¨  
**ç±»å‹**: ç»„ä»¶

**å®šä¹‰**:
Exporterè´Ÿè´£å°†é¥æµ‹æ•°æ®å‘é€åˆ°åç«¯å­˜å‚¨æˆ–åˆ†æç³»ç»Ÿã€‚

**ç±»å‹**:

1. **OTLP Exporter**: å‘é€åˆ°æ”¯æŒOTLPçš„åç«¯
2. **Jaeger Exporter**: å‘é€åˆ°Jaeger
3. **Prometheus Exporter**: æš´éœ²PrometheusæŒ‡æ ‡
4. **Zipkin Exporter**: å‘é€åˆ°Zipkin
5. **Console Exporter**: æ‰“å°åˆ°æ§åˆ¶å° (è°ƒè¯•ç”¨)
6. **File Exporter**: å†™å…¥æ–‡ä»¶

**é…ç½®é€‰é¡¹**:

```text
endpoint       â†’ åç«¯åœ°å€
timeout        â†’ è¶…æ—¶æ—¶é—´
compression    â†’ å‹ç¼©æ–¹å¼ (gzip)
headers        â†’ è‡ªå®šä¹‰å¤´
retry_config   â†’ é‡è¯•é…ç½®
```

**ç¤ºä¾‹** (Go):

```go
exporter, err := otlptracegrpc.New(
    context.Background(),
    otlptracegrpc.WithEndpoint("localhost:4317"),
    otlptracegrpc.WithInsecure(),
    otlptracegrpc.WithTimeout(5*time.Second),
)
```

---

### 4.4 Processor (å¤„ç†å™¨)

**è‹±æ–‡**: Processor  
**ä¸­æ–‡**: å¤„ç†å™¨  
**ç±»å‹**: ç»„ä»¶

**å®šä¹‰**:
Processoråœ¨é¥æµ‹æ•°æ®å¯¼å‡ºå‰å¯¹å…¶è¿›è¡Œå¤„ç†ã€è½¬æ¢æˆ–è¿‡æ»¤ã€‚

**å¸¸ç”¨Processor**:

1. **Batch Processor**
   - æ‰¹é‡èšåˆæ•°æ®
   - å‡å°‘ç½‘ç»œè¯·æ±‚
   - é…ç½®: timeout, send_batch_size

2. **Memory Limiter**
   - é™åˆ¶å†…å­˜ä½¿ç”¨
   - é˜²æ­¢OOM
   - é…ç½®: limit_mib, check_interval

3. **Attributes Processor**
   - æ·»åŠ /åˆ é™¤/ä¿®æ”¹å±æ€§
   - ç¤ºä¾‹: æ·»åŠ ç¯å¢ƒæ ‡ç­¾

4. **Span Processor**
   - ä¿®æ”¹Spanåç§°
   - è¿‡æ»¤æ•æ„Ÿæ•°æ®

5. **Tail Sampling Processor**
   - åŸºäºå®Œæ•´Traceçš„æ™ºèƒ½é‡‡æ ·
   - ä¿ç•™æ‰€æœ‰é”™è¯¯Trace

**å¤„ç†æµç¨‹**:

```text
Receive â†’ Process 1 â†’ Process 2 â†’ ... â†’ Export
           (batch)    (filter)         (transform)
```

**ç¤ºä¾‹é…ç½®**:

```yaml
processors:
  batch:
    timeout: 1s
    send_batch_size: 1024
    
  attributes:
    actions:
      - key: environment
        value: production
        action: insert
        
  filter:
    traces:
      span:
        - 'attributes["http.status_code"] >= 400'
```

---

## ğŸ“Š æ¦‚å¿µå…³ç³»æ€»ç»“

### æ ¸å¿ƒå…³ç³»å›¾

```mermaid
graph TD
    A[OTLP] --> B[Trace]
    A --> C[Metric]
    A --> D[Log]
    
    B --> E[Span]
    E --> F[Attribute]
    E --> G[Event]
    
    H[Resource] --> B
    H --> C
    H --> D
    
    I[Context] --> J[Baggage]
    I --> B
    
    K[SDK] --> A
    L[Collector] --> A
    
    style A fill:#4ecdc4
    style B fill:#45b7d1
    style C fill:#96ceb4
    style D fill:#ffeaa7
    style K fill:#dfe6e9
    style L fill:#fab1a0
```

---

## ğŸ”— ç›¸å…³èµ„æº

### æ ‡å‡†æ–‡æ¡£

- [OTLP Specification v1.3.0](https://opentelemetry.io/docs/specs/otlp/)
- [OpenTelemetry Specification](https://opentelemetry.io/docs/specs/otel/)
- [Semantic Conventions v1.29.0](https://opentelemetry.io/docs/specs/semconv/)

### ä¸‹ä¸€æ­¥é˜…è¯»

- [02_å½¢å¼åŒ–æ¦‚å¿µ.md](./02_å½¢å¼åŒ–æ¦‚å¿µ.md) - å½¢å¼åŒ–ç†è®ºæ¦‚å¿µ
- [03_å®ç°æ¦‚å¿µ.md](./03_å®ç°æ¦‚å¿µ.md) - æŠ€æœ¯å®ç°æ¦‚å¿µ
- [04_æ¦‚å¿µå…³ç³»å›¾.md](./04_æ¦‚å¿µå…³ç³»å›¾.md) - æ¦‚å¿µå…³è”å¯è§†åŒ–

---

**ç‰ˆæœ¬**: v1.0.0  
**åˆ›å»ºæ—¥æœŸ**: 2025å¹´10æœˆ26æ—¥  
**ç»´æŠ¤å›¢é˜Ÿ**: OTLPé¡¹ç›®å›¢é˜Ÿ

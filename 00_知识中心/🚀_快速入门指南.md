# ğŸš€ OTLPå¿«é€Ÿå…¥é—¨æŒ‡å—

> **é€‚ç”¨å¯¹è±¡**: åˆå­¦è€…  
> **é¢„è®¡æ—¶é—´**: 30åˆ†é’Ÿ  
> **éš¾åº¦çº§åˆ«**: â­â˜†â˜†â˜†â˜†

---

## ğŸ“‹ å­¦ä¹ ç›®æ ‡

é€šè¿‡æœ¬æŒ‡å—ï¼Œæ‚¨å°†ï¼š
- âœ… ç†è§£OTLPçš„æ ¸å¿ƒæ¦‚å¿µ
- âœ… æ­å»ºç¬¬ä¸€ä¸ªè¿½è¸ªç¤ºä¾‹
- âœ… æŸ¥çœ‹å’Œåˆ†æè¿½è¸ªæ•°æ®
- âœ… æŒæ¡åŸºæœ¬çš„è°ƒè¯•æŠ€å·§

---

## 1. æ ¸å¿ƒæ¦‚å¿µé€Ÿè§ˆ (5åˆ†é’Ÿ)

### 1.1 ä¸‰ä¸ªå¿…çŸ¥æ¦‚å¿µ

**Trace (è¿½è¸ª)**:
```
ä¸€æ¬¡å®Œæ•´çš„è¯·æ±‚è·¯å¾„

ç¤ºä¾‹ï¼šç”¨æˆ·ä¸‹å•
  Trace = ä»ç‚¹å‡»"ä¸‹å•"åˆ°è®¢å•å®Œæˆçš„å…¨è¿‡ç¨‹
```

**Span (ç‰‡æ®µ)**:
```
å•ä¸ªæ“ä½œçš„è®°å½•

ç¤ºä¾‹ï¼šåœ¨ä¸‹å•Traceä¸­
  Span 1: éªŒè¯ç”¨æˆ·èº«ä»½
  Span 2: æ£€æŸ¥åº“å­˜
  Span 3: åˆ›å»ºè®¢å•
  Span 4: æ‰£å‡åº“å­˜
  Span 5: å‘é€ç¡®è®¤é‚®ä»¶
```

**Context (ä¸Šä¸‹æ–‡)**:
```
è¿½è¸ªä¿¡æ¯çš„ä¼ é€’è½½ä½“

åŒ…å«ï¼š
  - TraceID: æ•´ä¸ªTraceçš„å”¯ä¸€æ ‡è¯†
  - SpanID: å½“å‰Spançš„æ ‡è¯†
  - é‡‡æ ·æ ‡å¿—: æ˜¯å¦è®°å½•è¿™ä¸ªTrace
```

### 1.2 å·¥ä½œåŸç†

```
[ç”¨æˆ·è¯·æ±‚]
    â†“
[Frontend] â† åˆ›å»º Trace (TraceID: ABC123)
    â†“
    åˆ›å»º Span1 (å¤„ç†è¯·æ±‚)
    â†“
[è°ƒç”¨ Auth Service] â† ä¼ é€’ TraceID: ABC123
    â†“
    åˆ›å»º Span2 (éªŒè¯ç”¨æˆ·)
    â†“
[è°ƒç”¨ Order Service] â† ä¼ é€’ TraceID: ABC123
    â†“
    åˆ›å»º Span3 (åˆ›å»ºè®¢å•)
    
æ‰€æœ‰Spanéƒ½æœ‰ç›¸åŒçš„TraceID
â†’ å¯ä»¥é‡å»ºå®Œæ•´çš„è¯·æ±‚è·¯å¾„ï¼
```

---

## 2. ç¯å¢ƒå‡†å¤‡ (5åˆ†é’Ÿ)

### 2.1 å®‰è£…Node.js (å¦‚æœå·²æœ‰ï¼Œè·³è¿‡)

```bash
# æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
node --version  # éœ€è¦ >= 14.0.0
npm --version
```

### 2.2 åˆ›å»ºé¡¹ç›®

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir otlp-quickstart
cd otlp-quickstart

# åˆå§‹åŒ–é¡¹ç›®
npm init -y

# å®‰è£…OpenTelemetryåŒ…
npm install @opentelemetry/api \
            @opentelemetry/sdk-node \
            @opentelemetry/auto-instrumentations-node \
            @opentelemetry/exporter-trace-otlp-http
```

---

## 3. ç¬¬ä¸€ä¸ªè¿½è¸ªç¤ºä¾‹ (10åˆ†é’Ÿ)

### 3.1 åˆ›å»ºè¿½è¸ªé…ç½®

åˆ›å»º `tracing.js`:

```javascript
// tracing.js
const { NodeSDK } = require('@opentelemetry/sdk-node');
const { getNodeAutoInstrumentations } = require('@opentelemetry/auto-instrumentations-node');
const { OTLPTraceExporter } = require('@opentelemetry/exporter-trace-otlp-http');

// é…ç½®å¯¼å‡ºå™¨ï¼ˆå‘é€åˆ°Jaegerï¼‰
const traceExporter = new OTLPTraceExporter({
  url: 'http://localhost:4318/v1/traces',
});

// åˆ›å»ºSDK
const sdk = new NodeSDK({
  traceExporter,
  instrumentations: [
    getNodeAutoInstrumentations({
      // è‡ªåŠ¨åŸ‹ç‚¹é…ç½®
      '@opentelemetry/instrumentation-fs': {
        enabled: false,  // å…³é—­æ–‡ä»¶ç³»ç»Ÿè¿½è¸ªï¼ˆå¤ªå¤šå™ªéŸ³ï¼‰
      },
    }),
  ],
  serviceName: 'my-first-service',
});

// å¯åŠ¨SDK
sdk.start();

// ä¼˜é›…å…³é—­
process.on('SIGTERM', () => {
  sdk.shutdown()
    .then(() => console.log('Tracing terminated'))
    .catch((error) => console.log('Error terminating tracing', error))
    .finally(() => process.exit(0));
});

module.exports = sdk;
```

### 3.2 åˆ›å»ºç¤ºä¾‹åº”ç”¨

åˆ›å»º `app.js`:

```javascript
// å¿…é¡»åœ¨æœ€å¼€å§‹å¯¼å…¥tracing
require('./tracing');

const express = require('express');
const app = express();

// ç®€å•çš„è·¯ç”±
app.get('/', (req, res) => {
  console.log('æ”¶åˆ°è¯·æ±‚');
  res.send('Hello, OpenTelemetry!');
});

// æ¨¡æ‹Ÿæ…¢æ“ä½œ
app.get('/slow', async (req, res) => {
  console.log('å¤„ç†æ…¢è¯·æ±‚...');
  
  // æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢
  await sleep(100);
  
  // æ¨¡æ‹Ÿå¤–éƒ¨APIè°ƒç”¨
  await sleep(200);
  
  res.send('Slow operation completed');
});

// æ¨¡æ‹Ÿé”™è¯¯
app.get('/error', (req, res) => {
  console.log('è§¦å‘é”™è¯¯');
  throw new Error('This is a test error');
});

// é”™è¯¯å¤„ç†
app.use((err, req, res, next) => {
  console.error('Error:', err.message);
  res.status(500).send('Internal Server Error');
});

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

const PORT = 3000;
app.listen(PORT, () => {
  console.log(`Server running on http://localhost:${PORT}`);
});
```

### 3.3 å®‰è£…Express

```bash
npm install express
```

---

## 4. å¯åŠ¨åç«¯æœåŠ¡ (5åˆ†é’Ÿ)

### 4.1 ä½¿ç”¨Dockerå¯åŠ¨Jaeger

```bash
# å¯åŠ¨Jaegerï¼ˆè¿½è¸ªæ•°æ®çš„å­˜å‚¨å’Œå¯è§†åŒ–ï¼‰
docker run -d --name jaeger \
  -e COLLECTOR_OTLP_ENABLED=true \
  -p 16686:16686 \
  -p 4318:4318 \
  jaegertracing/all-in-one:latest

# æ£€æŸ¥æ˜¯å¦å¯åŠ¨æˆåŠŸ
docker ps | grep jaeger
```

**è®¿é—®Jaeger UI**: http://localhost:16686

### 4.2 å¯åŠ¨åº”ç”¨

```bash
node app.js
```

æ‚¨åº”è¯¥çœ‹åˆ°ï¼š
```
Server running on http://localhost:3000
```

---

## 5. ç”Ÿæˆè¿½è¸ªæ•°æ® (5åˆ†é’Ÿ)

### 5.1 å‘é€è¯·æ±‚

**ç»ˆç«¯1**ï¼ˆåº”ç”¨æ—¥å¿—ï¼‰:
```bash
node app.js
```

**ç»ˆç«¯2**ï¼ˆå‘é€è¯·æ±‚ï¼‰:
```bash
# æ­£å¸¸è¯·æ±‚
curl http://localhost:3000/

# æ…¢è¯·æ±‚
curl http://localhost:3000/slow

# é”™è¯¯è¯·æ±‚
curl http://localhost:3000/error

# å‘é€å¤šä¸ªè¯·æ±‚
for i in {1..10}; do curl http://localhost:3000/slow; done
```

### 5.2 æŸ¥çœ‹Jaeger UI

1. æ‰“å¼€æµè§ˆå™¨: http://localhost:16686
2. åœ¨å·¦ä¾§é€‰æ‹©æœåŠ¡: `my-first-service`
3. ç‚¹å‡» "Find Traces"
4. æ‚¨ä¼šçœ‹åˆ°æ‰€æœ‰çš„è¿½è¸ªè®°å½•ï¼

**UIå¯¼èˆª**:
```
Jaeger UI
â”œâ”€â”€ Search (æœç´¢è¿½è¸ª)
â”‚   â”œâ”€â”€ Service: é€‰æ‹©æœåŠ¡
â”‚   â”œâ”€â”€ Operation: é€‰æ‹©æ“ä½œ
â”‚   â”œâ”€â”€ Tags: è¿‡æ»¤æ¡ä»¶
â”‚   â””â”€â”€ Lookback: æ—¶é—´èŒƒå›´
â”‚
â”œâ”€â”€ Traceåˆ—è¡¨
â”‚   â”œâ”€â”€ Trace ID: å”¯ä¸€æ ‡è¯†
â”‚   â”œâ”€â”€ Duration: æŒç»­æ—¶é—´
â”‚   â”œâ”€â”€ Spans: Spanæ•°é‡
â”‚   â””â”€â”€ Services: æ¶‰åŠçš„æœåŠ¡
â”‚
â””â”€â”€ Traceè¯¦æƒ…
    â”œâ”€â”€ Timeline: æ—¶é—´è½´è§†å›¾
    â”œâ”€â”€ Span Graph: è°ƒç”¨å…³ç³»å›¾
    â””â”€â”€ Spanè¯¦æƒ…: æ¯ä¸ªSpançš„è¯¦ç»†ä¿¡æ¯
```

---

## 6. åˆ†æè¿½è¸ªæ•°æ®

### 6.1 æŸ¥çœ‹æ­£å¸¸è¯·æ±‚

ç‚¹å‡»ä»»æ„ä¸€ä¸ª`GET /`çš„Traceï¼Œæ‚¨ä¼šçœ‹åˆ°ï¼š

```
Timelineè§†å›¾:
|--- GET / --------------------------------|  (æ€»è€—æ—¶: ~5ms)
    |--- middleware -|
    |--- handler ----|
```

**å…³é”®ä¿¡æ¯**:
- **Duration**: è¯·æ±‚æ€»è€—æ—¶
- **Spans**: 5-10ä¸ªSpanï¼ˆExpressè‡ªåŠ¨ç”Ÿæˆï¼‰
- **Tags**: http.method=GET, http.url=/

### 6.2 æŸ¥çœ‹æ…¢è¯·æ±‚

ç‚¹å‡»`GET /slow`çš„Traceï¼š

```
Timelineè§†å›¾:
|--- GET /slow ---------------------------------|  (æ€»è€—æ—¶: ~320ms)
    |--- middleware -|
    |--- handler ----------------------------|
        |--- sleep(100) -----|
        |--- sleep(200) --------------|
```

**å‘ç°**:
- å¯ä»¥æ¸…æ¥šçœ‹åˆ°å“ªé‡Œæ…¢
- ä¸¤æ¬¡sleepåˆ†åˆ«è€—æ—¶100mså’Œ200ms
- å¯ä»¥å®šä½æ€§èƒ½ç“¶é¢ˆï¼

### 6.3 æŸ¥çœ‹é”™è¯¯è¯·æ±‚

ç‚¹å‡»`GET /error`çš„Traceï¼š

```
Traceè¯¦æƒ…:
  Status: ERROR âŒ
  Error message: "This is a test error"
  Stack trace: (å®Œæ•´çš„é”™è¯¯å †æ ˆ)
```

**ä»·å€¼**:
- è‡ªåŠ¨æ•è·é”™è¯¯
- å®Œæ•´çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
- å¿«é€Ÿå®šä½é—®é¢˜ä»£ç 

---

## 7. æ·»åŠ è‡ªå®šä¹‰Span

### 7.1 æ‰‹åŠ¨åˆ›å»ºSpan

ä¿®æ”¹ `app.js`:

```javascript
require('./tracing');

const express = require('express');
const { trace } = require('@opentelemetry/api');

const app = express();

// è·å–tracer
const tracer = trace.getTracer('my-first-service');

app.get('/custom', async (req, res) => {
  // åˆ›å»ºè‡ªå®šä¹‰Span
  const span = tracer.startSpan('processOrder');
  
  try {
    // æ·»åŠ å±æ€§
    span.setAttribute('user.id', '12345');
    span.setAttribute('order.amount', 99.99);
    
    // æ­¥éª¤1: éªŒè¯åº“å­˜
    const inventorySpan = tracer.startSpan('checkInventory', {
      parent: span.context()
    });
    await sleep(50);
    inventorySpan.setAttribute('inventory.available', true);
    inventorySpan.end();
    
    // æ­¥éª¤2: åˆ›å»ºè®¢å•
    const createSpan = tracer.startSpan('createOrder', {
      parent: span.context()
    });
    await sleep(100);
    createSpan.setAttribute('order.id', 'ORD-001');
    createSpan.end();
    
    // æ­¥éª¤3: å‘é€é€šçŸ¥
    const notifySpan = tracer.startSpan('sendNotification', {
      parent: span.context()
    });
    await sleep(30);
    notifySpan.end();
    
    span.setStatus({ code: 1 });  // OK
    res.json({ 
      success: true, 
      orderId: 'ORD-001' 
    });
    
  } catch (error) {
    span.recordException(error);
    span.setStatus({ code: 2, message: error.message });  // ERROR
    res.status(500).json({ error: error.message });
  } finally {
    span.end();
  }
});

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

const PORT = 3000;
app.listen(PORT, () => {
  console.log(`Server running on http://localhost:${PORT}`);
});
```

### 7.2 æµ‹è¯•è‡ªå®šä¹‰Span

```bash
# é‡å¯åº”ç”¨
# Ctrl+C åœæ­¢ï¼Œç„¶åå†æ¬¡è¿è¡Œ
node app.js

# å‘é€è¯·æ±‚
curl http://localhost:3000/custom
```

### 7.3 åœ¨Jaegerä¸­æŸ¥çœ‹

åˆ·æ–°Jaeger UIï¼Œæ‰¾åˆ°`GET /custom`çš„Traceï¼š

```
Timelineè§†å›¾:
|--- processOrder ---------------------------------|  (180ms)
    |--- checkInventory -----|                       (50ms)
    |--- createOrder -----------|                    (100ms)
    |--- sendNotification -|                         (30ms)

Spanè¯¦æƒ…:
  processOrder:
    - user.id: 12345
    - order.amount: 99.99
  
  createOrder:
    - order.id: ORD-001
  
  checkInventory:
    - inventory.available: true
```

**ä»·å€¼**:
- ä¸šåŠ¡é€»è¾‘å¯è§†åŒ–
- æ€§èƒ½ç“¶é¢ˆä¸€ç›®äº†ç„¶
- å®Œæ•´çš„ä¸šåŠ¡ä¸Šä¸‹æ–‡

---

## 8. å¸¸è§é—®é¢˜

### Q1: çœ‹ä¸åˆ°è¿½è¸ªæ•°æ®ï¼Ÿ

**æ£€æŸ¥æ¸…å•**:
```bash
# 1. Jaegeræ˜¯å¦è¿è¡Œï¼Ÿ
docker ps | grep jaeger

# 2. ç«¯å£æ˜¯å¦æ­£ç¡®ï¼Ÿ
curl http://localhost:4318/v1/traces
# åº”è¯¥è¿”å› "404 page not found" (è¯´æ˜ç«¯å£å¼€æ”¾)

# 3. åº”ç”¨æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯ï¼Ÿ
# æŸ¥çœ‹ node app.js çš„è¾“å‡º

# 4. tracing.jsæ˜¯å¦åœ¨æœ€å¼€å§‹å¯¼å…¥ï¼Ÿ
# å¿…é¡»æ˜¯ç¬¬ä¸€è¡Œ: require('./tracing');
```

### Q2: è¿½è¸ªæ•°æ®ä¸å®Œæ•´ï¼Ÿ

**å¯èƒ½åŸå› **:
- é‡‡æ ·ç‡è®¾ç½®è¿‡ä½
- æŸäº›æ“ä½œå¤ªå¿«ï¼ˆ< 1msï¼‰
- å¼‚æ­¥æ“ä½œæ²¡æœ‰æ­£ç¡®ä¼ é€’Context

**è§£å†³æ–¹æ¡ˆ**:
```javascript
// tracing.jsä¸­æ·»åŠ 
const sdk = new NodeSDK({
  // ... å…¶ä»–é…ç½®
  
  // å¼ºåˆ¶100%é‡‡æ ·ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
  spanProcessor: new SimpleSpanProcessor(traceExporter),
});
```

### Q3: æ€§èƒ½å½±å“å¤§å—ï¼Ÿ

**å¼€é”€ç»Ÿè®¡**:
- CPU: +2-5%
- å†…å­˜: +10-20MB
- å»¶è¿Ÿ: +0.5-2ms per request

**ç”Ÿäº§ç¯å¢ƒå»ºè®®**:
- ä½¿ç”¨é‡‡æ · (1-10%)
- æ‰¹é‡å¯¼å‡º
- å¼‚æ­¥å¤„ç†

---

## 9. ä¸‹ä¸€æ­¥å­¦ä¹ 

### 9.1 æ·±å…¥å­¦ä¹ 

**æ¨èè·¯å¾„**:
1. âœ… [åŸºç¡€æ¦‚å¿µè¯¦è§£](./01_æ¦‚å¿µç´¢å¼•/01_åŸºç¡€æ¦‚å¿µ.md)
2. âœ… [å®ç°æ¦‚å¿µ](./01_æ¦‚å¿µç´¢å¼•/03_å®ç°æ¦‚å¿µ.md)
3. âœ… [å­¦ä¹ è·¯å¾„å¯¼å›¾](./04_æ€ç»´å¯¼å›¾/03_å­¦ä¹ è·¯å¾„å¯¼å›¾.md)

### 9.2 è¿›é˜¶ä¸»é¢˜

**Contextä¼ æ’­**:
- è·¨æœåŠ¡è¿½è¸ª
- HTTP/gRPCä¼ æ’­
- æ¶ˆæ¯é˜Ÿåˆ—ä¼ æ’­

**é‡‡æ ·ç­–ç•¥**:
- æ¦‚ç‡é‡‡æ ·
- è§„åˆ™é‡‡æ ·
- Tailé‡‡æ ·

**æ€§èƒ½ä¼˜åŒ–**:
- æ‰¹é‡å¯¼å‡º
- å¼‚æ­¥å¤„ç†
- èµ„æºä¼˜åŒ–

### 9.3 æœ€ä½³å®è·µ

æŸ¥çœ‹ï¼š
- [ä¸“ä¸šæœ¯è¯­è§£é‡Š](./05_æœ¯è¯­è¡¨/03_ä¸“ä¸šæœ¯è¯­è§£é‡Š.md)
- [æ•…éšœæ’æŸ¥æŒ‡å—](./â“_æ•…éšœæ’æŸ¥æŒ‡å—.md)
- [å¸¸è§é—®é¢˜FAQ](./â“_å¸¸è§é—®é¢˜FAQ.md)

---

## 10. å®Œæ•´ä»£ç ä»“åº“

å®Œæ•´çš„ç¤ºä¾‹ä»£ç ï¼š
```bash
git clone https://github.com/otlp-project/quickstart-examples
cd quickstart-examples/nodejs
npm install
docker-compose up -d  # å¯åŠ¨Jaeger
npm start
```

---

## ğŸŠ æ­å–œå®Œæˆï¼

æ‚¨å·²ç»ï¼š
- âœ… ç†è§£äº†OTLPæ ¸å¿ƒæ¦‚å¿µ
- âœ… æ­å»ºäº†ç¬¬ä¸€ä¸ªè¿½è¸ªåº”ç”¨
- âœ… å­¦ä¼šäº†æŸ¥çœ‹å’Œåˆ†æè¿½è¸ªæ•°æ®
- âœ… æŒæ¡äº†è‡ªå®šä¹‰Spançš„åˆ›å»º

**ä¸‹ä¸€æ­¥**: æ¢ç´¢æ›´å¤šé«˜çº§åŠŸèƒ½ï¼Œå°†OTLPåº”ç”¨åˆ°æ‚¨çš„å®é™…é¡¹ç›®ä¸­ï¼

---

## ğŸ“š å‚è€ƒèµ„æº

- [OpenTelemetryå®˜æ–¹æ–‡æ¡£](https://opentelemetry.io/)
- [Jaegeræ–‡æ¡£](https://www.jaegertracing.io/)
- [OTLPçŸ¥è¯†ä¸­å¿ƒ](./README.md)

---

**åˆ›å»ºæ—¥æœŸ**: 2025-10-26  
**ç»´æŠ¤**: OTLPé¡¹ç›®ç»„  
**éš¾åº¦**: â­â˜†â˜†â˜†â˜†  
**é¢„è®¡æ—¶é—´**: 30åˆ†é’Ÿ


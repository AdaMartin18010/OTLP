# 🚀 OTLP快速入门指南

> **适用对象**: 初学者  
> **预计时间**: 30分钟  
> **难度级别**: ⭐☆☆☆☆

---

## 📋 学习目标

通过本指南，您将：
- ✅ 理解OTLP的核心概念
- ✅ 搭建第一个追踪示例
- ✅ 查看和分析追踪数据
- ✅ 掌握基本的调试技巧

---

## 1. 核心概念速览 (5分钟)

### 1.1 三个必知概念

**Trace (追踪)**:
```
一次完整的请求路径

示例：用户下单
  Trace = 从点击"下单"到订单完成的全过程
```

**Span (片段)**:
```
单个操作的记录

示例：在下单Trace中
  Span 1: 验证用户身份
  Span 2: 检查库存
  Span 3: 创建订单
  Span 4: 扣减库存
  Span 5: 发送确认邮件
```

**Context (上下文)**:
```
追踪信息的传递载体

包含：
  - TraceID: 整个Trace的唯一标识
  - SpanID: 当前Span的标识
  - 采样标志: 是否记录这个Trace
```

### 1.2 工作原理

```
[用户请求]
    ↓
[Frontend] ← 创建 Trace (TraceID: ABC123)
    ↓
    创建 Span1 (处理请求)
    ↓
[调用 Auth Service] ← 传递 TraceID: ABC123
    ↓
    创建 Span2 (验证用户)
    ↓
[调用 Order Service] ← 传递 TraceID: ABC123
    ↓
    创建 Span3 (创建订单)
    
所有Span都有相同的TraceID
→ 可以重建完整的请求路径！
```

---

## 2. 环境准备 (5分钟)

### 2.1 安装Node.js (如果已有，跳过)

```bash
# 检查是否已安装
node --version  # 需要 >= 14.0.0
npm --version
```

### 2.2 创建项目

```bash
# 创建项目目录
mkdir otlp-quickstart
cd otlp-quickstart

# 初始化项目
npm init -y

# 安装OpenTelemetry包
npm install @opentelemetry/api \
            @opentelemetry/sdk-node \
            @opentelemetry/auto-instrumentations-node \
            @opentelemetry/exporter-trace-otlp-http
```

---

## 3. 第一个追踪示例 (10分钟)

### 3.1 创建追踪配置

创建 `tracing.js`:

```javascript
// tracing.js
const { NodeSDK } = require('@opentelemetry/sdk-node');
const { getNodeAutoInstrumentations } = require('@opentelemetry/auto-instrumentations-node');
const { OTLPTraceExporter } = require('@opentelemetry/exporter-trace-otlp-http');

// 配置导出器（发送到Jaeger）
const traceExporter = new OTLPTraceExporter({
  url: 'http://localhost:4318/v1/traces',
});

// 创建SDK
const sdk = new NodeSDK({
  traceExporter,
  instrumentations: [
    getNodeAutoInstrumentations({
      // 自动埋点配置
      '@opentelemetry/instrumentation-fs': {
        enabled: false,  // 关闭文件系统追踪（太多噪音）
      },
    }),
  ],
  serviceName: 'my-first-service',
});

// 启动SDK
sdk.start();

// 优雅关闭
process.on('SIGTERM', () => {
  sdk.shutdown()
    .then(() => console.log('Tracing terminated'))
    .catch((error) => console.log('Error terminating tracing', error))
    .finally(() => process.exit(0));
});

module.exports = sdk;
```

### 3.2 创建示例应用

创建 `app.js`:

```javascript
// 必须在最开始导入tracing
require('./tracing');

const express = require('express');
const app = express();

// 简单的路由
app.get('/', (req, res) => {
  console.log('收到请求');
  res.send('Hello, OpenTelemetry!');
});

// 模拟慢操作
app.get('/slow', async (req, res) => {
  console.log('处理慢请求...');
  
  // 模拟数据库查询
  await sleep(100);
  
  // 模拟外部API调用
  await sleep(200);
  
  res.send('Slow operation completed');
});

// 模拟错误
app.get('/error', (req, res) => {
  console.log('触发错误');
  throw new Error('This is a test error');
});

// 错误处理
app.use((err, req, res, next) => {
  console.error('Error:', err.message);
  res.status(500).send('Internal Server Error');
});

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

const PORT = 3000;
app.listen(PORT, () => {
  console.log(`Server running on http://localhost:${PORT}`);
});
```

### 3.3 安装Express

```bash
npm install express
```

---

## 4. 启动后端服务 (5分钟)

### 4.1 使用Docker启动Jaeger

```bash
# 启动Jaeger（追踪数据的存储和可视化）
docker run -d --name jaeger \
  -e COLLECTOR_OTLP_ENABLED=true \
  -p 16686:16686 \
  -p 4318:4318 \
  jaegertracing/all-in-one:latest

# 检查是否启动成功
docker ps | grep jaeger
```

**访问Jaeger UI**: http://localhost:16686

### 4.2 启动应用

```bash
node app.js
```

您应该看到：
```
Server running on http://localhost:3000
```

---

## 5. 生成追踪数据 (5分钟)

### 5.1 发送请求

**终端1**（应用日志）:
```bash
node app.js
```

**终端2**（发送请求）:
```bash
# 正常请求
curl http://localhost:3000/

# 慢请求
curl http://localhost:3000/slow

# 错误请求
curl http://localhost:3000/error

# 发送多个请求
for i in {1..10}; do curl http://localhost:3000/slow; done
```

### 5.2 查看Jaeger UI

1. 打开浏览器: http://localhost:16686
2. 在左侧选择服务: `my-first-service`
3. 点击 "Find Traces"
4. 您会看到所有的追踪记录！

**UI导航**:
```
Jaeger UI
├── Search (搜索追踪)
│   ├── Service: 选择服务
│   ├── Operation: 选择操作
│   ├── Tags: 过滤条件
│   └── Lookback: 时间范围
│
├── Trace列表
│   ├── Trace ID: 唯一标识
│   ├── Duration: 持续时间
│   ├── Spans: Span数量
│   └── Services: 涉及的服务
│
└── Trace详情
    ├── Timeline: 时间轴视图
    ├── Span Graph: 调用关系图
    └── Span详情: 每个Span的详细信息
```

---

## 6. 分析追踪数据

### 6.1 查看正常请求

点击任意一个`GET /`的Trace，您会看到：

```
Timeline视图:
|--- GET / --------------------------------|  (总耗时: ~5ms)
    |--- middleware -|
    |--- handler ----|
```

**关键信息**:
- **Duration**: 请求总耗时
- **Spans**: 5-10个Span（Express自动生成）
- **Tags**: http.method=GET, http.url=/

### 6.2 查看慢请求

点击`GET /slow`的Trace：

```
Timeline视图:
|--- GET /slow ---------------------------------|  (总耗时: ~320ms)
    |--- middleware -|
    |--- handler ----------------------------|
        |--- sleep(100) -----|
        |--- sleep(200) --------------|
```

**发现**:
- 可以清楚看到哪里慢
- 两次sleep分别耗时100ms和200ms
- 可以定位性能瓶颈！

### 6.3 查看错误请求

点击`GET /error`的Trace：

```
Trace详情:
  Status: ERROR ❌
  Error message: "This is a test error"
  Stack trace: (完整的错误堆栈)
```

**价值**:
- 自动捕获错误
- 完整的上下文信息
- 快速定位问题代码

---

## 7. 添加自定义Span

### 7.1 手动创建Span

修改 `app.js`:

```javascript
require('./tracing');

const express = require('express');
const { trace } = require('@opentelemetry/api');

const app = express();

// 获取tracer
const tracer = trace.getTracer('my-first-service');

app.get('/custom', async (req, res) => {
  // 创建自定义Span
  const span = tracer.startSpan('processOrder');
  
  try {
    // 添加属性
    span.setAttribute('user.id', '12345');
    span.setAttribute('order.amount', 99.99);
    
    // 步骤1: 验证库存
    const inventorySpan = tracer.startSpan('checkInventory', {
      parent: span.context()
    });
    await sleep(50);
    inventorySpan.setAttribute('inventory.available', true);
    inventorySpan.end();
    
    // 步骤2: 创建订单
    const createSpan = tracer.startSpan('createOrder', {
      parent: span.context()
    });
    await sleep(100);
    createSpan.setAttribute('order.id', 'ORD-001');
    createSpan.end();
    
    // 步骤3: 发送通知
    const notifySpan = tracer.startSpan('sendNotification', {
      parent: span.context()
    });
    await sleep(30);
    notifySpan.end();
    
    span.setStatus({ code: 1 });  // OK
    res.json({ 
      success: true, 
      orderId: 'ORD-001' 
    });
    
  } catch (error) {
    span.recordException(error);
    span.setStatus({ code: 2, message: error.message });  // ERROR
    res.status(500).json({ error: error.message });
  } finally {
    span.end();
  }
});

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

const PORT = 3000;
app.listen(PORT, () => {
  console.log(`Server running on http://localhost:${PORT}`);
});
```

### 7.2 测试自定义Span

```bash
# 重启应用
# Ctrl+C 停止，然后再次运行
node app.js

# 发送请求
curl http://localhost:3000/custom
```

### 7.3 在Jaeger中查看

刷新Jaeger UI，找到`GET /custom`的Trace：

```
Timeline视图:
|--- processOrder ---------------------------------|  (180ms)
    |--- checkInventory -----|                       (50ms)
    |--- createOrder -----------|                    (100ms)
    |--- sendNotification -|                         (30ms)

Span详情:
  processOrder:
    - user.id: 12345
    - order.amount: 99.99
  
  createOrder:
    - order.id: ORD-001
  
  checkInventory:
    - inventory.available: true
```

**价值**:
- 业务逻辑可视化
- 性能瓶颈一目了然
- 完整的业务上下文

---

## 8. 常见问题

### Q1: 看不到追踪数据？

**检查清单**:
```bash
# 1. Jaeger是否运行？
docker ps | grep jaeger

# 2. 端口是否正确？
curl http://localhost:4318/v1/traces
# 应该返回 "404 page not found" (说明端口开放)

# 3. 应用日志是否有错误？
# 查看 node app.js 的输出

# 4. tracing.js是否在最开始导入？
# 必须是第一行: require('./tracing');
```

### Q2: 追踪数据不完整？

**可能原因**:
- 采样率设置过低
- 某些操作太快（< 1ms）
- 异步操作没有正确传递Context

**解决方案**:
```javascript
// tracing.js中添加
const sdk = new NodeSDK({
  // ... 其他配置
  
  // 强制100%采样（仅开发环境）
  spanProcessor: new SimpleSpanProcessor(traceExporter),
});
```

### Q3: 性能影响大吗？

**开销统计**:
- CPU: +2-5%
- 内存: +10-20MB
- 延迟: +0.5-2ms per request

**生产环境建议**:
- 使用采样 (1-10%)
- 批量导出
- 异步处理

---

## 9. 下一步学习

### 9.1 深入学习

**推荐路径**:
1. ✅ [基础概念详解](./01_概念索引/01_基础概念.md)
2. ✅ [实现概念](./01_概念索引/03_实现概念.md)
3. ✅ [学习路径导图](./04_思维导图/03_学习路径导图.md)

### 9.2 进阶主题

**Context传播**:
- 跨服务追踪
- HTTP/gRPC传播
- 消息队列传播

**采样策略**:
- 概率采样
- 规则采样
- Tail采样

**性能优化**:
- 批量导出
- 异步处理
- 资源优化

### 9.3 最佳实践

查看：
- [专业术语解释](./05_术语表/03_专业术语解释.md)
- [故障排查指南](./❓_故障排查指南.md)
- [常见问题FAQ](./❓_常见问题FAQ.md)

---

## 10. 完整代码仓库

完整的示例代码：
```bash
git clone https://github.com/otlp-project/quickstart-examples
cd quickstart-examples/nodejs
npm install
docker-compose up -d  # 启动Jaeger
npm start
```

---

## 🎊 恭喜完成！

您已经：
- ✅ 理解了OTLP核心概念
- ✅ 搭建了第一个追踪应用
- ✅ 学会了查看和分析追踪数据
- ✅ 掌握了自定义Span的创建

**下一步**: 探索更多高级功能，将OTLP应用到您的实际项目中！

---

## 📚 参考资源

- [OpenTelemetry官方文档](https://opentelemetry.io/)
- [Jaeger文档](https://www.jaegertracing.io/)
- [OTLP知识中心](./README.md)

---

**创建日期**: 2025-10-26  
**维护**: OTLP项目组  
**难度**: ⭐☆☆☆☆  
**预计时间**: 30分钟


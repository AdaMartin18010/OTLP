name: OTLP 2025 ç‰ˆæœ¬æ£€æŸ¥

on:
  schedule:
    - cron: '0 9 * * 1'  # æ¯å‘¨ä¸€ä¸Šåˆ9ç‚¹
  workflow_dispatch:
    inputs:
      language:
        description: 'æ£€æŸ¥è¯­è¨€ (all, rust, go, js)'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - rust
        - go
        - js
  push:
    branches: [ main ]
    paths:
      - 'examples/**'
      - 'Cargo.toml'
      - 'go.mod'
      - 'package.json'

jobs:
  version-check:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        language: [rust, go, js]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Rust
      if: matrix.language == 'rust'
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        components: rustfmt, clippy
        
    - name: è®¾ç½® Go
      if: matrix.language == 'go'
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: è®¾ç½® Node.js
      if: matrix.language == 'js'
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: examples/minimal-javascript/package-lock.json
        
    - name: æ£€æŸ¥ Rust ç‰ˆæœ¬
      if: matrix.language == 'rust'
      run: |
        echo "ğŸ” æ£€æŸ¥ Rust ç‰ˆæœ¬..."
        rustc --version
        cargo --version
        
        echo "ğŸ“¦ æ£€æŸ¥ OpenTelemetry Rust ä¾èµ–..."
        cd examples/minimal-rust
        cargo tree --depth 1 | grep opentelemetry
        
    - name: æ£€æŸ¥ Go ç‰ˆæœ¬
      if: matrix.language == 'go'
      run: |
        echo "ğŸ” æ£€æŸ¥ Go ç‰ˆæœ¬..."
        go version
        
        echo "ğŸ“¦ æ£€æŸ¥ OpenTelemetry Go ä¾èµ–..."
        cd examples/minimal-go
        go list -m all | grep opentelemetry
        
    - name: æ£€æŸ¥ JavaScript ç‰ˆæœ¬
      if: matrix.language == 'js'
      run: |
        echo "ğŸ” æ£€æŸ¥ JavaScript ç‰ˆæœ¬..."
        node --version
        npm --version
        
        echo "ğŸ“¦ æ£€æŸ¥ OpenTelemetry JavaScript ä¾èµ–..."
        cd examples/minimal-javascript
        npm list --depth=0 | grep opentelemetry
        
    - name: ç”Ÿæˆç‰ˆæœ¬æŠ¥å‘Š
      run: |
        echo "# OTLP 2025 ç‰ˆæœ¬æ£€æŸ¥æŠ¥å‘Š" > version-report.md
        echo "**ç”Ÿæˆæ—¶é—´**: $(date)" >> version-report.md
        echo "**è¯­è¨€**: ${{ matrix.language }}" >> version-report.md
        echo "" >> version-report.md
        
        if [ "${{ matrix.language }}" = "rust" ]; then
          echo "## Rust ç‰ˆæœ¬" >> version-report.md
          rustc --version >> version-report.md
          cargo --version >> version-report.md
        elif [ "${{ matrix.language }}" = "go" ]; then
          echo "## Go ç‰ˆæœ¬" >> version-report.md
          go version >> version-report.md
        elif [ "${{ matrix.language }}" = "js" ]; then
          echo "## JavaScript ç‰ˆæœ¬" >> version-report.md
          node --version >> version-report.md
          npm --version >> version-report.md
        fi
        
    - name: ä¸Šä¼ ç‰ˆæœ¬æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: version-report-${{ matrix.language }}
        path: version-report.md
        
    - name: æ£€æŸ¥ç‰ˆæœ¬å…¼å®¹æ€§
      run: |
        echo "ğŸ” æ£€æŸ¥ç‰ˆæœ¬å…¼å®¹æ€§..."
        
        # æ£€æŸ¥ Rust ç‰ˆæœ¬å…¼å®¹æ€§
        if [ "${{ matrix.language }}" = "rust" ]; then
          cd examples/minimal-rust
          cargo check --quiet
          echo "âœ… Rust ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥é€šè¿‡"
        fi
        
        # æ£€æŸ¥ Go ç‰ˆæœ¬å…¼å®¹æ€§
        if [ "${{ matrix.language }}" = "go" ]; then
          cd examples/minimal-go
          go mod tidy
          go build -o /dev/null .
          echo "âœ… Go ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥é€šè¿‡"
        fi
        
        # æ£€æŸ¥ JavaScript ç‰ˆæœ¬å…¼å®¹æ€§
        if [ "${{ matrix.language }}" = "js" ]; then
          cd examples/minimal-javascript
          npm ci
          npm run build 2>/dev/null || echo "âš ï¸ æ— æ„å»ºè„šæœ¬ï¼Œè·³è¿‡æ„å»ºæ£€æŸ¥"
          echo "âœ… JavaScript ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥é€šè¿‡"
        fi
        
    - name: å®‰å…¨æ‰«æ
      run: |
        echo "ğŸ”’ æ‰§è¡Œå®‰å…¨æ‰«æ..."
        
        if [ "${{ matrix.language }}" = "rust" ]; then
          cd examples/minimal-rust
          cargo audit --deny warnings || echo "âš ï¸ å‘ç°å®‰å…¨æ¼æ´ï¼Œè¯·æ£€æŸ¥"
        elif [ "${{ matrix.language }}" = "go" ]; then
          cd examples/minimal-go
          go list -json -deps . | nancy sleuth || echo "âš ï¸ å‘ç°å®‰å…¨æ¼æ´ï¼Œè¯·æ£€æŸ¥"
        elif [ "${{ matrix.language }}" = "js" ]; then
          cd examples/minimal-javascript
          npm audit --audit-level moderate || echo "âš ï¸ å‘ç°å®‰å…¨æ¼æ´ï¼Œè¯·æ£€æŸ¥"
        fi
        
    - name: æ€§èƒ½åŸºå‡†æµ‹è¯•
      if: github.event_name == 'workflow_dispatch'
      run: |
        echo "âš¡ æ‰§è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•..."
        
        if [ "${{ matrix.language }}" = "rust" ]; then
          cd examples/minimal-rust
          cargo bench --quiet || echo "âš ï¸ æ— åŸºå‡†æµ‹è¯•ï¼Œè·³è¿‡"
        elif [ "${{ matrix.language }}" = "go" ]; then
          cd examples/minimal-go
          go test -bench=. -benchmem || echo "âš ï¸ æ— åŸºå‡†æµ‹è¯•ï¼Œè·³è¿‡"
        elif [ "${{ matrix.language }}" = "js" ]; then
          cd examples/minimal-javascript
          npm run benchmark || echo "âš ï¸ æ— åŸºå‡†æµ‹è¯•ï¼Œè·³è¿‡"
        fi

  summary:
    runs-on: ubuntu-latest
    needs: version-check
    if: always()
    
    steps:
    - name: ä¸‹è½½æ‰€æœ‰ç‰ˆæœ¬æŠ¥å‘Š
      uses: actions/download-artifact@v3
      
    - name: ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š
      run: |
        echo "# OTLP 2025 ç‰ˆæœ¬æ£€æŸ¥æ±‡æ€»æŠ¥å‘Š" > summary-report.md
        echo "**ç”Ÿæˆæ—¶é—´**: $(date)" >> summary-report.md
        echo "**å·¥ä½œæµ**: ${{ github.workflow }}" >> summary-report.md
        echo "**æäº¤**: ${{ github.sha }}" >> summary-report.md
        echo "" >> summary-report.md
        
        echo "## æ£€æŸ¥ç»“æœ" >> summary-report.md
        echo "- Rust: ${{ needs.version-check.result }}" >> summary-report.md
        echo "- Go: ${{ needs.version-check.result }}" >> summary-report.md
        echo "- JavaScript: ${{ needs.version-check.result }}" >> summary-report.md
        echo "" >> summary-report.md
        
        echo "## å»ºè®®" >> summary-report.md
        echo "1. å®šæœŸæ›´æ–° OpenTelemetry ä¾èµ–åˆ°æœ€æ–°ç¨³å®šç‰ˆæœ¬" >> summary-report.md
        echo "2. å…³æ³¨å®‰å…¨å…¬å‘Šå’Œå…¼å®¹æ€§æ›´æ–°" >> summary-report.md
        echo "3. åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å›ºå®šæ¬¡è¦ç‰ˆæœ¬å·" >> summary-report.md
        echo "4. å¯ç”¨ä¾èµ–ç‰ˆæœ¬é”å®šæœºåˆ¶" >> summary-report.md
        
    - name: ä¸Šä¼ æ±‡æ€»æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: version-check-summary
        path: summary-report.md
        
    - name: è¯„è®º PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('summary-report.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ğŸ” ç‰ˆæœ¬æ£€æŸ¥ç»“æœ\n\n${summary}`
          });

# ğŸ”’ OTLPå®‰å…¨æœ€ä½³å®è·µæŒ‡å—

> **ç›®æ ‡**: å¸®åŠ©ç”¨æˆ·æ„å»ºå®‰å…¨çš„OTLPéƒ¨ç½²ç¯å¢ƒ  
> **é€‚ç”¨åœºæ™¯**: ç”Ÿäº§ç¯å¢ƒå®‰å…¨åŠ å›º  
> **æ›´æ–°æ—¶é—´**: 2025å¹´10æœˆ20æ—¥

---

## ğŸ“‹ ç›®å½•

- [ğŸ”’ OTLPå®‰å…¨æœ€ä½³å®è·µæŒ‡å—](#-otlpå®‰å…¨æœ€ä½³å®è·µæŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ğŸ” ä¼ è¾“å®‰å…¨](#-ä¼ è¾“å®‰å…¨)
    - [1. TLS/SSLé…ç½®](#1-tlssslé…ç½®)
      - [Collector TLSé…ç½®](#collector-tlsé…ç½®)
      - [ç”Ÿæˆè‡ªç­¾åè¯ä¹¦](#ç”Ÿæˆè‡ªç­¾åè¯ä¹¦)
      - [SDK TLSé…ç½®](#sdk-tlsé…ç½®)
  - [ğŸ”‘ è®¤è¯å’Œæˆæƒ](#-è®¤è¯å’Œæˆæƒ)
    - [1. API Keyè®¤è¯](#1-api-keyè®¤è¯)
      - [Collectoré…ç½®](#collectoré…ç½®)
      - [SDKé…ç½®](#sdké…ç½®)
    - [2. OAuth 2.0 / OIDC](#2-oauth-20--oidc)
    - [3. Basic Auth](#3-basic-auth)
  - [ğŸ›¡ï¸ æ•°æ®å®‰å…¨](#ï¸-æ•°æ®å®‰å…¨)
    - [1. æ•æ„Ÿæ•°æ®è„±æ•](#1-æ•æ„Ÿæ•°æ®è„±æ•)
    - [2. PIIæ•°æ®å¤„ç†](#2-piiæ•°æ®å¤„ç†)
    - [3. æ•°æ®åŠ å¯†å­˜å‚¨](#3-æ•°æ®åŠ å¯†å­˜å‚¨)
  - [ğŸŒ ç½‘ç»œå®‰å…¨](#-ç½‘ç»œå®‰å…¨)
    - [1. ç½‘ç»œéš”ç¦»](#1-ç½‘ç»œéš”ç¦»)
      - [Docker Network](#docker-network)
      - [Kubernetes NetworkPolicy](#kubernetes-networkpolicy)
    - [2. é˜²ç«å¢™è§„åˆ™](#2-é˜²ç«å¢™è§„åˆ™)
    - [3. é€Ÿç‡é™åˆ¶](#3-é€Ÿç‡é™åˆ¶)
  - [ğŸ” è¿è¡Œæ—¶å®‰å…¨](#-è¿è¡Œæ—¶å®‰å…¨)
    - [1. æœ€å°æƒé™åŸåˆ™](#1-æœ€å°æƒé™åŸåˆ™)
      - [Docker](#docker)
      - [Kubernetes](#kubernetes)
    - [2. é•œåƒå®‰å…¨](#2-é•œåƒå®‰å…¨)
    - [3. Secretsç®¡ç†](#3-secretsç®¡ç†)
      - [Kubernetes Secrets](#kubernetes-secrets)
      - [HashiCorp Vaulté›†æˆ](#hashicorp-vaulté›†æˆ)
  - [ğŸ“‹ å®¡è®¡å’Œåˆè§„](#-å®¡è®¡å’Œåˆè§„)
    - [1. å®¡è®¡æ—¥å¿—](#1-å®¡è®¡æ—¥å¿—)
    - [2. åˆè§„æ€§é…ç½®](#2-åˆè§„æ€§é…ç½®)
      - [GDPRåˆè§„](#gdpråˆè§„)
      - [SOC 2åˆè§„](#soc-2åˆè§„)
  - [âœ… å®‰å…¨æ£€æŸ¥æ¸…å•](#-å®‰å…¨æ£€æŸ¥æ¸…å•)
    - [ä¼ è¾“å±‚å®‰å…¨](#ä¼ è¾“å±‚å®‰å…¨)
    - [è®¤è¯å’Œæˆæƒ](#è®¤è¯å’Œæˆæƒ)
    - [æ•°æ®å®‰å…¨](#æ•°æ®å®‰å…¨)
    - [ç½‘ç»œå®‰å…¨](#ç½‘ç»œå®‰å…¨)
    - [è¿è¡Œæ—¶å®‰å…¨](#è¿è¡Œæ—¶å®‰å…¨)
    - [ç›‘æ§å’Œå®¡è®¡](#ç›‘æ§å’Œå®¡è®¡)
  - [ğŸ”— ç›¸å…³èµ„æº](#-ç›¸å…³èµ„æº)

---

## ğŸ” ä¼ è¾“å®‰å…¨

### 1. TLS/SSLé…ç½®

#### Collector TLSé…ç½®

```yaml
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
        tls:
          cert_file: /certs/server.crt
          key_file: /certs/server.key
          client_ca_file: /certs/ca.crt  # åŒå‘TLS
          min_version: "1.2"
          max_version: "1.3"
      http:
        endpoint: 0.0.0.0:4318
        tls:
          cert_file: /certs/server.crt
          key_file: /certs/server.key

exporters:
  otlp:
    endpoint: backend:4317
    tls:
      cert_file: /certs/client.crt
      key_file: /certs/client.key
      ca_file: /certs/ca.crt
      insecure: false  # ç¦ç”¨ä¸å®‰å…¨è¿æ¥
```

#### ç”Ÿæˆè‡ªç­¾åè¯ä¹¦

```bash
# ç”ŸæˆCA
openssl genrsa -out ca.key 4096
openssl req -new -x509 -days 365 -key ca.key -out ca.crt \
  -subj "/CN=OTLP-CA"

# ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦
openssl genrsa -out server.key 4096
openssl req -new -key server.key -out server.csr \
  -subj "/CN=otel-collector"

# ç­¾åæœåŠ¡å™¨è¯ä¹¦
openssl x509 -req -days 365 -in server.csr \
  -CA ca.crt -CAkey ca.key -CAcreateserial \
  -out server.crt

# ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦
openssl genrsa -out client.key 4096
openssl req -new -key client.key -out client.csr \
  -subj "/CN=otlp-client"
openssl x509 -req -days 365 -in client.csr \
  -CA ca.crt -CAkey ca.key -CAcreateserial \
  -out client.crt
```

#### SDK TLSé…ç½®

**Go**:

```go
import (
    "crypto/tls"
    "crypto/x509"
    "go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc"
    "google.golang.org/grpc/credentials"
)

func createSecureExporter() (*otlptrace.Exporter, error) {
    // åŠ è½½CAè¯ä¹¦
    caCert, _ := ioutil.ReadFile("/certs/ca.crt")
    caCertPool := x509.NewCertPool()
    caCertPool.AppendCertsFromPEM(caCert)
    
    // åŠ è½½å®¢æˆ·ç«¯è¯ä¹¦
    clientCert, _ := tls.LoadX509KeyPair("/certs/client.crt", "/certs/client.key")
    
    // TLSé…ç½®
    tlsConfig := &tls.Config{
        Certificates: []tls.Certificate{clientCert},
        RootCAs:      caCertPool,
        MinVersion:   tls.VersionTLS12,
    }
    
    creds := credentials.NewTLS(tlsConfig)
    
    return otlptracegrpc.New(
        context.Background(),
        otlptracegrpc.WithEndpoint("collector:4317"),
        otlptracegrpc.WithTLSCredentials(creds),
    )
}
```

---

## ğŸ”‘ è®¤è¯å’Œæˆæƒ

### 1. API Keyè®¤è¯

#### Collectoré…ç½®

```yaml
receivers:
  otlp:
    protocols:
      http:
        endpoint: 0.0.0.0:4318
        headers:
          authorization: ${API_KEY}  # ç¯å¢ƒå˜é‡

extensions:
  headers_setter:
    headers:
      - key: Authorization
        from_context: authorization
```

#### SDKé…ç½®

```go
exporter, err := otlptracehttp.New(
    context.Background(),
    otlptracehttp.WithEndpoint("collector:4318"),
    otlptracehttp.WithHeaders(map[string]string{
        "Authorization": "Bearer your-api-key",
    }),
)
```

### 2. OAuth 2.0 / OIDC

```yaml
extensions:
  oauth2client:
    client_id: ${CLIENT_ID}
    client_secret: ${CLIENT_SECRET}
    token_url: https://auth.example.com/oauth/token
    scopes: ["otlp.write"]
    timeout: 30s

exporters:
  otlp:
    endpoint: backend:4317
    auth:
      authenticator: oauth2client
```

### 3. Basic Auth

```yaml
extensions:
  basicauth/collector:
    client_auth:
      username: ${OTLP_USERNAME}
      password: ${OTLP_PASSWORD}

exporters:
  otlp:
    endpoint: backend:4317
    auth:
      authenticator: basicauth/collector
```

---

## ğŸ›¡ï¸ æ•°æ®å®‰å…¨

### 1. æ•æ„Ÿæ•°æ®è„±æ•

```yaml
processors:
  attributes:
    actions:
      # åˆ é™¤æ•æ„Ÿheader
      - key: http.request.header.authorization
        action: delete
      
      - key: http.request.header.cookie
        action: delete
      
      # è„±æ•ä¿¡ç”¨å¡å·
      - key: payment.card_number
        action: update
        value: "****-****-****-1234"
      
      # Hashæ•æ„Ÿæ•°æ®
      - key: user.email
        action: hash
```

### 2. PIIæ•°æ®å¤„ç†

```yaml
processors:
  transform:
    traces:
      statements:
        # Hashé‚®ç®±
        - set(attributes["user.email"], SHA256(attributes["user.email"]))
        
        # è„±æ•ç”µè¯å·ç 
        - replace_pattern(attributes["user.phone"], "\\d{4}$", "****")
        
        # åˆ é™¤IPåœ°å€æœ€åä¸€æ®µ
        - replace_pattern(attributes["client.ip"], "\\.\\d+$", ".xxx")
```

### 3. æ•°æ®åŠ å¯†å­˜å‚¨

**Jaeger with Elasticsearch**:

```yaml
# Elasticsearché…ç½®
xpack.security.enabled: true
xpack.security.transport.ssl.enabled: true
xpack.security.http.ssl.enabled: true

# Collectorå¯¼å‡ºé…ç½®
exporters:
  elasticsearch:
    endpoints: [https://elasticsearch:9200]
    auth:
      authenticator: basicauth
    tls:
      ca_file: /certs/ca.crt
      insecure: false
```

---

## ğŸŒ ç½‘ç»œå®‰å…¨

### 1. ç½‘ç»œéš”ç¦»

#### Docker Network

```yaml
networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge
    internal: true  # ä¸å…è®¸å¤–éƒ¨è®¿é—®

services:
  otel-collector:
    networks:
      - frontend  # æ¥æ”¶å¤–éƒ¨æ•°æ®
      - backend   # è¿æ¥åç«¯
  
  jaeger:
    networks:
      - backend   # ä»…å†…éƒ¨è®¿é—®
```

#### Kubernetes NetworkPolicy

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: otel-collector-netpol
  namespace: observability
spec:
  podSelector:
    matchLabels:
      app: otel-collector
  policyTypes:
  - Ingress
  - Egress
  
  ingress:
  # åªå…è®¸æ¥è‡ªåº”ç”¨å‘½åç©ºé—´çš„æµé‡
  - from:
    - namespaceSelector:
        matchLabels:
          name: production
    ports:
    - protocol: TCP
      port: 4317
    - protocol: TCP
      port: 4318
  
  egress:
  # åªå…è®¸è®¿é—®observabilityå‘½åç©ºé—´
  - to:
    - namespaceSelector:
        matchLabels:
          name: observability
    ports:
    - protocol: TCP
      port: 14250  # Jaeger
    - protocol: TCP
      port: 9200   # Elasticsearch
```

### 2. é˜²ç«å¢™è§„åˆ™

```bash
# Linux iptables
sudo iptables -A INPUT -p tcp --dport 4317 -s 10.0.0.0/8 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 4317 -j DROP

# åªå…è®¸å†…ç½‘è®¿é—®
sudo iptables -A INPUT -p tcp --dport 4317 -s 192.168.0.0/16 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 4318 -s 192.168.0.0/16 -j ACCEPT
```

### 3. é€Ÿç‡é™åˆ¶

```yaml
processors:
  # Collectorçº§åˆ«é™æµ
  throttle:
    bytes_per_second: 10485760  # 10MB/s
    spans_per_second: 10000

  # æ‰¹å¤„ç†é™åˆ¶
  batch:
    send_batch_size: 512
    send_batch_max_size: 1024
```

---

## ğŸ” è¿è¡Œæ—¶å®‰å…¨

### 1. æœ€å°æƒé™åŸåˆ™

#### Docker

```yaml
services:
  otel-collector:
    user: "10001:10001"  # érootç”¨æˆ·
    read_only: true      # åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿ
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE  # ä»…éœ€è¦çš„æƒé™
    tmpfs:
      - /tmp
```

#### Kubernetes

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: otel-collector
spec:
  securityContext:
    runAsNonRoot: true
    runAsUser: 10001
    fsGroup: 10001
    seccompProfile:
      type: RuntimeDefault
  
  containers:
  - name: otel-collector
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
        - ALL
        add:
        - NET_BIND_SERVICE
    
    volumeMounts:
    - name: tmp
      mountPath: /tmp
  
  volumes:
  - name: tmp
    emptyDir: {}
```

### 2. é•œåƒå®‰å…¨

```bash
# ä½¿ç”¨å®˜æ–¹é•œåƒ
FROM otel/opentelemetry-collector-contrib:0.90.0

# æ‰«æé•œåƒæ¼æ´
trivy image otel/opentelemetry-collector-contrib:latest

# ä½¿ç”¨distrolessåŸºç¡€é•œåƒ
FROM gcr.io/distroless/base-debian11

# ç­¾åé•œåƒ
docker trust sign myregistry/otel-collector:1.0.0
```

### 3. Secretsç®¡ç†

#### Kubernetes Secrets

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: otel-secrets
  namespace: observability
type: Opaque
data:
  api-key: <base64-encoded-key>
  tls-cert: <base64-encoded-cert>
  tls-key: <base64-encoded-key>

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: otel-collector
spec:
  template:
    spec:
      containers:
      - name: otel-collector
        env:
        - name: API_KEY
          valueFrom:
            secretKeyRef:
              name: otel-secrets
              key: api-key
        
        volumeMounts:
        - name: tls-certs
          mountPath: /certs
          readOnly: true
      
      volumes:
      - name: tls-certs
        secret:
          secretName: otel-secrets
```

#### HashiCorp Vaulté›†æˆ

```yaml
extensions:
  vault:
    endpoint: https://vault.example.com:8200
    token: ${VAULT_TOKEN}
    path: secret/data/otlp

exporters:
  otlp:
    endpoint: backend:4317
    headers:
      authorization: "Bearer ${vault:api-key}"
```

---

## ğŸ“‹ å®¡è®¡å’Œåˆè§„

### 1. å®¡è®¡æ—¥å¿—

```yaml
processors:
  # è®°å½•æ‰€æœ‰è®¿é—®
  logging:
    loglevel: debug
    sampling_initial: 1
    sampling_thereafter: 1

exporters:
  # å¯¼å‡ºåˆ°SIEMç³»ç»Ÿ
  syslog:
    endpoint: siem.example.com:514
    protocol: tcp
    network: tcp

service:
  pipelines:
    logs:
      receivers: [otlp]
      processors: [logging]
      exporters: [syslog]
```

### 2. åˆè§„æ€§é…ç½®

#### GDPRåˆè§„

```yaml
processors:
  # åˆ é™¤ä¸ªäººèº«ä»½ä¿¡æ¯
  attributes:
    actions:
      - key: user.name
        action: delete
      - key: user.email
        action: hash
      - key: user.phone
        action: delete
      - key: client.ip
        action: hash
  
  # æ•°æ®ä¿ç•™ç­–ç•¥
  memory_limiter:
    check_interval: 1s
    limit_mib: 2048

exporters:
  # è®¾ç½®TTL
  jaeger:
    endpoint: jaeger:14250
    # Jaegerç«¯é…ç½®TTL=30å¤©
```

#### SOC 2åˆè§„

```yaml
# è®¿é—®æ§åˆ¶
extensions:
  oauth2client:
    client_id: ${CLIENT_ID}
    client_secret: ${CLIENT_SECRET}

# åŠ å¯†ä¼ è¾“
receivers:
  otlp:
    protocols:
      grpc:
        tls:
          cert_file: /certs/server.crt
          key_file: /certs/server.key

# å®¡è®¡æ—¥å¿—
service:
  telemetry:
    logs:
      level: debug
      output_paths: ["/var/log/otel/audit.log"]
```

---

## âœ… å®‰å…¨æ£€æŸ¥æ¸…å•

### ä¼ è¾“å±‚å®‰å…¨

- [ ] å¯ç”¨TLS 1.2+
- [ ] ä½¿ç”¨æœ‰æ•ˆçš„è¯ä¹¦ï¼ˆéè‡ªç­¾åï¼‰
- [ ] é…ç½®åŒå‘TLSï¼ˆmTLSï¼‰
- [ ] ç¦ç”¨ä¸å®‰å…¨çš„åè®®

### è®¤è¯å’Œæˆæƒ

- [ ] å®æ–½API Keyæˆ–OAuth
- [ ] ä½¿ç”¨å¼ºå¯†ç ç­–ç•¥
- [ ] å®šæœŸè½®æ¢å¯†é’¥
- [ ] é™åˆ¶è®¿é—®æƒé™

### æ•°æ®å®‰å…¨

- [ ] è„±æ•æ•æ„Ÿæ•°æ®ï¼ˆPIIï¼‰
- [ ] åˆ é™¤è®¤è¯header
- [ ] åŠ å¯†å­˜å‚¨æ•°æ®
- [ ] è®¾ç½®æ•°æ®ä¿ç•™ç­–ç•¥

### ç½‘ç»œå®‰å…¨

- [ ] é…ç½®é˜²ç«å¢™è§„åˆ™
- [ ] å®æ–½ç½‘ç»œéš”ç¦»
- [ ] å¯ç”¨é€Ÿç‡é™åˆ¶
- [ ] é…ç½®NetworkPolicyï¼ˆK8sï¼‰

### è¿è¡Œæ—¶å®‰å…¨

- [ ] ä»¥érootç”¨æˆ·è¿è¡Œ
- [ ] åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿ
- [ ] æœ€å°æƒé™åŸåˆ™
- [ ] æ‰«æé•œåƒæ¼æ´
- [ ] ä½¿ç”¨Secretsç®¡ç†

### ç›‘æ§å’Œå®¡è®¡

- [ ] å¯ç”¨å®¡è®¡æ—¥å¿—
- [ ] ç›‘æ§å¼‚å¸¸è®¿é—®
- [ ] é…ç½®å‘Šè­¦
- [ ] å®šæœŸå®‰å…¨å®¡æŸ¥

---

## ğŸ”— ç›¸å…³èµ„æº

- [ğŸ³ Dockeréƒ¨ç½²æŒ‡å—](ğŸ³_Dockeréƒ¨ç½²å®Œæ•´æŒ‡å—.md)
- [â˜¸ï¸ Kuberneteséƒ¨ç½²æŒ‡å—](â˜¸ï¸_Kuberneteséƒ¨ç½²å®Œæ•´æŒ‡å—.md)
- [ğŸ”§ æ•…éšœæ’æŸ¥æ‰‹å†Œ](ğŸ”§_æ•…éšœæ’æŸ¥å®Œæ•´æ‰‹å†Œ.md)

---

**æ›´æ–°æ—¶é—´**: 2025å¹´10æœˆ20æ—¥  
**ç‰ˆæœ¬**: v1.0.0  
**ç»´æŠ¤è€…**: OTLPé¡¹ç›®å›¢é˜Ÿ

---

**ğŸ”’ æ„å»ºå®‰å…¨çš„OTLPç¯å¢ƒï¼** ğŸ›¡ï¸

# 🔒 OTLP安全最佳实践指南

> **目标**: 帮助用户构建安全的OTLP部署环境  
> **适用场景**: 生产环境安全加固  
> **更新时间**: 2025年10月20日

---

## 📋 目录

- [🔒 OTLP安全最佳实践指南](#-otlp安全最佳实践指南)
  - [📋 目录](#-目录)
  - [🔐 传输安全](#-传输安全)
    - [1. TLS/SSL配置](#1-tlsssl配置)
      - [Collector TLS配置](#collector-tls配置)
      - [生成自签名证书](#生成自签名证书)
      - [SDK TLS配置](#sdk-tls配置)
  - [🔑 认证和授权](#-认证和授权)
    - [1. API Key认证](#1-api-key认证)
      - [Collector配置](#collector配置)
      - [SDK配置](#sdk配置)
    - [2. OAuth 2.0 / OIDC](#2-oauth-20--oidc)
    - [3. Basic Auth](#3-basic-auth)
  - [🛡️ 数据安全](#️-数据安全)
    - [1. 敏感数据脱敏](#1-敏感数据脱敏)
    - [2. PII数据处理](#2-pii数据处理)
    - [3. 数据加密存储](#3-数据加密存储)
  - [🌐 网络安全](#-网络安全)
    - [1. 网络隔离](#1-网络隔离)
      - [Docker Network](#docker-network)
      - [Kubernetes NetworkPolicy](#kubernetes-networkpolicy)
    - [2. 防火墙规则](#2-防火墙规则)
    - [3. 速率限制](#3-速率限制)
  - [🔐 运行时安全](#-运行时安全)
    - [1. 最小权限原则](#1-最小权限原则)
      - [Docker](#docker)
      - [Kubernetes](#kubernetes)
    - [2. 镜像安全](#2-镜像安全)
    - [3. Secrets管理](#3-secrets管理)
      - [Kubernetes Secrets](#kubernetes-secrets)
      - [HashiCorp Vault集成](#hashicorp-vault集成)
  - [📋 审计和合规](#-审计和合规)
    - [1. 审计日志](#1-审计日志)
    - [2. 合规性配置](#2-合规性配置)
      - [GDPR合规](#gdpr合规)
      - [SOC 2合规](#soc-2合规)
  - [✅ 安全检查清单](#-安全检查清单)
    - [传输层安全](#传输层安全)
    - [认证和授权](#认证和授权)
    - [数据安全](#数据安全)
    - [网络安全](#网络安全)
    - [运行时安全](#运行时安全)
    - [监控和审计](#监控和审计)
  - [🔗 相关资源](#-相关资源)

---

## 🔐 传输安全

### 1. TLS/SSL配置

#### Collector TLS配置

```yaml
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
        tls:
          cert_file: /certs/server.crt
          key_file: /certs/server.key
          client_ca_file: /certs/ca.crt  # 双向TLS
          min_version: "1.2"
          max_version: "1.3"
      http:
        endpoint: 0.0.0.0:4318
        tls:
          cert_file: /certs/server.crt
          key_file: /certs/server.key

exporters:
  otlp:
    endpoint: backend:4317
    tls:
      cert_file: /certs/client.crt
      key_file: /certs/client.key
      ca_file: /certs/ca.crt
      insecure: false  # 禁用不安全连接
```

#### 生成自签名证书

```bash
# 生成CA
openssl genrsa -out ca.key 4096
openssl req -new -x509 -days 365 -key ca.key -out ca.crt \
  -subj "/CN=OTLP-CA"

# 生成服务器证书
openssl genrsa -out server.key 4096
openssl req -new -key server.key -out server.csr \
  -subj "/CN=otel-collector"

# 签名服务器证书
openssl x509 -req -days 365 -in server.csr \
  -CA ca.crt -CAkey ca.key -CAcreateserial \
  -out server.crt

# 生成客户端证书
openssl genrsa -out client.key 4096
openssl req -new -key client.key -out client.csr \
  -subj "/CN=otlp-client"
openssl x509 -req -days 365 -in client.csr \
  -CA ca.crt -CAkey ca.key -CAcreateserial \
  -out client.crt
```

#### SDK TLS配置

**Go**:

```go
import (
    "crypto/tls"
    "crypto/x509"
    "go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc"
    "google.golang.org/grpc/credentials"
)

func createSecureExporter() (*otlptrace.Exporter, error) {
    // 加载CA证书
    caCert, _ := ioutil.ReadFile("/certs/ca.crt")
    caCertPool := x509.NewCertPool()
    caCertPool.AppendCertsFromPEM(caCert)
    
    // 加载客户端证书
    clientCert, _ := tls.LoadX509KeyPair("/certs/client.crt", "/certs/client.key")
    
    // TLS配置
    tlsConfig := &tls.Config{
        Certificates: []tls.Certificate{clientCert},
        RootCAs:      caCertPool,
        MinVersion:   tls.VersionTLS12,
    }
    
    creds := credentials.NewTLS(tlsConfig)
    
    return otlptracegrpc.New(
        context.Background(),
        otlptracegrpc.WithEndpoint("collector:4317"),
        otlptracegrpc.WithTLSCredentials(creds),
    )
}
```

---

## 🔑 认证和授权

### 1. API Key认证

#### Collector配置

```yaml
receivers:
  otlp:
    protocols:
      http:
        endpoint: 0.0.0.0:4318
        headers:
          authorization: ${API_KEY}  # 环境变量

extensions:
  headers_setter:
    headers:
      - key: Authorization
        from_context: authorization
```

#### SDK配置

```go
exporter, err := otlptracehttp.New(
    context.Background(),
    otlptracehttp.WithEndpoint("collector:4318"),
    otlptracehttp.WithHeaders(map[string]string{
        "Authorization": "Bearer your-api-key",
    }),
)
```

### 2. OAuth 2.0 / OIDC

```yaml
extensions:
  oauth2client:
    client_id: ${CLIENT_ID}
    client_secret: ${CLIENT_SECRET}
    token_url: https://auth.example.com/oauth/token
    scopes: ["otlp.write"]
    timeout: 30s

exporters:
  otlp:
    endpoint: backend:4317
    auth:
      authenticator: oauth2client
```

### 3. Basic Auth

```yaml
extensions:
  basicauth/collector:
    client_auth:
      username: ${OTLP_USERNAME}
      password: ${OTLP_PASSWORD}

exporters:
  otlp:
    endpoint: backend:4317
    auth:
      authenticator: basicauth/collector
```

---

## 🛡️ 数据安全

### 1. 敏感数据脱敏

```yaml
processors:
  attributes:
    actions:
      # 删除敏感header
      - key: http.request.header.authorization
        action: delete
      
      - key: http.request.header.cookie
        action: delete
      
      # 脱敏信用卡号
      - key: payment.card_number
        action: update
        value: "****-****-****-1234"
      
      # Hash敏感数据
      - key: user.email
        action: hash
```

### 2. PII数据处理

```yaml
processors:
  transform:
    traces:
      statements:
        # Hash邮箱
        - set(attributes["user.email"], SHA256(attributes["user.email"]))
        
        # 脱敏电话号码
        - replace_pattern(attributes["user.phone"], "\\d{4}$", "****")
        
        # 删除IP地址最后一段
        - replace_pattern(attributes["client.ip"], "\\.\\d+$", ".xxx")
```

### 3. 数据加密存储

**Jaeger with Elasticsearch**:

```yaml
# Elasticsearch配置
xpack.security.enabled: true
xpack.security.transport.ssl.enabled: true
xpack.security.http.ssl.enabled: true

# Collector导出配置
exporters:
  elasticsearch:
    endpoints: [https://elasticsearch:9200]
    auth:
      authenticator: basicauth
    tls:
      ca_file: /certs/ca.crt
      insecure: false
```

---

## 🌐 网络安全

### 1. 网络隔离

#### Docker Network

```yaml
networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge
    internal: true  # 不允许外部访问

services:
  otel-collector:
    networks:
      - frontend  # 接收外部数据
      - backend   # 连接后端
  
  jaeger:
    networks:
      - backend   # 仅内部访问
```

#### Kubernetes NetworkPolicy

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: otel-collector-netpol
  namespace: observability
spec:
  podSelector:
    matchLabels:
      app: otel-collector
  policyTypes:
  - Ingress
  - Egress
  
  ingress:
  # 只允许来自应用命名空间的流量
  - from:
    - namespaceSelector:
        matchLabels:
          name: production
    ports:
    - protocol: TCP
      port: 4317
    - protocol: TCP
      port: 4318
  
  egress:
  # 只允许访问observability命名空间
  - to:
    - namespaceSelector:
        matchLabels:
          name: observability
    ports:
    - protocol: TCP
      port: 14250  # Jaeger
    - protocol: TCP
      port: 9200   # Elasticsearch
```

### 2. 防火墙规则

```bash
# Linux iptables
sudo iptables -A INPUT -p tcp --dport 4317 -s 10.0.0.0/8 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 4317 -j DROP

# 只允许内网访问
sudo iptables -A INPUT -p tcp --dport 4317 -s 192.168.0.0/16 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 4318 -s 192.168.0.0/16 -j ACCEPT
```

### 3. 速率限制

```yaml
processors:
  # Collector级别限流
  throttle:
    bytes_per_second: 10485760  # 10MB/s
    spans_per_second: 10000

  # 批处理限制
  batch:
    send_batch_size: 512
    send_batch_max_size: 1024
```

---

## 🔐 运行时安全

### 1. 最小权限原则

#### Docker

```yaml
services:
  otel-collector:
    user: "10001:10001"  # 非root用户
    read_only: true      # 只读根文件系统
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE  # 仅需要的权限
    tmpfs:
      - /tmp
```

#### Kubernetes

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: otel-collector
spec:
  securityContext:
    runAsNonRoot: true
    runAsUser: 10001
    fsGroup: 10001
    seccompProfile:
      type: RuntimeDefault
  
  containers:
  - name: otel-collector
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
        - ALL
        add:
        - NET_BIND_SERVICE
    
    volumeMounts:
    - name: tmp
      mountPath: /tmp
  
  volumes:
  - name: tmp
    emptyDir: {}
```

### 2. 镜像安全

```bash
# 使用官方镜像
FROM otel/opentelemetry-collector-contrib:0.90.0

# 扫描镜像漏洞
trivy image otel/opentelemetry-collector-contrib:latest

# 使用distroless基础镜像
FROM gcr.io/distroless/base-debian11

# 签名镜像
docker trust sign myregistry/otel-collector:1.0.0
```

### 3. Secrets管理

#### Kubernetes Secrets

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: otel-secrets
  namespace: observability
type: Opaque
data:
  api-key: <base64-encoded-key>
  tls-cert: <base64-encoded-cert>
  tls-key: <base64-encoded-key>

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: otel-collector
spec:
  template:
    spec:
      containers:
      - name: otel-collector
        env:
        - name: API_KEY
          valueFrom:
            secretKeyRef:
              name: otel-secrets
              key: api-key
        
        volumeMounts:
        - name: tls-certs
          mountPath: /certs
          readOnly: true
      
      volumes:
      - name: tls-certs
        secret:
          secretName: otel-secrets
```

#### HashiCorp Vault集成

```yaml
extensions:
  vault:
    endpoint: https://vault.example.com:8200
    token: ${VAULT_TOKEN}
    path: secret/data/otlp

exporters:
  otlp:
    endpoint: backend:4317
    headers:
      authorization: "Bearer ${vault:api-key}"
```

---

## 📋 审计和合规

### 1. 审计日志

```yaml
processors:
  # 记录所有访问
  logging:
    loglevel: debug
    sampling_initial: 1
    sampling_thereafter: 1

exporters:
  # 导出到SIEM系统
  syslog:
    endpoint: siem.example.com:514
    protocol: tcp
    network: tcp

service:
  pipelines:
    logs:
      receivers: [otlp]
      processors: [logging]
      exporters: [syslog]
```

### 2. 合规性配置

#### GDPR合规

```yaml
processors:
  # 删除个人身份信息
  attributes:
    actions:
      - key: user.name
        action: delete
      - key: user.email
        action: hash
      - key: user.phone
        action: delete
      - key: client.ip
        action: hash
  
  # 数据保留策略
  memory_limiter:
    check_interval: 1s
    limit_mib: 2048

exporters:
  # 设置TTL
  jaeger:
    endpoint: jaeger:14250
    # Jaeger端配置TTL=30天
```

#### SOC 2合规

```yaml
# 访问控制
extensions:
  oauth2client:
    client_id: ${CLIENT_ID}
    client_secret: ${CLIENT_SECRET}

# 加密传输
receivers:
  otlp:
    protocols:
      grpc:
        tls:
          cert_file: /certs/server.crt
          key_file: /certs/server.key

# 审计日志
service:
  telemetry:
    logs:
      level: debug
      output_paths: ["/var/log/otel/audit.log"]
```

---

## ✅ 安全检查清单

### 传输层安全

- [ ] 启用TLS 1.2+
- [ ] 使用有效的证书（非自签名）
- [ ] 配置双向TLS（mTLS）
- [ ] 禁用不安全的协议

### 认证和授权

- [ ] 实施API Key或OAuth
- [ ] 使用强密码策略
- [ ] 定期轮换密钥
- [ ] 限制访问权限

### 数据安全

- [ ] 脱敏敏感数据（PII）
- [ ] 删除认证header
- [ ] 加密存储数据
- [ ] 设置数据保留策略

### 网络安全

- [ ] 配置防火墙规则
- [ ] 实施网络隔离
- [ ] 启用速率限制
- [ ] 配置NetworkPolicy（K8s）

### 运行时安全

- [ ] 以非root用户运行
- [ ] 只读根文件系统
- [ ] 最小权限原则
- [ ] 扫描镜像漏洞
- [ ] 使用Secrets管理

### 监控和审计

- [ ] 启用审计日志
- [ ] 监控异常访问
- [ ] 配置告警
- [ ] 定期安全审查

---

## 🔗 相关资源

- [🐳 Docker部署指南](🐳_Docker部署完整指南.md)
- [☸️ Kubernetes部署指南](☸️_Kubernetes部署完整指南.md)
- [🔧 故障排查手册](🔧_故障排查完整手册.md)

---

**更新时间**: 2025年10月20日  
**版本**: v1.0.0  
**维护者**: OTLP项目团队

---

**🔒 构建安全的OTLP环境！** 🛡️

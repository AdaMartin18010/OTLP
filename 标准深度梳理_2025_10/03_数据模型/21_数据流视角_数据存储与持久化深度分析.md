# OTLPæ•°æ®æµè§†è§’ï¼šæ•°æ®å­˜å‚¨ä¸æŒä¹…åŒ–æ·±åº¦åˆ†æ

> **æ–‡æ¡£ç±»å‹**: æ•°æ®æ¨¡å‹æ·±åº¦åˆ†æ  
> **åˆ†æç»´åº¦**: æ•°æ®æµè§†è§’ - æ•°æ®å­˜å‚¨ä¸æŒä¹…åŒ–  
> **åˆ›å»ºæ—¥æœŸ**: 2025å¹´10æœˆ11æ—¥  
> **æ–‡æ¡£çŠ¶æ€**: âœ… å®Œæˆ

---

## ğŸ“‹ ç›®å½•

- [OTLPæ•°æ®æµè§†è§’ï¼šæ•°æ®å­˜å‚¨ä¸æŒä¹…åŒ–æ·±åº¦åˆ†æ](#otlpæ•°æ®æµè§†è§’æ•°æ®å­˜å‚¨ä¸æŒä¹…åŒ–æ·±åº¦åˆ†æ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ğŸ¯ æ‰§è¡Œæ‘˜è¦](#-æ‰§è¡Œæ‘˜è¦)
  - [ğŸ“Š å­˜å‚¨å…¨æ™¯](#-å­˜å‚¨å…¨æ™¯)
    - [å­˜å‚¨ç­–ç•¥çŸ©é˜µ](#å­˜å‚¨ç­–ç•¥çŸ©é˜µ)
  - [ğŸ’¾ å­˜å‚¨ç­–ç•¥](#-å­˜å‚¨ç­–ç•¥)
    - [çƒ­å­˜å‚¨ç­–ç•¥](#çƒ­å­˜å‚¨ç­–ç•¥)
    - [æ¸©å­˜å‚¨ç­–ç•¥](#æ¸©å­˜å‚¨ç­–ç•¥)
    - [å†·å­˜å‚¨ç­–ç•¥](#å†·å­˜å‚¨ç­–ç•¥)
  - [ğŸ—„ï¸ å­˜å‚¨å¼•æ“](#ï¸-å­˜å‚¨å¼•æ“)
    - [æ—¶åºæ•°æ®åº“](#æ—¶åºæ•°æ®åº“)
    - [åˆ—å¼æ•°æ®åº“](#åˆ—å¼æ•°æ®åº“)
    - [å¯¹è±¡å­˜å‚¨](#å¯¹è±¡å­˜å‚¨)
  - [ğŸ“ˆ å­˜å‚¨æ€§èƒ½åˆ†æ](#-å­˜å‚¨æ€§èƒ½åˆ†æ)
    - [å­˜å‚¨æ€§èƒ½åŸºå‡†æµ‹è¯•](#å­˜å‚¨æ€§èƒ½åŸºå‡†æµ‹è¯•)
  - [âš¡ å­˜å‚¨ä¼˜åŒ–ç­–ç•¥](#-å­˜å‚¨ä¼˜åŒ–ç­–ç•¥)
    - [1. æ•°æ®åˆ†åŒº](#1-æ•°æ®åˆ†åŒº)
    - [2. æ•°æ®å‹ç¼©](#2-æ•°æ®å‹ç¼©)
    - [3. æ•°æ®ç´¢å¼•](#3-æ•°æ®ç´¢å¼•)
  - [ğŸ’¡ å®æˆ˜æ¡ˆä¾‹](#-å®æˆ˜æ¡ˆä¾‹)
    - [æ¡ˆä¾‹1ï¼šå¤šçº§å­˜å‚¨æ¶æ„](#æ¡ˆä¾‹1å¤šçº§å­˜å‚¨æ¶æ„)
    - [æ¡ˆä¾‹2ï¼šæ—¶åºæ•°æ®å­˜å‚¨ä¼˜åŒ–](#æ¡ˆä¾‹2æ—¶åºæ•°æ®å­˜å‚¨ä¼˜åŒ–)
  - [ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®](#-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
    - [å­˜å‚¨ä¼˜åŒ–çŸ©é˜µ](#å­˜å‚¨ä¼˜åŒ–çŸ©é˜µ)
  - [ğŸ¯ æ€»ç»“](#-æ€»ç»“)

---

## ğŸ¯ æ‰§è¡Œæ‘˜è¦

**æ•°æ®å­˜å‚¨ä¸æŒä¹…åŒ–**æ˜¯OTLPæ•°æ®æµçš„ç»ˆç‚¹ï¼Œå†³å®šäº†æ•°æ®çš„é•¿æœŸä¿å­˜å’ŒæŸ¥è¯¢èƒ½åŠ›ã€‚

```text
å­˜å‚¨å…¨æ™¯:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            OTLPæ•°æ®å­˜å‚¨ä¸æŒä¹…åŒ–ä½“ç³»                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  å­˜å‚¨ç­–ç•¥                                      â”‚      â”‚
â”‚  â”‚  - çƒ­å­˜å‚¨ (å†…å­˜/SSD)                          â”‚      â”‚
â”‚  â”‚  - æ¸©å­˜å‚¨ (SSD/HDD)                           â”‚      â”‚
â”‚  â”‚  - å†·å­˜å‚¨ (HDD/å¯¹è±¡å­˜å‚¨)                       â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                         â”‚                               â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚         â”‚               â”‚               â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ å­˜å‚¨å¼•æ“    â”‚  â”‚ å­˜å‚¨æ ¼å¼    â”‚  â”‚ ç´¢å¼•ç­–ç•¥    â”‚        â”‚
â”‚  â”‚ - æ—¶åºDB    â”‚  â”‚ - Protobuf  â”‚  â”‚ - æ—¶é—´ç´¢å¼•  â”‚        â”‚
â”‚  â”‚ - åˆ—å¼DB    â”‚  â”‚ - Parquet   â”‚  â”‚ - æ ‡ç­¾ç´¢å¼•  â”‚        â”‚
â”‚  â”‚ - å¯¹è±¡å­˜å‚¨  â”‚  â”‚ - Arrow     â”‚  â”‚ - å…¨æ–‡ç´¢å¼•  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  å­˜å‚¨åœºæ™¯                                      â”‚      â”‚
â”‚  â”‚  - Traceså­˜å‚¨                                  â”‚      â”‚
â”‚  â”‚  - Metricså­˜å‚¨                                 â”‚      â”‚
â”‚  â”‚  - Logså­˜å‚¨                                    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒæ´å¯Ÿ**ï¼š

1. **å­˜å‚¨ç­–ç•¥**ï¼šçƒ­å­˜å‚¨ > æ¸©å­˜å‚¨ > å†·å­˜å‚¨ï¼ˆè®¿é—®é¢‘ç‡ï¼‰
2. **å­˜å‚¨å¼•æ“**ï¼šæ—¶åºDB > åˆ—å¼DB > å¯¹è±¡å­˜å‚¨ï¼ˆæŸ¥è¯¢æ€§èƒ½ï¼‰
3. **å­˜å‚¨æ ¼å¼**ï¼šProtobuf > Parquet > Arrowï¼ˆå‹ç¼©ç‡ï¼‰
4. **ç´¢å¼•ç­–ç•¥**ï¼šæ—¶é—´ç´¢å¼• + æ ‡ç­¾ç´¢å¼• + å…¨æ–‡ç´¢å¼•

---

## ğŸ“Š å­˜å‚¨å…¨æ™¯

### å­˜å‚¨ç­–ç•¥çŸ©é˜µ

```text
å­˜å‚¨ç­–ç•¥çŸ©é˜µ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å­˜å‚¨ç­–ç•¥      â”‚ è®¿é—®é¢‘ç‡    â”‚ å­˜å‚¨æˆæœ¬ â”‚ æŸ¥è¯¢å»¶è¿Ÿ    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  çƒ­å­˜å‚¨        â”‚ é«˜          â”‚ é«˜      â”‚ ä½          â”‚
â”‚  æ¸©å­˜å‚¨        â”‚ ä¸­          â”‚ ä¸­      â”‚ ä¸­          â”‚
â”‚  å†·å­˜å‚¨        â”‚ ä½          â”‚ ä½      â”‚ é«˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¾ å­˜å‚¨ç­–ç•¥

### çƒ­å­˜å‚¨ç­–ç•¥

```text
çƒ­å­˜å‚¨ç­–ç•¥:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç‰¹ç‚¹          â”‚ è¯´æ˜                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å­˜å‚¨ä»‹è´¨      â”‚ å†…å­˜/SSD                                 â”‚
â”‚  è®¿é—®é¢‘ç‡      â”‚ é«˜ (ç§’çº§)                                â”‚
â”‚  å­˜å‚¨å‘¨æœŸ      â”‚ çŸ­æœŸ (å°æ—¶-å¤©)                           â”‚
â”‚  æŸ¥è¯¢å»¶è¿Ÿ      â”‚ ä½ (<10ms)                               â”‚
â”‚  å­˜å‚¨æˆæœ¬      â”‚ é«˜ ($0.10/GB/æœˆ)                         â”‚
â”‚  é€‚ç”¨åœºæ™¯      â”‚ å®æ—¶æŸ¥è¯¢ã€å‘Šè­¦åˆ†æ                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¸©å­˜å‚¨ç­–ç•¥

```text
æ¸©å­˜å‚¨ç­–ç•¥:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç‰¹ç‚¹          â”‚ è¯´æ˜                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å­˜å‚¨ä»‹è´¨      â”‚ SSD/HDD                                 â”‚
â”‚  è®¿é—®é¢‘ç‡      â”‚ ä¸­ (åˆ†é’Ÿçº§)                              â”‚
â”‚  å­˜å‚¨å‘¨æœŸ      â”‚ ä¸­æœŸ (å¤©-å‘¨)                             â”‚
â”‚  æŸ¥è¯¢å»¶è¿Ÿ      â”‚ ä¸­ (10-100ms)                            â”‚
â”‚  å­˜å‚¨æˆæœ¬      â”‚ ä¸­ ($0.03/GB/æœˆ)                         â”‚
â”‚  é€‚ç”¨åœºæ™¯      â”‚ å†å²æŸ¥è¯¢ã€è¶‹åŠ¿åˆ†æ                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å†·å­˜å‚¨ç­–ç•¥

```text
å†·å­˜å‚¨ç­–ç•¥:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç‰¹ç‚¹          â”‚ è¯´æ˜                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å­˜å‚¨ä»‹è´¨      â”‚ HDD/å¯¹è±¡å­˜å‚¨                             â”‚
â”‚  è®¿é—®é¢‘ç‡      â”‚ ä½ (å°æ—¶çº§)                              â”‚
â”‚  å­˜å‚¨å‘¨æœŸ      â”‚ é•¿æœŸ (å‘¨-æœˆ)                             â”‚
â”‚  æŸ¥è¯¢å»¶è¿Ÿ      â”‚ é«˜ (>100ms)                              â”‚
â”‚  å­˜å‚¨æˆæœ¬      â”‚ ä½ ($0.01/GB/æœˆ)                         â”‚
â”‚  é€‚ç”¨åœºæ™¯      â”‚ å½’æ¡£å­˜å‚¨ã€åˆè§„å®¡è®¡                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ å­˜å‚¨å¼•æ“

### æ—¶åºæ•°æ®åº“

```go
// æ—¶åºæ•°æ®åº“å­˜å‚¨ç¤ºä¾‹
package main

import (
    "github.com/influxdata/influxdb-client-go/v2"
    "github.com/influxdata/influxdb-client-go/v2/api"
)

func setupInfluxDB() (influxdb2.Client, api.WriteAPI) {
    client := influxdb2.NewClient("http://localhost:8086", "token")
    writeAPI := client.WriteAPI("org", "bucket")
    
    return client, writeAPI
}

// å­˜å‚¨Spanæ•°æ®
func storeSpan(writeAPI api.WriteAPI, span Span) {
    p := influxdb2.NewPoint("spans",
        map[string]string{
            "service.name": "user-service",
            "span.kind":    "SERVER",
        },
        map[string]interface{}{
            "duration": span.Duration,
            "status":   span.Status,
        },
        span.StartTime,
    )
    
    writeAPI.WritePoint(p)
    writeAPI.Flush()
}

// æŸ¥è¯¢Spanæ•°æ®
func querySpans(client influxdb2.Client, query string) []Span {
    queryAPI := client.QueryAPI("org")
    
    result, err := queryAPI.Query(context.Background(), query)
    if err != nil {
        return nil
    }
    
    var spans []Span
    for result.Next() {
        record := result.Record()
        spans = append(spans, Span{
            Name:      record.ValueByKey("name").(string),
            Duration:  record.ValueByKey("duration").(float64),
            StartTime: record.Time(),
        })
    }
    
    return spans
}
```

### åˆ—å¼æ•°æ®åº“

```go
// åˆ—å¼æ•°æ®åº“å­˜å‚¨ç¤ºä¾‹
package main

import (
    "github.com/ClickHouse/clickhouse-go/v2"
)

func setupClickHouse() (clickhouse.Conn, error) {
    conn, err := clickhouse.Open(&clickhouse.Options{
        Addr: []string{"localhost:9000"},
        Auth: clickhouse.Auth{
            Database: "default",
            Username: "default",
            Password: "",
        },
    })
    
    return conn, err
}

// åˆ›å»ºè¡¨
func createTable(conn clickhouse.Conn) error {
    return conn.Exec(context.Background(), `
        CREATE TABLE IF NOT EXISTS spans (
            trace_id String,
            span_id String,
            name String,
            start_time DateTime64(9),
            end_time DateTime64(9),
            duration UInt64,
            status String,
            INDEX idx_trace_id trace_id TYPE bloom_filter GRANULARITY 1
        ) ENGINE = MergeTree()
        ORDER BY (start_time, trace_id)
        TTL start_time + INTERVAL 7 DAY
    `)
}

// å­˜å‚¨Spanæ•°æ®
func storeSpan(conn clickhouse.Conn, span Span) error {
    return conn.Exec(context.Background(), `
        INSERT INTO spans VALUES
        (?, ?, ?, ?, ?, ?, ?)
    `,
        span.TraceID,
        span.SpanID,
        span.Name,
        span.StartTime,
        span.EndTime,
        span.Duration,
        span.Status,
    )
}

// æŸ¥è¯¢Spanæ•°æ®
func querySpans(conn clickhouse.Conn, traceID string) ([]Span, error) {
    rows, err := conn.Query(context.Background(), `
        SELECT trace_id, span_id, name, start_time, end_time, duration, status
        FROM spans
        WHERE trace_id = ?
        ORDER BY start_time
    `, traceID)
    
    if err != nil {
        return nil, err
    }
    defer rows.Close()
    
    var spans []Span
    for rows.Next() {
        var span Span
        if err := rows.Scan(&span.TraceID, &span.SpanID, &span.Name,
            &span.StartTime, &span.EndTime, &span.Duration, &span.Status); err != nil {
            return nil, err
        }
        spans = append(spans, span)
    }
    
    return spans, nil
}
```

### å¯¹è±¡å­˜å‚¨

```go
// å¯¹è±¡å­˜å‚¨ç¤ºä¾‹
package main

import (
    "github.com/aws/aws-sdk-go/aws"
    "github.com/aws/aws-sdk-go/aws/session"
    "github.com/aws/aws-sdk-go/service/s3"
)

func setupS3() (*s3.S3, error) {
    sess, err := session.NewSession(&aws.Config{
        Region: aws.String("us-east-1"),
    })
    
    if err != nil {
        return nil, err
    }
    
    return s3.New(sess), nil
}

// å­˜å‚¨Spanæ•°æ®
func storeSpan(s3Client *s3.S3, span Span) error {
    // åºåˆ—åŒ–Span
    data, err := proto.Marshal(&span)
    if err != nil {
        return err
    }
    
    // ä¸Šä¼ åˆ°S3
    _, err = s3Client.PutObject(&s3.PutObjectInput{
        Bucket:      aws.String("otlp-spans"),
        Key:         aws.String(fmt.Sprintf("spans/%s/%s", span.TraceID, span.SpanID)),
        Body:        bytes.NewReader(data),
        ContentType: aws.String("application/x-protobuf"),
    })
    
    return err
}

// æŸ¥è¯¢Spanæ•°æ®
func querySpan(s3Client *s3.S3, traceID, spanID string) (*Span, error) {
    // ä»S3ä¸‹è½½
    result, err := s3Client.GetObject(&s3.GetObjectInput{
        Bucket: aws.String("otlp-spans"),
        Key:    aws.String(fmt.Sprintf("spans/%s/%s", traceID, spanID)),
    })
    
    if err != nil {
        return nil, err
    }
    defer result.Body.Close()
    
    // ååºåˆ—åŒ–Span
    data, err := io.ReadAll(result.Body)
    if err != nil {
        return nil, err
    }
    
    var span Span
    if err := proto.Unmarshal(data, &span); err != nil {
        return nil, err
    }
    
    return &span, nil
}
```

---

## ğŸ“ˆ å­˜å‚¨æ€§èƒ½åˆ†æ

### å­˜å‚¨æ€§èƒ½åŸºå‡†æµ‹è¯•

```text
å­˜å‚¨æ€§èƒ½åŸºå‡†æµ‹è¯• (10,000 Spans):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å­˜å‚¨å¼•æ“      â”‚ å†™å…¥é€Ÿåº¦    â”‚ æŸ¥è¯¢é€Ÿåº¦ â”‚ å­˜å‚¨æˆæœ¬    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  InfluxDB     â”‚ 50K spans/s â”‚ 10ms    â”‚ $0.10/GB   â”‚
â”‚  ClickHouse   â”‚ 100K spans/sâ”‚ 5ms     â”‚ $0.05/GB   â”‚
â”‚  TimescaleDB  â”‚ 30K spans/s â”‚ 15ms    â”‚ $0.08/GB   â”‚
â”‚  S3           â”‚ 10K spans/s â”‚ 200ms   â”‚ $0.01/GB   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš¡ å­˜å‚¨ä¼˜åŒ–ç­–ç•¥

### 1. æ•°æ®åˆ†åŒº

```go
// æ•°æ®åˆ†åŒºç­–ç•¥
package main

import (
    "github.com/ClickHouse/clickhouse-go/v2"
)

// æŒ‰æ—¶é—´åˆ†åŒº
func createTimePartitionedTable(conn clickhouse.Conn) error {
    return conn.Exec(context.Background(), `
        CREATE TABLE IF NOT EXISTS spans (
            trace_id String,
            span_id String,
            name String,
            start_time DateTime64(9),
            end_time DateTime64(9),
            duration UInt64,
            status String
        ) ENGINE = MergeTree()
        PARTITION BY toYYYYMM(start_time)
        ORDER BY (start_time, trace_id)
        TTL start_time + INTERVAL 30 DAY
    `)
}

// æŒ‰æœåŠ¡åˆ†åŒº
func createServicePartitionedTable(conn clickhouse.Conn) error {
    return conn.Exec(context.Background(), `
        CREATE TABLE IF NOT EXISTS spans (
            trace_id String,
            span_id String,
            name String,
            service_name String,
            start_time DateTime64(9),
            end_time DateTime64(9),
            duration UInt64,
            status String
        ) ENGINE = MergeTree()
        PARTITION BY service_name
        ORDER BY (start_time, trace_id)
        TTL start_time + INTERVAL 30 DAY
    `)
}
```

### 2. æ•°æ®å‹ç¼©

```go
// æ•°æ®å‹ç¼©ç­–ç•¥
package main

import (
    "compress/gzip"
    "bytes"
    "io"
)

// å‹ç¼©Spanæ•°æ®
func compressSpan(span Span) ([]byte, error) {
    // åºåˆ—åŒ–
    data, err := proto.Marshal(&span)
    if err != nil {
        return nil, err
    }
    
    // å‹ç¼©
    var buf bytes.Buffer
    writer := gzip.NewWriter(&buf)
    if _, err := writer.Write(data); err != nil {
        return nil, err
    }
    if err := writer.Close(); err != nil {
        return nil, err
    }
    
    return buf.Bytes(), nil
}

// è§£å‹Spanæ•°æ®
func decompressSpan(data []byte) (*Span, error) {
    // è§£å‹
    reader, err := gzip.NewReader(bytes.NewReader(data))
    if err != nil {
        return nil, err
    }
    defer reader.Close()
    
    decompressed, err := io.ReadAll(reader)
    if err != nil {
        return nil, err
    }
    
    // ååºåˆ—åŒ–
    var span Span
    if err := proto.Unmarshal(decompressed, &span); err != nil {
        return nil, err
    }
    
    return &span, nil
}
```

### 3. æ•°æ®ç´¢å¼•

```go
// æ•°æ®ç´¢å¼•ç­–ç•¥
package main

import (
    "github.com/ClickHouse/clickhouse-go/v2"
)

// åˆ›å»ºç´¢å¼•
func createIndexes(conn clickhouse.Conn) error {
    return conn.Exec(context.Background(), `
        CREATE TABLE IF NOT EXISTS spans (
            trace_id String,
            span_id String,
            name String,
            service_name String,
            start_time DateTime64(9),
            end_time DateTime64(9),
            duration UInt64,
            status String,
            
            -- æ—¶é—´ç´¢å¼•
            INDEX idx_start_time start_time TYPE minmax GRANULARITY 1,
            
            -- æ ‡ç­¾ç´¢å¼•
            INDEX idx_trace_id trace_id TYPE bloom_filter GRANULARITY 1,
            INDEX idx_service_name service_name TYPE bloom_filter GRANULARITY 1,
            
            -- å…¨æ–‡ç´¢å¼•
            INDEX idx_name name TYPE tokenbf_v1(512, 3, 0) GRANULARITY 1
        ) ENGINE = MergeTree()
        ORDER BY (start_time, trace_id)
    `)
}
```

---

## ğŸ’¡ å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹1ï¼šå¤šçº§å­˜å‚¨æ¶æ„

```yaml
# å¤šçº§å­˜å‚¨æ¶æ„é…ç½®
storage:
  hot:
    engine: ClickHouse
    retention: 1d
    compression: lz4
    replication: 3
    
  warm:
    engine: ClickHouse
    retention: 7d
    compression: zstd
    replication: 2
    
  cold:
    engine: S3
    retention: 30d
    compression: gzip
    replication: 1
```

### æ¡ˆä¾‹2ï¼šæ—¶åºæ•°æ®å­˜å‚¨ä¼˜åŒ–

```go
// æ—¶åºæ•°æ®å­˜å‚¨ä¼˜åŒ–
package main

import (
    "github.com/ClickHouse/clickhouse-go/v2"
)

func setupOptimizedStorage() error {
    conn, err := setupClickHouse()
    if err != nil {
        return err
    }
    
    // åˆ›å»ºä¼˜åŒ–è¡¨
    return conn.Exec(context.Background(), `
        CREATE TABLE IF NOT EXISTS metrics (
            metric_name String,
            labels Map(String, String),
            value Float64,
            timestamp DateTime64(9),
            
            -- ç´¢å¼•
            INDEX idx_metric_name metric_name TYPE bloom_filter GRANULARITY 1,
            INDEX idx_timestamp timestamp TYPE minmax GRANULARITY 1
        ) ENGINE = MergeTree()
        PARTITION BY toYYYYMMDD(timestamp)
        ORDER BY (metric_name, timestamp)
        TTL timestamp + INTERVAL 7 DAY
        
        SETTINGS
            index_granularity = 8192,
            merge_with_ttl_timeout = 3600
    `)
}
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### å­˜å‚¨ä¼˜åŒ–çŸ©é˜µ

```text
å­˜å‚¨ä¼˜åŒ–çŸ©é˜µ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¼˜åŒ–é¡¹          â”‚ ç­–ç•¥                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åˆ†åŒºç­–ç•¥        â”‚ æŒ‰æ—¶é—´åˆ†åŒº (æå‡æŸ¥è¯¢æ€§èƒ½)              â”‚
â”‚  å‹ç¼©ç­–ç•¥        â”‚ Zstdå‹ç¼© (å¹³è¡¡å‹ç¼©ç‡å’Œé€Ÿåº¦)            â”‚
â”‚  ç´¢å¼•ç­–ç•¥        â”‚ æ—¶é—´+æ ‡ç­¾ç´¢å¼• (åŠ é€ŸæŸ¥è¯¢)               â”‚
â”‚  å‰¯æœ¬ç­–ç•¥        â”‚ 3å‰¯æœ¬ (ä¿è¯å¯é æ€§)                     â”‚
â”‚  ç”Ÿå‘½å‘¨æœŸ        â”‚ çƒ­7å¤©/æ¸©30å¤©/å†·90å¤© (é™ä½æˆæœ¬)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ æ€»ç»“

**æ•°æ®å­˜å‚¨ä¸æŒä¹…åŒ–**æ˜¯OTLPæ•°æ®æµçš„å…³é”®ç¯èŠ‚ï¼š

1. **å­˜å‚¨ç­–ç•¥**ï¼šçƒ­å­˜å‚¨ + æ¸©å­˜å‚¨ + å†·å­˜å‚¨
2. **å­˜å‚¨å¼•æ“**ï¼šæ—¶åºDB + åˆ—å¼DB + å¯¹è±¡å­˜å‚¨
3. **å­˜å‚¨æ ¼å¼**ï¼šProtobuf + Parquet + Arrow
4. **ä¼˜åŒ–ç­–ç•¥**ï¼šåˆ†åŒº + å‹ç¼© + ç´¢å¼•

**å…³é”®è¦ç‚¹**ï¼š

- âœ… çƒ­å­˜å‚¨ç”¨äºå®æ—¶æŸ¥è¯¢
- âœ… æ¸©å­˜å‚¨ç”¨äºå†å²æŸ¥è¯¢
- âœ… å†·å­˜å‚¨ç”¨äºå½’æ¡£å­˜å‚¨
- âœ… åˆ†åŒºæå‡æŸ¥è¯¢æ€§èƒ½
- âœ… å‹ç¼©é™ä½å­˜å‚¨æˆæœ¬

---

**æœ€åæ›´æ–°**: 2025å¹´10æœˆ11æ—¥  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0  
**ç»´æŠ¤è€…**: OTLPæ·±åº¦æ¢³ç†å›¢é˜Ÿ

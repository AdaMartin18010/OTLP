# OpenTelemetry Collector 配置 - Elasticsearch 集成
# 支持将 traces、metrics、logs 数据导出到 Elasticsearch

receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
        max_recv_msg_size: 4194304
        max_concurrent_streams: 16
      http:
        endpoint: 0.0.0.0:4318
        max_recv_msg_size: 4194304

processors:
  # 批处理器
  batch:
    timeout: 1s
    send_batch_size: 512
    send_batch_max_size: 2048

  # 内存限制器
  memory_limiter:
    check_interval: 2s
    limit_mib: 512
    spike_limit_mib: 128

  # 属性处理器 - 为Elasticsearch优化
  attributes:
    actions:
      # 添加索引相关属性
      - key: "elasticsearch.index"
        action: insert
        value: "opentelemetry-traces"
        from_attribute: "service.name"
        # 根据服务名动态设置索引
      - key: "elasticsearch.type"
        action: insert
        value: "_doc"
      # 标准化时间戳格式
      - key: "@timestamp"
        action: insert
        from_attribute: "timestamp"
      # 添加数据源标识
      - key: "data_source"
        action: insert
        value: "opentelemetry"

  # 资源处理器 - 添加Elasticsearch元数据
  resource:
    attributes:
      - key: "elasticsearch.cluster"
        action: insert
        value: "opentelemetry-cluster"
      - key: "elasticsearch.node"
        action: insert
        value: "collector-node"
      - key: "data_format"
        action: insert
        value: "otlp"

  # 采样器
  probabilistic_sampler:
    sampling_percentage: 10.0

exporters:
  # Elasticsearch 导出器 - Traces
  elasticsearch/traces:
    endpoints:
      - "http://elasticsearch:9200"
    mapping:
      mode: "ecs"  # 使用ECS映射
    index: "opentelemetry-traces"
    index_template:
      name: "opentelemetry-traces"
      pattern: "opentelemetry-traces-*"
      settings:
        number_of_shards: 1
        number_of_replicas: 0
        index.refresh_interval: "5s"
        index.mapping.total_fields.limit: 2000
      mappings:
        properties:
          "@timestamp":
            type: "date"
          trace_id:
            type: "keyword"
          span_id:
            type: "keyword"
          parent_span_id:
            type: "keyword"
          operation_name:
            type: "keyword"
          service_name:
            type: "keyword"
          service_version:
            type: "keyword"
          duration_nanos:
            type: "long"
          status_code:
            type: "keyword"
          status_message:
            type: "text"
          attributes:
            type: "object"
            dynamic: true
          events:
            type: "nested"
            properties:
              name:
                type: "keyword"
              timestamp:
                type: "date"
              attributes:
                type: "object"
                dynamic: true
    # 认证配置
    auth:
      authenticator: "basicauth/client"
    # 重试配置
    retry_on_failure:
      enabled: true
      initial_interval: 5s
      max_interval: 30s
      max_elapsed_time: 300s
    # 队列配置
    sending_queue:
      enabled: true
      num_consumers: 10
      queue_size: 1000
    # 压缩配置
    compression: gzip
    # 超时配置
    timeout: 30s

  # Elasticsearch 导出器 - Metrics
  elasticsearch/metrics:
    endpoints:
      - "http://elasticsearch:9200"
    mapping:
      mode: "ecs"
    index: "opentelemetry-metrics"
    index_template:
      name: "opentelemetry-metrics"
      pattern: "opentelemetry-metrics-*"
      settings:
        number_of_shards: 1
        number_of_replicas: 0
        index.refresh_interval: "10s"
        index.mapping.total_fields.limit: 1000
      mappings:
        properties:
          "@timestamp":
            type: "date"
          metric_name:
            type: "keyword"
          metric_type:
            type: "keyword"
          value:
            type: "double"
          unit:
            type: "keyword"
          service_name:
            type: "keyword"
          service_version:
            type: "keyword"
          attributes:
            type: "object"
            dynamic: true
    auth:
      authenticator: "basicauth/client"
    retry_on_failure:
      enabled: true
      initial_interval: 5s
      max_interval: 30s
      max_elapsed_time: 300s
    sending_queue:
      enabled: true
      num_consumers: 5
      queue_size: 500
    compression: gzip
    timeout: 30s

  # Elasticsearch 导出器 - Logs
  elasticsearch/logs:
    endpoints:
      - "http://elasticsearch:9200"
    mapping:
      mode: "ecs"
    index: "opentelemetry-logs"
    index_template:
      name: "opentelemetry-logs"
      pattern: "opentelemetry-logs-*"
      settings:
        number_of_shards: 1
        number_of_replicas: 0
        index.refresh_interval: "5s"
        index.mapping.total_fields.limit: 2000
      mappings:
        properties:
          "@timestamp":
            type: "date"
          log_level:
            type: "keyword"
          log_message:
            type: "text"
          service_name:
            type: "keyword"
          service_version:
            type: "keyword"
          trace_id:
            type: "keyword"
          span_id:
            type: "keyword"
          attributes:
            type: "object"
            dynamic: true
    auth:
      authenticator: "basicauth/client"
    retry_on_failure:
      enabled: true
      initial_interval: 5s
      max_interval: 30s
      max_elapsed_time: 300s
    sending_queue:
      enabled: true
      num_consumers: 5
      queue_size: 500
    compression: gzip
    timeout: 30s

  # 日志导出器 - 用于调试
  logging:
    loglevel: info
    sampling_initial: 5
    sampling_thereafter: 200

  # Prometheus 导出器 - 监控Collector自身
  prometheus:
    endpoint: "0.0.0.0:8889"
    namespace: "otelcol"
    const_labels:
      service: "opentelemetry-collector"
      version: "0.91.0"

service:
  pipelines:
    # Traces 管道
    traces:
      receivers: [otlp]
      processors: [memory_limiter, resource, attributes, probabilistic_sampler, batch]
      exporters: [elasticsearch/traces, logging]

    # Metrics 管道
    metrics:
      receivers: [otlp]
      processors: [memory_limiter, resource, attributes, batch]
      exporters: [elasticsearch/metrics, prometheus, logging]

    # Logs 管道
    logs:
      receivers: [otlp]
      processors: [memory_limiter, resource, attributes, batch]
      exporters: [elasticsearch/logs, logging]

  # 扩展配置
  extensions: [health_check, pprof, zpages, basicauth]

  # 健康检查
  health_check:
    endpoint: 0.0.0.0:13133

  # 性能分析
  pprof:
    endpoint: 0.0.0.0:1777

  # 调试页面
  zpages:
    endpoint: 0.0.0.0:55679

  # 基础认证
  basicauth:
    client:
      username: "elastic"
      password: "changeme"

# Elasticsearch 特定配置
elasticsearch:
  # 集群配置
  cluster:
    name: "opentelemetry-cluster"
    nodes:
      - "elasticsearch:9200"
  
  # 索引生命周期管理
  ilm:
    enabled: true
    policies:
      - name: "opentelemetry-traces-policy"
        pattern: "opentelemetry-traces-*"
        phases:
          hot:
            actions:
              rollover:
                max_size: "50GB"
                max_age: "7d"
          warm:
            min_age: "7d"
            actions:
              allocate:
                number_of_replicas: 0
          cold:
            min_age: "30d"
            actions:
              allocate:
                number_of_replicas: 0
          delete:
            min_age: "90d"
      
      - name: "opentelemetry-metrics-policy"
        pattern: "opentelemetry-metrics-*"
        phases:
          hot:
            actions:
              rollover:
                max_size: "10GB"
                max_age: "1d"
          warm:
            min_age: "1d"
            actions:
              allocate:
                number_of_replicas: 0
          cold:
            min_age: "7d"
            actions:
              allocate:
                number_of_replicas: 0
          delete:
            min_age: "30d"
      
      - name: "opentelemetry-logs-policy"
        pattern: "opentelemetry-logs-*"
        phases:
          hot:
            actions:
              rollover:
                max_size: "20GB"
                max_age: "1d"
          warm:
            min_age: "1d"
            actions:
              allocate:
                number_of_replicas: 0
          cold:
            min_age: "7d"
            actions:
              allocate:
                number_of_replicas: 0
          delete:
            min_age: "30d"

  # 索引模板配置
  index_templates:
    - name: "opentelemetry-traces"
      index_patterns: ["opentelemetry-traces-*"]
      template:
        settings:
          number_of_shards: 1
          number_of_replicas: 0
          index.refresh_interval: "5s"
          index.mapping.total_fields.limit: 2000
          index.codec: "best_compression"
        mappings:
          properties:
            "@timestamp":
              type: "date"
            trace_id:
              type: "keyword"
            span_id:
              type: "keyword"
            parent_span_id:
              type: "keyword"
            operation_name:
              type: "keyword"
            service_name:
              type: "keyword"
            service_version:
              type: "keyword"
            duration_nanos:
              type: "long"
            status_code:
              type: "keyword"
            status_message:
              type: "text"
            attributes:
              type: "object"
              dynamic: true
            events:
              type: "nested"
              properties:
                name:
                  type: "keyword"
                timestamp:
                  type: "date"
                attributes:
                  type: "object"
                  dynamic: true

  # 监控配置
  monitoring:
    enabled: true
    metrics:
      - name: "elasticsearch_index_document_count"
        description: "Number of documents in Elasticsearch indices"
      - name: "elasticsearch_index_size_bytes"
        description: "Size of Elasticsearch indices in bytes"
      - name: "elasticsearch_bulk_requests_total"
        description: "Total number of bulk requests to Elasticsearch"
      - name: "elasticsearch_bulk_errors_total"
        description: "Total number of bulk request errors"

  # 性能优化配置
  performance:
    # 批量大小
    bulk_size: 1000
    # 并发数
    concurrency: 10
    # 刷新间隔
    refresh_interval: "5s"
    # 压缩
    compression: true
    # 超时设置
    timeout: "30s"
    # 重试配置
    retry:
      max_attempts: 3
      backoff: "exponential"
      initial_interval: "1s"
      max_interval: "30s"

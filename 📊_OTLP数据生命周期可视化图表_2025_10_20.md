# ğŸ“Š OTLPæ•°æ®ç”Ÿå‘½å‘¨æœŸå¯è§†åŒ–å›¾è¡¨

> **åˆ›å»ºæ—¶é—´**: 2025å¹´10æœˆ20æ—¥  
> **ç”¨é€”**: å¯è§†åŒ–å±•ç¤ºOTLPæ•°æ®çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ  
> **å›¾è¡¨æ•°é‡**: 4ä¸ªMermaidæµç¨‹å›¾  
> **å…³è”æ–‡æ¡£**: [æ•°æ®æ¨¡å‹ä¸è¯­ä¹‰è½¬æ¢å®Œæ•´æŒ‡å—](./ğŸ“Š_æ•°æ®æ¨¡å‹ä¸è¯­ä¹‰è½¬æ¢å®Œæ•´æŒ‡å—_2025_10_20.md)

---

## ğŸ“‹ å›¾è¡¨ç›®å½•

1. [å›¾è¡¨1ï¼šOTLPæ•°æ®ç”Ÿå‘½å‘¨æœŸå…¨æµç¨‹å›¾](#å›¾è¡¨1otlpæ•°æ®ç”Ÿå‘½å‘¨æœŸå…¨æµç¨‹å›¾)
2. [å›¾è¡¨2ï¼šOTLPè¯­ä¹‰æ¨¡å‹å±‚æ¬¡ç»“æ„å›¾](#å›¾è¡¨2otlpè¯­ä¹‰æ¨¡å‹å±‚æ¬¡ç»“æ„å›¾)
3. [å›¾è¡¨3ï¼šCollectorå¤„ç†æµç¨‹è¯¦ç»†å›¾](#å›¾è¡¨3collectorå¤„ç†æµç¨‹è¯¦ç»†å›¾)
4. [å›¾è¡¨4ï¼šå¤šåç«¯å­˜å‚¨æ¶æ„å›¾](#å›¾è¡¨4å¤šåç«¯å­˜å‚¨æ¶æ„å›¾)

---

## å›¾è¡¨1ï¼šOTLPæ•°æ®ç”Ÿå‘½å‘¨æœŸå…¨æµç¨‹å›¾

### æ¦‚è¿°

å±•ç¤ºä»åº”ç”¨ç¨‹åºç”Ÿæˆé¥æµ‹æ•°æ®ï¼Œåˆ°æœ€ç»ˆæŸ¥è¯¢åˆ†æçš„å®Œæ•´æ•°æ®æµè½¬è¿‡ç¨‹ã€‚

### æµç¨‹å›¾

```mermaid
graph TB
    subgraph "ç¬¬1é˜¶æ®µï¼šæ•°æ®æ”¶é›†"
        A1[åº”ç”¨ç¨‹åºä»£ç ]
        A2[OpenTelemetry SDK]
        A3[è‡ªåŠ¨åŸ‹ç‚¹]
        A4[æ‰‹åŠ¨åŸ‹ç‚¹]
        
        A1 --> A2
        A2 --> A3
        A2 --> A4
    end
    
    subgraph "ç¬¬2é˜¶æ®µï¼šæ•°æ®å¯¼å‡º"
        B1[Trace Exporter]
        B2[Metrics Exporter]
        B3[Logs Exporter]
        B4[OTLP/gRPC]
        B5[OTLP/HTTP]
        
        A3 --> B1
        A3 --> B2
        A3 --> B3
        A4 --> B1
        A4 --> B2
        A4 --> B3
        
        B1 --> B4
        B1 --> B5
        B2 --> B4
        B2 --> B5
        B3 --> B4
        B3 --> B5
    end
    
    subgraph "ç¬¬3é˜¶æ®µï¼šæ•°æ®è½¬æ¢ (Collector)"
        C1[Receivers]
        C2[Processors]
        C3[Exporters]
        C4[é‡‡æ ·å¤„ç†]
        C5[å±æ€§å¢å¼º]
        C6[æ•°æ®è¿‡æ»¤]
        C7[æ‰¹å¤„ç†]
        
        B4 --> C1
        B5 --> C1
        C1 --> C2
        C2 --> C4
        C2 --> C5
        C2 --> C6
        C4 --> C7
        C5 --> C7
        C6 --> C7
        C7 --> C3
    end
    
    subgraph "ç¬¬4é˜¶æ®µï¼šæ•°æ®å­˜å‚¨"
        D1[Elasticsearch]
        D2[ClickHouse]
        D3[Prometheus]
        D4[Jaeger]
        D5[S3/å¯¹è±¡å­˜å‚¨]
        
        C3 --> D1
        C3 --> D2
        C3 --> D3
        C3 --> D4
        C3 --> D5
    end
    
    subgraph "ç¬¬5é˜¶æ®µï¼šæ•°æ®å¤„ç†"
        E1[å®æ—¶å¤„ç†/Flink]
        E2[æ‰¹å¤„ç†/Spark]
        E3[æµå¼èšåˆ]
        E4[æŒ‡æ ‡è®¡ç®—]
        
        D1 --> E1
        D2 --> E1
        D5 --> E2
        E1 --> E3
        E2 --> E4
    end
    
    subgraph "ç¬¬6é˜¶æ®µï¼šæ•°æ®æŸ¥è¯¢ä¸å±•ç¤º"
        F1[Grafana Dashboard]
        F2[Kibana]
        F3[Jaeger UI]
        F4[è‡ªå®šä¹‰æŸ¥è¯¢API]
        F5[å‘Šè­¦ç³»ç»Ÿ]
        
        D1 --> F1
        D1 --> F2
        D2 --> F1
        D3 --> F1
        D4 --> F3
        E3 --> F1
        E4 --> F1
        F1 --> F5
    end
    
    style A2 fill:#4ecdc4
    style C2 fill:#45b7d1
    style D1 fill:#96ceb4
    style D2 fill:#96ceb4
    style F1 fill:#ffeaa7
```

### å…³é”®é˜¶æ®µè¯´æ˜

| é˜¶æ®µ | åç§° | æ ¸å¿ƒç»„ä»¶ | æ•°æ®é‡çº§ | å»¶è¿Ÿ |
|------|------|---------|---------|------|
| **1ï¸âƒ£** | æ•°æ®æ”¶é›† | SDK + åŸ‹ç‚¹ | 100% | <1ms |
| **2ï¸âƒ£** | æ•°æ®å¯¼å‡º | OTLP Exporter | 100% | 1-10ms |
| **3ï¸âƒ£** | æ•°æ®è½¬æ¢ | Collector | 1-10% (é‡‡æ ·å) | 10-50ms |
| **4ï¸âƒ£** | æ•°æ®å­˜å‚¨ | å¤šåç«¯å­˜å‚¨ | 1-10% | 50-200ms |
| **5ï¸âƒ£** | æ•°æ®å¤„ç† | å®æ—¶+æ‰¹å¤„ç† | èšåˆæ•°æ® | ç§’-åˆ†é’Ÿçº§ |
| **6ï¸âƒ£** | æ•°æ®æŸ¥è¯¢ | å¯è§†åŒ–+å‘Šè­¦ | æŒ‰éœ€ | 100ms-1s |

---

## å›¾è¡¨2ï¼šOTLPè¯­ä¹‰æ¨¡å‹å±‚æ¬¡ç»“æ„å›¾

### æ¦‚è¿°

å±•ç¤ºOTLPæ ‡å‡†å®šä¹‰çš„ä¸‰å±‚è¯­ä¹‰æ¨¡å‹ç»“æ„å…³ç³»ã€‚

### å±‚æ¬¡ç»“æ„å›¾

```mermaid
graph TD
    subgraph "å®Œæ•´OTLPæ•°æ®åŒ…"
        ROOT[ResourceSpans/ResourceMetrics/ResourceLogs]
    end
    
    subgraph "ç¬¬1å±‚ï¼šResource Model (èµ„æºæ¨¡å‹)"
        R1[Resource]
        R2[service.name]
        R3[service.version]
        R4[service.namespace]
        R5[host.name]
        R6[cloud.provider]
        R7[k8s.pod.name]
        R8[å…¶ä»–èµ„æºå±æ€§...]
        
        ROOT --> R1
        R1 --> R2
        R1 --> R3
        R1 --> R4
        R1 --> R5
        R1 --> R6
        R1 --> R7
        R1 --> R8
    end
    
    subgraph "ç¬¬2å±‚ï¼šInstrumentation Scope (ä»ªå™¨åŒ–ä½œç”¨åŸŸ)"
        I1[ScopeSpans/ScopeMetrics/ScopeLogs]
        I2[Scope Name: åº“åç§°]
        I3[Scope Version: åº“ç‰ˆæœ¬]
        I4[Scope Attributes]
        I5[Schema URL]
        
        R1 --> I1
        I1 --> I2
        I1 --> I3
        I1 --> I4
        I1 --> I5
    end
    
    subgraph "ç¬¬3å±‚ï¼šTelemetry Data Model (é¥æµ‹æ•°æ®æ¨¡å‹)"
        subgraph "Traces (è¿½è¸ª)"
            T1[Span Array]
            T2[Span: trace_id]
            T3[Span: span_id]
            T4[Span: parent_span_id]
            T5[Span: name]
            T6[Span: kind]
            T7[Span: start_time]
            T8[Span: end_time]
            T9[Span: attributes]
            T10[Span: events]
            T11[Span: links]
            T12[Span: status]
            
            I1 --> T1
            T1 --> T2
            T1 --> T3
            T1 --> T4
            T1 --> T5
            T1 --> T6
            T1 --> T7
            T1 --> T8
            T1 --> T9
            T1 --> T10
            T1 --> T11
            T1 --> T12
        end
        
        subgraph "Metrics (æŒ‡æ ‡)"
            M1[Metric Array]
            M2[Metric: name]
            M3[Metric: description]
            M4[Metric: unit]
            M5[Metric: data_type]
            M6[Counter]
            M7[Gauge]
            M8[Histogram]
            M9[Summary]
            M10[data_points]
            
            I1 --> M1
            M1 --> M2
            M1 --> M3
            M1 --> M4
            M1 --> M5
            M5 --> M6
            M5 --> M7
            M5 --> M8
            M5 --> M9
            M6 --> M10
            M7 --> M10
            M8 --> M10
            M9 --> M10
        end
        
        subgraph "Logs (æ—¥å¿—)"
            L1[LogRecord Array]
            L2[LogRecord: timestamp]
            L3[LogRecord: severity]
            L4[LogRecord: body]
            L5[LogRecord: attributes]
            L6[LogRecord: trace_id]
            L7[LogRecord: span_id]
            L8[LogRecord: flags]
            
            I1 --> L1
            L1 --> L2
            L1 --> L3
            L1 --> L4
            L1 --> L5
            L1 --> L6
            L1 --> L7
            L1 --> L8
        end
    end
    
    style ROOT fill:#ff6b6b
    style R1 fill:#4ecdc4
    style I1 fill:#45b7d1
    style T1 fill:#96ceb4
    style M1 fill:#96ceb4
    style L1 fill:#96ceb4
```

### ä¸‰å±‚æ¨¡å‹è¯´æ˜

#### ç¬¬1å±‚ï¼šResource Modelï¼ˆèµ„æºæ¨¡å‹ï¼‰

```text
ä½œç”¨: æè¿°äº§ç”Ÿé¥æµ‹æ•°æ®çš„å®ä½“ï¼ˆæœåŠ¡ã€ä¸»æœºã€å®¹å™¨ç­‰ï¼‰
ç‰¹ç‚¹:
  âœ… åœ¨æ•´ä¸ªè¯·æ±‚é“¾è·¯ä¸­ä¿æŒä¸å˜
  âœ… æ ‡è¯†æ•°æ®æ¥æº
  âœ… ç”¨äºåˆ†ç»„å’Œèšåˆ

å¿…éœ€å±æ€§:
  - service.name: æœåŠ¡åç§° (å¿…éœ€)
  - service.version: æœåŠ¡ç‰ˆæœ¬ (æ¨è)
  
æ¨èå±æ€§:
  - service.namespace: æœåŠ¡å‘½åç©ºé—´
  - deployment.environment: éƒ¨ç½²ç¯å¢ƒ
  - host.name: ä¸»æœºå
  - cloud.provider: äº‘æä¾›å•†
  - k8s.pod.name: K8s Podåç§°
```

#### ç¬¬2å±‚ï¼šInstrumentation Scopeï¼ˆä»ªå™¨åŒ–ä½œç”¨åŸŸï¼‰

```text
ä½œç”¨: æ ‡è¯†ç”Ÿæˆæ•°æ®çš„åº“æˆ–æ¨¡å—
ç‰¹ç‚¹:
  âœ… åŒºåˆ†ä¸åŒçš„SDK/åº“ç‰ˆæœ¬
  âœ… æ–¹ä¾¿æ•…éšœéš”ç¦»
  âœ… æ”¯æŒåº“çº§åˆ«çš„é…ç½®

å…¸å‹å€¼:
  - Scope Name: "opentelemetry.instrumentation.http"
  - Scope Version: "1.20.0"
  - Schema URL: "https://opentelemetry.io/schemas/1.21.0"
```

#### ç¬¬3å±‚ï¼šTelemetry Data Modelï¼ˆé¥æµ‹æ•°æ®æ¨¡å‹ï¼‰

```text
ä½œç”¨: å®é™…çš„é¥æµ‹æ•°æ®ï¼ˆTraces/Metrics/Logsï¼‰
ç‰¹ç‚¹:
  âœ… é«˜åº¦ç»“æ„åŒ–
  âœ… ç±»å‹ä¸¥æ ¼
  âœ… æ”¯æŒä¸°å¯Œçš„å…ƒæ•°æ®

æ•°æ®ç±»å‹:
  - Traces: åˆ†å¸ƒå¼è¿½è¸ª (Span)
  - Metrics: æ€§èƒ½æŒ‡æ ‡ (Counter/Gauge/Histogram/Summary)
  - Logs: ç»“æ„åŒ–æ—¥å¿— (LogRecord)
```

---

## å›¾è¡¨3ï¼šCollectorå¤„ç†æµç¨‹è¯¦ç»†å›¾

### æ¦‚è¿°

å±•ç¤ºOpenTelemetry Collectorå†…éƒ¨çš„æ•°æ®å¤„ç†pipelineè¯¦ç»†æµç¨‹ã€‚

### å¤„ç†æµç¨‹å›¾

```mermaid
graph TB
    subgraph "è¾“å…¥ï¼šReceivers"
        R1[OTLP Receiver<br/>gRPC: 4317<br/>HTTP: 4318]
        R2[Jaeger Receiver<br/>14250, 14268]
        R3[Zipkin Receiver<br/>9411]
        R4[Prometheus Receiver<br/>8888]
        R5[Custom Receivers]
    end
    
    subgraph "å¤„ç†ç®¡é“ï¼šProcessors"
        subgraph "æ•°æ®è¿‡æ»¤"
            P1[Filter Processor]
            P2[é‡‡æ ·è§„åˆ™]
            P3[å±æ€§è¿‡æ»¤]
            P4[èµ„æºè¿‡æ»¤]
        end
        
        subgraph "æ•°æ®è½¬æ¢"
            P5[Attributes Processor]
            P6[å±æ€§æ·»åŠ /åˆ é™¤]
            P7[å±æ€§é‡å‘½å]
            P8[å±æ€§è½¬æ¢]
        end
        
        subgraph "æ•°æ®å¢å¼º"
            P9[Resource Processor]
            P10[Resource Detection Processor]
            P11[K8s Attributes Processor]
            P12[æ·»åŠ ç¯å¢ƒä¿¡æ¯]
        end
        
        subgraph "é‡‡æ ·å¤„ç†"
            P13[Probabilistic Sampler]
            P14[Tail Sampling]
            P15[æ™ºèƒ½é‡‡æ ·]
            P16[å›ºå®šæ¯”ä¾‹: 10%]
            P17[åŸºäºé”™è¯¯: 100%]
            P18[åŸºäºå»¶è¿Ÿ: æ¡ä»¶]
        end
        
        subgraph "æ‰¹å¤„ç†"
            P19[Batch Processor]
            P20[ç¼“å†²åŒºå¤§å°: 8192]
            P21[è¶…æ—¶æ—¶é—´: 200ms]
            P22[å‹ç¼©æ•°æ®åŒ…]
        end
    end
    
    subgraph "è¾“å‡ºï¼šExporters"
        E1[OTLP Exporter<br/>å‘é€åˆ°åç«¯Collector]
        E2[Elasticsearch Exporter<br/>å­˜å‚¨åˆ°ES]
        E3[ClickHouse Exporter<br/>å­˜å‚¨åˆ°ClickHouse]
        E4[Jaeger Exporter<br/>å‘é€åˆ°Jaeger]
        E5[Prometheus Exporter<br/>æš´éœ²Metricsç«¯ç‚¹]
        E6[File Exporter<br/>å†™å…¥æœ¬åœ°æ–‡ä»¶]
        E7[S3 Exporter<br/>å­˜å‚¨åˆ°å¯¹è±¡å­˜å‚¨]
    end
    
    R1 --> P1
    R2 --> P1
    R3 --> P1
    R4 --> P1
    R5 --> P1
    
    P1 --> P2
    P1 --> P3
    P1 --> P4
    
    P2 --> P5
    P3 --> P5
    P4 --> P5
    
    P5 --> P6
    P5 --> P7
    P5 --> P8
    
    P6 --> P9
    P7 --> P9
    P8 --> P9
    
    P9 --> P10
    P9 --> P11
    P9 --> P12
    
    P10 --> P13
    P11 --> P13
    P12 --> P13
    
    P13 --> P14
    P13 --> P15
    P14 --> P16
    P14 --> P17
    P14 --> P18
    
    P16 --> P19
    P17 --> P19
    P18 --> P19
    
    P19 --> P20
    P19 --> P21
    P19 --> P22
    
    P20 --> E1
    P20 --> E2
    P20 --> E3
    P21 --> E4
    P21 --> E5
    P22 --> E6
    P22 --> E7
    
    style R1 fill:#4ecdc4
    style P1 fill:#45b7d1
    style P9 fill:#96ceb4
    style P13 fill:#ffd93d
    style P19 fill:#ff6b6b
    style E2 fill:#95e1d3
    style E3 fill:#95e1d3
```

### Collectorå¤„ç†æ­¥éª¤è¯¦è§£

#### æ­¥éª¤1ï¼šReceiversï¼ˆæ¥æ”¶å™¨ï¼‰

```yaml
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318
  
  jaeger:
    protocols:
      grpc:
        endpoint: 0.0.0.0:14250
      thrift_http:
        endpoint: 0.0.0.0:14268
  
  prometheus:
    config:
      scrape_configs:
        - job_name: 'otel-collector'
          scrape_interval: 10s
          static_configs:
            - targets: ['localhost:8888']
```

**ä½œç”¨**: æ¥æ”¶æ¥è‡ªä¸åŒæ¥æºå’Œåè®®çš„é¥æµ‹æ•°æ®

**æ”¯æŒçš„åè®®**:

- âœ… OTLP (gRPC + HTTP)
- âœ… Jaeger (gRPC + Thrift)
- âœ… Zipkin (HTTP)
- âœ… Prometheus (Pull)
- âœ… è‡ªå®šä¹‰Receivers

#### æ­¥éª¤2ï¼šProcessorsï¼ˆå¤„ç†å™¨ï¼‰

**2.1 æ•°æ®è¿‡æ»¤ (Filter)**:

```yaml
processors:
  filter:
    traces:
      span:
        # è¿‡æ»¤å¥åº·æ£€æŸ¥è¯·æ±‚
        - 'attributes["http.target"] == "/health"'
        - 'attributes["http.target"] == "/metrics"'
    
    metrics:
      metric:
        # è¿‡æ»¤å†…éƒ¨æŒ‡æ ‡
        - 'name == "internal.metric"'
```

**2.2 é‡‡æ ·å¤„ç† (Sampling)**:

```yaml
processors:
  # æ¦‚ç‡é‡‡æ · (10%)
  probabilistic_sampler:
    sampling_percentage: 10
  
  # å°¾éƒ¨é‡‡æ · (æ™ºèƒ½é‡‡æ ·)
  tail_sampling:
    decision_wait: 10s
    num_traces: 100
    expected_new_traces_per_sec: 10
    policies:
      # é”™è¯¯è¿½è¸ª100%ä¿ç•™
      - name: errors-policy
        type: status_code
        status_code:
          status_codes: [ERROR]
      
      # æ…¢è¯·æ±‚100%ä¿ç•™
      - name: slow-traces-policy
        type: latency
        latency:
          threshold_ms: 1000
      
      # å…¶ä»–è¯·æ±‚10%é‡‡æ ·
      - name: probabilistic-policy
        type: probabilistic
        probabilistic:
          sampling_percentage: 10
```

**2.3 å±æ€§å¢å¼º (Attributes)**:

```yaml
processors:
  attributes:
    actions:
      # æ·»åŠ ç¯å¢ƒä¿¡æ¯
      - key: environment
        value: production
        action: insert
      
      # æ·»åŠ K8sä¿¡æ¯
      - key: k8s.cluster.name
        value: prod-cluster-01
        action: upsert
      
      # åˆ é™¤æ•æ„Ÿä¿¡æ¯
      - key: http.request.header.authorization
        action: delete
  
  resource:
    attributes:
      - key: service.namespace
        value: ecommerce
        action: insert
```

#### æ­¥éª¤3ï¼šExportersï¼ˆå¯¼å‡ºå™¨ï¼‰

```yaml
exporters:
  # å¯¼å‡ºåˆ°Elasticsearch
  elasticsearch:
    endpoints: [http://elasticsearch:9200]
    logs_index: logs-otlp
    traces_index: traces-otlp
    metrics_index: metrics-otlp
  
  # å¯¼å‡ºåˆ°ClickHouse
  clickhouse:
    endpoint: tcp://clickhouse:9000
    database: otlp
    ttl_days: 30
    compression: lz4
  
  # å¯¼å‡ºåˆ°Jaeger
  jaeger:
    endpoint: jaeger-collector:14250
    tls:
      insecure: false
  
  # å¯¼å‡ºåˆ°S3
  awss3:
    s3uploader:
      region: us-west-2
      s3_bucket: otlp-archive
      s3_prefix: traces/
```

### æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | å…¸å‹å€¼ | è¯´æ˜ |
|------|--------|------|
| **ååé‡** | 100K spans/ç§’ | å•Collectorå®ä¾‹ |
| **å»¶è¿Ÿ** | P50: 10ms, P99: 50ms | å¤„ç†å»¶è¿Ÿ |
| **å†…å­˜å ç”¨** | 512MB - 2GB | å–å†³äºæ‰¹å¤„ç†å¤§å° |
| **CPUä½¿ç”¨** | 2-4 cores | ç”Ÿäº§ç¯å¢ƒæ¨è |
| **æ•°æ®å‹ç¼©æ¯”** | 5:1 - 10:1 | é‡‡æ ·å |

---

## å›¾è¡¨4ï¼šå¤šåç«¯å­˜å‚¨æ¶æ„å›¾

### æ¦‚è¿°

å±•ç¤ºOTLPæ•°æ®åœ¨å¤šä¸ªåç«¯å­˜å‚¨ç³»ç»Ÿä¸­çš„åˆ†å¸ƒå’ŒæŸ¥è¯¢æ¶æ„ã€‚

### å­˜å‚¨æ¶æ„å›¾

```mermaid
graph TB
    subgraph "æ•°æ®å…¥å£"
        C[OpenTelemetry Collector]
    end
    
    subgraph "å­˜å‚¨å±‚"
        subgraph "çƒ­æ•°æ®å­˜å‚¨ (7å¤©)"
            S1[Elasticsearch Cluster]
            S1_1[Master Node x3]
            S1_2[Data Node x6]
            S1_3[Coordinating Node x2]
            
            S1 --> S1_1
            S1 --> S1_2
            S1 --> S1_3
        end
        
        subgraph "æ¸©æ•°æ®å­˜å‚¨ (30å¤©)"
            S2[ClickHouse Cluster]
            S2_1[Shard 1: 3 replicas]
            S2_2[Shard 2: 3 replicas]
            S2_3[Shard 3: 3 replicas]
            S2_4[ZooKeeper x3]
            
            S2 --> S2_1
            S2 --> S2_2
            S2 --> S2_3
            S2 --> S2_4
        end
        
        subgraph "å†·æ•°æ®å­˜å‚¨ (1å¹´+)"
            S3[S3/å¯¹è±¡å­˜å‚¨]
            S3_1[Standard: 30-90å¤©]
            S3_2[IA: 90-365å¤©]
            S3_3[Glacier: 1å¹´+]
            
            S3 --> S3_1
            S3 --> S3_2
            S3 --> S3_3
        end
        
        subgraph "ä¸“ç”¨å­˜å‚¨"
            S4[Jaeger Backend<br/>ä¸“ç”¨äºTraces]
            S5[Prometheus<br/>ä¸“ç”¨äºMetrics]
            S6[Loki<br/>ä¸“ç”¨äºLogs]
        end
    end
    
    subgraph "æ•°æ®åˆ†æµç­–ç•¥"
        D1[Traces â†’ ES + ClickHouse + Jaeger]
        D2[Metrics â†’ Prometheus + ClickHouse]
        D3[Logs â†’ ES + Loki]
        D4[Archive â†’ S3]
    end
    
    subgraph "æŸ¥è¯¢å±‚"
        subgraph "å®æ—¶æŸ¥è¯¢ (<1ç§’)"
            Q1[Grafana]
            Q2[Kibana]
            Q3[Jaeger UI]
        end
        
        subgraph "æ‰¹é‡æŸ¥è¯¢ (ç§’çº§)"
            Q4[ClickHouse SQL]
            Q5[Presto/Trino<br/>è”é‚¦æŸ¥è¯¢]
        end
        
        subgraph "å½’æ¡£æŸ¥è¯¢ (åˆ†é’Ÿçº§)"
            Q6[S3 Select]
            Q7[Athena]
        end
    end
    
    subgraph "æ•°æ®å¤„ç†"
        P1[Flink å®æ—¶æµå¤„ç†]
        P2[Spark æ‰¹å¤„ç†åˆ†æ]
        P3[èšåˆæŒ‡æ ‡è®¡ç®—]
        P4[å¼‚å¸¸æ£€æµ‹]
    end
    
    C --> D1
    C --> D2
    C --> D3
    C --> D4
    
    D1 --> S1
    D1 --> S2
    D1 --> S4
    D2 --> S2
    D2 --> S5
    D3 --> S1
    D3 --> S6
    D4 --> S3
    
    S1 --> Q1
    S1 --> Q2
    S2 --> Q1
    S2 --> Q4
    S2 --> Q5
    S3 --> Q6
    S3 --> Q7
    S4 --> Q3
    S5 --> Q1
    S6 --> Q1
    
    S1 --> P1
    S2 --> P1
    S2 --> P2
    S3 --> P2
    
    P1 --> P3
    P1 --> P4
    P2 --> P3
    
    style C fill:#4ecdc4
    style S1 fill:#45b7d1
    style S2 fill:#96ceb4
    style S3 fill:#ffeaa7
    style Q1 fill:#ff6b6b
    style P1 fill:#95e1d3
```

### å­˜å‚¨ç­–ç•¥è¯¦è§£

#### 1. çƒ­æ•°æ®å­˜å‚¨ï¼ˆElasticsearchï¼‰- 7å¤©

```yaml
é…ç½®:
  ä¿ç•™æ—¶é—´: 7å¤©
  æ•°æ®é‡: å®Œæ•´æ•°æ®
  æŸ¥è¯¢å»¶è¿Ÿ: <100ms
  æˆæœ¬: $$$$

é€‚ç”¨åœºæ™¯:
  âœ… å®æ—¶å‘Šè­¦
  âœ… è¿ç»´æ’æŸ¥
  âœ… æ€§èƒ½åˆ†æ
  âœ… æ•…éšœå®šä½

ç´¢å¼•ç­–ç•¥:
  - æŒ‰å¤©æ»šåŠ¨: traces-2025-10-20
  - ILMç­–ç•¥: 7å¤©åè‡ªåŠ¨åˆ é™¤
  - å‰¯æœ¬æ•°: 1
  - åˆ†ç‰‡æ•°: æ ¹æ®æ•°æ®é‡åŠ¨æ€è°ƒæ•´
```

**Elasticsearchç´¢å¼•æ¨¡æ¿ç¤ºä¾‹**:

```json
{
  "index_patterns": ["traces-*"],
  "settings": {
    "number_of_shards": 6,
    "number_of_replicas": 1,
    "index.lifecycle.name": "traces-ilm-policy",
    "index.lifecycle.rollover_alias": "traces"
  },
  "mappings": {
    "properties": {
      "trace_id": { "type": "keyword" },
      "span_id": { "type": "keyword" },
      "parent_span_id": { "type": "keyword" },
      "name": { "type": "text" },
      "start_time": { "type": "date" },
      "end_time": { "type": "date" },
      "duration": { "type": "long" },
      "attributes": { "type": "object" },
      "resource": { "type": "object" },
      "status": { "type": "keyword" }
    }
  }
}
```

#### 2. æ¸©æ•°æ®å­˜å‚¨ï¼ˆClickHouseï¼‰- 30å¤©

```yaml
é…ç½®:
  ä¿ç•™æ—¶é—´: 30å¤©
  æ•°æ®é‡: é‡‡æ ·åæ•°æ® (10%)
  æŸ¥è¯¢å»¶è¿Ÿ: <1s
  æˆæœ¬: $$

é€‚ç”¨åœºæ™¯:
  âœ… è¶‹åŠ¿åˆ†æ
  âœ… æŠ¥è¡¨ç”Ÿæˆ
  âœ… èšåˆæŸ¥è¯¢
  âœ… æˆæœ¬åˆ†æ

è¡¨ç»“æ„:
  å¼•æ“: ReplicatedMergeTree
  åˆ†åŒºé”®: toYYYYMMDD(start_time)
  æ’åºé”®: (service_name, start_time, trace_id)
  TTL: start_time + INTERVAL 30 DAY
```

**ClickHouseè¡¨ç»“æ„ç¤ºä¾‹**:

```sql
CREATE TABLE otlp.traces ON CLUSTER prod_cluster (
    trace_id String,
    span_id String,
    parent_span_id String,
    name String,
    start_time DateTime64(9),
    end_time DateTime64(9),
    duration UInt64,
    
    -- Resource
    service_name String,
    service_namespace String,
    service_version String,
    
    -- Attributes
    attributes Map(String, String),
    
    -- Status
    status_code String,
    status_message String,
    
    -- ç´¢å¼•åˆ—
    INDEX idx_service_name service_name TYPE bloom_filter GRANULARITY 4,
    INDEX idx_status status_code TYPE set(0) GRANULARITY 1
)
ENGINE = ReplicatedMergeTree('/clickhouse/tables/{cluster}/{shard}/otlp/traces', '{replica}')
PARTITION BY toYYYYMMDD(start_time)
ORDER BY (service_name, start_time, trace_id)
TTL start_time + INTERVAL 30 DAY
SETTINGS index_granularity = 8192;
```

#### 3. å†·æ•°æ®å­˜å‚¨ï¼ˆS3ï¼‰- 1å¹´+

```yaml
é…ç½®:
  ä¿ç•™æ—¶é—´: 1å¹´ - æ°¸ä¹…
  æ•°æ®é‡: å®Œæ•´åŸå§‹æ•°æ®
  æŸ¥è¯¢å»¶è¿Ÿ: åˆ†é’Ÿçº§
  æˆæœ¬: $

é€‚ç”¨åœºæ™¯:
  âœ… åˆè§„å®¡è®¡
  âœ… å†å²åˆ†æ
  âœ… æœºå™¨å­¦ä¹ è®­ç»ƒ
  âœ… ç¾éš¾æ¢å¤

å­˜å‚¨åˆ†å±‚:
  - Standard (30-90å¤©): $0.023/GB/æœˆ
  - IA (90-365å¤©): $0.0125/GB/æœˆ
  - Glacier (1å¹´+): $0.004/GB/æœˆ

æ–‡ä»¶æ ¼å¼: Parquet (åˆ—å¼å­˜å‚¨ï¼Œé«˜å‹ç¼©æ¯”)
å‹ç¼©: SNAPPY
åˆ†åŒº: year=2025/month=10/day=20/hour=14/
```

**S3ç”Ÿå‘½å‘¨æœŸç­–ç•¥**:

```xml
<LifecycleConfiguration>
  <Rule>
    <ID>otlp-traces-lifecycle</ID>
    <Status>Enabled</Status>
    <Prefix>traces/</Prefix>
    
    <Transition>
      <Days>30</Days>
      <StorageClass>STANDARD_IA</StorageClass>
    </Transition>
    
    <Transition>
      <Days>90</Days>
      <StorageClass>GLACIER</StorageClass>
    </Transition>
    
    <Expiration>
      <Days>2555</Days>  <!-- 7å¹´ååˆ é™¤ -->
    </Expiration>
  </Rule>
</LifecycleConfiguration>
```

### æ•°æ®åˆ†æµé…ç½®ç¤ºä¾‹

```yaml
# OpenTelemetry Collectoré…ç½®
exporters:
  # çƒ­æ•°æ® â†’ Elasticsearch (å…¨é‡ï¼Œ7å¤©)
  elasticsearch/hot:
    endpoints: [http://es-hot-cluster:9200]
    traces_index: traces-hot
    logs_index: logs-hot
    sending_queue:
      enabled: true
      num_consumers: 10
      queue_size: 5000
  
  # æ¸©æ•°æ® â†’ ClickHouse (é‡‡æ ·10%ï¼Œ30å¤©)
  clickhouse/warm:
    endpoint: tcp://clickhouse:9000
    database: otlp
    traces_table: traces
    metrics_table: metrics
    compression: lz4
  
  # å†·æ•°æ® â†’ S3 (å…¨é‡ï¼Œæ°¸ä¹…å½’æ¡£)
  awss3/cold:
    s3uploader:
      region: us-west-2
      s3_bucket: otlp-archive
      s3_prefix: year={year}/month={month}/day={day}/
      file_format: parquet
      compression: snappy
  
  # ä¸“ç”¨ â†’ Jaeger (Traces)
  jaeger:
    endpoint: jaeger:14250
  
  # ä¸“ç”¨ â†’ Prometheus (Metrics)
  prometheus:
    endpoint: 0.0.0.0:8889
    namespace: otlp

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [batch]
      exporters: 
        - elasticsearch/hot    # å…¨é‡
        - clickhouse/warm      # é‡‡æ ·
        - awss3/cold          # å…¨é‡å½’æ¡£
        - jaeger              # ä¸“ç”¨
    
    metrics:
      receivers: [otlp]
      processors: [batch]
      exporters:
        - clickhouse/warm
        - prometheus
    
    logs:
      receivers: [otlp]
      processors: [batch]
      exporters:
        - elasticsearch/hot
```

### æˆæœ¬å¯¹æ¯”

| å­˜å‚¨ç±»å‹ | æ•°æ®é‡ | æœˆæˆæœ¬ä¼°ç®— (1TBåŸå§‹) | æŸ¥è¯¢å»¶è¿Ÿ |
|----------|--------|---------------------|---------|
| **Elasticsearch (çƒ­)** | 100% (7å¤©) | $350 | <100ms |
| **ClickHouse (æ¸©)** | 10% (30å¤©) | $45 | <1s |
| **S3 Standard (æ¸©)** | 100% (60å¤©) | $46 | åˆ†é’Ÿçº§ |
| **S3 IA (å†·)** | 100% (275å¤©) | $34 | åˆ†é’Ÿçº§ |
| **S3 Glacier (å†·)** | 100% (1å¹´+) | $48/å¹´ | å°æ—¶çº§ |
| **æ€»æˆæœ¬** | - | **~$500/æœˆ** | - |

### æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”

| æŸ¥è¯¢ç±»å‹ | çƒ­æ•°æ® (ES) | æ¸©æ•°æ® (CH) | å†·æ•°æ® (S3) |
|----------|------------|------------|------------|
| **å•traceæŸ¥è¯¢** | 50ms | 200ms | 30s |
| **æ—¶é—´èŒƒå›´æŸ¥è¯¢** | 100ms | 500ms | 2min |
| **èšåˆç»Ÿè®¡** | 500ms | 1s | 5min |
| **å…¨æ–‡æœç´¢** | 200ms | 2s | ä¸æ”¯æŒ |
| **è”é‚¦æŸ¥è¯¢** | ä¸æ”¯æŒ | é€šè¿‡Presto | é€šè¿‡Athena |

---

## ğŸ“Š å›¾è¡¨ä½¿ç”¨è¯´æ˜

### ä½¿ç”¨åœºæ™¯

1. **æŠ€æœ¯åˆ†äº«**: åœ¨æŠ€æœ¯ä¼šè®®æˆ–å†…éƒ¨åˆ†äº«ä¸­ä½¿ç”¨
2. **æ–‡æ¡£é…å›¾**: åœ¨æŠ€æœ¯æ–‡æ¡£ä¸­å¼•ç”¨
3. **æ¶æ„è®¾è®¡**: ä½œä¸ºç³»ç»Ÿè®¾è®¡çš„å‚è€ƒ
4. **åŸ¹è®­æ•™è‚²**: ç”¨äºæ–°äººåŸ¹è®­å’ŒçŸ¥è¯†ä¼ é€’

### åœ¨Markdownä¸­å¼•ç”¨

```markdown
æŸ¥çœ‹å®Œæ•´æµç¨‹ï¼Œè¯·å‚è€ƒï¼š
[OTLPæ•°æ®ç”Ÿå‘½å‘¨æœŸå…¨æµç¨‹å›¾](./ğŸ“Š_OTLPæ•°æ®ç”Ÿå‘½å‘¨æœŸå¯è§†åŒ–å›¾è¡¨_2025_10_20.md#å›¾è¡¨1otlpæ•°æ®ç”Ÿå‘½å‘¨æœŸå…¨æµç¨‹å›¾)
```

### å¯¼å‡ºä¸ºPNG/SVG

è¿™äº›Mermaidå›¾è¡¨å¯ä»¥é€šè¿‡ä»¥ä¸‹å·¥å…·å¯¼å‡ºä¸ºå›¾ç‰‡ï¼š

1. **Mermaid Live Editor**: <https://mermaid.live/>
2. **VS Codeæ’ä»¶**: Markdown Preview Mermaid Support
3. **å‘½ä»¤è¡Œå·¥å…·**: mermaid-cli

```bash
# å®‰è£…mermaid-cli
npm install -g @mermaid-js/mermaid-cli

# å¯¼å‡ºä¸ºPNG
mmdc -i diagram.md -o diagram.png

# å¯¼å‡ºä¸ºSVG
mmdc -i diagram.md -o diagram.svg
```

---

## ğŸ”— ç›¸å…³èµ„æº

### å…³è”æ–‡æ¡£

- [ğŸ“Š æ•°æ®æ¨¡å‹ä¸è¯­ä¹‰è½¬æ¢å®Œæ•´æŒ‡å—](./ğŸ“Š_æ•°æ®æ¨¡å‹ä¸è¯­ä¹‰è½¬æ¢å®Œæ•´æŒ‡å—_2025_10_20.md)
- [ğŸ“Š OTLPé¡¹ç›®å…¨é¢å¯¹æ ‡åˆ†ææŠ¥å‘Š](./ğŸ“Š_OTLPé¡¹ç›®2025å¹´10æœˆ20æ—¥å…¨é¢å¯¹æ ‡åˆ†ææŠ¥å‘Š.md)
- [ğŸš€ OTLPé¡¹ç›®æŒç»­æ¨è¿›è®¡åˆ’](./ğŸš€_OTLPé¡¹ç›®æŒç»­æ¨è¿›è®¡åˆ’_2025_10_20.md)
- [PROJECT_DASHBOARD.md](./PROJECT_DASHBOARD.md)

### å®˜æ–¹èµ„æº

- [OpenTelemetryå®˜ç½‘](https://opentelemetry.io/)
- [OTLPåè®®è§„èŒƒ](https://opentelemetry.io/docs/specs/otlp/)
- [Collectoræ–‡æ¡£](https://opentelemetry.io/docs/collector/)
- [Semantic Conventions](https://opentelemetry.io/docs/specs/semconv/)

---

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.0.0 (2025-10-20)

- âœ… åˆ›å»º4ä¸ªæ ¸å¿ƒå¯è§†åŒ–å›¾è¡¨
- âœ… æ·»åŠ è¯¦ç»†çš„é…ç½®ç¤ºä¾‹
- âœ… è¡¥å……æ€§èƒ½å’Œæˆæœ¬å¯¹æ¯”æ•°æ®

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**åˆ›å»ºæ—¶é—´**: 2025å¹´10æœˆ20æ—¥  
**ç»´æŠ¤è€…**: OTLPé¡¹ç›®å›¢é˜Ÿ  
**è®¸å¯è¯**: MIT

---

**ğŸ‰ æ•°æ®ç”Ÿå‘½å‘¨æœŸå¯è§†åŒ–å›¾è¡¨åˆ›å»ºå®Œæˆï¼**
